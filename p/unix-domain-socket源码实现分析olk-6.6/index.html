<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Ê∑±ÂÖ•ÂÜÖÊ†∏Ê∫êÁ†ÅÂàÜÊûêudsÈÄö‰ø°Êú∫Âà∂">
<meta name="keywords" content="IPC„ÄÅUDS„ÄÅÊ∫êÁ†ÅÂàÜÊûê„ÄÅË∞ÉÁ†î"><title>Unix Domain SocketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûê(OLK 6.6)</title>

<link rel='canonical' href='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/'>

<link rel="stylesheet" href="/scss/style.min.1d7a77f66a9605dfbac1c7922a91290042c454a1166056d913fcbcea340dd583.css"><meta property='og:title' content="Unix Domain SocketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûê(OLK 6.6)">
<meta property='og:description' content="Ê∑±ÂÖ•ÂÜÖÊ†∏Ê∫êÁ†ÅÂàÜÊûêudsÈÄö‰ø°Êú∫Âà∂">
<meta property='og:url' content='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/'>
<meta property='og:site_name' content='Ëæ∞Ëøú'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='IPC' /><meta property='article:published_time' content='2024-12-15T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-12-15T15:01:27&#43;08:00'/><meta property='og:image' content='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1.jpg' />
<meta name="twitter:title" content="Unix Domain SocketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûê(OLK 6.6)">
<meta name="twitter:description" content="Ê∑±ÂÖ•ÂÜÖÊ†∏Ê∫êÁ†ÅÂàÜÊûêudsÈÄö‰ø°Êú∫Âà∂"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1.jpg' />

<link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu4999655723030452168.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Ëæ∞Ëøú</a></h1>
            <h2 class="site-description">Â§©Â∞ÜÈôçÂ§ß‰ªª‰∫éÊñØ‰∫∫‰πü</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='/'
                        
                        title="È¶ñÈ°µ&amp;ÂÖ≥‰∫é"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/chenyuan1125'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>ÈìæÊé•</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://chenyuan1125.github.io/en/" >English</option>
                                
                                    <option value="https://chenyuan1125.github.io/" selected>‰∏≠Êñá</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#unix-domain-socketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûêolk-66">Unix Domain SocketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûê(OLK 6.6)</a>
      <ol>
        <li><a href="#socket"><strong>socket()</strong></a></li>
        <li><a href="#bind">bind()</a></li>
        <li><a href="#listen">listen()</a></li>
        <li><a href="#connect">connect()</a></li>
        <li><a href="#accept">accept()</a></li>
        <li><a href="#write">write()</a></li>
        <li><a href="#read">read()</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/">
                <img src="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1_hu379590808969644185.jpg"
                        srcset="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1_hu379590808969644185.jpg 800w, /p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1_hu7618736452145915547.jpg 1600w"
                        width="800" 
                        height="500" 
                        loading="lazy"
                        alt="Featured image of post Unix Domain SocketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûê(OLK 6.6)" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%97%A5%E5%B8%B8%E7%A0%94%E7%A9%B6/" style="background-color: #364073; color: #fff;">
                Êó•Â∏∏Á†îÁ©∂
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/">Unix Domain SocketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûê(OLK 6.6)</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Ê∑±ÂÖ•ÂÜÖÊ†∏Ê∫êÁ†ÅÂàÜÊûêudsÈÄö‰ø°Êú∫Âà∂
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-12-15</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 33 ÂàÜÈíü
                </time>
            </div>
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
  <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
  <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
</svg>
                <time class="article-words">
                    16124Â≠ó
                </time>
        </div>
        

    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="unix-domain-socketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûêolk-66">Unix Domain SocketÊ∫êÁ†ÅÂÆûÁé∞ÂàÜÊûê(OLK 6.6)
</h2><blockquote>
<p>ÂØπ‰∫éÊ≠£Â∏∏ÁöÑudsÈÄö‰ø°ÁöÑÂàõÂª∫‰∏ÄËà¨ÂàÜ‰∏∫‰∏§‰∏™ÈÉ®ÂàÜÔºöserverÂíåclientÔºåÊàë‰ª¨ÂàÜÂà´‰ªéserverÂíåclientÊûÑÂª∫‰ª£Á†ÅÁöÑÂÖ≥ÈîÆÂáΩÊï∞Êù•ÂàÜÊûêudsÁöÑÊ∫êÁ†ÅÂÆûÁé∞</p>
</blockquote>
<p>serverÂÆûÁé∞‰ª£Á†ÅÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Server code (server.c)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/un.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOCKET_PATH &#34;unix_socket&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 100
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">server_sock</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">server_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">server_sock</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set server address structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strncpy</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Bind the socket to the address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlink</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">bind</span><span class="p">(</span><span class="n">server_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;bind error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Listen for incoming connections
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">listen</span><span class="p">(</span><span class="n">server_sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;listen error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Server is listening on %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Accept a client connection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">client_sock</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">server_sock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;accept error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Receive data from the client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="p">[</span><span class="n">bytes_received</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Received from client: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Send a response to the client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">response</span> <span class="o">=</span> <span class="s">&#34;Message received&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">response</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Clean up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlink</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>clientÂÆûÁé∞‰ª£Á†ÅÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Client code (client.c)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/un.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOCKET_PATH &#34;unix_socket&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">client_sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">server_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">client_sock</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set server address structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strncpy</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Connect to the server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">connect</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;connect error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Send data to the server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Hello, server!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Receive response from the server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="p">[</span><span class="n">bytes_received</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Received from server: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Clean up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈÄö‰ø°ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<p><img src="https://docs.acoinfo.com/assets/GnT3bM2sUoPLPoxZIk8cGgOonCf-BpH5rQYX.png"
	
	
	
	loading="lazy"
	
		alt="udsÈÄö‰ø°Êú∫Âà∂"
	
	
></p>
<p>Ê∫êÁ†ÅÂàÜÊûêÁªìÊûÑÂõæÂ¶Ç‰∏ãÔºö</p>
<p><img src="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%871.png"
	width="4389"
	height="2211"
	srcset="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%871_hu6564432392964446896.png 480w, /p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%871_hu9100531612404831662.png 1024w"
	loading="lazy"
	
		alt="Ê∫êÁ†ÅÂàÜÊûêÁªìÊûÑÂõæ1"
	
	
		class="gallery-image" 
		data-flex-grow="198"
		data-flex-basis="476px"
	
></p>
<p><img src="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%872.png"
	width="3264"
	height="2164"
	srcset="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%872_hu14611210765363944589.png 480w, /p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%872_hu7793714986617602277.png 1024w"
	loading="lazy"
	
		alt="Ê∫êÁ†ÅÂàÜÊûêÁªìÊûÑÂõæ1"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="361px"
	
></p>
<p><strong>unixÂüüÂ•óÊé•Â≠óÂú∞ÂùÄÁªìÊûÑ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//include/uapi/linux/un.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define UNIX_PATH_MAX   108
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">__kernel_sa_family_t</span> <span class="n">sun_family</span><span class="p">;</span> <span class="cm">/* AF_UNIX */</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">sun_path</span><span class="p">[</span><span class="n">UNIX_PATH_MAX</span><span class="p">];</span>   <span class="cm">/* pathname */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="socket"><strong>socket()</strong>
</h3><blockquote>
<p>‰∏ÄÂè•ËØùÊ¶ÇÊã¨socketÂáΩÊï∞ÔºöÂàõÂª∫Âπ∂ÂàùÂßãÂåñÂ•óÊé•Â≠óÔºåÂàõÂª∫Êñá‰ª∂ÊèèËø∞Á¨¶Âπ∂ÂÖ≥ËÅî„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscallÁ≥ªÁªüË∞ÉÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>socket()-&gt;__sys_socket()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//__sys_socketÈÄöËøáË∞ÉÁî®__sys_socket_createÂáΩÊï∞ËøîÂõûsockÂØπË±°ÔºåÊúÄÂêéÈÄöËøásock_map_fdÂáΩÊï∞Â∞ÜÂØπË±°ËΩ¨Âåñ‰∏∫Êñá‰ª∂ÊèèËø∞Á¨¶„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">__sys_socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sock</span> <span class="o">=</span> <span class="nf">__sys_socket_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				   <span class="nf">update_socket_protocol</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">sock</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">flags</span> <span class="o">=</span> <span class="n">type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_TYPE_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">SOCK_NONBLOCK</span> <span class="o">!=</span> <span class="n">O_NONBLOCK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">sock_map_fd</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â•óÊé•Â≠óÁöÑÂàõÂª∫Áî±__sys_socket_createÂÆåÊàêÔºåsock_map_fdÂàÜÈÖç‰∏Ä‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶ÔºåÁÑ∂Âêé‰∏∫Â•óÊé•Â≠óÂàÜÈÖçÊñá‰ª∂ÂØπË±°ÔºåÊúÄÂêéÂ∞Ü‰∏§ËÄÖÂÖ≥ËÅîËµ∑Êù•„ÄÇ</p>
<blockquote>
<p>sock_map_fd()Â∞ÜsockÁªìÊûÑÊò†Â∞Ñ‰∏∫Êñá‰ª∂ÊèèËø∞Á¨¶</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">sock_map_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Ëé∑ÂèñÂèØÁî®Êñá‰ª∂ÊèèËø∞Á¨¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">get_unused_fd_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Ë∞ÉÁî® sock_alloc_file() ‰∏∫Â•óÊé•Â≠óÂàÜÈÖç‰∏Ä‰∏™Êñá‰ª∂ÂØπË±° (struct file)„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">newfile</span> <span class="o">=</span> <span class="nf">sock_alloc_file</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Â¶ÇÊûúÂàÜÈÖçÊàêÂäüÔºåË∞ÉÁî® fd_install(fd, newfile) Â∞ÜÊñá‰ª∂ÂØπË±°‰∏éÊñá‰ª∂ÊèèËø∞Á¨¶ (fd) ÂÖ≥ËÅîËµ∑Êù•ÔºåÂπ∂ËøîÂõûËØ•Êñá‰ª∂ÊèèËø∞Á¨¶„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_map_fd()-&gt;sock_alloc_file()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">sock_alloc_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">dname</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">?</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot_creator</span><span class="o">-&gt;</span><span class="nl">name</span> <span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÂàÜÈÖç‰º™Êñá‰ª∂ (alloc_file_pseudo)Ôºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">file</span> <span class="o">=</span> <span class="nf">alloc_file_pseudo</span><span class="p">(</span><span class="nf">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">),</span> <span class="n">sock_mnt</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">O_RDWR</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">				<span class="o">&amp;</span><span class="n">socket_file_ops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Êñá‰ª∂ÂØπË±°ÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">|=</span> <span class="n">FMODE_NOWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">stream_open</span><span class="p">(</span><span class="nf">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">),</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sock_alloc_file</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_socket()-&gt;__sys_socket_create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//__sys_socket_createË∞ÉÁî®sock_createÂàõÂª∫socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="nf">__sys_socket_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Check the SOCK_* constants for consistency.  */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">!=</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">((</span><span class="n">SOCK_MAX</span> <span class="o">|</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">&amp;</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SOCK_NONBLOCK</span> <span class="o">&amp;</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_TYPE_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">|</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">type</span> <span class="o">&amp;=</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">retval</span> <span class="o">=</span> <span class="nf">sock_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_socket_create()-&gt;sock_create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//sock_createË∞ÉÁî®__sock_create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	sock_create - creates a socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@family: protocol family (AF_INET, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@type: communication type (SOCK_STREAM, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@protocol: protocol (0, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@res: new socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	A wrapper around __sock_create().
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	Returns 0 or an error. This function internally uses GFP_KERNEL.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sock_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sock_create</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//EXPORT_SYMBOL() ÊòØ‰∏Ä‰∏™ÂÜÖÊ†∏ÂÆèÔºåÁî®‰∫éÂ∞ÜÁ¨¶Âè∑ÔºàÂáΩÊï∞ÊàñÂèòÈáèÔºâÂØºÂá∫Âà∞ÂÜÖÊ†∏ÁöÑÁ¨¶Âè∑Ë°®‰∏≠Ôºå‰ª•‰æøËØ•ÂáΩÊï∞ÂèØ‰ª•Ë¢´ÂÖ∂‰ªñÂÜÖÊ†∏Ê®°Âùó‰ΩøÁî®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sock_create</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sock_create-&gt;unix_create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	__sock_create - creates a socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@net: net namespace
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@family: protocol family (AF_INET, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@type: communication type (SOCK_STREAM, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@protocol: protocol (0, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@res: new socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@kern: boolean for kernel space sockets
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	Creates a new socket and assigns it to @res, passing through LSM.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	Returns 0 or an error. On failure @res is set to %NULL. @kern must
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	be set to true if the socket resides in kernel space.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	This function internally uses GFP_KERNEL.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sock_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="o">*</span><span class="n">pf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Check if creating a new socket is allowed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *	Allocate the socket and allow the family to set things up. if
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *	the protocol is 0, the family is instructed to select an appropriate
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *	default.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sock_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">net_warn_ratelimited</span><span class="p">(</span><span class="s">&#34;socket: no more sockets</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ENFILE</span><span class="p">;</span>	<span class="cm">/* Not exactly a match, but its the
</span></span></span><span class="line"><span class="cl"><span class="cm">				   closest posix thing */</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="n">pf</span> <span class="o">=</span> <span class="nf">rcu_dereference</span><span class="p">(</span><span class="n">net_families</span><span class="p">[</span><span class="n">family</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * We will call the -&gt;create function, that possibly is in a loadable
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * module, so we have to bump that loadable module refcnt first.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__sock_create</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>sock_create()</code> ÂáΩÊï∞È¶ñÂÖàË∞ÉÁî®<code>security_socket_create</code> Ê£ÄÊü•ÊòØÂê¶ÊúâÊùÉÈôêÂàõÂª∫Êñ∞ÁöÑsocketÊñá‰ª∂ÔºåÊé•ÁùÄË∞ÉÁî®<code>sock_alloc()</code> Áî≥ËØ∑‰∏Ä‰∏™ <code>struct socket</code> ÁªìÊûÑÔºåÁÑ∂ÂêéË∞ÉÁî®ÊåáÂÆöÂçèËÆÆÊóèÁöÑ <code>create()</code> ÂáΩÊï∞Ôºà<code>net_families[family]-&gt;create()</code>ÔºâËøõË°åËøõ‰∏ÄÊ≠•ÁöÑÂàõÂª∫ÂäüËÉΩ„ÄÇ<code>net_families</code> ÂèòÈáèÁöÑÁ±ªÂûã‰∏∫ <code>struct net_proto_family</code>ÔºåÂÖ∂ÂÆö‰πâÂ¶Ç‰∏ãÔºö</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">net_proto_family</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">create</span><span class="p">)(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>family</code> Â≠óÊÆµÂØπÂ∫îÁöÑÂ∞±ÊòØÂÖ∑‰ΩìÁöÑÂçèËÆÆÊóèÔºåËÄå <code>create</code> Â≠óÊÆµÊåáÂÆö‰∫ÜÂÖ∂ÂàõÂª∫socketÁöÑÊñπÊ≥ï„ÄÇ‰∏Ä‰∏™ÂÖ∑‰ΩìÂçèËÆÆÊóèÈúÄË¶ÅÈÄöËøáË∞ÉÁî® <code>sock_register()</code> ÂáΩÊï∞ÂêëÁ≥ªÁªüÊ≥®ÂÜåÂÖ∂ÂàõÂª∫socketÁöÑÊñπÊ≥ï„ÄÇ‰æãÂ¶Ç <code>Unix socket</code> Â∞±Âú®ÂàùÂßãÂåñÊó∂ÈÄöËøá‰∏ãÈù¢ÁöÑ‰ª£Á†ÅÊ≥®ÂÜåÔºö</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">unix_family_ops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">PF_UNIX</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">unix_create</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">af_unix_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unix_family_ops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÊâÄ‰ª•‰ªé‰∏äÈù¢ÁöÑ‰ª£Á†ÅÂèØ‰ª•ÊåáÂÆöÔºåÂØπ‰∫é <code>Unix socket</code> ÁöÑËØùÔºå<code>net_families[family]-&gt;create()</code> ËøôË°å‰ª£Á†ÅÂÆûÈôÖË∞ÉÁî®ÁöÑÊòØ <code>unix_create()</code> ÂáΩÊï∞„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//unix_createÂàùÂßãÂåñÂ•óÊé•Â≠óÂπ∂Ê†πÊçÆÁ±ªÂûãË∞ÉÁî®ÂêàÈÄÇÁöÑÂ§ÑÁêÜÂáΩÊï∞ÔºåÂêåÊó∂Ë∞ÉÁî®unix_create1ÂáΩÊï∞ÂàõÂª∫socket„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Â∞ÜÂ•óÊé•Â≠óÁä∂ÊÄÅËÆæÁΩÆ‰∏∫Êú™ËøûÊé•„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//Ê†πÊçÆÂ•óÊé•Â≠óÁ±ªÂûãËÆæÁΩÆÊìç‰ΩúÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_STREAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unix_stream_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *	Believe it or not BSD has AF_UNIX, SOCK_RAW though
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *	nothing uses it.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_RAW</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SOCK_DGRAM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">fallthrough</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_DGRAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unix_dgram_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_SEQPACKET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unix_seqpacket_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_create1</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_create()-&gt;unix_create1()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//ÂàÜÈÖçËµÑÊ∫êÂíåÂàùÂßãÂåñÂêÑÁßçÂÜÖÈÉ®Êï∞ÊçÆÁªìÊûÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">unix_create1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Ê†πÊçÆÂ•óÊé•Â≠óÁ±ªÂûã (SOCK_STREAM, SOCK_DGRAM Êàñ SOCK_SEQPACKET)ÔºåË∞ÉÁî® sk_alloc() ÂàÜÈÖç‰∏Ä‰∏™Êñ∞ÁöÑ sock ÂØπË±°„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unix_stream_proto</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="cm">/*dgram and  seqpacket */</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unix_dgram_proto</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Â∞ÜÂ•óÊé•Â≠ó sock ‰∏ésockÂØπË±° sk Áõ∏ÂÖ≥ËÅîÔºåÂàùÂßãÂåñÊï∞ÊçÆÁªìÊûÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÂàùÂßãÂåñ sk ÁªìÊûÑÁöÑÊàêÂëò
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span>		<span class="o">=</span> <span class="nf">unix_unbound_hash</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span>	<span class="o">=</span> <span class="n">GFP_KERNEL_ACCOUNT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span>	<span class="o">=</span> <span class="n">unix_write_space</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span>	<span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">unx</span><span class="p">.</span><span class="n">sysctl_max_dgram_qlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_destruct</span>		<span class="o">=</span> <span class="n">unix_sock_destructor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u</span>	  <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>struct socket</code> ÊòØ Linux ÁΩëÁªúÊ†à‰∏≠Ë°®Á§∫‰∏Ä‰∏™Â•óÊé•Â≠óÁöÑÊ†∏ÂøÉÁªìÊûÑÔºåÈÄöÂ∏∏Áî®‰∫é‰∏éÁî®Êà∑Á©∫Èó¥Â∫îÁî®Á®ãÂ∫èËøõË°å‰∫§‰∫í„ÄÇ<code>sock</code> ÊòØÁî®Êà∑Á©∫Èó¥Á®ãÂ∫è‰∏éÂÜÖÊ†∏‰∏≠ÁöÑÁΩëÁªúÊ†àÈÄö‰ø°ÁöÑÊé•Âè£Ôºå‰ª£Ë°®‰∫Ü‰∏Ä‰∏™ÁΩëÁªúÁ´ØÁÇπÔºåÁî®‰∫éÂª∫Á´ãËøûÊé•„ÄÅÂèëÈÄÅ/Êé•Êî∂Êï∞ÊçÆÁ≠âÊìç‰Ωú</p>
<p><code>unix_sock</code> ÊòØ‰∏Ä‰∏™Âú® Linux ÂÜÖÊ†∏‰∏≠‰∏é Unix ÂüüÂ•óÊé•Â≠óÁõ∏ÂÖ≥ÁöÑÁßÅÊúâÊï∞ÊçÆÁªìÊûÑ„ÄÇÂÆÉÊâ©Â±ï‰∫Ü <code>struct sock</code>ÔºåÁî®‰∫éÂ≠òÂÇ®‰∏é Unix ÂüüÂ•óÊé•Â≠óÁõ∏ÂÖ≥ÁöÑÁâπÂÆöÊï∞ÊçÆ„ÄÇ</p>
<h3 id="bind">bind()
</h3><blockquote>
<p>‰∏ÄÂè•ËØùÊ¶ÇÊã¨bindÂáΩÊï∞ÔºöÂ∞ÜudsÂú∞ÂùÄÁªëÂÆöÂà∞Â•óÊé•Â≠ó</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscallÁ≥ªÁªüË∞ÉÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">umyaddr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">umyaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>bind()-&gt;__sys_bind()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">umyaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Êü•ÊâæÂ•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sockfd_lookup_light</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Â∞ÜÁî®Êà∑Á©∫Èó¥Âú∞ÂùÄÁßªÂä®Âà∞ÂÜÖÊ†∏Á©∫Èó¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">err</span> <span class="o">=</span> <span class="nf">move_addr_to_kernel</span><span class="p">(</span><span class="n">umyaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//ÂÆâÂÖ®Ê£ÄÊü•(ÊùÉÈôê)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						   <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						   <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//ÊâßË°åÂÖ∑‰ΩìÂçèËÆÆÂÆûÁé∞ÁöÑbindÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">err</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						      <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						      <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fput_light</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_bind()-&gt;unix_bind()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span> <span class="c1">// Â∞ÜÈÄöÁî®Âú∞ÂùÄÁªìÊûÑËΩ¨Êç¢‰∏∫UNIX‰∏ìÁî®ÁöÑÂú∞ÂùÄÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span> <span class="c1">// Ëé∑ÂèñÂ•óÊé•Â≠óÁöÑÂü∫Á°ÄÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kt">int</span> <span class="n">err</span><span class="p">;</span> <span class="c1">// Áî®‰∫éÂ≠òÂÇ®ÈîôËØØÁ†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"> <span class="c1">// ÂΩì sun_path ‰∏∫Á©∫Êó∂Ôºåunix_autobind() ‰ºö‰∏∫Â•óÊé•Â≠óËá™Âä®ÁîüÊàê‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑ„ÄÅ‰∏¥Êó∂ÁöÑÂú∞ÂùÄÔºåÈÄöÂ∏∏Âú®ÂÜÖÊ†∏‰∏≠ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂Êñá‰ª∂Êù•Ë°®Á§∫ËØ•Â•óÊé•Â≠óÁöÑÂú∞ÂùÄ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">==</span> <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">,</span> <span class="n">sun_path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">     <span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_family</span> <span class="o">==</span> <span class="n">AF_UNIX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nf">unix_autobind</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// È™åËØÅÂú∞ÂùÄÊòØÂê¶ÂêàÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_validate_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// Ê†πÊçÆsun_pathÁöÑÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶ÂÜ≥ÂÆöË∞ÉÁî®Âì™‰∏™ÁªëÂÆöÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">     <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_bind_bsd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span> <span class="c1">// Ë∞ÉÁî®BSDÈ£éÊ†ºÂú∞ÂùÄÁªëÂÆöÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">else</span>
</span></span><span class="line"><span class="cl">     <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_bind_abstract</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span> <span class="c1">// Ë∞ÉÁî®ÊäΩË±°Âú∞ÂùÄÁªëÂÆöÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ËøôÈáåÊ∂âÂèäÂà∞‰∫Ü‰∏âÁßç‰∏çÂêåÁöÑbindÂáΩÊï∞Ë∞ÉÁî®ÔºåËá™Âä®ÁªëÂÆö(<code>unix_autobind</code>)„ÄÅBSD È£éÊ†º (<code>unix_bind_bsd()</code>) ÂíåÊäΩË±°È£éÊ†º (<code>unix_bind_abstract()</code>)</p>
</blockquote>
<ol>
<li><strong>BSD È£éÊ†ºÁªëÂÆö</strong> (<code>unix_bind_bsd()</code>)
<ul>
<li><strong>Ë∑ØÂæÑÂú∞ÂùÄÁªëÂÆö</strong>ÔºöBSD È£éÊ†ºÁöÑ UNIX domain socket ‰ΩøÁî®Êñá‰ª∂Á≥ªÁªü‰∏≠ÁöÑË∑ØÂæÑ‰Ωú‰∏∫Âú∞ÂùÄ„ÄÇ‰æãÂ¶ÇÔºö<code>/tmp/mysocket</code>ÔºåÂç≥ <code>sun_path</code> ÁöÑÁ¨¨‰∏Ä‰∏™Â≠óÁ¨¶ÊòØ <code>/</code>ÔºåË°®Á§∫ÂÆÉÊòØ‰∏Ä‰∏™Ê†áÂáÜÁöÑË∑ØÂæÑ„ÄÇ</li>
<li><strong>Êñá‰ª∂Á≥ªÁªü‰æùËµñ</strong>ÔºöBSD È£éÊ†ºÁöÑÂú∞ÂùÄÂÆûÈôÖ‰∏äÊòØÊñá‰ª∂Á≥ªÁªü‰∏≠ÁöÑ‰∏Ä‰∏™Ë∑ØÂæÑÔºåÂõ†Ê≠§ÂÆÉÈúÄË¶ÅÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫‰∏Ä‰∏™ÂØπÂ∫îÁöÑÊñá‰ª∂ËäÇÁÇπÔºåËøôÊ†∑ÂÖ∂‰ªñËøõÁ®ãÂ∞±ÂèØ‰ª•ÈÄöËøáËÆøÈóÆËøô‰∏™Êñá‰ª∂ËäÇÁÇπÊù•‰∏éËØ•Â•óÊé•Â≠óÈÄö‰ø°„ÄÇ</li>
<li><strong>ÊåÅ‰πÖÊÄß</strong>ÔºöÁî±‰∫éÊòØÂü∫‰∫éÊñá‰ª∂Á≥ªÁªüÁöÑË∑ØÂæÑÔºåBSD È£éÊ†ºÁöÑ UNIX socket Âú∞ÂùÄÂú®Á®ãÂ∫èÈÄÄÂá∫ÂêéÊñá‰ª∂‰ªçÁÑ∂Â≠òÂú®ÔºåÂõ†Ê≠§ÈúÄË¶ÅÊòæÂºèÂú∞Âà†Èô§Ë∑ØÂæÑÔºàÂç≥‰ΩøÁî® <code>unlink()</code>ÔºâÔºåÂê¶Âàô‰∏ãÊ¨°ÁªëÂÆöÂêåÊ†∑ÁöÑË∑ØÂæÑÂèØËÉΩ‰ºöÂ§±Ë¥•„ÄÇ</li>
</ul>
</li>
<li><strong>ÊäΩË±°È£éÊ†ºÁªëÂÆö</strong> (<code>unix_bind_abstract()</code>)
<ul>
<li><strong>‰∏ç‰æùËµñ‰∫éÊñá‰ª∂Á≥ªÁªü</strong>ÔºöÊäΩË±°È£éÊ†ºÁöÑ UNIX domain socket Âú∞ÂùÄ‰∏çÊòØÂü∫‰∫éÊñá‰ª∂Á≥ªÁªüÁöÑË∑ØÂæÑÔºåËÄåÊòØÁî±‰∏Ä‰∏™‰ª• <code>NUL</code>ÔºàÁ©∫Â≠óÁ¨¶Ôºå<code>'\0'</code>ÔºâÂºÄÂ§¥ÁöÑÂ≠óÁ¨¶‰∏≤‰Ωú‰∏∫Âú∞ÂùÄ„ÄÇÂõ†‰∏∫Ëøô‰∏™Âú∞ÂùÄ‰∏çÊòØÊñá‰ª∂Ë∑ØÂæÑÔºåÊâÄ‰ª•ÂÆÉ‰∏ç‰æùËµñÊñá‰ª∂Á≥ªÁªüÔºåÈÄÇÂêàÂú®Êüê‰∫õÊÉÖÂÜµ‰∏ãÈÅøÂÖçÊñá‰ª∂Á≥ªÁªüÁöÑÂ§çÊùÇÊÄßÊàñÂºÄÈîÄ„ÄÇ</li>
<li><strong>‰ªÖÂú®ÂÜÖÊ†∏‰∏≠Â≠òÂú®</strong>ÔºöÊäΩË±°Âú∞ÂùÄÁöÑ‰ΩúÁî®Âüü‰ªÖÈôê‰∫éÂÜÖÊ†∏ÂÜÖÈÉ®ÔºåÂÆÉ‰∏çÈúÄË¶ÅÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫ËäÇÁÇπÔºåÂõ†Ê≠§ÂÆåÂÖ®Áî±ÂÜÖÊ†∏ÁÆ°ÁêÜ„ÄÇËøôÊ†∑ÂèØ‰ª•ÂáèÂ∞ëÂØπÁ£ÅÁõòÁöÑ‰æùËµñÔºåÂêåÊó∂Âú®Êüê‰∫õÁ≥ªÁªüÔºàÂ¶ÇÊ≤°ÊúâÊåÅ‰πÖÂ≠òÂÇ®ÁöÑÂµåÂÖ•ÂºèÁ≥ªÁªüÔºâ‰∏≠‰πüÂæàÊúâÁî®„ÄÇ</li>
<li><strong>‰∏¥Êó∂ÊÄß</strong>ÔºöÊäΩË±°Âú∞ÂùÄÁöÑÁîüÂëΩÂë®Êúü‰∏éÁªëÂÆöËØ•Âú∞ÂùÄÁöÑËøõÁ®ãÁöÑÁîüÂëΩÂë®ÊúüÁõ∏ÂêåÔºåÂΩìËøõÁ®ãÁªìÊùüÊó∂ÔºåÊäΩË±°Âú∞ÂùÄ‰πüÈöè‰πãÈáäÊîæ„ÄÇÂÆÉ‰∏çÈúÄË¶ÅÂÉè BSD È£éÊ†ºÈÇ£Ê†∑ÊâãÂä®Âà†Èô§Ë∑ØÂæÑ„ÄÇ</li>
</ul>
</li>
</ol>
<p><strong>BSD È£éÊ†ºÊèê‰æõ‰∫Ü‰∏ÄÁßçÂü∫‰∫éÊñá‰ª∂Á≥ªÁªüÁöÑÂú∞ÂùÄÁªëÂÆöÊñπÂºèÔºåÂÖ∑ÊúâÊåÅ‰πÖÊÄßÂíåÊñá‰ª∂ÊùÉÈôêÁÆ°ÁêÜÁöÑ‰ºòÁÇπÔºåÈÄÇÂêàÈúÄË¶ÅÈïøÊúüÈÄö‰ø°ÂíåÊñá‰ª∂ÊùÉÈôêÊéßÂà∂ÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ</strong></p>
<p><strong>ÊäΩË±°È£éÊ†ºÂàôÊèê‰æõ‰∫Ü‰∏ÄÁßçÂÜÖÊ†∏ÁÆ°ÁêÜÁöÑËΩªÈáèÂåñÂú∞ÂùÄÁªëÂÆöÊñπÂºèÔºåÈÅøÂÖç‰∫ÜÊñá‰ª∂Á≥ªÁªüÁöÑ‰æùËµñÔºåÊõ¥ÈÄÇÂêà‰∏¥Êó∂ÊÄßÈÄö‰ø°ÔºåÂáèÂ∞ë‰∫ÜËµÑÊ∫êÂç†Áî®ÂíåÁÆ°ÁêÜÂºÄÈîÄ„ÄÇ</strong></p>
<blockquote>
<p>Á¨¨‰∏ÄÁßç:unix_bind()-&gt;unix_autobind()</p>
<p><code>unix_autobind()</code> ÊòØ‰∏Ä‰∏™Áî®‰∫éËá™Âä®‰∏∫Â•óÊé•Â≠óÂàÜÈÖçÂú∞ÂùÄÁöÑÂáΩÊï∞ÔºåÈÄÇÁî®‰∫é UNIX domain socket Ê≤°ÊúâÊèê‰æõÂÖ∑‰ΩìÁªëÂÆöÂú∞ÂùÄÁöÑÊÉÖÂÜµ„ÄÇÂΩìÁî®Êà∑Ë∞ÉÁî® <code>bind()</code> ‰ΩÜÊòØÊ≤°ÊúâÊåáÂÆöÂú∞ÂùÄÊó∂Ôºå<code>unix_autobind()</code> ‰ºöË¢´Ë∞ÉÁî®ÔºåÂÆÉ‰ºö‰∏∫Â•óÊé•Â≠óÁîüÊàê‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑ„ÄÅ‰∏¥Êó∂ÁöÑÊäΩË±°Âú∞ÂùÄ„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_autobind</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_hash</span><span class="p">,</span> <span class="n">old_hash</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">lastnum</span><span class="p">,</span> <span class="n">ordernum</span><span class="p">;</span> <span class="c1">//ordernum Âíå lastnumÔºöÁî®‰∫éÁîüÊàêÂîØ‰∏ÄÁöÑÊäΩË±°Âú∞ÂùÄ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="nf">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ‰ΩøÁî® kzalloc() ‰∏∫ unix_address ÁªìÊûÑÂàÜÈÖçÂÜÖÂ≠òÔºåÂåÖÂê´‰∫ÜÂú∞ÂùÄÁªìÊûÑÂíå sun_path ÁöÑÂ≠òÂÇ®Á©∫Èó¥„ÄÇÂ¶ÇÊûúÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû -ENOMEM„ÄÇ‰ΩøÁî® kzalloc() ‰∏∫ unix_address ÁªìÊûÑÂàÜÈÖçÂÜÖÂ≠òÔºåÂåÖÂê´‰∫ÜÂú∞ÂùÄÁªìÊûÑÂíå sun_path ÁöÑÂ≠òÂÇ®Á©∫Èó¥„ÄÇÂ¶ÇÊûúÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû -ENOMEM„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		       <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">,</span> <span class="n">sun_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">,</span> <span class="n">sun_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">refcount_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ‰ΩøÁî® get_random_u32() Ëé∑Âèñ‰∏Ä‰∏™ÈöèÊú∫Êï∞ÔºåÁî®‰∫éÁîüÊàêÂîØ‰∏ÄÁöÑÊäΩË±°Âú∞ÂùÄ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ordernum</span> <span class="o">=</span> <span class="nf">get_random_u32</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// lastnum ‰øùÂ≠ò‰∫ÜÈöèÊú∫Êï∞ÁöÑ‰Ωé 20 ‰ΩçÔºåÁî®‰∫éÈôêÂà∂Âæ™ÁéØÊ¨°Êï∞ÔºåÁ°Æ‰øù‰∏ç‰ºöÊó†ÈôêÂæ™ÁéØ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">lastnum</span> <span class="o">=</span> <span class="n">ordernum</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>  <span class="c1">// ÁîüÊàêÂíåÊ£ÄÊü•Âú∞ÂùÄÂîØ‰∏ÄÊÄß (retry)Ôºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ordernum</span> <span class="o">=</span> <span class="p">(</span><span class="n">ordernum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">sprintf</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">sun_path</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;%05x&#34;</span><span class="p">,</span> <span class="n">ordernum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">new_hash</span> <span class="o">=</span> <span class="nf">unix_abstract_hash</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">unix_table_double_lock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•Âú∞ÂùÄÊòØÂê¶Â∑≤Â≠òÂú®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="nf">__unix_find_socket_byname</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">unix_table_double_unlock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* __unix_find_socket_byname() may take long time if many names
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * are already in use.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//Â¶ÇÊûúÂú∞ÂùÄÂ∑≤Â≠òÂú®ÔºåËß£ÈîÅÂìàÂ∏åË°®ÔºåÂπ∂Ë∞ÉÁî® cond_resched() ËÆ©Âá∫ CPU ËµÑÊ∫êÔºåÁÑ∂ÂêéÁªßÁª≠ÁîüÊàêÊñ∞ÁöÑÂú∞ÂùÄÔºàË∑≥ËΩ¨Âà∞ retry Ê†áÁ≠æÔºâ„ÄÇÂ¶ÇÊûúÊâÄÊúâÂú∞ÂùÄÈÉΩÂ∑≤Áî®Â∞ΩÔºåËøîÂõû -ENOSPCÔºåË°®Á§∫Ê≤°ÊúâÁ©∫Èó¥ÂèØÁî®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">cond_resched</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ordernum</span> <span class="o">==</span> <span class="n">lastnum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* Give up if all names seems to be in use. */</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_release_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// __unix_set_addr_hash() Â∞ÜÁîüÊàêÁöÑÂú∞ÂùÄËÆæÁΩÆÂà∞Â•óÊé•Â≠ó‰∏≠ÔºåÂπ∂Êõ¥Êñ∞ÂìàÂ∏åË°®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">__unix_set_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">unix_table_double_unlock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>	<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Á¨¨‰∫åÁßçÔºöunix_bind()-&gt;unix_bind_abstract()</p>
<p><code>unix_bind_abstract()</code> ÊòØ‰∏Ä‰∏™Áî®‰∫éÂ∞Ü UNIX domain socket Âú∞ÂùÄÁªëÂÆöÂà∞Â•óÊé•Â≠óÁöÑÂÜÖÊ†∏ÂáΩÊï∞Ôºå‰∏ìÈó®Áî®‰∫éÊäΩË±°È£éÊ†ºÂú∞ÂùÄÔºàÂç≥‰∏ç‰æùËµñ‰∫éÊñá‰ª∂Á≥ªÁªüÁöÑÂú∞ÂùÄÔºâ„ÄÇËøô‰∏™ÂáΩÊï∞Ë¥üË¥£Á°Æ‰øùÂ•óÊé•Â≠óË¢´ÁªëÂÆöÂà∞‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑÊäΩË±°Âú∞ÂùÄÔºåÂπ∂ÂØπÂú∞ÂùÄËøõË°åÂìàÂ∏åÂíåÊ≥®ÂÜåÂ§ÑÁêÜ„ÄÇ‰ª•‰∏ãÊòØÂØπËØ•ÂáΩÊï∞ÁöÑËØ¶ÁªÜÂàÜÊûê„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_bind_abstract</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			      <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_hash</span><span class="p">,</span> <span class="n">old_hash</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ÂàõÂª∫UNIXÂú∞ÂùÄ,‰∏∫ÊäΩË±°Âú∞ÂùÄÂàÜÈÖçÂÜÖÂ≠òÔºåÂπ∂Â∞ÜÁî®Êà∑Êèê‰æõÁöÑÂú∞ÂùÄÊï∞ÊçÆÔºàsunaddrÔºâËΩ¨Êç¢‰∏∫ÂÜÖÊ†∏‰ΩøÁî®ÁöÑÂú∞ÂùÄÁªìÊûÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr</span> <span class="o">=</span> <span class="nf">unix_create_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//‰ΩøÁî® unix_abstract_hash() ËÆ°ÁÆóÊñ∞Âú∞ÂùÄÁöÑÂìàÂ∏åÂÄºÔºåÁî®‰∫éÂ∞ÜÊäΩË±°Âú∞ÂùÄÊîæÂÖ•ÂÜÖÊ†∏‰∏≠ÁöÑÂìàÂ∏åË°®ËøõË°åÁÆ°ÁêÜ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">new_hash</span> <span class="o">=</span> <span class="nf">unix_abstract_hash</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//__unix_set_addr_hash() ËÆæÁΩÆÊñ∞ÁöÑÁªëÂÆöÂú∞ÂùÄÔºåÂπ∂Â∞ÜÂÖ∂ÊèíÂÖ•ÂìàÂ∏åË°®‰∏≠Ôºå‰ª•‰æøÂêéÁª≠ÂèØ‰ª•ÈÄöËøáÂú∞ÂùÄÂø´ÈÄüÊâæÂà∞ÂØπÂ∫îÁöÑÂ•óÊé•Â≠ó„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">__unix_set_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Á¨¨‰∏âÁßçÔºöunix_bind()-&gt;unix_bind_bsd()</p>
<p><code>unix_bind_bsd()</code> ÊòØÂÜÖÊ†∏‰∏≠Áî®‰∫éÂ∞Ü BSD È£éÊ†ºÁöÑ UNIX domain socket Âú∞ÂùÄÁªëÂÆöÂà∞Â•óÊé•Â≠óÁöÑÂáΩÊï∞„ÄÇÂÆÉÂÆûÁé∞‰∫ÜÂ∞ÜÂ•óÊé•Â≠óÂú∞ÂùÄÁªëÂÆöÂà∞Êñá‰ª∂Á≥ªÁªüË∑ØÂæÑÁöÑÈÄªËæëÔºåÂπ∂Á°Æ‰øùÂú∞ÂùÄÂîØ‰∏ÄÊÄßÂíåÁõ∏Â∫îÁöÑÊñá‰ª∂Á≥ªÁªüÊìç‰Ωú„ÄÇ‰ª•‰∏ãÊòØÂØπËøô‰∏™ÂáΩÊï∞ÁöÑËØ¶ÁªÜÂàÜÊûê„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_bind_bsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">umode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFSOCK</span> <span class="o">|</span>  <span class="c1">// ËÆæÁΩÆÊñá‰ª∂Ê®°Âºè‰∏∫Â•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	       <span class="p">(</span><span class="nf">SOCK_INODE</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="nf">current_umask</span><span class="p">());</span>  <span class="c1">// Ê†πÊçÆÂ•óÊé•Â≠óÁöÑÊ®°ÂºèÂíåÂΩìÂâçÊé©Á†ÅËÆ°ÁÆóÊñá‰ª∂Ê®°Âºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_hash</span><span class="p">,</span> <span class="n">old_hash</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="p">;</span>  <span class="c1">// Êñ∞ÊóßÂìàÂ∏åÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// Ëé∑ÂèñUNIXÂ•óÊé•Â≠óÁªìÊûÑ‰Ωì
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// Ëé∑ÂèñÂ•óÊé•Â≠óÂÖ≥ËÅîÁöÑÁΩëÁªúÂëΩÂêçÁ©∫Èó¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">mnt_idmap</span> <span class="o">*</span><span class="n">idmap</span><span class="p">;</span>  <span class="c1">// IDÊò†Â∞Ñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">unix_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>  <span class="c1">// UNIXÂú∞ÂùÄÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>  <span class="c1">// ÁõÆÂΩïÈ°π
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">path</span> <span class="n">parent</span><span class="p">;</span>  <span class="c1">// Áà∂ÁõÆÂΩïË∑ØÂæÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>  <span class="c1">// ÈîôËØØÁ†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ÂØπ‰º†ÂÖ•ÁöÑÂú∞ÂùÄËøõË°åÂ§ÑÁêÜÔºåÁ°Æ‰øùÂÖ∂Ê†ºÂºèÊ≠£Á°ÆÔºåÂπ∂ËÆ°ÁÆóÊâÄÈúÄÁöÑÂú∞ÂùÄÈïøÂ∫¶„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr_len</span> <span class="o">=</span> <span class="nf">unix_mkname_bsd</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// unix_create_addr()Ôºö‰∏∫Â•óÊé•Â≠óÂú∞ÂùÄÂàÜÈÖçÂÜÖÂ≠òÔºåÂ∞Ü‰º†ÂÖ•ÁöÑÂú∞ÂùÄÊï∞ÊçÆÂ≠òÂÇ®Âú®Êñ∞ÂàõÂª∫ÁöÑ unix_address ÁªìÊûÑ‰∏≠„ÄÇÂ¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåËøîÂõû -ENOMEM„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr</span> <span class="o">=</span> <span class="nf">unix_create_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>  <span class="c1">// ÂÜÖÂ≠òÂàÜÈÖçÂ§±Ë¥•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// kern_path_create()ÔºöÊü•ÊâæÊàñÂàõÂª∫ÂØπÂ∫îË∑ØÂæÑÁöÑÁõÆÂΩïÈ°π (dentry)ÔºåËé∑ÂèñÂú∞ÂùÄÊâÄÂú®Ë∑ØÂæÑÁöÑÁà∂ÁõÆÂΩï (parent)„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">dentry</span> <span class="o">=</span> <span class="nf">kern_path_create</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// Â§ÑÁêÜÈîôËØØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Âú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫Â•óÊé•Â≠óËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">idmap</span> <span class="o">=</span> <span class="nf">mnt_idmap</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">mnt</span><span class="p">);</span>  <span class="c1">// Ëé∑ÂèñIDÊò†Â∞Ñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">security_path_mknod</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// È¶ñÂÖàËøõË°åÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùÂΩìÂâçËøõÁ®ãÊúâÊùÉÈôêÂú®ÊåáÂÆöË∑ØÂæÑÂàõÂª∫ËäÇÁÇπ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">vfs_mknod</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="nf">d_inode</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">dentry</span><span class="p">),</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// Âú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫ËäÇÁÇπÔºåÁî®‰∫éË°®Á§∫ËØ• UNIX domain socket„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>  <span class="c1">// ÈîÅÂÆö‰∫íÊñ•Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">new_hash</span> <span class="o">=</span> <span class="nf">unix_bsd_hash</span><span class="p">(</span><span class="nf">d_backing_inode</span><span class="p">(</span><span class="n">dentry</span><span class="p">));</span>  <span class="c1">// ÂàõÂª∫ÂìàÂ∏åÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_table_double_lock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>  <span class="c1">// ÈîÅÂÆöÂèåÂêëÂìàÂ∏åË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span> <span class="o">=</span> <span class="nf">mntget</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">mnt</span><span class="p">);</span>  <span class="c1">// ËÆæÁΩÆË∑ØÂæÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="nf">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>  <span class="c1">// ËÆæÁΩÆÁõÆÂΩïÈ°π
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">__unix_set_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>  <span class="c1">// ËÆæÁΩÆÂú∞ÂùÄÂìàÂ∏å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_table_double_unlock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>  <span class="c1">// Ëß£ÈîÅÂèåÂêëÂìàÂ∏åË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_insert_bsd_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// unix_insert_bsd_socket()ÔºöÂ∞ÜËØ•Â•óÊé•Â≠óÊèíÂÖ•Âà∞ BSD È£éÊ†ºÂ•óÊé•Â≠óÁöÑÁÆ°ÁêÜÁªìÊûÑ‰∏≠„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>  <span class="c1">// Ëß£ÈîÅ‰∫íÊñ•Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">done_path_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>vfs_mknod()</p>
<p><code>vfs_mknod()</code> ÊòØÂÜÖÊ†∏‰∏≠ÁöÑ‰∏Ä‰∏™ÂáΩÊï∞ÔºåÁî®‰∫éÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫ËÆæÂ§áËäÇÁÇπÊàñÊôÆÈÄöÊñá‰ª∂„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">vfs_mknod</span><span class="p">(</span><span class="k">struct</span> <span class="n">mnt_idmap</span> <span class="o">*</span><span class="n">idmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">dev_t</span> <span class="n">dev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// is_whiteoutÔºöÊ£ÄÊü•ÂàõÂª∫ÁöÑËäÇÁÇπÊòØÂê¶‰∏∫‚Äúwhiteout‚ÄùËÆæÂ§áËäÇÁÇπÔºàÁâπÂÆöÂú∫ÊôØ‰∏ãË°®Á§∫Ë¶ÜÁõñÁöÑÂ≠óÁ¨¶ËÆæÂ§áËäÇÁÇπÔºâ„ÄÇËøôÊòØ‰∏Ä‰∏™ÁâπÊÆäÁ±ªÂûãÔºåÁî®‰∫éÊüê‰∫õÊñá‰ª∂Á≥ªÁªüÊìç‰ΩúÔºåÊØîÂ¶ÇÂú® overlay Êñá‰ª∂Á≥ªÁªü‰∏≠„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">is_whiteout</span> <span class="o">=</span> <span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span> <span class="o">==</span> <span class="n">WHITEOUT_DEV</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// may_create()ÔºöÊ£ÄÊü•ÊòØÂê¶ÊúâÊùÉÈôêÂú®Áà∂ÁõÆÂΩï‰∏≠ÂàõÂª∫Êñ∞Êñá‰ª∂ÊàñËÆæÂ§áËäÇÁÇπ„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÊùÉÈôêÔºåÂàôÁõ¥Êé•ËøîÂõûÈîôËØØ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="nf">may_create</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//S_ISCHR(mode) Âíå S_ISBLK(mode)ÔºöÂà§Êñ≠ÊâÄË¶ÅÂàõÂª∫ÁöÑËäÇÁÇπÊòØÂê¶‰∏∫Â≠óÁ¨¶ËÆæÂ§áÊàñÂùóËÆæÂ§á„ÄÇÂ¶ÇÊûúÊòØÂ≠óÁ¨¶ËÆæÂ§áÊàñÂùóËÆæÂ§áËäÇÁÇπÔºå‰∏î‰∏çÊòØ &#34;whiteout&#34;ÔºåÂàôÈúÄË¶ÅË∞ÉÁî® capable(CAP_MKNOD) Êù•Ê£ÄÊü•ÊòØÂê¶ÂÖ∑ÊúâÂàõÂª∫ËÆæÂ§áËäÇÁÇπÁöÑÊùÉÈôêÔºàÈÄöÂ∏∏ÊòØË∂ÖÁ∫ßÁî®Êà∑ÊùÉÈôêÔºâ„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÊùÉÈôêÔºåËøîÂõû -EPERMÔºàÊìç‰Ωú‰∏çÂÖÅËÆ∏Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="nf">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_whiteout</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="nf">capable</span><span class="p">(</span><span class="n">CAP_MKNOD</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•Áà∂ÁõÆÂΩïÁöÑ inode Êìç‰Ωú (i_op) ÊòØÂê¶ÊîØÊåÅ mknodÔºåÂç≥ÊòØÂê¶ÂÖ∑ÊúâÂàõÂª∫ËÆæÂ§áËäÇÁÇπÁöÑÂäüËÉΩ„ÄÇÂ¶ÇÊûúÁà∂ÁõÆÂΩï‰∏çÊîØÊåÅËØ•Êìç‰ΩúÔºåÂàôËøîÂõû -EPERM„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">mknod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mode</span> <span class="o">=</span> <span class="nf">vfs_prepare_mode</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="nf">devcgroup_inode_mknod</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="nf">security_inode_mknod</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// dir-&gt;i_op-&gt;mknod()ÔºöÂÆûÈôÖË∞ÉÁî®Êñá‰ª∂Á≥ªÁªüÊèê‰æõÁöÑ mknod Êìç‰ΩúÊù•ÂàõÂª∫ËÆæÂ§áËäÇÁÇπ„ÄÇËøô‰∏™Êìç‰ΩúÁî±ÂÖ∑‰ΩìÁöÑÊñá‰ª∂Á≥ªÁªüÂÆûÁé∞ÔºàÂ¶Ç EXT4„ÄÅXFS Á≠âÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">error</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="nf">mknod</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fsnotify_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vfs_mknod</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÈóÆÈ¢òÔºöÊâÄ‰ª•sockÊñá‰ª∂Âà∞Â∫ïÊòØsocketÂáΩÊï∞ÂàõÂª∫ÁöÑËøòÊòØbindÂáΩÊï∞ÂàõÂª∫ÁöÑÔºü</p>
<p>Á≠îÔºö<code>sock</code> Êñá‰ª∂ÔºàÂç≥ UNIX domain socket Êñá‰ª∂ÔºâÂÆûÈôÖ‰∏äÊòØÂú® <strong><code>bind()</code></strong> ÂáΩÊï∞ÁöÑÊâßË°åËøáÁ®ã‰∏≠ÂàõÂª∫ÁöÑÔºåËÄå‰∏çÊòØÂú®Ë∞ÉÁî® <strong><code>socket()</code></strong> ÂáΩÊï∞Êó∂ÂàõÂª∫ÁöÑ„ÄÇ</p>
<ol>
<li><strong><code>socket()</code> ÂáΩÊï∞ÁöÑ‰ΩúÁî®</strong></li>
</ol>
<ul>
<li><strong><code>socket()</code></strong> ÂáΩÊï∞ÂàõÂª∫ÁöÑÊòØÂ•óÊé•Â≠óÁöÑÂÜÖÊ†∏ÂØπË±°ÔºåËøîÂõû‰∏Ä‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶Ôºà<code>fd</code>ÔºâÔºåÁî®‰∫éË°®Á§∫‰∏Ä‰∏™Â•óÊé•Â≠ó„ÄÇ</li>
<li>ÂΩì‰Ω†Ë∞ÉÁî® <code>socket()</code> ÂáΩÊï∞Êó∂ÔºåÂÜÖÊ†∏‰ºö‰∏∫ËØ•Â•óÊé•Â≠óÂàÜÈÖçÂøÖË¶ÅÁöÑÂÜÖÊ†∏ÁªìÊûÑ‰ΩìÔºà‰æãÂ¶Ç <code>struct socket</code> Âíå <code>struct sock</code>ÔºâÔºåÂπ∂ÂàùÂßãÂåñ‰∏éËØ•Â•óÊé•Â≠óÁõ∏ÂÖ≥ÁöÑÂÜÖÊ†∏Êï∞ÊçÆÁªìÊûÑ„ÄÇ</li>
<li>Âú®Ëøô‰∏ÄÊ≠•ÔºåËôΩÁÑ∂Â•óÊé•Â≠óÁöÑÂØπË±°Â∑≤ÁªèÂ≠òÂú®Ôºå‰ΩÜËøòÊ≤°Êúâ‰∏éÂÖ∑‰ΩìÁöÑÊñá‰ª∂Á≥ªÁªüË∑ØÂæÑËøõË°åÂÖ≥ËÅî„ÄÇÂõ†Ê≠§ÔºåËøôÊó∂ÂÄôÂπ∂Ê≤°Êúâ‰∫ßÁîü‰ªª‰ΩïÊñá‰ª∂Á≥ªÁªü‰∏≠ÁöÑËäÇÁÇπÔºà<code>sock</code> Êñá‰ª∂Ôºâ„ÄÇ</li>
</ul>
<ol start="2">
<li><strong><code>bind()</code> ÂáΩÊï∞ÁöÑ‰ΩúÁî®</strong></li>
</ol>
<ul>
<li><strong><code>bind()</code></strong> ÂáΩÊï∞ÁöÑ‰ΩúÁî®ÊòØÂ∞ÜÂ•óÊé•Â≠ó‰∏é‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑÂú∞ÂùÄÁªëÂÆö„ÄÇÂú® UNIX domain socket ÁöÑÂú∫ÊôØ‰∏ãÔºåËøô‰∏™Âú∞ÂùÄÂèØ‰ª•ÊòØ‰∏Ä‰∏™Êñá‰ª∂Á≥ªÁªü‰∏≠ÁöÑË∑ØÂæÑÔºå‰πüÂèØ‰ª•ÊòØ‰∏Ä‰∏™ÊäΩË±°ÂêçÁß∞„ÄÇ</li>
<li>ÂØπ‰∫é <strong>BSD È£éÊ†º</strong> ÁöÑ UNIX domain socketÔºåË∞ÉÁî® <code>bind()</code> ÂáΩÊï∞Êó∂Ôºå‰ºöÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫‰∏Ä‰∏™Êñá‰ª∂ËäÇÁÇπÔºåËøô‰∏™ËäÇÁÇπÂ∞±ÊòØÊàë‰ª¨Âú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÁúãÂà∞ÁöÑ <code>.sock</code> Êñá‰ª∂ÔºåÊàñËÄÖÊòØÁ±ª‰ºº <code>/tmp/mysocket</code> ÁöÑÊñá‰ª∂„ÄÇ</li>
<li>ÂÖ∑‰ΩìÊù•ËØ¥Ôºå<code>bind()</code> ÂáΩÊï∞‰∏≠‰ºöË∞ÉÁî® <code>vfs_mknod()</code>ÔºåÂÆÉÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÊñá‰ª∂ËäÇÁÇπÔºàÁ±ªÂûã‰∏∫ <code>S_IFSOCK</code>ÔºâÔºåÂπ∂ÊääËøô‰∏™ËäÇÁÇπ‰∏éÂ•óÊé•Â≠óÁõ∏ÂÖ≥ËÅî„ÄÇËøôÊ†∑ÔºåÂÖ∂‰ªñËøõÁ®ãÂ∞±ÂèØ‰ª•ÈÄöËøáËØ•Ë∑ØÂæÑÊâæÂà∞Ëøô‰∏™Â•óÊé•Â≠óÔºå‰ªéËÄåËøõË°åÈÄö‰ø°„ÄÇ</li>
</ul>
<ol start="3">
<li>
<p><strong><code>sock</code> Êñá‰ª∂ÁöÑÂàõÂª∫ËøáÁ®ã</strong></p>
<p>‰ª•‰∏ãÊòØ <code>sock</code> Êñá‰ª∂ÂàõÂª∫ÁöÑÂÖ≥ÈîÆÊ≠•È™§Ôºö</p>
<p>(1)<strong>Ë∞ÉÁî® <code>socket()</code> ÂáΩÊï∞</strong>Ôºö</p>
<ul>
<li>
<p>ÂàõÂª∫Â•óÊé•Â≠óÂØπË±°ÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶ÔºåÊ†áËØÜËøô‰∏™Â•óÊé•Â≠ó„ÄÇ</p>
</li>
<li>
<p>Ê≠§Êó∂ÔºåÂÜÖÊ†∏‰∏≠ÂàõÂª∫‰∫ÜÂ•óÊé•Â≠óÁöÑÁõ∏ÂÖ≥Êï∞ÊçÆÁªìÊûÑÔºå‰ΩÜÊñá‰ª∂Á≥ªÁªü‰∏≠Âπ∂Ê≤°Êúâ‰ªª‰Ωï‰ΩìÁé∞„ÄÇ</p>
</li>
</ul>
<p>(2)<strong>Ë∞ÉÁî® <code>bind()</code> ÂáΩÊï∞</strong>Ôºö</p>
<ul>
<li>Â∞ÜÂ•óÊé•Â≠ó‰∏éÂÖ∑‰ΩìÁöÑÂú∞ÂùÄÁªëÂÆö„ÄÇÂØπ‰∫é UNIX domain socketÔºåËøô‰∏™Âú∞ÂùÄÊòØ‰∏Ä‰∏™Êñá‰ª∂Á≥ªÁªüË∑ØÂæÑÔºàBSD È£éÊ†ºÔºâÊàñÊäΩË±°Ë∑ØÂæÑ„ÄÇ</li>
<li>Â¶ÇÊûúÊòØ BSD È£éÊ†ºÁöÑÂú∞ÂùÄÔºå<code>bind()</code> ÂáΩÊï∞‰ºöÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠‰∏∫ËØ•Âú∞ÂùÄÂàõÂª∫‰∏Ä‰∏™Êñá‰ª∂ËäÇÁÇπ„ÄÇÊØîÂ¶Ç <code>/tmp/mysocket</code>„ÄÇ</li>
<li>ÂÜÖÊ†∏‰∏≠‰ºöË∞ÉÁî® <code>vfs_mknod()</code> ÊàñÁ±ª‰ººÁöÑÊñá‰ª∂Á≥ªÁªüÂáΩÊï∞Êù•ÂàõÂª∫ËÆæÂ§áËäÇÁÇπÔºåÁ°Æ‰øùÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠Êúâ‰∏Ä‰∏™ÂØπÂ∫îÁöÑÊñá‰ª∂ÔºåË°®Á§∫ËØ• UNIX domain socket Âú∞ÂùÄ„ÄÇ</li>
<li>Â¶ÇÊûúÊòØÊäΩË±°Âú∞ÂùÄÔºåÂàôÊ≤°ÊúâÊñá‰ª∂Á≥ªÁªüËäÇÁÇπÁöÑÂàõÂª∫Ôºå‰ªÖÂú®ÂÜÖÊ†∏‰∏≠Áª¥Êä§Áõ∏Â∫îÁöÑÊäΩË±°Ë∑ØÂæÑ„ÄÇ</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="listen">listen()
</h3><blockquote>
<p>‰∏ÄÂè•ËØùÊ¶ÇÊã¨listenÂáΩÊï∞ÔºöÂ∞ÜÂ•óÊé•Â≠óÁä∂ÊÄÅËÆæÁΩÆ‰∏∫ÁõëÂê¨Ê®°Âºè„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">listen</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>listen()-&gt;sys_listen()</p>
<p>ËøôÊÆµ‰ª£Á†ÅÂÆûÁé∞‰∫ÜÂÜÖÊ†∏‰∏≠ <code>listen()</code> Á≥ªÁªüË∞ÉÁî®ÁöÑÊ†∏ÂøÉÈÉ®ÂàÜ„ÄÇÂÆÉÁî®‰∫éÂ∞Ü‰∏Ä‰∏™Â•óÊé•Â≠óËΩ¨Êç¢‰∏∫Ë¢´Âä®ËøûÊé•Ê®°ÂºèÔºåÂºÄÂßãÁõëÂê¨Êù•Ëá™ÂÆ¢Êà∑Á´ØÁöÑËøûÊé•ËØ∑Ê±Ç„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">somaxconn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//sockfd_lookup_light() Áî®‰∫éÊü•Êâæ‰∏éÁªôÂÆöÊñá‰ª∂ÊèèËø∞Á¨¶ fd ÂÖ≥ËÅîÁöÑÂ•óÊé•Â≠óÂØπË±° (struct socket)„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sockfd_lookup_light</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËÆæÁΩÆÊúÄÂ§ßËøûÊé•Êï∞ (somaxconn)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">somaxconn</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="nf">sock_net</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">.</span><span class="n">sysctl_somaxconn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">backlog</span> <span class="o">&gt;</span> <span class="n">somaxconn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">backlog</span> <span class="o">=</span> <span class="n">somaxconn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Ë∞ÉÁî®ÂçèËÆÆÊ†àÁöÑ listen() ÂáΩÊï∞ÔºåÂ∞ÜÂ•óÊé•Â≠óËΩ¨Êç¢‰∏∫ÁõëÂê¨Ê®°Âºè„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">err</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ÈáäÊîæÊñá‰ª∂ÂºïÁî®Ôºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">fput_light</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sys_listen()-&gt;unix_listen()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>  <span class="c1">// ÈîôËØØÁ†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>  <span class="c1">// Ëé∑ÂèñÂ•óÊé•Â≠óÁöÑÂü∫Á°ÄÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// Ëé∑ÂèñUNIXÂ•óÊé•Â≠óÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•Â•óÊé•Â≠óÁ±ªÂûãÊòØÂê¶‰∏∫ SOCK_STREAM Êàñ SOCK_SEQPACKET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>  <span class="c1">// ‰ªÖÊúâÊµÅÂ•óÊé•Â≠óÂíåÈ°∫Â∫èÂåÖÂ•óÊé•Â≠óÊîØÊåÅÁõëÂê¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•ÊòØÂê¶ÁªëÂÆöÂú∞ÂùÄÔºåÊú™ÁªëÂÆöÂú∞ÂùÄÁöÑÂ•óÊé•Â≠ó‰∏çËÉΩËøõË°åÁõëÂê¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	<span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// ÈîÅÂÆöÂ•óÊé•Â≠óÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•Â•óÊé•Â≠óÁä∂ÊÄÅÊòØÂê¶‰∏∫ TCP_CLOSE Êàñ TCP_LISTEN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE</span> <span class="o">&amp;&amp;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>  <span class="c1">// Â•óÊé•Â≠óÁä∂ÊÄÅÂøÖÈ°ª‰∏∫ÂÖ≥Èó≠ÊàñÁõëÂê¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Â¶ÇÊûúÊñ∞ÁöÑSYNÁ≠âÂæÖÈòüÂàóÂ§ßÂ∞èÂ§ß‰∫éÂΩìÂâçÁöÑSYNÊúÄÂ§ßÁ≠âÂæÖÈòüÂàóÂ§ßÂ∞èÔºåÂàôÂî§ÈÜíÊâÄÊúâSYNÁ≠âÂæÖÈòüÂàó‰∏≠ÁöÑÂØπÁ≠â‰Ωì
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">backlog</span> <span class="o">&gt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">wake_up_interruptible_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">peer_wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>  <span class="c1">// ËÆæÁΩÆÊñ∞ÁöÑÁ≠âÂæÖÈòüÂàóÂ§ßÂ∞è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>  <span class="c1">// Â∞ÜÂ•óÊé•Â≠óÁä∂ÊÄÅËÆæÁΩÆ‰∏∫ÁõëÂê¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ËÆæÁΩÆËøûÊé•ÁöÑÂá≠ËØÅÔºå‰ª•‰æøËøûÊé•Êìç‰ΩúÂèØ‰ª•Â§çÂà∂ÂÆÉ‰ª¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">init_peercred</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// Ëß£ÈîÅÂ•óÊé•Â≠óÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>  <span class="c1">// ËøîÂõûÈîôËØØÁ†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="connect">connect()
</h3><blockquote>
<p>‰∏ÄÂè•ËØùÊ¶ÇÊã¨connectÂáΩÊï∞ÔºöÂÆûÁé∞‰∫Ü UNIX domain socket ÁöÑËøûÊé•ÈÄªËæë„ÄÇÂÆÉÂ§ÑÁêÜ‰∫ÜÂÆ¢Êà∑Á´ØÂ•óÊé•Â≠óËøûÊé•Âà∞ÊúçÂä°Âô®ÁõëÂê¨Â•óÊé•Â≠óÁöÑËøáÁ®ã„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">connect</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">uwservaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">uservaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>connect()-&gt;__sys_connect()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uservaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ëé∑ÂèñÊñá‰ª∂ÊèèËø∞Á¨¶ÁöÑXÊñá‰ª∂ÂØπË±° (fdget())Ôºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">f</span> <span class="o">=</span> <span class="nf">fdget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// move_addr_to_kernel()ÔºöÂ∞ÜÁî®Êà∑Á©∫Èó¥ÁöÑÂú∞ÂùÄÔºàuservaddrÔºâÁßªÂä®Âà∞ÂÜÖÊ†∏Á©∫Èó¥ÁöÑ address ÁªìÊûÑ‰∏≠„ÄÇËøô‰∏ÄÊ≠•Â∞ÜÁî®Êà∑Êèê‰æõÁöÑÂú∞ÂùÄÊã∑Ë¥ùÂà∞ÂÜÖÊ†∏‰∏≠Ôºå‰ª•‰æøÂÜÖÊ†∏ËÉΩÂ§üÂÆâÂÖ®Âú∞‰ΩøÁî®ÂÆÉ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="nf">move_addr_to_kernel</span><span class="p">(</span><span class="n">uservaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// __sys_connect_file()ÔºöËøôÊòØ‰∏Ä‰∏™ÂÆûÈôÖËøõË°åËøûÊé•Êìç‰ΩúÁöÑÂáΩÊï∞„ÄÇÂÆÉÊé•Êî∂Êñá‰ª∂ÂØπË±°ÔºàÂç≥Â•óÊé•Â≠óÔºâ„ÄÅÂÜÖÊ†∏‰∏≠ÁöÑÂú∞ÂùÄÁªìÊûÑ‰ª•ÂèäÂú∞ÂùÄÈïøÂ∫¶ÔºåÂÆåÊàêËøûÊé•Êìç‰Ωú„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">ret</span> <span class="o">=</span> <span class="nf">__sys_connect_file</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fdput</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_connect()-&gt;__sys_connect_file()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_connect_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">file_flags</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ëé∑ÂèñÂ•óÊé•Â≠óÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sock_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// security_socket_connect()ÔºöË∞ÉÁî® Linux ÂÆâÂÖ®Ê®°ÂùóÔºàLSMÔºâËøõË°åÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùÂΩìÂâçÁî®Êà∑ÊàñËøõÁ®ãÊúâÊùÉÈôêÂØπÊåáÂÆöÁöÑÂ•óÊé•Â≠óÂèëËµ∑ËøûÊé•ËØ∑Ê±Ç„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">	    <span class="nf">security_socket_connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">address</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// READ_ONCE(sock-&gt;ops)ÔºöËØªÂèñÂ•óÊé•Â≠óÊìç‰ΩúË°®„ÄÇÁî±‰∫éÂ•óÊé•Â≠óÁöÑÊìç‰ΩúË°®ÂèØËÉΩ‰ºöË¢´Â§öÁ∫øÁ®ãÂπ∂Âèë‰øÆÊîπÔºå‰ΩøÁî® READ_ONCE() Á°Æ‰øùËØªÂèñÁöÑÂÄºÊòØÊúÄÊñ∞ÁöÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// sock-&gt;ops-&gt;connect()ÔºöË∞ÉÁî®Â•óÊé•Â≠óÁöÑ connect Êìç‰ΩúÂáΩÊï∞ÔºåÊâßË°åÂÆûÈôÖÁöÑËøûÊé•Êìç‰Ωú„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">addrlen</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|</span> <span class="n">file_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>**Ê≥®ÊÑèÔºö**ËøôÈáå<code>(sock-&gt;ops)-&gt;connect()</code>‰ºöÊ†πÊçÆÂ•óÊé•Â≠óÁöÑÁ±ªÂûãË∞ÉÁî®‰∏çÂêåÁöÑÂÆûÁé∞ÂáΩÊï∞Ôºå‰æãÂ¶ÇSOCK_STREAM‰ºöË∞ÉÁî®<code>unix_stream_connect()</code>ÔºåSOCK_DGRAMÔºö‰ºöË∞ÉÁî®<code>unix_dgram_connect()</code>„ÄÇ</p>
<p>Âú® UNIX domain socket ‰∏≠ÔºåÂ•óÊé•Â≠óÁöÑÁ±ªÂûãÂèñÂÜ≥‰∫éÂú®Ë∞ÉÁî® <code>socket()</code> ÂáΩÊï∞Êó∂ÊâÄÊåáÂÆöÁöÑÁ±ªÂûãÂèÇÊï∞„ÄÇ‰∏ªË¶ÅÊúâ‰ª•‰∏ãÂá†ÁßçÁ±ªÂûãÔºö</p>
<ol>
<li><strong>SOCK_STREAM (ÊµÅÂºèÂ•óÊé•Â≠ó)</strong>Ôºö
<ul>
<li>Âú®‰Ω†Êèê‰æõÁöÑ‰ª£Á†Å‰∏≠Ôºå‰ΩøÁî®‰∫Ü <code>SOCK_STREAM</code>ÔºåËøôÊÑèÂë≥ÁùÄÂ•óÊé•Â≠óÊòØÊµÅÂºèÁöÑÔºåÁ±ª‰ºº‰∫é TCP ÂçèËÆÆÁöÑÂ•óÊé•Â≠ó„ÄÇ</li>
<li><strong>ÁâπÊÄß</strong>ÔºöÈù¢ÂêëËøûÊé•ÔºåÊèê‰æõÂèØÈù†ÁöÑ„ÄÅÊåâÈ°∫Â∫èÁöÑ„ÄÅÊó†Êï∞ÊçÆ‰∏¢Â§±ÁöÑÈÄö‰ø°ÔºåÈÄÇÁî®‰∫éÈúÄË¶ÅÂèØÈù†‰º†ËæìÁöÑÂú∫ÊôØ„ÄÇ</li>
<li>ÊàëÁöÑ <code>server.c</code> Âíå <code>client.c</code> Êñá‰ª∂‰∏≠ÈÉΩ‰ΩøÁî®‰∫Ü <code>AF_UNIX</code> Âíå <code>SOCK_STREAM</code>ÔºåÂõ†Ê≠§Ëøô‰∏§‰∏™Â•óÊé•Â≠óÊòØÂèØÈù†ÁöÑÈù¢ÂêëËøûÊé•ÁöÑÊµÅÂºèÂ•óÊé•Â≠ó„ÄÇ</li>
</ul>
</li>
<li><strong>SOCK_DGRAM (Êï∞ÊçÆÊä•Â•óÊé•Â≠ó)</strong>Ôºö
<ul>
<li>ËøôÊòØÂè¶‰∏ÄÁßçÁ±ªÂûãÁöÑ UNIX domain socketÔºåÁ±ª‰ºº‰∫é UDP ÂçèËÆÆÁöÑÂ•óÊé•Â≠ó„ÄÇ</li>
<li><strong>ÁâπÊÄß</strong>ÔºöÈù¢ÂêëÊó†ËøûÊé•Ôºå‰º†Ëæì‰∏ç‰øùËØÅÈ°∫Â∫èÊàñÂèØÈù†ÊÄßÔºåÈÄÇÁî®‰∫éÂØπÂèØÈù†ÊÄßË¶ÅÊ±ÇËæÉ‰Ωé‰ΩÜÈÄüÂ∫¶ËæÉÂø´ÁöÑÂú∫ÊôØ„ÄÇ</li>
<li>‰ΩøÁî® <code>SOCK_DGRAM</code> ÂèØ‰ª•Âú® UNIX domain ‰∏≠ÂÆûÁé∞Êó†ËøûÊé•ÁöÑÊï∞ÊçÆÊä•ÈÄö‰ø°„ÄÇ</li>
</ul>
</li>
<li><strong>SOCK_SEQPACKET (ÊúâÂ∫èÂàÜÁªÑÂ•óÊé•Â≠ó)</strong>Ôºö
<ul>
<li>ËøôÊòØ UNIX domain socket ‰∏≠ÁöÑ‰∏ÄÁßçËæÉÂ∞ë‰ΩøÁî®ÁöÑÁ±ªÂûã„ÄÇ</li>
<li><strong>ÁâπÊÄß</strong>ÔºöÈù¢ÂêëËøûÊé•ÔºåÊèê‰æõÂèØÈù†ÁöÑ„ÄÅÊúâÂ∫èÁöÑÊï∞ÊçÆ‰º†ËæìÔºå‰ΩÜ‰∏çÂÉè <code>SOCK_STREAM</code> ÈÇ£Ê†∑ÊòØ‰∏Ä‰∏™ËøûÁª≠ÁöÑÊï∞ÊçÆÊµÅÔºåËÄåÊòØ‰∏Ä‰∏™ÊúâÂ∫èÁöÑÊï∞ÊçÆÂåÖÂ∫èÂàó„ÄÇ</li>
<li>ÈÄÇÁî®‰∫éÈúÄË¶ÅÊúâÂ∫è‰º†ËæìÊï∞ÊçÆÂåÖÁöÑÂ∫îÁî®„ÄÇ</li>
</ul>
</li>
</ol>
</blockquote>
<blockquote>
<p><code>unix_stream_connect()</code> ÂáΩÊï∞ÂÆûÁé∞‰∫Ü UNIX domain socket ÁöÑËøûÊé•ÈÄªËæë„ÄÇÂÆÉÂ§ÑÁêÜ‰∫ÜÂÆ¢Êà∑Á´ØÂ•óÊé•Â≠óËøûÊé•Âà∞ÊúçÂä°Âô®ÁõëÂê¨Â•óÊé•Â≠óÁöÑËøáÁ®ã„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞Ü‰º†ÂÖ•ÁöÑÈÄöÁî®Âú∞ÂùÄÁªìÊûÑËΩ¨Êç¢‰∏∫ UNIX ‰∏ìÁî®Âú∞ÂùÄÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="o">*</span><span class="n">newsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">*</span><span class="n">newu</span><span class="p">,</span> <span class="o">*</span><span class="n">otheru</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span><span class="n">X</span><span class="err">@</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">st</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// È™åËØÅ‰º†ÂÖ•ÁöÑÂú∞ÂùÄÊòØÂê¶ÊúâÊïà
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_validate_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂ•óÊé•Â≠óÈúÄË¶Å‰º†ÈÄíÂá≠ÊçÆ‰ΩÜÂ∞öÊú™ÁªëÂÆöÔºåÂàôËøõË°åËá™Âä®ÁªëÂÆö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSCRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSPIDFD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_autobind</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆË∂ÖÊó∂Êó∂Èó¥ÔºåÂèñÂÜ≥‰∫éÊòØÂê¶‰∏∫ÈùûÈòªÂ°ûÊ®°Âºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">timeo</span> <span class="o">=</span> <span class="nf">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂ•óÊé•Â≠óÔºåÁî®‰∫é‰ª£Ë°®Âç≥Â∞ÜÂª∫Á´ãÁöÑËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newsk</span> <span class="o">=</span> <span class="nf">unix_create1</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newsk</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">newsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰∏∫Êñ∞ÁöÑÂ•óÊé•Â≠óÂàÜÈÖçsk_buff
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">skb</span> <span class="o">=</span> <span class="nf">sock_wmalloc</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">restart</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Êü•ÊâæÁõëÂê¨Â•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">other</span> <span class="o">=</span> <span class="nf">unix_find_other</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈîÅÂÆöÁõÆÊ†áÂ•óÊé•Â≠óÁöÑÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÁõÆÊ†áÂ•óÊé•Â≠óÂ∑≤Ê≠ª‰∫°ÔºåËß£ÈîÅÂπ∂ÈáçÊñ∞Êü•Êâæ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">sock_flag</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•ÁõÆÊ†áÂ•óÊé•Â≠óÊòØÂê¶Âú®ÁõëÂê¨Áä∂ÊÄÅÔºåÊàñÂ∑≤ÂÖ≥Èó≠Êé•Êî∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÁõÆÊ†áÁõëÂê¨Â•óÊé•Â≠óÁöÑÊé•Êî∂ÈòüÂàóÂ∑≤Êª°ÔºåÂàôÁ≠âÂæÖÁõ¥Âà∞ÊúâÁ©∫Èó¥ÊàñË∂ÖÊó∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">unix_recvq_full</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timeo</span> <span class="o">=</span> <span class="nf">unix_wait_for_peer</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈîÅÂÆöÂèëËµ∑ËøûÊé•ÁöÑÂ•óÊé•Â≠óÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">st</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â•óÊé•Â≠óÂ§Ñ‰∫éÂÖ≥Èó≠Áä∂ÊÄÅÔºåÂèØ‰ª•ÁªßÁª≠ËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_ESTABLISHED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â•óÊé•Â≠óÂ∑≤ÁªèËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_lock_nested</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Âú®ÈîÅÂÆöÁä∂ÊÄÅ‰∏ãÈáçÊñ∞Ê£ÄÊü•Â•óÊé•Â≠óÁä∂ÊÄÅÔºåÁ°Æ‰øùÊ≤°ÊúâÂèòÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">st</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËøõË°åÂÆâÂÖ®ÊÄßÊ£ÄÊü•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">security_unix_stream_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÊñ∞Â•óÊé•Â≠ó‰ª•ÂÆåÊàêËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_peer</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_peercred</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">newu</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newu</span><span class="o">-&gt;</span><span class="n">peer_wq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">otheru</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰ªéÁõëÂê¨Â•óÊé•Â≠óÂ§çÂà∂Âú∞ÂùÄ‰ø°ÊÅØÂà∞Êñ∞Â•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">otheru</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">path_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">otheru</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">newu</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">otheru</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">refcount_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">otheru</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">smp_store_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newu</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">otheru</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÊñ∞Â•óÊé•Â≠óÁöÑÂá≠ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">copy_peercred</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êõ¥Êñ∞ÂÆ¢Êà∑Á´ØÂ•óÊé•Â≠óÂíåÊñ∞Â•óÊé•Â≠óÁöÑÁä∂ÊÄÅ‰∏∫Â∑≤ËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_hold</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">smp_mb__after_atomic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_peer</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">=</span> <span class="n">newsk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜËøûÊé•‰ø°ÊÅØÂèëÈÄÅÁªôÁõëÂê¨Â•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">other</span><span class="o">-&gt;</span><span class="nf">sk_data_ready</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newsk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_release_sock</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_find_other()ÔºöÊü•ÊâæÂØπÊñπÊ≠£Âú®ÁõëÂê¨ÁöÑÂ•óÊé•Â≠ó</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">unix_find_other</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				    <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_find_bsd</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_find_abstract</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ËøôÈáåÊúâ‰∏§‰∏™Êü•ÊâæÂáΩÊï∞ÔºåÊàë‰ª¨ÈÄâÊã©bsdÈ£éÊ†ºÂàÜÊûê„ÄÇ</p>
<p><code>unix_find_bsd()</code> ÂáΩÊï∞Áî®‰∫éÂú®Êñá‰ª∂Á≥ªÁªü‰∏≠Êü•Êâæ‰∏é BSD È£éÊ†ºÂú∞ÂùÄÁªëÂÆöÁöÑ UNIX domain socket„ÄÇÂÆÉÈÄöËøáÁªôÂÆöÁöÑË∑ØÂæÑÂêçÊâæÂà∞ÂØπÂ∫îÁöÑÊñá‰ª∂ÔºàÂ•óÊé•Â≠óÔºâÔºåÂπ∂ËøîÂõû‰∏é‰πãÂÖ≥ËÅîÁöÑ <code>sock</code> ÁªìÊûÑ‰Ωì„ÄÇ‰ª•‰∏ãÊòØÂØπËØ•ÂáΩÊï∞ÁöÑÈÄêÊ≠•ÂàÜÊûêÂíå‰∏≠ÊñáÊ≥®Èáä„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">unix_find_bsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">path</span> <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ÊûÑÂª∫ BSD È£éÊ†ºÂú∞ÂùÄÔºåÁ°Æ‰øù sun_path ÂêàÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_mkname_bsd</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ‰ΩøÁî® kern_path Êü•ÊâæÁªôÂÆöË∑ØÂæÑÂØπÂ∫îÁöÑÊñá‰ª∂ÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">kern_path</span><span class="p">(</span><span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">LOOKUP_FOLLOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•ÂØπË∑ØÂæÑÁöÑÂÜôÊùÉÈôêÔºå‰ª•Á°Æ‰øùËÉΩÂ§üÁªëÂÆö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">path_permission</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="n">MAY_WRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">path_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•ËØ•Ë∑ØÂæÑÂØπÂ∫îÁöÑ inode ÊòØÂê¶‰∏∫Â•óÊé•Â≠óÁ±ªÂûã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">inode</span> <span class="o">=</span> <span class="nf">d_backing_inode</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">S_ISSOCK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">path_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Êü•Êâæ inode ÂØπÂ∫îÁöÑÂ•óÊé•Â≠óÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_find_socket_byinode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">path_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Á°Æ‰øùÂ•óÊé•Â≠óÁ±ªÂûã‰∏ÄËá¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTOTYPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">touch_atime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>  <span class="c1">// Êõ¥Êñ∞ËÆøÈóÆÊó∂Èó¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">sock_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ÈáäÊîæË∑ØÂæÑËµÑÊ∫ê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">sock_put</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ÈáäÊîæÂ•óÊé•Â≠óÂºïÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">path_put</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ÈáäÊîæË∑ØÂæÑÂºïÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ËøîÂõûÈîôËØØÊåáÈíà
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="accept">accept()
</h3><blockquote>
<p>‰ªéÁõëÂê¨Â•óÊé•Â≠ó‰∏≠Êé•Âèó‰∏Ä‰∏™Êñ∞ËøûÊé•ÔºåÂπ∂Â∞ÜÊñ∞ËøûÊé•ÁöÑÂ•óÊé•Â≠ó‰ø°ÊÅØÂ§çÂà∂Âà∞‰º†ÂÖ•ÁöÑ‰∏Ä‰∏™Êñ∞ÁöÑÂ•óÊé•Â≠ó</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_accept4</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>accept()-&gt;__sys_accept4()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_accept4</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		  <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">f</span> <span class="o">=</span> <span class="nf">fdget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ret</span> <span class="o">=</span> <span class="nf">__sys_accept4_file</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					 <span class="n">upeer_addrlen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fdput</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_accept4()-&gt;__sys_accept4_file()</p>
<p><code>__sys_accept4_file()</code> ÂáΩÊï∞ÂÆûÁé∞‰∫ÜÂØπÂ∑≤Â≠òÂú®Â•óÊé•Â≠óÊñá‰ª∂ÁöÑ <code>accept</code> Êìç‰ΩúÔºåËØ•ÂáΩÊï∞Áî®‰∫é‰ªéÊñá‰ª∂ÊèèËø∞Á¨¶‰∏≠Ëé∑ÂèñÊñ∞ËøûÊé•„ÄÇÂÆÉÂÖÅËÆ∏ÂØπÊñ∞ÁöÑÂ•óÊé•Â≠óËÆæÁΩÆ‰∏Ä‰∫õÊ†áÂøóÔºåÊØîÂ¶ÇÈùûÈòªÂ°ûÂíåÂÖ≥Èó≠Êñá‰ª∂ÊèèËø∞Á¨¶Êó∂Ëá™Âä®ÊâßË°å <code>close</code>„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">__sys_accept4_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			      <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">newfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü• flagsÔºåÁ°Æ‰øùÂÆÉ‰ª¨ÊòØÂêàÊ≥ïÁöÑÔºå‰∏çËÉΩÊúâÈô§ SOCK_CLOEXEC Âíå SOCK_NONBLOCK ‰πãÂ§ñÁöÑÂÖ∂‰ªñÊ†áÂøó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">|</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûú SOCK_NONBLOCK ‰∏é O_NONBLOCK ‰∏çÁõ∏Á≠â‰∏îËÆæÁΩÆ‰∫Ü SOCK_NONBLOCKÔºåÂàôËΩ¨Êç¢‰∏∫ O_NONBLOCK
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">SOCK_NONBLOCK</span> <span class="o">!=</span> <span class="n">O_NONBLOCK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑Âèñ‰∏Ä‰∏™Êñ∞ÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newfd</span> <span class="o">=</span> <span class="nf">get_unused_fd_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">newfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰ΩøÁî® do_accept ÂáΩÊï∞Êé•ÂèóËøûÊé•ÔºåËøîÂõûÊñ∞ÁöÑÊñá‰ª∂ÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newfile</span> <span class="o">=</span> <span class="nf">do_accept</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂá∫ÈîôÔºåÂàôÈáäÊîæ‰πãÂâçËé∑ÂèñÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">put_unused_fd</span><span class="p">(</span><span class="n">newfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÊñ∞ÁöÑÊñá‰ª∂ÂØπË±°ÂÆâË£ÖÂà∞Êñ∞Ëé∑ÂèñÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶‰∏ä
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fd_install</span><span class="p">(</span><span class="n">newfd</span><span class="p">,</span> <span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">newfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_accept4_file()-&gt;do_accept()</p>
<p><code>do_accept()</code> ÂáΩÊï∞Áî®‰∫éÊé•Âèó‰º†ÂÖ•ÁöÑËøûÊé•ËØ∑Ê±ÇÔºå‰∏∫Êñ∞ÁöÑËøûÊé•ÂàõÂª∫Â•óÊé•Â≠óÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™‰∏éÊñ∞ËøûÊé•ÂÖ≥ËÅîÁöÑÊñá‰ª∂ÂØπË±°„ÄÇËØ•ÂáΩÊï∞ÊòØÂ§ÑÁêÜ <code>accept</code> Á≥ªÁªüË∞ÉÁî®ÁöÑÊ†∏ÂøÉÈÉ®ÂàÜÔºå‰∏ªË¶ÅË¥üË¥£ËµÑÊ∫êÁöÑÂàÜÈÖçÂíåËøûÊé•ÁöÑÂª∫Á´ã„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">do_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">file_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="n">newsock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰ªéÊñá‰ª∂ÂØπË±°Ëé∑ÂèñÂ•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sock</span> <span class="o">=</span> <span class="nf">sock_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOTSOCK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰∏∫Êñ∞ÁöÑËøûÊé•ÂàÜÈÖçÂ•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newsock</span> <span class="o">=</span> <span class="nf">sock_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newsock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENFILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÂéüÂßãÂ•óÊé•Â≠óÁöÑÊìç‰ΩúÊåáÈíà
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ops</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÊñ∞Â•óÊé•Â≠óÁöÑÁ±ªÂûãÂíåÊìç‰ΩúÊåáÈíà
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newsock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Êàë‰ª¨‰∏çÈúÄË¶ÅË∞ÉÁî® try_module_getÔºåÂõ†‰∏∫ÁõëÂê¨Â•óÊé•Â≠ó (sock) Â∑≤ÁªèÊåÅÊúâ‰∫Ü
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ÂçèËÆÆÊ®°Âùó (sock-&gt;ops-&gt;owner)„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__module_get</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰∏∫Êñ∞Â•óÊé•Â≠óÂàÜÈÖçÊñá‰ª∂ÂØπË±°ÔºåÂπ∂‰ΩøÁî®ÁªôÂÆöÁöÑÊ†áÂøó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newfile</span> <span class="o">=</span> <span class="nf">sock_alloc_file</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot_creator</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËøõË°åÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùÂèØ‰ª•Êé•ÂèóËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">newsock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ë∞ÉÁî®Â•óÊé•Â≠óÁöÑ accept Êìç‰Ωú‰ª•Âª∫Á´ãÊñ∞ËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="nf">accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">newsock</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|</span> <span class="n">file_flags</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÈúÄË¶ÅÔºåËé∑ÂèñÂØπÁ≠âÁ´ØÁöÑÂú∞ÂùÄ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">upeer_sockaddr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="nf">getname</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">move_addr_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êñá‰ª∂Ê†áÂøó‰∏ç‰ºöÈÄöËøá accept() ÁªßÊâøÔºåËøô‰∏éÂÖ∂‰ªñÊìç‰ΩúÁ≥ªÁªü‰∏çÂêå„ÄÇ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_fd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈáäÊîæÊñ∞Êñá‰ª∂ÂØπË±°ÁöÑÂºïÁî®ÔºåÈáäÊîæËµÑÊ∫ê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fput</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>do_accept()-&gt;unix_accept()</p>
<p><code>unix_accept()</code> ÂáΩÊï∞Áî®‰∫éÂÆûÁé∞ UNIX domain socket ÁöÑ <code>accept</code> Êìç‰ΩúÔºåÂÆÉ‰ªéÁõëÂê¨Â•óÊé•Â≠ó‰∏≠Êé•Âèó‰∏Ä‰∏™Êñ∞ËøûÊé•ÔºåÂπ∂Â∞ÜÊñ∞ËøûÊé•ÁöÑÂ•óÊé•Â≠ó‰ø°ÊÅØÂ§çÂà∂Âà∞‰º†ÂÖ•ÁöÑ <code>newsock</code> ‰∏≠„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">newsock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">kern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂ•óÊé•Â≠óÁ±ªÂûã‰∏çÊòØ SOCK_STREAM Êàñ SOCK_SEQPACKETÔºåÂàôËøîÂõû‰∏çÊîØÊåÅÁöÑÈîôËØØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂ•óÊé•Â≠óÁä∂ÊÄÅ‰∏çÊòØ TCP_LISTENÔºåÂàôËøîÂõûÊó†ÊïàÂèÇÊï∞ÈîôËØØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÂ•óÊé•Â≠óÁä∂ÊÄÅ‰∏∫ TCP_LISTENÔºåÂÆÉÂú®Ê≠§Â§Ñ‰∏ç‰ºöÊîπÂèòÔºàÊöÇÊó∂...ÔºâÔºåÂõ†Ê≠§‰∏çÈúÄË¶ÅÂä†ÈîÅ„ÄÇ */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ùËØï‰ªéÁõëÂê¨Â•óÊé•Â≠óÁöÑÊé•Êî∂ÈòüÂàó‰∏≠Ëé∑ÂèñÊï∞ÊçÆÂåÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">?</span> <span class="nl">MSG_DONTWAIT</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊé•Êî∂ÈòüÂàó‰∏∫Á©∫Âπ∂‰∏îÂèëÁîüÊé•Êî∂ÂÖ≥Èó≠ÔºåËøîÂõûÈîôËØØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÊñ∞ËøûÊé•ÁöÑÂ•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tsk</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âî§ÈÜíÁ≠âÂæÖËøûÊé•ÁöÑËøõÁ®ã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer_wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÊñ∞ËøûÊé•ÁöÑÂ•óÊé•Â≠óÈôÑÂä†Âà∞‰º†ÂÖ•ÁöÑ newsock ‰∏ä
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_sock_inherit_flags</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">newsock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_graft</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">newsock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="write">write()
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">size_t</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ksys_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>write()-&gt;ksys_write()</p>
<p><code>ksys_write()</code> ÊòØ Linux ÂÜÖÊ†∏‰∏≠ÂÆûÁé∞ÁöÑ‰∏Ä‰∏™Á≥ªÁªüË∞ÉÁî®Â§ÑÁêÜÂáΩÊï∞ÔºåÁî®‰∫éÂ§ÑÁêÜÊù•Ëá™Áî®Êà∑ÊÄÅÁöÑ <code>write()</code> Á≥ªÁªüË∞ÉÁî®„ÄÇÂú®Ëøô‰∏™ÂáΩÊï∞‰∏≠ÔºåÂÆÉÊé•Êî∂‰∫Ü‰∏Ä‰∏™Êñá‰ª∂ÊèèËø∞Á¨¶ <code>fd</code>„ÄÅ‰∏Ä‰∏™Áî®Êà∑Á©∫Èó¥ÁöÑÁºìÂÜ≤Âå∫ <code>buf</code> ‰ª•ÂèäÂÜôÂÖ•ÁöÑÂ≠óËäÇÊï∞ <code>count</code>ÔºåÂπ∂ÈÄöËøáÁõ∏Â∫îÁöÑÊñá‰ª∂Á≥ªÁªüÊé•Âè£Â∞ÜÊï∞ÊçÆÂÜôÂÖ•ÁõÆÊ†áÊñá‰ª∂ÊàñËÆæÂ§á„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">ksys_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fdget_pos</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Á°Æ‰øùÊñá‰ª∂ÊèèËø∞Á¨¶ÊúâÊïà
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// file_ppos(f.file)ÔºöËØ•ÂáΩÊï∞Áî®‰∫éËé∑ÂèñÊñá‰ª∂ÁöÑÂΩìÂâçÂÅèÁßªÈáèÊåáÈíà„ÄÇÂØπ‰∫éÊüê‰∫õÊñá‰ª∂Á±ªÂûãÔºàÂ¶ÇÂ∏∏ËßÑÊñá‰ª∂ÔºâÔºåÂÅèÁßªÈáèÈúÄË¶Å‰∏çÊñ≠Êõ¥Êñ∞ÔºåËÄåÂØπ‰∫éÊüê‰∫õÁâπÊÆäÊñá‰ª∂ÔºàÂ¶Ç socketÔºâÔºåÂèØËÉΩ‰∏çÈúÄË¶ÅÂÅèÁßªÈáè„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="nf">file_ppos</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊñá‰ª∂ÊåáÈíàÂ≠òÂú®ÔºåËÆæÁΩÆÂÜôÂÖ•ÁöÑËµ∑Âßã‰ΩçÁΩÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ppos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Ë∞ÉÁî® vfs_write ËøõË°åÂÆûÈôÖÁöÑÂÜôÂÖ•Êìç‰ΩúÔºåÂÖ∑‰ΩìÁöÑÂÜôÂÖ•Êìç‰ΩúÂ∞ÜÁî±‰∏çÂêåÁöÑÊñá‰ª∂Á≥ªÁªüÊàñËÆæÂ§áÈ©±Âä®Êù•ÂÆûÁé∞Ôºå‰æãÂ¶ÇÂ≠óÁ¨¶ËÆæÂ§á„ÄÅÂùóËÆæÂ§á„ÄÅÁΩëÁªúÂ•óÊé•Â≠óÁ≠â„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ret</span> <span class="o">=</span> <span class="nf">vfs_write</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Êõ¥Êñ∞Êñá‰ª∂ÁöÑÂÅèÁßªÈáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ppos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈáäÊîæÊñá‰ª∂ÊèèËø∞Á¨¶ÂºïÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">fdput_pos</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ksys_write()-&gt;vfs_write()</p>
<p><code>vfs_write()</code> ÊòØ Linux ÂÜÖÊ†∏‰∏≠Áî®‰∫éÂ§ÑÁêÜÊñá‰ª∂ÂÜôÂÖ•Êìç‰ΩúÁöÑËôöÊãüÊñá‰ª∂Á≥ªÁªüÔºàVFSÔºâÊé•Âè£ÂáΩÊï∞„ÄÇÂÆÉÊé•Êî∂‰∏Ä‰∏™ <code>struct file</code> ÊåáÈíà„ÄÅÁî®Êà∑Á©∫Èó¥ÁºìÂÜ≤Âå∫„ÄÅË¶ÅÂÜôÂÖ•ÁöÑÂ≠óËäÇÊï∞‰ª•ÂèäÊñá‰ª∂ÁöÑÂÅèÁßªÈáèÊåáÈíàÔºåË¥üË¥£ÊâßË°åÂÆûÈôÖÁöÑÊï∞ÊçÆÂÜôÂÖ•Êìç‰Ωú„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vfs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÂÖ∑ÊúâÂÜôÊùÉÈôê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÂèØ‰ª•ÂÜô
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_CAN_WRITE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•Áî®Êà∑Á©∫Èó¥ÁºìÂÜ≤Âå∫ÊòØÂê¶ÂèØËÆøÈóÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="o">!</span><span class="nf">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// È™åËØÅÂÜôÂÖ•Âå∫ÂüüÊòØÂê¶ÂêàÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">rw_verify_area</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈôêÂà∂ÂÜôÂÖ•Â≠óËäÇÊï∞ÔºåÈÅøÂÖçËøáÂ§ßÁöÑÂÜôÂÖ•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_RW_COUNT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">=</span>  <span class="n">MAX_RW_COUNT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// file_start_write()ÔºöÁî®‰∫éÊñá‰ª∂Á≥ªÁªüÁöÑÂπ∂ÂèëÊéßÂà∂ÔºåÂºÄÂßãÂÜôÊìç‰Ωú„ÄÇÊüê‰∫õÊñá‰ª∂Á≥ªÁªüÈúÄË¶ÅËøôÁßçÊú∫Âà∂Êù•Á°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">file_start_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ë∞ÉÁî®ÂÖ∑‰ΩìÁöÑÂÜôÂÖ•ÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="nf">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>  <span class="c1">// ÊóßÁâàÂÜôÂÖ•Êé•Âè£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write_iter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">new_sync_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>     <span class="c1">// Êñ∞ÁâàÂÜôÂÖ•Êé•Âè£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂÜôÂÖ•ÊàêÂäüÔºåËøõË°åÈÄöÁü•ÂíåÊõ¥Êñ∞ÁªüËÆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fsnotify_modify</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add_wchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êõ¥Êñ∞ÂÜôÂÖ•Á≥ªÁªüË∞ÉÁî®ËÆ°Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">inc_syscw</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÁªìÊùüÂÜôÊìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">file_end_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>vfs_write()-&gt;sock_write_iter()</p>
<p><code>sock_write_iter()</code> ÊòØÁî®‰∫éÂÆûÁé∞Â•óÊé•Â≠óÊñá‰ª∂ÂÜôÂÖ•ÁöÑÂáΩÊï∞ÔºåÊîØÊåÅÈÄöËøá<strong>Ëø≠‰ª£Êé•Âè£</strong> (<code>write_iter</code>)Êù•ÂÆåÊàêÂÜôÂÖ•Êìç‰Ωú„ÄÇËØ•ÂáΩÊï∞‰ªéÁî®Êà∑Á©∫Èó¥Ëé∑ÂèñÊï∞ÊçÆÂπ∂ÂÜôÂÖ•Âà∞‰∏é‰πãÂÖ≥ËÅîÁöÑÂ•óÊé•Â≠ó‰∏≠„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sock_write_iter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iov_iter</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">msg_iter</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="p">.</span><span class="n">msg_iocb</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÊñá‰ª∂ÂÅèÁßªÈáè‰∏ç‰∏∫0ÔºåÂàôËøîÂõû-ESPIPEÈîôËØØÔºåÂõ†‰∏∫Â•óÊé•Â≠óÊòØÊµÅÂºèÊñá‰ª∂Ôºå‰∏çÊîØÊåÅ‰ΩçÁΩÆË∞ÉÊï¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÊñá‰ª∂ÊòØÈùûÈòªÂ°ûÊ®°ÂºèÊàñËÄÖIOCBÊ†áÂøóËÆæÁΩÆ‰∫Ü‰∏çÁ≠âÂæÖÔºåÂàôËÆæÁΩÆÊ∂àÊÅØÊ†áÂøóMSG_DONTWAIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">||</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_flags</span> <span class="o">&amp;</span> <span class="n">IOCB_NOWAIT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂ•óÊé•Â≠óÁ±ªÂûãÊòØÈ°∫Â∫èÂåÖÔºàSOCK_SEQPACKETÔºâÔºåËÆæÁΩÆÊ∂àÊÅØÊ†áÂøóMSG_EOR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_EOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ë∞ÉÁî®ÂÜÖÊ†∏ÂáΩÊï∞ÂèëÈÄÅÊ∂àÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">res</span> <span class="o">=</span> <span class="nf">__sock_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êõ¥Êñ∞Ëø≠‰ª£Âô®Áä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sock_sendmsg()-&gt;__sock_sendmsg()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">__sock_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span> <span class="o">?:</span> <span class="nf">sock_sendmsg_nosec</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sock_sendmsg()-&gt;sock_sendmsg_nosec()</p>
<p><code>sock_sendmsg_nosec()</code> ÊòØ‰∏Ä‰∏™ÂÜÖÊ†∏‰∏≠ÁöÑÈùôÊÄÅÂÜÖËÅîÂáΩÊï∞Ôºå‰∏ªË¶ÅÁî®‰∫éÂèëÈÄÅÊ∂àÊÅØÔºà<code>sendmsg</code>ÔºâÁöÑÊìç‰Ωú„ÄÇËøô‰∏™ÂáΩÊï∞ÁöÑ‰ΩúÁî®ÊòØÂ∞ÜÁî®Êà∑Á©∫Èó¥ÁöÑÊ∂àÊÅØÂ∞ÅË£ÖÂêéÔºåÈÄöËøáË∞ÉÁî®Â•óÊé•Â≠óÂçèËÆÆÁöÑÂèëÈÄÅÂáΩÊï∞ÔºåÂ∞ÜÊï∞ÊçÆÂèëÈÄÅÂà∞Áõ∏Â∫îÁöÑÁΩëÁªúÊ†à‰∏≠„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sock_sendmsg_nosec</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// READ_ONCE(sock-&gt;ops)-&gt;sendmsgÔºö‰ΩøÁî® READ_ONCE ËØªÂèñÂ•óÊé•Â≠óÁöÑÊìç‰ΩúÁªìÊûÑ‰ΩìÔºàsock-&gt;opsÔºâ‰∏≠ÁöÑ sendmsg ÂáΩÊï∞ÊåáÈíàÔºåÁ°Æ‰øùËØªÂèñÁöÑÂéüÂ≠êÊÄß„ÄÇsendmsg ÊòØ‰∏çÂêåÂçèËÆÆÁöÑÂÆûÁé∞ÂáΩÊï∞ÔºåËøôÈáåÈÄöËøáÂä®ÊÄÅÂà§Êñ≠ÂçèËÆÆÁ±ªÂûãÂπ∂Ë∞ÉÁî®ÂêàÈÄÇÁöÑ sendmsg ÂáΩÊï∞ÔºåÂÖàË∞ÉÁî®sock-&gt;ops-&gt;sendmsgÔºåËã•‰∏∫Á©∫ÔºåÂàô‰ºöË∞ÉÁî®IPv4 Êàñ IPv6 „ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">INDIRECT_CALL_INET</span><span class="p">(</span><span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">,</span> <span class="n">inet6_sendmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="n">inet_sendmsg</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIOCBQUEUED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">trace_sock_send_length_enabled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nf">call_trace_sock_send_length</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_sendmsg_nosec()-&gt;unix_stream_sendmsg()</p>
<p><code>unix_stream_sendmsg()</code> ÊòØÁî®‰∫é Unix ÂüüÂ•óÊé•Â≠óÁöÑÊï∞ÊçÆÂèëÈÄÅÂáΩÊï∞ÔºåÊîØÊåÅÊµÅÂºè (<code>SOCK_STREAM</code>) Â•óÊé•Â≠ó„ÄÇÂÆÉË¥üË¥£Â∞ÜÁî®Êà∑Á©∫Èó¥ÁöÑÊï∞ÊçÆÈÄöËøáÂ•óÊé•Â≠óÂèëÈÄÅÁªôÂ∑≤ËøûÊé•ÁöÑÂè¶‰∏ÄÁ´Ø„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">scm_cookie</span> <span class="n">scm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">fds_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">data_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Á≠âÂæÖ Unix ÂûÉÂúæÂõûÊî∂ÂÆåÊàê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wait_for_unix_gc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â§ÑÁêÜÊéßÂà∂‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">scm_send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰∏çÊîØÊåÅ MSG_OOBÔºàÂ∏¶Â§ñÊï∞ÊçÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">len</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// È™åËØÅÊòØÂê¶ÊúâÁõÆÊ†áËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_ESTABLISHED</span> <span class="o">?</span> <span class="o">-</span><span class="nl">EISCONN</span> <span class="p">:</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span> <span class="o">=</span> <span class="nf">unix_peer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•ÂèëÈÄÅÁ´ØÊòØÂê¶Â∑≤ÁªèÂÖ≥Èó≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">SEND_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">pipe_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Âæ™ÁéØÂèëÈÄÅÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">sent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_SPLICE_PAGES</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ‰ΩøÁî® splice ÊñπÊ≥ïÂàÜÈÖçÂèëÈÄÅÁºìÂÜ≤Âå∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skb</span> <span class="o">=</span> <span class="nf">sock_alloc_send_pskb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ‰ª•ÂèëÈÄÅÁºìÂÜ≤Âå∫ÁöÑ‰∏ÄÂçäÂ§ßÂ∞è‰∏∫ÊúÄÂ§ßÂÄºÔºåÈÅøÂÖçÈòªÂ°û
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">size</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ÈôêÂà∂ size ‰ª•‰øùËØÅÂèØ‰ª•ËøõË°å order-0 ÂàÜÈÖç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">size</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nf">SKB_MAX_HEAD</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">UNIX_SKB_FRAGS_SZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">data_len</span> <span class="o">=</span> <span class="kt">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="nf">SKB_MAX_HEAD</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_len</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">data_len</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ÂàÜÈÖçÂèëÈÄÅÁºìÂÜ≤Âå∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skb</span> <span class="o">=</span> <span class="nf">sock_alloc_send_pskb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="nf">get_order</span><span class="p">(</span><span class="n">UNIX_SKB_FRAGS_SZ</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞ÜÊñá‰ª∂ÊèèËø∞Á¨¶‰ªÖÂú®Á¨¨‰∏Ä‰∏™ÁºìÂÜ≤Âå∫‰∏≠ÂèëÈÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_scm_to_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">!</span><span class="n">fds_sent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">fds_sent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ‰ΩøÁî® splice ËøõË°åÊï∞ÊçÆÊã∑Ë¥ù
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_SPLICE_PAGES</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="nf">skb_splice_from_iter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iter</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">size</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">refcount_add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">data_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Â∞ÜÊï∞ÊçÆ‰ªéËø≠‰ª£Âô®Êã∑Ë¥ùÂà∞ÂèëÈÄÅÁºìÂÜ≤Âå∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">err</span> <span class="o">=</span> <span class="nf">skb_copy_datagram_from_iter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iter</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈîÅ‰ΩèÂØπÁ´ØÂ•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂØπÁ´ØÂ•óÊé•Â≠óÂ∑≤ÂÖ≥Èó≠ÔºåË∑≥ËΩ¨Âà∞ÈîôËØØÂ§ÑÁêÜ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">sock_flag</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">pipe_err_free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Ê∑ªÂä†Âá≠ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">maybe_add_creds</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">scm_stat_add</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞ÜÊï∞ÊçÆÂåÖÂä†ÂÖ•Âà∞ÂØπÁ´ØÁöÑÊé•Êî∂ÈòüÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈÄöÁü•ÂØπÁ´ØÊúâÊñ∞Êï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">other</span><span class="o">-&gt;</span><span class="nf">sk_data_ready</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sent</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// Â§ÑÁêÜÂ∏¶Â§ñÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">queue_oob</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">fds_sent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sent</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈîÄÊØÅÊéßÂà∂‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">pipe_err_free</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">pipe_err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•Ôºå‰∏îÈùû MSG_NOSIGNALÔºåÂàôÂèëÈÄÅ SIGPIPE ‰ø°Âè∑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_NOSIGNAL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">send_sig</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">out_err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sent</span> <span class="o">?</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_stream_sendmsgÂáΩÊï∞‰∏≠Â∞ÜÂ∞ÜÊï∞ÊçÆ‰ªéËø≠‰ª£Âô®Êã∑Ë¥ùÂà∞skb‰∏≠Êúâ‰∏§Áßç‰∏çÂêåÁöÑÊñπÊ≥ïÔºö‰ΩøÁî®spliceÊñπÊ≥ï(skb_splice_from_iter)ÂíåÊôÆÈÄöÊñπÊ≥ï(skb_copy_datagram_from_iter)</p>
<p>Ê≥®ÔºöspliceÊñπÊ≥ï‰ºöÂú®ÂêØÁî®MSG_SPLICE_PAGESÈÄâÈ°πÊó∂‰ΩøÁî®„ÄÇ</p>
<p>ËøôÈáåÊàë‰ª¨‰ªãÁªçÊôÆÈÄöÊñπÊ≥ï skb_copy_datagram_from_iter()</p>
<p><code>skb_copy_datagram_from_iter()</code> ÊòØ Linux ÂÜÖÊ†∏‰∏≠Áî®‰∫éÂ∞ÜÊï∞ÊçÆ‰ªé <code>iov_iter</code> Ëø≠‰ª£Âô®Â§çÂà∂Âà∞Â•óÊé•Â≠óÁºìÂÜ≤Âå∫ (<code>sk_buff</code>) ‰∏≠ÁöÑÂáΩÊï∞„ÄÇÂÆÉÁî®‰∫éÂ§ÑÁêÜÊï∞ÊçÆÁöÑÊã∑Ë¥ùËøáÁ®ãÔºåÂ∞ÜÁî®Êà∑Á©∫Èó¥ÊàñÂÜÖÊ†∏‰∏≠ÁöÑÊï∞ÊçÆ‰º†ÈÄíÂà∞ <code>sk_buff</code>Ôºå‰ª•‰æøËøõË°åËøõ‰∏ÄÊ≠•ÁöÑÁΩëÁªú‰º†ËæìÊàñÂ§ÑÁêÜ„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">skb_copy_datagram_from_iter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				 <span class="k">struct</span> <span class="n">iov_iter</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				 <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag_iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Copy header. */</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// È¶ñÂÖàÂ∞ÜÂ§¥ÈÉ®Êï∞ÊçÆÂ§çÂà∂Âà∞ÁºìÂÜ≤Âå∫‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">copy</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_iter</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">from</span><span class="p">)</span> <span class="o">!=</span> <span class="n">copy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">offset</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Copy paged appendix. Hmm... why does this look so complicated? */</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Â§ÑÁêÜÈ°µÁâáÊÆµÁöÑÊï∞ÊçÆÊã∑Ë¥ù
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="kt">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nf">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">WARN_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nf">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">copy</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">size_t</span> <span class="n">copied</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">copy</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">copied</span> <span class="o">=</span> <span class="nf">copy_page_from_iter</span><span class="p">(</span><span class="nf">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">					  <span class="nf">skb_frag_off</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="n">copy</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">!=</span> <span class="n">copy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">offset</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">start</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Copy data from skb fragments (e.g., GSO fragments) */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">skb_walk_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">frag_iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">WARN_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">frag_iter</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">copy</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">copy</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">skb_copy_datagram_from_iter</span><span class="p">(</span><span class="n">frag_iter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="n">offset</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="n">from</span><span class="p">,</span> <span class="n">copy</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">offset</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">start</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">fault</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="read">read()
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ksys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>read()-&gt;ksys_read()</p>
<p><code>ksys_read</code> ÂáΩÊï∞ÊòØ Linux ÂÜÖÊ†∏‰∏≠Áî®‰∫éËØªÂèñÊñá‰ª∂ÊèèËø∞Á¨¶ÂÜÖÂÆπÁöÑÂáΩÊï∞„ÄÇÂÆÉÁöÑÁõÆÁöÑÊòØ‰ªéÊåáÂÆöÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶ (<code>fd</code>) ‰∏≠ËØªÂèñÊï∞ÊçÆÂà∞Áî®Êà∑Êèê‰æõÁöÑÁºìÂÜ≤Âå∫ (<code>buf</code>) ‰∏≠ÔºåÂπ∂ËøîÂõûËØªÂèñÁöÑÂ≠óËäÇÊï∞„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">ksys_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fdget_pos</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="nf">file_ppos</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">ppos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Ë∞ÉÁî® vfs_read() ÂáΩÊï∞ÊâßË°åÂÆûÈôÖÁöÑÊñá‰ª∂ËØªÂèñÊìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="nf">vfs_read</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ppos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fdput_pos</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ksys_read()-&gt;vfs_read()</p>
<p><code>vfs_read</code> ÂáΩÊï∞Ë¥üË¥£‰ªéÊñá‰ª∂ÂØπË±°ËØªÂèñÊï∞ÊçÆÂπ∂Â∞ÜÂÖ∂Êã∑Ë¥ùÂà∞Áî®Êà∑Á©∫Èó¥ÁöÑÁºìÂÜ≤Âå∫‰∏≠„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vfs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÂèØËØª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÂÖÅËÆ∏ËØªÂèñÊìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_CAN_READ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•Áî®Êà∑Á©∫Èó¥ÁºìÂÜ≤Âå∫ÁöÑÊúâÊïàÊÄß
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="o">!</span><span class="nf">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ë∞ÉÁî® rw_verify_area() È™åËØÅËØªÂèñÁöÑÂå∫ÂüüÊòØÂê¶ÂêàÊ≥ïÔºå‰∏ªË¶ÅÁî®‰∫éÊ£ÄÊü•Êñá‰ª∂ÁöÑÂÅèÁßªÈáèÂíåËØªÂèñÁöÑÂ≠óËäÇÊï∞ÊòØÂê¶Ë∂ÖÂá∫‰∫ÜÊñá‰ª∂ËæπÁïå„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ret</span> <span class="o">=</span> <span class="nf">rw_verify_area</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈôêÂà∂ËØªÂèñÂ≠óËäÇÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_RW_COUNT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">count</span> <span class="o">=</span>  <span class="n">MAX_RW_COUNT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ÊâßË°åËØªÂèñÊìç‰Ωú,ËøôÈáå‰ºöË∞ÉÁî®sock_read_iter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="c1">//Êóß
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="nf">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span><span class="p">)</span> <span class="c1">//Êñ∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="nf">new_sync_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Êõ¥Êñ∞ËØªÂèñÁöÑÁªüËÆ°‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">fsnotify_access</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">add_rchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">inc_syscr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>vfs_read()-&gt;sock_read_iter()</p>
<p><code>sock_read_iter()</code> ÊòØ Linux ÂÜÖÊ†∏‰∏≠Áî®‰∫éÂ§ÑÁêÜÂ•óÊé•Â≠óËØªÂèñÊìç‰ΩúÁöÑÂáΩÊï∞„ÄÇÂÆÉÁî®‰∫é‰ªéÂ•óÊé•Â≠ó‰∏≠ËØªÂèñÊï∞ÊçÆÔºåÂπ∂Â∞ÜÊï∞ÊçÆÂÜôÂÖ•Áî®Êà∑Á©∫Èó¥ÁöÑÁºìÂÜ≤Âå∫‰∏≠„ÄÇËøô‰∏™ÂáΩÊï∞Âà©Áî® <code>kiocb</code> Âíå <code>iov_iter</code> ÁªìÊûÑÊù•ÊîØÊåÅÂºÇÊ≠•ÂíåÂêëÈáèÂåñÁöÑ I/O Êìç‰Ωú„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sock_read_iter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iov_iter</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">msg_iter</span> <span class="o">=</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="p">.</span><span class="n">msg_iocb</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÊñá‰ª∂Ê†áÂøóÂåÖÂê´ O_NONBLOCK Êàñ iocb ‰∏≠ÁöÑÊ†áÂøóÂåÖÂê´ IOCB_NOWAITÔºåÂàôËÆæÁΩÆÈùûÈòªÂ°ûÊ†áÂøó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">||</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_flags</span> <span class="o">&amp;</span> <span class="n">IOCB_NOWAIT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Á°Æ‰øùÂÅèÁßªÈáè‰∏∫ 0ÔºåÂõ†‰∏∫ socket ‰∏çËÉΩËøõË°åÂÅèÁßªËØªÂÜô
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËø≠‰ª£Âô®Ê≤°ÊúâÊï∞ÊçÆÈúÄË¶ÅÂÜôÂÖ•ÔºåÁõ¥Êé•ËøîÂõû 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">iov_iter_count</span><span class="p">(</span><span class="n">to</span><span class="p">))</span>    <span class="cm">/* Match SYS5 behaviour */</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ë∞ÉÁî® sock_recvmsg Êù•Êé•Êî∂Ê∂àÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">res</span> <span class="o">=</span> <span class="nf">sock_recvmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êõ¥Êñ∞Ëø≠‰ª£Âô®ÁöÑÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_read_iter()-&gt;sock_recvmsg()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sock_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_recvmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span> <span class="o">?:</span> <span class="nf">sock_recvmsg_nosec</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_recvmsg()-&gt;sock_recvmsg_nosec()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sock_recvmsg_nosec</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">INDIRECT_CALL_INET</span><span class="p">(</span><span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">recvmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="n">inet6_recvmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="n">inet_recvmsg</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">trace_sock_recv_length_enabled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nf">call_trace_sock_recv_length</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_recvmsg_nosec()-&gt;unix_stream_recvmsg()</p>
<p><code>unix_stream_recvmsg()</code> ÊòØ Linux ÂÜÖÊ†∏‰∏≠Â§ÑÁêÜ UNIX ÂüüÂ•óÊé•Â≠óÊµÅÁ±ªÂûãÁöÑÊ∂àÊÅØÊé•Êî∂ÂáΩÊï∞„ÄÇÂÆÉ‰∏ªË¶ÅÁî®‰∫é‰ªéÊµÅÂºè UNIX ÂüüÂ•óÊé•Â≠ó‰∏≠Êé•Êî∂Êï∞ÊçÆÂπ∂Â°´ÂÖÖÂà∞ <code>msghdr</code> ÁªìÊûÑ‰∏≠„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_stream_read_state</span> <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">recv_actor</span> <span class="o">=</span> <span class="n">unix_stream_read_actor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">sock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_BPF_SYSCALL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">proto</span> <span class="o">*</span><span class="n">prot</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Â¶ÇÊûúÂ•óÊé•Â≠óÂçèËÆÆ‰∏çÊòØ UNIX ÂüüÂçèËÆÆÔºåÂàôË∞ÉÁî®ÂÖ∂‰ªñÂçèËÆÆÁöÑ recvmsg ÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">prot</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">unix_stream_proto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="nf">recvmsg</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="c1">// Ë∞ÉÁî®ÈÄöÁî®ÁöÑ UNIX ÊµÅËØªÂèñÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nf">unix_stream_read_generic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_stream_recvmsg()-&gt;unix_stream_read_generic()</p>
<p><code>unix_stream_read_generic()</code> ÊòØ‰∏Ä‰∏™Áî®‰∫é‰ªé UNIX ÂüüÂ•óÊé•Â≠óÊµÅ‰∏≠ËØªÂèñÊï∞ÊçÆÁöÑÂáΩÊï∞„ÄÇÂÆÉÁÆ°ÁêÜ‰ªéÂÜÖÊ†∏‰∏≠ÁöÑÂ•óÊé•Â≠óÁºìÂÜ≤Âå∫ (<code>sk_buff</code>) ‰∏≠ËØªÂèñÊï∞ÊçÆÁöÑÊï¥‰∏™ËøáÁ®ãÔºåÂπ∂Â§ÑÁêÜÂ§ö‰∏™Â§çÊùÇÂú∫ÊôØÔºåÂåÖÊã¨ÈùûÈòªÂ°ûËØªÂèñ„ÄÅÊé•Êî∂Â§ñÂ∏¶Êï∞ÊçÆÔºàOOBÔºâ„ÄÅÁ≠âÂæÖÊï∞ÊçÆÂèØÁî®Á≠â„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_read_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">unix_stream_read_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				    <span class="kt">bool</span> <span class="n">freezable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">scm_cookie</span> <span class="n">scm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">noblock</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">check_creds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">skip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">err</span> <span class="o">=</span> <span class="nf">unix_stream_recv_urg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ëé∑Âèñ socket ËØªÂèñÁöÑ‰ΩéÊ∞¥‰ΩçÊ†áËÆ∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">target</span> <span class="o">=</span> <span class="nf">sock_rcvlowat</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_WAITALL</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">timeo</span> <span class="o">=</span> <span class="nf">sock_rcvtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">noblock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scm</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Âä†ÈîÅ‰ª•Èò≤Ê≠¢Âú®ËØªÂèñËøáÁ®ã‰∏≠ÂèëÁîüÈòüÂàóÊ∑∑‰π±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">skip</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="nf">sk_peek_offset</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">drop_skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">redo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ÈîÅÂÆöÂ•óÊé•Â≠óÁöÑÁä∂ÊÄÅ‰ª•ËøõË°åÂÆâÂÖ®ÁöÑÊï∞ÊçÆËØªÂèñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">last</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">last_len</span> <span class="o">=</span> <span class="n">last</span> <span class="o">?</span> <span class="n">last</span><span class="o">-&gt;</span><span class="nl">len</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">skb</span> <span class="o">=</span> <span class="nf">manage_oob</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">redo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nl">again</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Ê£ÄÊü• socket ÈîôËØØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">err</span> <span class="o">=</span> <span class="nf">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Ê£ÄÊü•Êé•Êî∂Á´ØÂÖ≥Èó≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Á≠âÂæÖÊï∞ÊçÆÂà∞Êù•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">timeo</span> <span class="o">=</span> <span class="nf">unix_stream_data_wait</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeo</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						      <span class="n">last_len</span><span class="p">,</span> <span class="n">freezable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">err</span> <span class="o">=</span> <span class="nf">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">redo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">unlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//  Âæ™ÁéØÂ§ÑÁêÜ sk_buff Êï∞ÊçÆÔºåÊâæÂà∞Ë¶ÅÂºÄÂßãËØªÂèñÁöÑ skbÔºåÂπ∂Ë∑≥ËøáÂ∑≤Ë¢´ËØªÂèñÁöÑÊï∞ÊçÆ„ÄÇskip ÊòØÈúÄË¶ÅË∑≥ËøáÁöÑÊï∞ÊçÆÂ≠óËäÇÊï∞ÔºåÂÆÉÈÄöËøá‰∏éÊØè‰∏™ skb ÁöÑÈïøÂ∫¶ÊØîËæÉÔºåÂÜ≥ÂÆöÊòØÂê¶ÈúÄË¶ÅË∑≥ËøáÂΩìÂâçÁöÑ skbÔºåÁõ¥Âà∞ÊâæÂà∞ÈúÄË¶ÅËØªÂèñÁöÑ skb„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">while</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&gt;=</span> <span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">skip</span> <span class="o">-=</span> <span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">last</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">last_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_peek_next</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Ê£ÄÊü•Âπ∂ËÆæÁΩÆÊ∂àÊÅØÂèëÈÄÅËÄÖÁöÑÂá≠ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">check_creds</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">unix_skb_scm_eq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSCRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">			   <span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSPIDFD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">scm_set_cred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span> <span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">uid</span><span class="p">,</span> <span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">gid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_set_secdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">check_creds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Â∞ÜÂú∞ÂùÄ‰ø°ÊÅØÂ§çÂà∂Âà∞Ê∂àÊÅØ‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">DECLARE_SOCKADDR</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					 <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_copy_addr</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">sunaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Á°ÆÂÆöÊú¨Ê¨°Ë¶ÅËØªÂèñÁöÑÊï∞ÊçÆÈáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">chunk</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skip</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// recv_actor ÊòØ‰∏Ä‰∏™ÂáΩÊï∞ÊåáÈíàÔºåÁî®‰∫éÂ∞ÜÊï∞ÊçÆ‰ªé sk_buff Â§çÂà∂Âà∞Áî®Êà∑Á©∫Èó¥ÁöÑÁºìÂÜ≤Âå∫‰∏≠„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// recv_actor ‰ºöËØªÂèñ‰ªéÂÅèÁßªÈáè skip ÂºÄÂßãÁöÑ chunk Â≠óËäÇÁöÑÊï∞ÊçÆÂà∞ÊåáÂÆöÁöÑÁºìÂÜ≤Âå∫ÔºåÈÄöÂ∏∏Áî± unix_stream_read_actor ÊåáÂêëÁöÑÂáΩÊï∞Êù•ÂÆåÊàê„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">chunk</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="nf">recv_actor</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">drop_skb</span> <span class="o">=</span> <span class="o">!</span><span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">copied</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">copied</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">size</span> <span class="o">-=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">drop_skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Ê†áËÆ∞Ë¢´ËØªÂèñÁöÑÈÉ®ÂàÜÔºåÂ∞ÜÂ∑≤ËØªÂèñÁöÑÊï∞ÊçÆ‰ªéÁºìÂÜ≤Âå∫‰∏≠Ê†áËÆ∞‰∏∫Â∑≤Ê∂àË¥πÔºåÂπ∂Ë∞ÉÊï¥ÂÅèÁßªÈáèÔºåÂ¶ÇÊûúËØªÂèñÂÆåÊØïÂàôÂ∞Ü skb ‰ªéÈòüÂàó‰∏≠ÁßªÈô§Âπ∂ÈáäÊîæ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">consumed</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">sk_peek_offset_bwd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">scm_stat_del</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="nf">unix_detach_fds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">scm</span><span class="p">.</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nf">unix_peek_fds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">sk_peek_offset_fwd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">last</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">last_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_peek_next</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">scm_recv_unix</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">copied</span> <span class="o">?</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Âá†‰∏™Â•óÊé•Â≠óÁªìÊûÑ‰πãÈó¥ÁöÑÂå∫Âà´Â¶Ç‰∏ãË°®ÊâÄÁ§∫</p>
</blockquote>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">ÂêçÁß∞</th>
          <th style="text-align: left">Á±ªÂûã</th>
          <th style="text-align: left">‰ΩçÁΩÆ</th>
          <th style="text-align: left">‰∏ªË¶ÅÂäüËÉΩ</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong><code>socket</code></strong></td>
          <td style="text-align: left">Áî®Êà∑Á©∫Èó¥ÁªìÊûÑ</td>
          <td style="text-align: left">Áî®Êà∑Á©∫Èó¥</td>
          <td style="text-align: left">Áî±Â∫îÁî®Á®ãÂ∫èÂàõÂª∫ÂíåÊìç‰ΩúÁöÑÁΩëÁªúÂ•óÊé•Â≠óÊé•Âè£ÔºåÊèê‰æõÂØπÂ§ñÈÄö‰ø°ÂäüËÉΩ„ÄÇ</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>sock</code></strong></td>
          <td style="text-align: left">ÂÜÖÊ†∏Á©∫Èó¥ÁªìÊûÑ</td>
          <td style="text-align: left">ÂÜÖÊ†∏Á©∫Èó¥</td>
          <td style="text-align: left">ÂÜÖÊ†∏‰∏≠ÁöÑÂ•óÊé•Â≠óË°®Á§∫ÔºåÂ∞ÅË£ÖÂÖ∑‰ΩìÂçèËÆÆÊ†àÁöÑÂÆûÁé∞ÔºåË¥üË¥£ÁÆ°ÁêÜÁΩëÁªúËøûÊé•ÂíåÊï∞ÊçÆ‰º†Ëæì„ÄÇ</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>unix_sock</code></strong></td>
          <td style="text-align: left">ÂÜÖÊ†∏Á©∫Èó¥ÁªìÊûÑÔºà<code>sock</code>ÁöÑÂ≠êÁ±ªÔºâ</td>
          <td style="text-align: left">ÂÜÖÊ†∏Á©∫Èó¥</td>
          <td style="text-align: left">‰∏ìÁî®‰∫é Unix ÂüüÂ•óÊé•Â≠óÔºåÂ≠òÂÇ®ÁâπÂÆö‰∫é Unix ÂüüÂ•óÊé•Â≠óÁöÑÊï∞ÊçÆÔºàÂ¶ÇË∑ØÂæÑ„ÄÅÂú∞ÂùÄÁ≠âÔºâ„ÄÇ</td>
      </tr>
  </tbody>
</table></div>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ipc/">IPC</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            ÊúÄÂêéÊõ¥Êñ∞‰∫é 2024-12-15
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist", "waline-container"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/">
        
        
            <div class="article-image">
                <img src="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/1.dc5e838b8c6aae5fdbcc6d3483dda94f_hu11388172370948836222.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post ËøõÁ®ãÈó¥ÈÄö‰ø°ÔºàIPCÔºâÊ∫êÁ†ÅÂàÜÊûêÂèäÊÄªÁªì"
                        
                        data-hash="md5-3F6Di4xqrl/bzG00g92pTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">ËøõÁ®ãÈó¥ÈÄö‰ø°ÔºàIPCÔºâÊ∫êÁ†ÅÂàÜÊûêÂèäÊÄªÁªì</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E8%B0%83%E7%A0%94/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E8%B0%83%E7%A0%94/1.456b8b62f4e93ff289a0752cb9a275a0_hu14772543834815088792.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Âä†ÂØÜÁÆóÊ≥ïË∞ÉÁ†î"
                        
                        data-hash="md5-RWuLYvTpP/KJoHUsuaJ1oA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Âä†ÂØÜÁÆóÊ≥ïË∞ÉÁ†î</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }

    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":"ÊÑüË∞¢ÊÇ®ÁöÑËØÑËÆ∫"},"pageview":true,"requiredMeta":["nick"],"serverURL":"https://waline.chenyuan1125.top","visitor":true});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Lee
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
