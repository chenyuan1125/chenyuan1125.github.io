<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="æ·±å…¥å†…æ ¸æºç åˆ†æudsé€šä¿¡æœºåˆ¶">
<meta name="keywords" content="IPCã€UDSã€æºç åˆ†æã€è°ƒç ”"><title>Unix Domain Socketæºç å®ç°åˆ†æ(OLK 6.6)</title>

<link rel='canonical' href='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/'>

<link rel="stylesheet" href="/scss/style.min.1d7a77f66a9605dfbac1c7922a91290042c454a1166056d913fcbcea340dd583.css"><meta property='og:title' content="Unix Domain Socketæºç å®ç°åˆ†æ(OLK 6.6)">
<meta property='og:description' content="æ·±å…¥å†…æ ¸æºç åˆ†æudsé€šä¿¡æœºåˆ¶">
<meta property='og:url' content='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/'>
<meta property='og:site_name' content='è¾°è¿œ'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='IPC' /><meta property='article:published_time' content='2024-12-15T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-12-15T15:01:27&#43;08:00'/><meta property='og:image' content='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1.jpg' />
<meta name="twitter:title" content="Unix Domain Socketæºç å®ç°åˆ†æ(OLK 6.6)">
<meta name="twitter:description" content="æ·±å…¥å†…æ ¸æºç åˆ†æudsé€šä¿¡æœºåˆ¶"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://chenyuan1125.github.io/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1.jpg' />

<link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu4999655723030452168.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">è¾°è¿œ</a></h1>
            <h2 class="site-description">å¤©å°†é™å¤§ä»»äºæ–¯äººä¹Ÿ</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='/'
                        
                        title="é¦–é¡µ&amp;å…³äº"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/chenyuan1125'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>é“¾æ¥</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://chenyuan1125.github.io/en/" >English</option>
                                
                                    <option value="https://chenyuan1125.github.io/" selected>ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#unix-domain-socketæºç å®ç°åˆ†æolk-66">Unix Domain Socketæºç å®ç°åˆ†æ(OLK 6.6)</a>
      <ol>
        <li><a href="#socket"><strong>socket()</strong></a></li>
        <li><a href="#bind">bind()</a></li>
        <li><a href="#listen">listen()</a></li>
        <li><a href="#connect">connect()</a></li>
        <li><a href="#accept">accept()</a></li>
        <li><a href="#write">write()</a></li>
        <li><a href="#read">read()</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/">
                <img src="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1_hu379590808969644185.jpg"
                        srcset="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1_hu379590808969644185.jpg 800w, /p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1_hu7618736452145915547.jpg 1600w"
                        width="800" 
                        height="500" 
                        loading="lazy"
                        alt="Featured image of post Unix Domain Socketæºç å®ç°åˆ†æ(OLK 6.6)" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%97%A5%E5%B8%B8%E7%A0%94%E7%A9%B6/" style="background-color: #364073; color: #fff;">
                æ—¥å¸¸ç ”ç©¶
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/">Unix Domain Socketæºç å®ç°åˆ†æ(OLK 6.6)</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            æ·±å…¥å†…æ ¸æºç åˆ†æudsé€šä¿¡æœºåˆ¶
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-12-15</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 33 åˆ†é’Ÿ
                </time>
            </div>
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
  <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
  <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
</svg>
                <time class="article-words">
                    16124å­—
                </time>
        </div>
        

    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="unix-domain-socketæºç å®ç°åˆ†æolk-66">Unix Domain Socketæºç å®ç°åˆ†æ(OLK 6.6)
</h2><blockquote>
<p>å¯¹äºæ­£å¸¸çš„udsé€šä¿¡çš„åˆ›å»ºä¸€èˆ¬åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šserverå’Œclientï¼Œæˆ‘ä»¬åˆ†åˆ«ä»serverå’Œclientæ„å»ºä»£ç çš„å…³é”®å‡½æ•°æ¥åˆ†æudsçš„æºç å®ç°</p>
</blockquote>
<p>serverå®ç°ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Server code (server.c)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/un.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOCKET_PATH &#34;unix_socket&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp">#define BUFFER_SIZE 100
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">server_sock</span><span class="p">,</span> <span class="n">client_sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">server_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">server_sock</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set server address structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strncpy</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Bind the socket to the address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlink</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">bind</span><span class="p">(</span><span class="n">server_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;bind error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Listen for incoming connections
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">listen</span><span class="p">(</span><span class="n">server_sock</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;listen error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Server is listening on %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Accept a client connection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">client_sock</span> <span class="o">=</span> <span class="nf">accept</span><span class="p">(</span><span class="n">server_sock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;accept error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Receive data from the client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="p">[</span><span class="n">bytes_received</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Received from client: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Send a response to the client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">response</span> <span class="o">=</span> <span class="s">&#34;Message received&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">response</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Clean up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">server_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlink</span><span class="p">(</span><span class="n">SOCKET_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>clientå®ç°ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Client code (client.c)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/un.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SOCKET_PATH &#34;unix_socket&#34;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">client_sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">server_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Create socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">client_sock</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set server address structure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server_addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">strncpy</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">SOCKET_PATH</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Connect to the server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">connect</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;connect error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Send data to the server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">message</span> <span class="o">=</span> <span class="s">&#34;Hello, server!&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">write</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Receive response from the server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">bytes_received</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">client_sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bytes_received</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">buffer</span><span class="p">[</span><span class="n">bytes_received</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Received from server: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Clean up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">close</span><span class="p">(</span><span class="n">client_sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šä¿¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://docs.acoinfo.com/assets/GnT3bM2sUoPLPoxZIk8cGgOonCf-BpH5rQYX.png"
	
	
	
	loading="lazy"
	
		alt="udsé€šä¿¡æœºåˆ¶"
	
	
></p>
<p>æºç åˆ†æç»“æ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%871.png"
	width="4389"
	height="2211"
	srcset="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%871_hu6564432392964446896.png 480w, /p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%871_hu9100531612404831662.png 1024w"
	loading="lazy"
	
		alt="æºç åˆ†æç»“æ„å›¾1"
	
	
		class="gallery-image" 
		data-flex-grow="198"
		data-flex-basis="476px"
	
></p>
<p><img src="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%872.png"
	width="3264"
	height="2164"
	srcset="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%872_hu14611210765363944589.png 480w, /p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/assets/%E5%9B%BE%E7%89%872_hu7793714986617602277.png 1024w"
	loading="lazy"
	
		alt="æºç åˆ†æç»“æ„å›¾1"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="361px"
	
></p>
<p><strong>unixåŸŸå¥—æ¥å­—åœ°å€ç»“æ„</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//include/uapi/linux/un.h
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#define UNIX_PATH_MAX   108
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">__kernel_sa_family_t</span> <span class="n">sun_family</span><span class="p">;</span> <span class="cm">/* AF_UNIX */</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">sun_path</span><span class="p">[</span><span class="n">UNIX_PATH_MAX</span><span class="p">];</span>   <span class="cm">/* pathname */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="socket"><strong>socket()</strong>
</h3><blockquote>
<p>ä¸€å¥è¯æ¦‚æ‹¬socketå‡½æ•°ï¼šåˆ›å»ºå¹¶åˆå§‹åŒ–å¥—æ¥å­—ï¼Œåˆ›å»ºæ–‡ä»¶æè¿°ç¬¦å¹¶å…³è”ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscallç³»ç»Ÿè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>socket()-&gt;__sys_socket()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//__sys_socketé€šè¿‡è°ƒç”¨__sys_socket_createå‡½æ•°è¿”å›sockå¯¹è±¡ï¼Œæœ€åé€šè¿‡sock_map_fdå‡½æ•°å°†å¯¹è±¡è½¬åŒ–ä¸ºæ–‡ä»¶æè¿°ç¬¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">__sys_socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sock</span> <span class="o">=</span> <span class="nf">__sys_socket_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				   <span class="nf">update_socket_protocol</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">sock</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">flags</span> <span class="o">=</span> <span class="n">type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_TYPE_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">SOCK_NONBLOCK</span> <span class="o">!=</span> <span class="n">O_NONBLOCK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">sock_map_fd</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¥—æ¥å­—çš„åˆ›å»ºç”±__sys_socket_createå®Œæˆï¼Œsock_map_fdåˆ†é…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç„¶åä¸ºå¥—æ¥å­—åˆ†é…æ–‡ä»¶å¯¹è±¡ï¼Œæœ€åå°†ä¸¤è€…å…³è”èµ·æ¥ã€‚</p>
<blockquote>
<p>sock_map_fd()å°†sockç»“æ„æ˜ å°„ä¸ºæ–‡ä»¶æè¿°ç¬¦</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">sock_map_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//è·å–å¯ç”¨æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">get_unused_fd_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//è°ƒç”¨ sock_alloc_file() ä¸ºå¥—æ¥å­—åˆ†é…ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ (struct file)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">newfile</span> <span class="o">=</span> <span class="nf">sock_alloc_file</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å¦‚æœåˆ†é…æˆåŠŸï¼Œè°ƒç”¨ fd_install(fd, newfile) å°†æ–‡ä»¶å¯¹è±¡ä¸æ–‡ä»¶æè¿°ç¬¦ (fd) å…³è”èµ·æ¥ï¼Œå¹¶è¿”å›è¯¥æ–‡ä»¶æè¿°ç¬¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_map_fd()-&gt;sock_alloc_file()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">sock_alloc_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dname</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">dname</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">?</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot_creator</span><span class="o">-&gt;</span><span class="nl">name</span> <span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆ†é…ä¼ªæ–‡ä»¶ (alloc_file_pseudo)ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">file</span> <span class="o">=</span> <span class="nf">alloc_file_pseudo</span><span class="p">(</span><span class="nf">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">),</span> <span class="n">sock_mnt</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">O_RDWR</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">				<span class="o">&amp;</span><span class="n">socket_file_ops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æ–‡ä»¶å¯¹è±¡åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">|=</span> <span class="n">FMODE_NOWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">stream_open</span><span class="p">(</span><span class="nf">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">),</span> <span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sock_alloc_file</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_socket()-&gt;__sys_socket_create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//__sys_socket_createè°ƒç”¨sock_createåˆ›å»ºsocket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="nf">__sys_socket_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Check the SOCK_* constants for consistency.  */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">!=</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">((</span><span class="n">SOCK_MAX</span> <span class="o">|</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">&amp;</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUILD_BUG_ON</span><span class="p">(</span><span class="n">SOCK_NONBLOCK</span> <span class="o">&amp;</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_TYPE_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">|</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">type</span> <span class="o">&amp;=</span> <span class="n">SOCK_TYPE_MASK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">retval</span> <span class="o">=</span> <span class="nf">sock_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="n">retval</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_socket_create()-&gt;sock_create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//sock_createè°ƒç”¨__sock_create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	sock_create - creates a socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@family: protocol family (AF_INET, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@type: communication type (SOCK_STREAM, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@protocol: protocol (0, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@res: new socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	A wrapper around __sock_create().
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	Returns 0 or an error. This function internally uses GFP_KERNEL.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sock_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sock_create</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//EXPORT_SYMBOL() æ˜¯ä¸€ä¸ªå†…æ ¸å®ï¼Œç”¨äºå°†ç¬¦å·ï¼ˆå‡½æ•°æˆ–å˜é‡ï¼‰å¯¼å‡ºåˆ°å†…æ ¸çš„ç¬¦å·è¡¨ä¸­ï¼Œä»¥ä¾¿è¯¥å‡½æ•°å¯ä»¥è¢«å…¶ä»–å†…æ ¸æ¨¡å—ä½¿ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sock_create</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sock_create-&gt;unix_create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	__sock_create - creates a socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@net: net namespace
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@family: protocol family (AF_INET, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@type: communication type (SOCK_STREAM, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@protocol: protocol (0, ...)
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@res: new socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	@kern: boolean for kernel space sockets
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	Creates a new socket and assigns it to @res, passing through LSM.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	Returns 0 or an error. On failure @res is set to %NULL. @kern must
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	be set to true if the socket resides in kernel space.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *	This function internally uses GFP_KERNEL.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sock_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="o">*</span><span class="n">pf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//Check if creating a new socket is allowed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *	Allocate the socket and allow the family to set things up. if
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *	the protocol is 0, the family is instructed to select an appropriate
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *	default.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sock_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">net_warn_ratelimited</span><span class="p">(</span><span class="s">&#34;socket: no more sockets</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ENFILE</span><span class="p">;</span>	<span class="cm">/* Not exactly a match, but its the
</span></span></span><span class="line"><span class="cl"><span class="cm">				   closest posix thing */</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="n">pf</span> <span class="o">=</span> <span class="nf">rcu_dereference</span><span class="p">(</span><span class="n">net_families</span><span class="p">[</span><span class="n">family</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * We will call the -&gt;create function, that possibly is in a loadable
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * module, so we have to bump that loadable module refcnt first.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="nf">create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">__sock_create</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>sock_create()</code> å‡½æ•°é¦–å…ˆè°ƒç”¨<code>security_socket_create</code> æ£€æŸ¥æ˜¯å¦æœ‰æƒé™åˆ›å»ºæ–°çš„socketæ–‡ä»¶ï¼Œæ¥ç€è°ƒç”¨<code>sock_alloc()</code> ç”³è¯·ä¸€ä¸ª <code>struct socket</code> ç»“æ„ï¼Œç„¶åè°ƒç”¨æŒ‡å®šåè®®æ—çš„ <code>create()</code> å‡½æ•°ï¼ˆ<code>net_families[family]-&gt;create()</code>ï¼‰è¿›è¡Œè¿›ä¸€æ­¥çš„åˆ›å»ºåŠŸèƒ½ã€‚<code>net_families</code> å˜é‡çš„ç±»å‹ä¸º <code>struct net_proto_family</code>ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">net_proto_family</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">family</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">create</span><span class="p">)(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>family</code> å­—æ®µå¯¹åº”çš„å°±æ˜¯å…·ä½“çš„åè®®æ—ï¼Œè€Œ <code>create</code> å­—æ®µæŒ‡å®šäº†å…¶åˆ›å»ºsocketçš„æ–¹æ³•ã€‚ä¸€ä¸ªå…·ä½“åè®®æ—éœ€è¦é€šè¿‡è°ƒç”¨ <code>sock_register()</code> å‡½æ•°å‘ç³»ç»Ÿæ³¨å†Œå…¶åˆ›å»ºsocketçš„æ–¹æ³•ã€‚ä¾‹å¦‚ <code>Unix socket</code> å°±åœ¨åˆå§‹åŒ–æ—¶é€šè¿‡ä¸‹é¢çš„ä»£ç æ³¨å†Œï¼š</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">unix_family_ops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">PF_UNIX</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">unix_create</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">af_unix_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unix_family_ops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ‰€ä»¥ä»ä¸Šé¢çš„ä»£ç å¯ä»¥æŒ‡å®šï¼Œå¯¹äº <code>Unix socket</code> çš„è¯ï¼Œ<code>net_families[family]-&gt;create()</code> è¿™è¡Œä»£ç å®é™…è°ƒç”¨çš„æ˜¯ <code>unix_create()</code> å‡½æ•°ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//unix_createåˆå§‹åŒ–å¥—æ¥å­—å¹¶æ ¹æ®ç±»å‹è°ƒç”¨åˆé€‚çš„å¤„ç†å‡½æ•°ï¼ŒåŒæ—¶è°ƒç”¨unix_create1å‡½æ•°åˆ›å»ºsocketã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å°†å¥—æ¥å­—çŠ¶æ€è®¾ç½®ä¸ºæœªè¿æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_UNCONNECTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//æ ¹æ®å¥—æ¥å­—ç±»å‹è®¾ç½®æ“ä½œï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_STREAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unix_stream_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *	Believe it or not BSD has AF_UNIX, SOCK_RAW though
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *	nothing uses it.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_RAW</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SOCK_DGRAM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">fallthrough</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_DGRAM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unix_dgram_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SOCK_SEQPACKET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">unix_seqpacket_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ESOCKTNOSUPPORT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_create1</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">kern</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_create()-&gt;unix_create1()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//åˆ†é…èµ„æºå’Œåˆå§‹åŒ–å„ç§å†…éƒ¨æ•°æ®ç»“æ„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">unix_create1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//æ ¹æ®å¥—æ¥å­—ç±»å‹ (SOCK_STREAM, SOCK_DGRAM æˆ– SOCK_SEQPACKET)ï¼Œè°ƒç”¨ sk_alloc() åˆ†é…ä¸€ä¸ªæ–°çš„ sock å¯¹è±¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_STREAM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unix_stream_proto</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="cm">/*dgram and  seqpacket */</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_UNIX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">unix_dgram_proto</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//å°†å¥—æ¥å­— sock ä¸sockå¯¹è±¡ sk ç›¸å…³è”ï¼Œåˆå§‹åŒ–æ•°æ®ç»“æ„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆå§‹åŒ– sk ç»“æ„çš„æˆå‘˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span>		<span class="o">=</span> <span class="nf">unix_unbound_hash</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span>	<span class="o">=</span> <span class="n">GFP_KERNEL_ACCOUNT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_write_space</span>	<span class="o">=</span> <span class="n">unix_write_space</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span>	<span class="o">=</span> <span class="n">net</span><span class="o">-&gt;</span><span class="n">unx</span><span class="p">.</span><span class="n">sysctl_max_dgram_qlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_destruct</span>		<span class="o">=</span> <span class="n">unix_sock_destructor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u</span>	  <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>struct socket</code> æ˜¯ Linux ç½‘ç»œæ ˆä¸­è¡¨ç¤ºä¸€ä¸ªå¥—æ¥å­—çš„æ ¸å¿ƒç»“æ„ï¼Œé€šå¸¸ç”¨äºä¸ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºè¿›è¡Œäº¤äº’ã€‚<code>sock</code> æ˜¯ç”¨æˆ·ç©ºé—´ç¨‹åºä¸å†…æ ¸ä¸­çš„ç½‘ç»œæ ˆé€šä¿¡çš„æ¥å£ï¼Œä»£è¡¨äº†ä¸€ä¸ªç½‘ç»œç«¯ç‚¹ï¼Œç”¨äºå»ºç«‹è¿æ¥ã€å‘é€/æ¥æ”¶æ•°æ®ç­‰æ“ä½œ</p>
<p><code>unix_sock</code> æ˜¯ä¸€ä¸ªåœ¨ Linux å†…æ ¸ä¸­ä¸ Unix åŸŸå¥—æ¥å­—ç›¸å…³çš„ç§æœ‰æ•°æ®ç»“æ„ã€‚å®ƒæ‰©å±•äº† <code>struct sock</code>ï¼Œç”¨äºå­˜å‚¨ä¸ Unix åŸŸå¥—æ¥å­—ç›¸å…³çš„ç‰¹å®šæ•°æ®ã€‚</p>
<h3 id="bind">bind()
</h3><blockquote>
<p>ä¸€å¥è¯æ¦‚æ‹¬bindå‡½æ•°ï¼šå°†udsåœ°å€ç»‘å®šåˆ°å¥—æ¥å­—</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscallç³»ç»Ÿè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">umyaddr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">umyaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>bind()-&gt;__sys_bind()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">umyaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//æŸ¥æ‰¾å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sockfd_lookup_light</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//å°†ç”¨æˆ·ç©ºé—´åœ°å€ç§»åŠ¨åˆ°å†…æ ¸ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">err</span> <span class="o">=</span> <span class="nf">move_addr_to_kernel</span><span class="p">(</span><span class="n">umyaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//å®‰å…¨æ£€æŸ¥(æƒé™)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						   <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						   <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">//æ‰§è¡Œå…·ä½“åè®®å®ç°çš„bindå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">err</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">bind</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						      <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">						      <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fput_light</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_bind()-&gt;unix_bind()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span> <span class="c1">// å°†é€šç”¨åœ°å€ç»“æ„è½¬æ¢ä¸ºUNIXä¸“ç”¨çš„åœ°å€ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span> <span class="c1">// è·å–å¥—æ¥å­—çš„åŸºç¡€ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="kt">int</span> <span class="n">err</span><span class="p">;</span> <span class="c1">// ç”¨äºå­˜å‚¨é”™è¯¯ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"> <span class="c1">// å½“ sun_path ä¸ºç©ºæ—¶ï¼Œunix_autobind() ä¼šä¸ºå¥—æ¥å­—è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ã€ä¸´æ—¶çš„åœ°å€ï¼Œé€šå¸¸åœ¨å†…æ ¸ä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶æ¥è¡¨ç¤ºè¯¥å¥—æ¥å­—çš„åœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="n">addr_len</span> <span class="o">==</span> <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">,</span> <span class="n">sun_path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> 
</span></span><span class="line"><span class="cl">     <span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_family</span> <span class="o">==</span> <span class="n">AF_UNIX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="nf">unix_autobind</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// éªŒè¯åœ°å€æ˜¯å¦åˆæ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_validate_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1">// æ ¹æ®sun_pathçš„ç¬¬ä¸€ä¸ªå­—ç¬¦å†³å®šè°ƒç”¨å“ªä¸ªç»‘å®šå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">if</span> <span class="p">(</span><span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">     <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_bind_bsd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span> <span class="c1">// è°ƒç”¨BSDé£æ ¼åœ°å€ç»‘å®šå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">else</span>
</span></span><span class="line"><span class="cl">     <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_bind_abstract</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span> <span class="c1">// è°ƒç”¨æŠ½è±¡åœ°å€ç»‘å®šå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è¿™é‡Œæ¶‰åŠåˆ°äº†ä¸‰ç§ä¸åŒçš„bindå‡½æ•°è°ƒç”¨ï¼Œè‡ªåŠ¨ç»‘å®š(<code>unix_autobind</code>)ã€BSD é£æ ¼ (<code>unix_bind_bsd()</code>) å’ŒæŠ½è±¡é£æ ¼ (<code>unix_bind_abstract()</code>)</p>
</blockquote>
<ol>
<li><strong>BSD é£æ ¼ç»‘å®š</strong> (<code>unix_bind_bsd()</code>)
<ul>
<li><strong>è·¯å¾„åœ°å€ç»‘å®š</strong>ï¼šBSD é£æ ¼çš„ UNIX domain socket ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ä½œä¸ºåœ°å€ã€‚ä¾‹å¦‚ï¼š<code>/tmp/mysocket</code>ï¼Œå³ <code>sun_path</code> çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ <code>/</code>ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†çš„è·¯å¾„ã€‚</li>
<li><strong>æ–‡ä»¶ç³»ç»Ÿä¾èµ–</strong>ï¼šBSD é£æ ¼çš„åœ°å€å®é™…ä¸Šæ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªè·¯å¾„ï¼Œå› æ­¤å®ƒéœ€è¦åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æ–‡ä»¶èŠ‚ç‚¹ï¼Œè¿™æ ·å…¶ä»–è¿›ç¨‹å°±å¯ä»¥é€šè¿‡è®¿é—®è¿™ä¸ªæ–‡ä»¶èŠ‚ç‚¹æ¥ä¸è¯¥å¥—æ¥å­—é€šä¿¡ã€‚</li>
<li><strong>æŒä¹…æ€§</strong>ï¼šç”±äºæ˜¯åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„ï¼ŒBSD é£æ ¼çš„ UNIX socket åœ°å€åœ¨ç¨‹åºé€€å‡ºåæ–‡ä»¶ä»ç„¶å­˜åœ¨ï¼Œå› æ­¤éœ€è¦æ˜¾å¼åœ°åˆ é™¤è·¯å¾„ï¼ˆå³ä½¿ç”¨ <code>unlink()</code>ï¼‰ï¼Œå¦åˆ™ä¸‹æ¬¡ç»‘å®šåŒæ ·çš„è·¯å¾„å¯èƒ½ä¼šå¤±è´¥ã€‚</li>
</ul>
</li>
<li><strong>æŠ½è±¡é£æ ¼ç»‘å®š</strong> (<code>unix_bind_abstract()</code>)
<ul>
<li><strong>ä¸ä¾èµ–äºæ–‡ä»¶ç³»ç»Ÿ</strong>ï¼šæŠ½è±¡é£æ ¼çš„ UNIX domain socket åœ°å€ä¸æ˜¯åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„ï¼Œè€Œæ˜¯ç”±ä¸€ä¸ªä»¥ <code>NUL</code>ï¼ˆç©ºå­—ç¬¦ï¼Œ<code>'\0'</code>ï¼‰å¼€å¤´çš„å­—ç¬¦ä¸²ä½œä¸ºåœ°å€ã€‚å› ä¸ºè¿™ä¸ªåœ°å€ä¸æ˜¯æ–‡ä»¶è·¯å¾„ï¼Œæ‰€ä»¥å®ƒä¸ä¾èµ–æ–‡ä»¶ç³»ç»Ÿï¼Œé€‚åˆåœ¨æŸäº›æƒ…å†µä¸‹é¿å…æ–‡ä»¶ç³»ç»Ÿçš„å¤æ‚æ€§æˆ–å¼€é”€ã€‚</li>
<li><strong>ä»…åœ¨å†…æ ¸ä¸­å­˜åœ¨</strong>ï¼šæŠ½è±¡åœ°å€çš„ä½œç”¨åŸŸä»…é™äºå†…æ ¸å†…éƒ¨ï¼Œå®ƒä¸éœ€è¦åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºèŠ‚ç‚¹ï¼Œå› æ­¤å®Œå…¨ç”±å†…æ ¸ç®¡ç†ã€‚è¿™æ ·å¯ä»¥å‡å°‘å¯¹ç£ç›˜çš„ä¾èµ–ï¼ŒåŒæ—¶åœ¨æŸäº›ç³»ç»Ÿï¼ˆå¦‚æ²¡æœ‰æŒä¹…å­˜å‚¨çš„åµŒå…¥å¼ç³»ç»Ÿï¼‰ä¸­ä¹Ÿå¾ˆæœ‰ç”¨ã€‚</li>
<li><strong>ä¸´æ—¶æ€§</strong>ï¼šæŠ½è±¡åœ°å€çš„ç”Ÿå‘½å‘¨æœŸä¸ç»‘å®šè¯¥åœ°å€çš„è¿›ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒï¼Œå½“è¿›ç¨‹ç»“æŸæ—¶ï¼ŒæŠ½è±¡åœ°å€ä¹Ÿéšä¹‹é‡Šæ”¾ã€‚å®ƒä¸éœ€è¦åƒ BSD é£æ ¼é‚£æ ·æ‰‹åŠ¨åˆ é™¤è·¯å¾„ã€‚</li>
</ul>
</li>
</ol>
<p><strong>BSD é£æ ¼æä¾›äº†ä¸€ç§åŸºäºæ–‡ä»¶ç³»ç»Ÿçš„åœ°å€ç»‘å®šæ–¹å¼ï¼Œå…·æœ‰æŒä¹…æ€§å’Œæ–‡ä»¶æƒé™ç®¡ç†çš„ä¼˜ç‚¹ï¼Œé€‚åˆéœ€è¦é•¿æœŸé€šä¿¡å’Œæ–‡ä»¶æƒé™æ§åˆ¶çš„åº”ç”¨åœºæ™¯ã€‚</strong></p>
<p><strong>æŠ½è±¡é£æ ¼åˆ™æä¾›äº†ä¸€ç§å†…æ ¸ç®¡ç†çš„è½»é‡åŒ–åœ°å€ç»‘å®šæ–¹å¼ï¼Œé¿å…äº†æ–‡ä»¶ç³»ç»Ÿçš„ä¾èµ–ï¼Œæ›´é€‚åˆä¸´æ—¶æ€§é€šä¿¡ï¼Œå‡å°‘äº†èµ„æºå ç”¨å’Œç®¡ç†å¼€é”€ã€‚</strong></p>
<blockquote>
<p>ç¬¬ä¸€ç§:unix_bind()-&gt;unix_autobind()</p>
<p><code>unix_autobind()</code> æ˜¯ä¸€ä¸ªç”¨äºè‡ªåŠ¨ä¸ºå¥—æ¥å­—åˆ†é…åœ°å€çš„å‡½æ•°ï¼Œé€‚ç”¨äº UNIX domain socket æ²¡æœ‰æä¾›å…·ä½“ç»‘å®šåœ°å€çš„æƒ…å†µã€‚å½“ç”¨æˆ·è°ƒç”¨ <code>bind()</code> ä½†æ˜¯æ²¡æœ‰æŒ‡å®šåœ°å€æ—¶ï¼Œ<code>unix_autobind()</code> ä¼šè¢«è°ƒç”¨ï¼Œå®ƒä¼šä¸ºå¥—æ¥å­—ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ã€ä¸´æ—¶çš„æŠ½è±¡åœ°å€ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_autobind</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_hash</span><span class="p">,</span> <span class="n">old_hash</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u32</span> <span class="n">lastnum</span><span class="p">,</span> <span class="n">ordernum</span><span class="p">;</span> <span class="c1">//ordernum å’Œ lastnumï¼šç”¨äºç”Ÿæˆå”¯ä¸€çš„æŠ½è±¡åœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="nf">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä½¿ç”¨ kzalloc() ä¸º unix_address ç»“æ„åˆ†é…å†…å­˜ï¼ŒåŒ…å«äº†åœ°å€ç»“æ„å’Œ sun_path çš„å­˜å‚¨ç©ºé—´ã€‚å¦‚æœå†…å­˜åˆ†é…å¤±è´¥ï¼Œè¿”å› -ENOMEMã€‚ä½¿ç”¨ kzalloc() ä¸º unix_address ç»“æ„åˆ†é…å†…å­˜ï¼ŒåŒ…å«äº†åœ°å€ç»“æ„å’Œ sun_path çš„å­˜å‚¨ç©ºé—´ã€‚å¦‚æœå†…å­˜åˆ†é…å¤±è´¥ï¼Œè¿”å› -ENOMEMã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">addr</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">		       <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">,</span> <span class="n">sun_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">,</span> <span class="n">sun_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">refcount_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ä½¿ç”¨ get_random_u32() è·å–ä¸€ä¸ªéšæœºæ•°ï¼Œç”¨äºç”Ÿæˆå”¯ä¸€çš„æŠ½è±¡åœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ordernum</span> <span class="o">=</span> <span class="nf">get_random_u32</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// lastnum ä¿å­˜äº†éšæœºæ•°çš„ä½ 20 ä½ï¼Œç”¨äºé™åˆ¶å¾ªç¯æ¬¡æ•°ï¼Œç¡®ä¿ä¸ä¼šæ— é™å¾ªç¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">lastnum</span> <span class="o">=</span> <span class="n">ordernum</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">retry</span><span class="p">:</span>  <span class="c1">// ç”Ÿæˆå’Œæ£€æŸ¥åœ°å€å”¯ä¸€æ€§ (retry)ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ordernum</span> <span class="o">=</span> <span class="p">(</span><span class="n">ordernum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">sprintf</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">sun_path</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;%05x&#34;</span><span class="p">,</span> <span class="n">ordernum</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">new_hash</span> <span class="o">=</span> <span class="nf">unix_abstract_hash</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">unix_table_double_lock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥åœ°å€æ˜¯å¦å·²å­˜åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="nf">__unix_find_socket_byname</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">unix_table_double_unlock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* __unix_find_socket_byname() may take long time if many names
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * are already in use.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//å¦‚æœåœ°å€å·²å­˜åœ¨ï¼Œè§£é”å“ˆå¸Œè¡¨ï¼Œå¹¶è°ƒç”¨ cond_resched() è®©å‡º CPU èµ„æºï¼Œç„¶åç»§ç»­ç”Ÿæˆæ–°çš„åœ°å€ï¼ˆè·³è½¬åˆ° retry æ ‡ç­¾ï¼‰ã€‚å¦‚æœæ‰€æœ‰åœ°å€éƒ½å·²ç”¨å°½ï¼Œè¿”å› -ENOSPCï¼Œè¡¨ç¤ºæ²¡æœ‰ç©ºé—´å¯ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">cond_resched</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ordernum</span> <span class="o">==</span> <span class="n">lastnum</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* Give up if all names seems to be in use. */</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_release_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// __unix_set_addr_hash() å°†ç”Ÿæˆçš„åœ°å€è®¾ç½®åˆ°å¥—æ¥å­—ä¸­ï¼Œå¹¶æ›´æ–°å“ˆå¸Œè¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">__unix_set_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">unix_table_double_unlock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>	<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ç¬¬äºŒç§ï¼šunix_bind()-&gt;unix_bind_abstract()</p>
<p><code>unix_bind_abstract()</code> æ˜¯ä¸€ä¸ªç”¨äºå°† UNIX domain socket åœ°å€ç»‘å®šåˆ°å¥—æ¥å­—çš„å†…æ ¸å‡½æ•°ï¼Œä¸“é—¨ç”¨äºæŠ½è±¡é£æ ¼åœ°å€ï¼ˆå³ä¸ä¾èµ–äºæ–‡ä»¶ç³»ç»Ÿçš„åœ°å€ï¼‰ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£ç¡®ä¿å¥—æ¥å­—è¢«ç»‘å®šåˆ°ä¸€ä¸ªå”¯ä¸€çš„æŠ½è±¡åœ°å€ï¼Œå¹¶å¯¹åœ°å€è¿›è¡Œå“ˆå¸Œå’Œæ³¨å†Œå¤„ç†ã€‚ä»¥ä¸‹æ˜¯å¯¹è¯¥å‡½æ•°çš„è¯¦ç»†åˆ†æã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_bind_abstract</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			      <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_hash</span><span class="p">,</span> <span class="n">old_hash</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// åˆ›å»ºUNIXåœ°å€,ä¸ºæŠ½è±¡åœ°å€åˆ†é…å†…å­˜ï¼Œå¹¶å°†ç”¨æˆ·æä¾›çš„åœ°å€æ•°æ®ï¼ˆsunaddrï¼‰è½¬æ¢ä¸ºå†…æ ¸ä½¿ç”¨çš„åœ°å€ç»“æ„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr</span> <span class="o">=</span> <span class="nf">unix_create_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ä½¿ç”¨ unix_abstract_hash() è®¡ç®—æ–°åœ°å€çš„å“ˆå¸Œå€¼ï¼Œç”¨äºå°†æŠ½è±¡åœ°å€æ”¾å…¥å†…æ ¸ä¸­çš„å“ˆå¸Œè¡¨è¿›è¡Œç®¡ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">new_hash</span> <span class="o">=</span> <span class="nf">unix_abstract_hash</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//__unix_set_addr_hash() è®¾ç½®æ–°çš„ç»‘å®šåœ°å€ï¼Œå¹¶å°†å…¶æ’å…¥å“ˆå¸Œè¡¨ä¸­ï¼Œä»¥ä¾¿åç»­å¯ä»¥é€šè¿‡åœ°å€å¿«é€Ÿæ‰¾åˆ°å¯¹åº”çš„å¥—æ¥å­—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">__unix_set_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ç¬¬ä¸‰ç§ï¼šunix_bind()-&gt;unix_bind_bsd()</p>
<p><code>unix_bind_bsd()</code> æ˜¯å†…æ ¸ä¸­ç”¨äºå°† BSD é£æ ¼çš„ UNIX domain socket åœ°å€ç»‘å®šåˆ°å¥—æ¥å­—çš„å‡½æ•°ã€‚å®ƒå®ç°äº†å°†å¥—æ¥å­—åœ°å€ç»‘å®šåˆ°æ–‡ä»¶ç³»ç»Ÿè·¯å¾„çš„é€»è¾‘ï¼Œå¹¶ç¡®ä¿åœ°å€å”¯ä¸€æ€§å’Œç›¸åº”çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™ä¸ªå‡½æ•°çš„è¯¦ç»†åˆ†æã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_bind_bsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="kt">int</span> <span class="n">addr_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">umode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFSOCK</span> <span class="o">|</span>  <span class="c1">// è®¾ç½®æ–‡ä»¶æ¨¡å¼ä¸ºå¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	       <span class="p">(</span><span class="nf">SOCK_INODE</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="nf">current_umask</span><span class="p">());</span>  <span class="c1">// æ ¹æ®å¥—æ¥å­—çš„æ¨¡å¼å’Œå½“å‰æ©ç è®¡ç®—æ–‡ä»¶æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_hash</span><span class="p">,</span> <span class="n">old_hash</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_hash</span><span class="p">;</span>  <span class="c1">// æ–°æ—§å“ˆå¸Œå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// è·å–UNIXå¥—æ¥å­—ç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// è·å–å¥—æ¥å­—å…³è”çš„ç½‘ç»œå‘½åç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">mnt_idmap</span> <span class="o">*</span><span class="n">idmap</span><span class="p">;</span>  <span class="c1">// IDæ˜ å°„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">unix_address</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>  <span class="c1">// UNIXåœ°å€ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">;</span>  <span class="c1">// ç›®å½•é¡¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">path</span> <span class="n">parent</span><span class="p">;</span>  <span class="c1">// çˆ¶ç›®å½•è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>  <span class="c1">// é”™è¯¯ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// å¯¹ä¼ å…¥çš„åœ°å€è¿›è¡Œå¤„ç†ï¼Œç¡®ä¿å…¶æ ¼å¼æ­£ç¡®ï¼Œå¹¶è®¡ç®—æ‰€éœ€çš„åœ°å€é•¿åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr_len</span> <span class="o">=</span> <span class="nf">unix_mkname_bsd</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// unix_create_addr()ï¼šä¸ºå¥—æ¥å­—åœ°å€åˆ†é…å†…å­˜ï¼Œå°†ä¼ å…¥çš„åœ°å€æ•°æ®å­˜å‚¨åœ¨æ–°åˆ›å»ºçš„ unix_address ç»“æ„ä¸­ã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œè¿”å› -ENOMEMã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">addr</span> <span class="o">=</span> <span class="nf">unix_create_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>  <span class="c1">// å†…å­˜åˆ†é…å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// kern_path_create()ï¼šæŸ¥æ‰¾æˆ–åˆ›å»ºå¯¹åº”è·¯å¾„çš„ç›®å½•é¡¹ (dentry)ï¼Œè·å–åœ°å€æ‰€åœ¨è·¯å¾„çš„çˆ¶ç›®å½• (parent)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">dentry</span> <span class="o">=</span> <span class="nf">kern_path_create</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// å¤„ç†é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºå¥—æ¥å­—èŠ‚ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">idmap</span> <span class="o">=</span> <span class="nf">mnt_idmap</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">mnt</span><span class="p">);</span>  <span class="c1">// è·å–IDæ˜ å°„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">security_path_mknod</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// é¦–å…ˆè¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿å½“å‰è¿›ç¨‹æœ‰æƒé™åœ¨æŒ‡å®šè·¯å¾„åˆ›å»ºèŠ‚ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">vfs_mknod</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="nf">d_inode</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">dentry</span><span class="p">),</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºèŠ‚ç‚¹ï¼Œç”¨äºè¡¨ç¤ºè¯¥ UNIX domain socketã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>  <span class="c1">// é”å®šäº’æ–¥é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">new_hash</span> <span class="o">=</span> <span class="nf">unix_bsd_hash</span><span class="p">(</span><span class="nf">d_backing_inode</span><span class="p">(</span><span class="n">dentry</span><span class="p">));</span>  <span class="c1">// åˆ›å»ºå“ˆå¸Œå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_table_double_lock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>  <span class="c1">// é”å®šåŒå‘å“ˆå¸Œè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mnt</span> <span class="o">=</span> <span class="nf">mntget</span><span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">mnt</span><span class="p">);</span>  <span class="c1">// è®¾ç½®è·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">u</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span> <span class="o">=</span> <span class="nf">dget</span><span class="p">(</span><span class="n">dentry</span><span class="p">);</span>  <span class="c1">// è®¾ç½®ç›®å½•é¡¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">__unix_set_addr_hash</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>  <span class="c1">// è®¾ç½®åœ°å€å“ˆå¸Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_table_double_unlock</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">old_hash</span><span class="p">,</span> <span class="n">new_hash</span><span class="p">);</span>  <span class="c1">// è§£é”åŒå‘å“ˆå¸Œè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_insert_bsd_socket</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// unix_insert_bsd_socket()ï¼šå°†è¯¥å¥—æ¥å­—æ’å…¥åˆ° BSD é£æ ¼å¥—æ¥å­—çš„ç®¡ç†ç»“æ„ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">bindlock</span><span class="p">);</span>  <span class="c1">// è§£é”äº’æ–¥é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">done_path_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>vfs_mknod()</p>
<p><code>vfs_mknod()</code> æ˜¯å†…æ ¸ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹æˆ–æ™®é€šæ–‡ä»¶ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">vfs_mknod</span><span class="p">(</span><span class="k">struct</span> <span class="n">mnt_idmap</span> <span class="o">*</span><span class="n">idmap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">,</span> <span class="kt">umode_t</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">dev_t</span> <span class="n">dev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// is_whiteoutï¼šæ£€æŸ¥åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦ä¸ºâ€œwhiteoutâ€è®¾å¤‡èŠ‚ç‚¹ï¼ˆç‰¹å®šåœºæ™¯ä¸‹è¡¨ç¤ºè¦†ç›–çš„å­—ç¬¦è®¾å¤‡èŠ‚ç‚¹ï¼‰ã€‚è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹ï¼Œç”¨äºæŸäº›æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œæ¯”å¦‚åœ¨ overlay æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">is_whiteout</span> <span class="o">=</span> <span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span> <span class="o">==</span> <span class="n">WHITEOUT_DEV</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// may_create()ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æƒé™åœ¨çˆ¶ç›®å½•ä¸­åˆ›å»ºæ–°æ–‡ä»¶æˆ–è®¾å¤‡èŠ‚ç‚¹ã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œåˆ™ç›´æ¥è¿”å›é”™è¯¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="nf">may_create</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//S_ISCHR(mode) å’Œ S_ISBLK(mode)ï¼šåˆ¤æ–­æ‰€è¦åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯å¦ä¸ºå­—ç¬¦è®¾å¤‡æˆ–å—è®¾å¤‡ã€‚å¦‚æœæ˜¯å­—ç¬¦è®¾å¤‡æˆ–å—è®¾å¤‡èŠ‚ç‚¹ï¼Œä¸”ä¸æ˜¯ &#34;whiteout&#34;ï¼Œåˆ™éœ€è¦è°ƒç”¨ capable(CAP_MKNOD) æ¥æ£€æŸ¥æ˜¯å¦å…·æœ‰åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹çš„æƒé™ï¼ˆé€šå¸¸æ˜¯è¶…çº§ç”¨æˆ·æƒé™ï¼‰ã€‚å¦‚æœæ²¡æœ‰æƒé™ï¼Œè¿”å› -EPERMï¼ˆæ“ä½œä¸å…è®¸ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="nf">S_ISCHR</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="o">||</span> <span class="nf">S_ISBLK</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_whiteout</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="nf">capable</span><span class="p">(</span><span class="n">CAP_MKNOD</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥çˆ¶ç›®å½•çš„ inode æ“ä½œ (i_op) æ˜¯å¦æ”¯æŒ mknodï¼Œå³æ˜¯å¦å…·æœ‰åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹çš„åŠŸèƒ½ã€‚å¦‚æœçˆ¶ç›®å½•ä¸æ”¯æŒè¯¥æ“ä½œï¼Œåˆ™è¿”å› -EPERMã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="n">mknod</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">mode</span> <span class="o">=</span> <span class="nf">vfs_prepare_mode</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="nf">devcgroup_inode_mknod</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">error</span> <span class="o">=</span> <span class="nf">security_inode_mknod</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// dir-&gt;i_op-&gt;mknod()ï¼šå®é™…è°ƒç”¨æ–‡ä»¶ç³»ç»Ÿæä¾›çš„ mknod æ“ä½œæ¥åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ã€‚è¿™ä¸ªæ“ä½œç”±å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿå®ç°ï¼ˆå¦‚ EXT4ã€XFS ç­‰ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">error</span> <span class="o">=</span> <span class="n">dir</span><span class="o">-&gt;</span><span class="n">i_op</span><span class="o">-&gt;</span><span class="nf">mknod</span><span class="p">(</span><span class="n">idmap</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fsnotify_create</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">vfs_mknod</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>é—®é¢˜ï¼šæ‰€ä»¥sockæ–‡ä»¶åˆ°åº•æ˜¯socketå‡½æ•°åˆ›å»ºçš„è¿˜æ˜¯bindå‡½æ•°åˆ›å»ºçš„ï¼Ÿ</p>
<p>ç­”ï¼š<code>sock</code> æ–‡ä»¶ï¼ˆå³ UNIX domain socket æ–‡ä»¶ï¼‰å®é™…ä¸Šæ˜¯åœ¨ <strong><code>bind()</code></strong> å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ä¸­åˆ›å»ºçš„ï¼Œè€Œä¸æ˜¯åœ¨è°ƒç”¨ <strong><code>socket()</code></strong> å‡½æ•°æ—¶åˆ›å»ºçš„ã€‚</p>
<ol>
<li><strong><code>socket()</code> å‡½æ•°çš„ä½œç”¨</strong></li>
</ol>
<ul>
<li><strong><code>socket()</code></strong> å‡½æ•°åˆ›å»ºçš„æ˜¯å¥—æ¥å­—çš„å†…æ ¸å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆ<code>fd</code>ï¼‰ï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªå¥—æ¥å­—ã€‚</li>
<li>å½“ä½ è°ƒç”¨ <code>socket()</code> å‡½æ•°æ—¶ï¼Œå†…æ ¸ä¼šä¸ºè¯¥å¥—æ¥å­—åˆ†é…å¿…è¦çš„å†…æ ¸ç»“æ„ä½“ï¼ˆä¾‹å¦‚ <code>struct socket</code> å’Œ <code>struct sock</code>ï¼‰ï¼Œå¹¶åˆå§‹åŒ–ä¸è¯¥å¥—æ¥å­—ç›¸å…³çš„å†…æ ¸æ•°æ®ç»“æ„ã€‚</li>
<li>åœ¨è¿™ä¸€æ­¥ï¼Œè™½ç„¶å¥—æ¥å­—çš„å¯¹è±¡å·²ç»å­˜åœ¨ï¼Œä½†è¿˜æ²¡æœ‰ä¸å…·ä½“çš„æ–‡ä»¶ç³»ç»Ÿè·¯å¾„è¿›è¡Œå…³è”ã€‚å› æ­¤ï¼Œè¿™æ—¶å€™å¹¶æ²¡æœ‰äº§ç”Ÿä»»ä½•æ–‡ä»¶ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹ï¼ˆ<code>sock</code> æ–‡ä»¶ï¼‰ã€‚</li>
</ul>
<ol start="2">
<li><strong><code>bind()</code> å‡½æ•°çš„ä½œç”¨</strong></li>
</ol>
<ul>
<li><strong><code>bind()</code></strong> å‡½æ•°çš„ä½œç”¨æ˜¯å°†å¥—æ¥å­—ä¸ä¸€ä¸ªå…·ä½“çš„åœ°å€ç»‘å®šã€‚åœ¨ UNIX domain socket çš„åœºæ™¯ä¸‹ï¼Œè¿™ä¸ªåœ°å€å¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæŠ½è±¡åç§°ã€‚</li>
<li>å¯¹äº <strong>BSD é£æ ¼</strong> çš„ UNIX domain socketï¼Œè°ƒç”¨ <code>bind()</code> å‡½æ•°æ—¶ï¼Œä¼šåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹å°±æ˜¯æˆ‘ä»¬åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çœ‹åˆ°çš„ <code>.sock</code> æ–‡ä»¶ï¼Œæˆ–è€…æ˜¯ç±»ä¼¼ <code>/tmp/mysocket</code> çš„æ–‡ä»¶ã€‚</li>
<li>å…·ä½“æ¥è¯´ï¼Œ<code>bind()</code> å‡½æ•°ä¸­ä¼šè°ƒç”¨ <code>vfs_mknod()</code>ï¼Œå®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶èŠ‚ç‚¹ï¼ˆç±»å‹ä¸º <code>S_IFSOCK</code>ï¼‰ï¼Œå¹¶æŠŠè¿™ä¸ªèŠ‚ç‚¹ä¸å¥—æ¥å­—ç›¸å…³è”ã€‚è¿™æ ·ï¼Œå…¶ä»–è¿›ç¨‹å°±å¯ä»¥é€šè¿‡è¯¥è·¯å¾„æ‰¾åˆ°è¿™ä¸ªå¥—æ¥å­—ï¼Œä»è€Œè¿›è¡Œé€šä¿¡ã€‚</li>
</ul>
<ol start="3">
<li>
<p><strong><code>sock</code> æ–‡ä»¶çš„åˆ›å»ºè¿‡ç¨‹</strong></p>
<p>ä»¥ä¸‹æ˜¯ <code>sock</code> æ–‡ä»¶åˆ›å»ºçš„å…³é”®æ­¥éª¤ï¼š</p>
<p>(1)<strong>è°ƒç”¨ <code>socket()</code> å‡½æ•°</strong>ï¼š</p>
<ul>
<li>
<p>åˆ›å»ºå¥—æ¥å­—å¯¹è±¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œæ ‡è¯†è¿™ä¸ªå¥—æ¥å­—ã€‚</p>
</li>
<li>
<p>æ­¤æ—¶ï¼Œå†…æ ¸ä¸­åˆ›å»ºäº†å¥—æ¥å­—çš„ç›¸å…³æ•°æ®ç»“æ„ï¼Œä½†æ–‡ä»¶ç³»ç»Ÿä¸­å¹¶æ²¡æœ‰ä»»ä½•ä½“ç°ã€‚</p>
</li>
</ul>
<p>(2)<strong>è°ƒç”¨ <code>bind()</code> å‡½æ•°</strong>ï¼š</p>
<ul>
<li>å°†å¥—æ¥å­—ä¸å…·ä½“çš„åœ°å€ç»‘å®šã€‚å¯¹äº UNIX domain socketï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼ˆBSD é£æ ¼ï¼‰æˆ–æŠ½è±¡è·¯å¾„ã€‚</li>
<li>å¦‚æœæ˜¯ BSD é£æ ¼çš„åœ°å€ï¼Œ<code>bind()</code> å‡½æ•°ä¼šåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä¸ºè¯¥åœ°å€åˆ›å»ºä¸€ä¸ªæ–‡ä»¶èŠ‚ç‚¹ã€‚æ¯”å¦‚ <code>/tmp/mysocket</code>ã€‚</li>
<li>å†…æ ¸ä¸­ä¼šè°ƒç”¨ <code>vfs_mknod()</code> æˆ–ç±»ä¼¼çš„æ–‡ä»¶ç³»ç»Ÿå‡½æ•°æ¥åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œç¡®ä¿åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªå¯¹åº”çš„æ–‡ä»¶ï¼Œè¡¨ç¤ºè¯¥ UNIX domain socket åœ°å€ã€‚</li>
<li>å¦‚æœæ˜¯æŠ½è±¡åœ°å€ï¼Œåˆ™æ²¡æœ‰æ–‡ä»¶ç³»ç»ŸèŠ‚ç‚¹çš„åˆ›å»ºï¼Œä»…åœ¨å†…æ ¸ä¸­ç»´æŠ¤ç›¸åº”çš„æŠ½è±¡è·¯å¾„ã€‚</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="listen">listen()
</h3><blockquote>
<p>ä¸€å¥è¯æ¦‚æ‹¬listenå‡½æ•°ï¼šå°†å¥—æ¥å­—çŠ¶æ€è®¾ç½®ä¸ºç›‘å¬æ¨¡å¼ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE2</span><span class="p">(</span><span class="n">listen</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>listen()-&gt;sys_listen()</p>
<p>è¿™æ®µä»£ç å®ç°äº†å†…æ ¸ä¸­ <code>listen()</code> ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å®ƒç”¨äºå°†ä¸€ä¸ªå¥—æ¥å­—è½¬æ¢ä¸ºè¢«åŠ¨è¿æ¥æ¨¡å¼ï¼Œå¼€å§‹ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">somaxconn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//sockfd_lookup_light() ç”¨äºæŸ¥æ‰¾ä¸ç»™å®šæ–‡ä»¶æè¿°ç¬¦ fd å…³è”çš„å¥—æ¥å­—å¯¹è±¡ (struct socket)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sockfd_lookup_light</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è®¾ç½®æœ€å¤§è¿æ¥æ•° (somaxconn)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">somaxconn</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="nf">sock_net</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">core</span><span class="p">.</span><span class="n">sysctl_somaxconn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">backlog</span> <span class="o">&gt;</span> <span class="n">somaxconn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">backlog</span> <span class="o">=</span> <span class="n">somaxconn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è°ƒç”¨åè®®æ ˆçš„ listen() å‡½æ•°ï¼Œå°†å¥—æ¥å­—è½¬æ¢ä¸ºç›‘å¬æ¨¡å¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">err</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">listen</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">backlog</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// é‡Šæ”¾æ–‡ä»¶å¼•ç”¨ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">fput_light</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="p">,</span> <span class="n">fput_needed</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sys_listen()-&gt;unix_listen()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_listen</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>  <span class="c1">// é”™è¯¯ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>  <span class="c1">// è·å–å¥—æ¥å­—çš„åŸºç¡€ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// è·å–UNIXå¥—æ¥å­—ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥å¥—æ¥å­—ç±»å‹æ˜¯å¦ä¸º SOCK_STREAM æˆ– SOCK_SEQPACKET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>  <span class="c1">// ä»…æœ‰æµå¥—æ¥å­—å’Œé¡ºåºåŒ…å¥—æ¥å­—æ”¯æŒç›‘å¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥æ˜¯å¦ç»‘å®šåœ°å€ï¼Œæœªç»‘å®šåœ°å€çš„å¥—æ¥å­—ä¸èƒ½è¿›è¡Œç›‘å¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	<span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// é”å®šå¥—æ¥å­—çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥å¥—æ¥å­—çŠ¶æ€æ˜¯å¦ä¸º TCP_CLOSE æˆ– TCP_LISTEN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_CLOSE</span> <span class="o">&amp;&amp;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>  <span class="c1">// å¥—æ¥å­—çŠ¶æ€å¿…é¡»ä¸ºå…³é—­æˆ–ç›‘å¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¦‚æœæ–°çš„SYNç­‰å¾…é˜Ÿåˆ—å¤§å°å¤§äºå½“å‰çš„SYNæœ€å¤§ç­‰å¾…é˜Ÿåˆ—å¤§å°ï¼Œåˆ™å”¤é†’æ‰€æœ‰SYNç­‰å¾…é˜Ÿåˆ—ä¸­çš„å¯¹ç­‰ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">backlog</span> <span class="o">&gt;</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">wake_up_interruptible_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">peer_wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_max_ack_backlog</span> <span class="o">=</span> <span class="n">backlog</span><span class="p">;</span>  <span class="c1">// è®¾ç½®æ–°çš„ç­‰å¾…é˜Ÿåˆ—å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_LISTEN</span><span class="p">;</span>  <span class="c1">// å°†å¥—æ¥å­—çŠ¶æ€è®¾ç½®ä¸ºç›‘å¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è®¾ç½®è¿æ¥çš„å‡­è¯ï¼Œä»¥ä¾¿è¿æ¥æ“ä½œå¯ä»¥å¤åˆ¶å®ƒä»¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">init_peercred</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>  <span class="c1">// è§£é”å¥—æ¥å­—çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>  <span class="c1">// è¿”å›é”™è¯¯ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="connect">connect()
</h3><blockquote>
<p>ä¸€å¥è¯æ¦‚æ‹¬connectå‡½æ•°ï¼šå®ç°äº† UNIX domain socket çš„è¿æ¥é€»è¾‘ã€‚å®ƒå¤„ç†äº†å®¢æˆ·ç«¯å¥—æ¥å­—è¿æ¥åˆ°æœåŠ¡å™¨ç›‘å¬å¥—æ¥å­—çš„è¿‡ç¨‹ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">//syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">connect</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">uwservaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">uservaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>connect()-&gt;__sys_connect()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uservaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è·å–æ–‡ä»¶æè¿°ç¬¦çš„Xæ–‡ä»¶å¯¹è±¡ (fdget())ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">f</span> <span class="o">=</span> <span class="nf">fdget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// move_addr_to_kernel()ï¼šå°†ç”¨æˆ·ç©ºé—´çš„åœ°å€ï¼ˆuservaddrï¼‰ç§»åŠ¨åˆ°å†…æ ¸ç©ºé—´çš„ address ç»“æ„ä¸­ã€‚è¿™ä¸€æ­¥å°†ç”¨æˆ·æä¾›çš„åœ°å€æ‹·è´åˆ°å†…æ ¸ä¸­ï¼Œä»¥ä¾¿å†…æ ¸èƒ½å¤Ÿå®‰å…¨åœ°ä½¿ç”¨å®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="nf">move_addr_to_kernel</span><span class="p">(</span><span class="n">uservaddr</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// __sys_connect_file()ï¼šè¿™æ˜¯ä¸€ä¸ªå®é™…è¿›è¡Œè¿æ¥æ“ä½œçš„å‡½æ•°ã€‚å®ƒæ¥æ”¶æ–‡ä»¶å¯¹è±¡ï¼ˆå³å¥—æ¥å­—ï¼‰ã€å†…æ ¸ä¸­çš„åœ°å€ç»“æ„ä»¥åŠåœ°å€é•¿åº¦ï¼Œå®Œæˆè¿æ¥æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">ret</span> <span class="o">=</span> <span class="nf">__sys_connect_file</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fdput</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_connect()-&gt;__sys_connect_file()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_connect_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		       <span class="kt">int</span> <span class="n">addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">file_flags</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è·å–å¥—æ¥å­—å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sock</span> <span class="o">=</span> <span class="nf">sock_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// security_socket_connect()ï¼šè°ƒç”¨ Linux å®‰å…¨æ¨¡å—ï¼ˆLSMï¼‰è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿å½“å‰ç”¨æˆ·æˆ–è¿›ç¨‹æœ‰æƒé™å¯¹æŒ‡å®šçš„å¥—æ¥å­—å‘èµ·è¿æ¥è¯·æ±‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">	    <span class="nf">security_socket_connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">address</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// READ_ONCE(sock-&gt;ops)ï¼šè¯»å–å¥—æ¥å­—æ“ä½œè¡¨ã€‚ç”±äºå¥—æ¥å­—çš„æ“ä½œè¡¨å¯èƒ½ä¼šè¢«å¤šçº¿ç¨‹å¹¶å‘ä¿®æ”¹ï¼Œä½¿ç”¨ READ_ONCE() ç¡®ä¿è¯»å–çš„å€¼æ˜¯æœ€æ–°çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// sock-&gt;ops-&gt;connect()ï¼šè°ƒç”¨å¥—æ¥å­—çš„ connect æ“ä½œå‡½æ•°ï¼Œæ‰§è¡Œå®é™…çš„è¿æ¥æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">connect</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="n">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="n">addrlen</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|</span> <span class="n">file_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>**æ³¨æ„ï¼š**è¿™é‡Œ<code>(sock-&gt;ops)-&gt;connect()</code>ä¼šæ ¹æ®å¥—æ¥å­—çš„ç±»å‹è°ƒç”¨ä¸åŒçš„å®ç°å‡½æ•°ï¼Œä¾‹å¦‚SOCK_STREAMä¼šè°ƒç”¨<code>unix_stream_connect()</code>ï¼ŒSOCK_DGRAMï¼šä¼šè°ƒç”¨<code>unix_dgram_connect()</code>ã€‚</p>
<p>åœ¨ UNIX domain socket ä¸­ï¼Œå¥—æ¥å­—çš„ç±»å‹å–å†³äºåœ¨è°ƒç”¨ <code>socket()</code> å‡½æ•°æ—¶æ‰€æŒ‡å®šçš„ç±»å‹å‚æ•°ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p>
<ol>
<li><strong>SOCK_STREAM (æµå¼å¥—æ¥å­—)</strong>ï¼š
<ul>
<li>åœ¨ä½ æä¾›çš„ä»£ç ä¸­ï¼Œä½¿ç”¨äº† <code>SOCK_STREAM</code>ï¼Œè¿™æ„å‘³ç€å¥—æ¥å­—æ˜¯æµå¼çš„ï¼Œç±»ä¼¼äº TCP åè®®çš„å¥—æ¥å­—ã€‚</li>
<li><strong>ç‰¹æ€§</strong>ï¼šé¢å‘è¿æ¥ï¼Œæä¾›å¯é çš„ã€æŒ‰é¡ºåºçš„ã€æ— æ•°æ®ä¸¢å¤±çš„é€šä¿¡ï¼Œé€‚ç”¨äºéœ€è¦å¯é ä¼ è¾“çš„åœºæ™¯ã€‚</li>
<li>æˆ‘çš„ <code>server.c</code> å’Œ <code>client.c</code> æ–‡ä»¶ä¸­éƒ½ä½¿ç”¨äº† <code>AF_UNIX</code> å’Œ <code>SOCK_STREAM</code>ï¼Œå› æ­¤è¿™ä¸¤ä¸ªå¥—æ¥å­—æ˜¯å¯é çš„é¢å‘è¿æ¥çš„æµå¼å¥—æ¥å­—ã€‚</li>
</ul>
</li>
<li><strong>SOCK_DGRAM (æ•°æ®æŠ¥å¥—æ¥å­—)</strong>ï¼š
<ul>
<li>è¿™æ˜¯å¦ä¸€ç§ç±»å‹çš„ UNIX domain socketï¼Œç±»ä¼¼äº UDP åè®®çš„å¥—æ¥å­—ã€‚</li>
<li><strong>ç‰¹æ€§</strong>ï¼šé¢å‘æ— è¿æ¥ï¼Œä¼ è¾“ä¸ä¿è¯é¡ºåºæˆ–å¯é æ€§ï¼Œé€‚ç”¨äºå¯¹å¯é æ€§è¦æ±‚è¾ƒä½ä½†é€Ÿåº¦è¾ƒå¿«çš„åœºæ™¯ã€‚</li>
<li>ä½¿ç”¨ <code>SOCK_DGRAM</code> å¯ä»¥åœ¨ UNIX domain ä¸­å®ç°æ— è¿æ¥çš„æ•°æ®æŠ¥é€šä¿¡ã€‚</li>
</ul>
</li>
<li><strong>SOCK_SEQPACKET (æœ‰åºåˆ†ç»„å¥—æ¥å­—)</strong>ï¼š
<ul>
<li>è¿™æ˜¯ UNIX domain socket ä¸­çš„ä¸€ç§è¾ƒå°‘ä½¿ç”¨çš„ç±»å‹ã€‚</li>
<li><strong>ç‰¹æ€§</strong>ï¼šé¢å‘è¿æ¥ï¼Œæä¾›å¯é çš„ã€æœ‰åºçš„æ•°æ®ä¼ è¾“ï¼Œä½†ä¸åƒ <code>SOCK_STREAM</code> é‚£æ ·æ˜¯ä¸€ä¸ªè¿ç»­çš„æ•°æ®æµï¼Œè€Œæ˜¯ä¸€ä¸ªæœ‰åºçš„æ•°æ®åŒ…åºåˆ—ã€‚</li>
<li>é€‚ç”¨äºéœ€è¦æœ‰åºä¼ è¾“æ•°æ®åŒ…çš„åº”ç”¨ã€‚</li>
</ul>
</li>
</ol>
</blockquote>
<blockquote>
<p><code>unix_stream_connect()</code> å‡½æ•°å®ç°äº† UNIX domain socket çš„è¿æ¥é€»è¾‘ã€‚å®ƒå¤„ç†äº†å®¢æˆ·ç«¯å¥—æ¥å­—è¿æ¥åˆ°æœåŠ¡å™¨ç›‘å¬å¥—æ¥å­—çš„è¿‡ç¨‹ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">uaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†ä¼ å…¥çš„é€šç”¨åœ°å€ç»“æ„è½¬æ¢ä¸º UNIX ä¸“ç”¨åœ°å€ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="p">)</span><span class="n">uaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="o">*</span><span class="n">newsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">),</span> <span class="o">*</span><span class="n">newu</span><span class="p">,</span> <span class="o">*</span><span class="n">otheru</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span> <span class="o">=</span> <span class="nf">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span><span class="n">X</span><span class="err">@</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">st</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// éªŒè¯ä¼ å…¥çš„åœ°å€æ˜¯å¦æœ‰æ•ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_validate_addr</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå¥—æ¥å­—éœ€è¦ä¼ é€’å‡­æ®ä½†å°šæœªç»‘å®šï¼Œåˆ™è¿›è¡Œè‡ªåŠ¨ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSCRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSPIDFD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_autobind</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå–å†³äºæ˜¯å¦ä¸ºéé˜»å¡æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">timeo</span> <span class="o">=</span> <span class="nf">sock_sndtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°çš„å¥—æ¥å­—ï¼Œç”¨äºä»£è¡¨å³å°†å»ºç«‹çš„è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newsk</span> <span class="o">=</span> <span class="nf">unix_create1</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newsk</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">newsk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸ºæ–°çš„å¥—æ¥å­—åˆ†é…sk_buff
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">skb</span> <span class="o">=</span> <span class="nf">sock_wmalloc</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">restart</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æŸ¥æ‰¾ç›‘å¬å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">other</span> <span class="o">=</span> <span class="nf">unix_find_other</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// é”å®šç›®æ ‡å¥—æ¥å­—çš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœç›®æ ‡å¥—æ¥å­—å·²æ­»äº¡ï¼Œè§£é”å¹¶é‡æ–°æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">sock_flag</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥ç›®æ ‡å¥—æ¥å­—æ˜¯å¦åœ¨ç›‘å¬çŠ¶æ€ï¼Œæˆ–å·²å…³é—­æ¥æ”¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœç›®æ ‡ç›‘å¬å¥—æ¥å­—çš„æ¥æ”¶é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ç­‰å¾…ç›´åˆ°æœ‰ç©ºé—´æˆ–è¶…æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">unix_recvq_full</span><span class="p">(</span><span class="n">other</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">timeo</span> <span class="o">=</span> <span class="nf">unix_wait_for_peer</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">timeo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// é”å®šå‘èµ·è¿æ¥çš„å¥—æ¥å­—çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">st</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_CLOSE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¥—æ¥å­—å¤„äºå…³é—­çŠ¶æ€ï¼Œå¯ä»¥ç»§ç»­è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nl">TCP_ESTABLISHED</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¥—æ¥å­—å·²ç»è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EISCONN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_lock_nested</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åœ¨é”å®šçŠ¶æ€ä¸‹é‡æ–°æ£€æŸ¥å¥—æ¥å­—çŠ¶æ€ï¼Œç¡®ä¿æ²¡æœ‰å˜åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">st</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿›è¡Œå®‰å…¨æ€§æ£€æŸ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">security_unix_stream_connect</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®æ–°å¥—æ¥å­—ä»¥å®Œæˆè¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sock_hold</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_peer</span><span class="p">(</span><span class="n">newsk</span><span class="p">)</span> <span class="o">=</span> <span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">init_peercred</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">newu</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">newsk</span><span class="o">-&gt;</span><span class="n">sk_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newu</span><span class="o">-&gt;</span><span class="n">peer_wq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">otheru</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»ç›‘å¬å¥—æ¥å­—å¤åˆ¶åœ°å€ä¿¡æ¯åˆ°æ–°å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">otheru</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">path_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">otheru</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">newu</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">otheru</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">refcount_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">otheru</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">smp_store_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newu</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">otheru</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®æ–°å¥—æ¥å­—çš„å‡­æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">copy_peercred</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ›´æ–°å®¢æˆ·ç«¯å¥—æ¥å­—å’Œæ–°å¥—æ¥å­—çš„çŠ¶æ€ä¸ºå·²è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_hold</span><span class="p">(</span><span class="n">newsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">smp_mb__after_atomic</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_peer</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span> <span class="o">=</span> <span class="n">newsk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†è¿æ¥ä¿¡æ¯å‘é€ç»™ç›‘å¬å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">other</span><span class="o">-&gt;</span><span class="nf">sk_data_ready</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newsk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_release_sock</span><span class="p">(</span><span class="n">newsk</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sock_put</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_find_other()ï¼šæŸ¥æ‰¾å¯¹æ–¹æ­£åœ¨ç›‘å¬çš„å¥—æ¥å­—</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">unix_find_other</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				    <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_find_bsd</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_find_abstract</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªæŸ¥æ‰¾å‡½æ•°ï¼Œæˆ‘ä»¬é€‰æ‹©bsdé£æ ¼åˆ†æã€‚</p>
<p><code>unix_find_bsd()</code> å‡½æ•°ç”¨äºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥æ‰¾ä¸ BSD é£æ ¼åœ°å€ç»‘å®šçš„ UNIX domain socketã€‚å®ƒé€šè¿‡ç»™å®šçš„è·¯å¾„åæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼ˆå¥—æ¥å­—ï¼‰ï¼Œå¹¶è¿”å›ä¸ä¹‹å…³è”çš„ <code>sock</code> ç»“æ„ä½“ã€‚ä»¥ä¸‹æ˜¯å¯¹è¯¥å‡½æ•°çš„é€æ­¥åˆ†æå’Œä¸­æ–‡æ³¨é‡Šã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="nf">unix_find_bsd</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="n">sunaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				  <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">path</span> <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ„å»º BSD é£æ ¼åœ°å€ï¼Œç¡®ä¿ sun_path åˆæ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">unix_mkname_bsd</span><span class="p">(</span><span class="n">sunaddr</span><span class="p">,</span> <span class="n">addr_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ä½¿ç”¨ kern_path æŸ¥æ‰¾ç»™å®šè·¯å¾„å¯¹åº”çš„æ–‡ä»¶å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">kern_path</span><span class="p">(</span><span class="n">sunaddr</span><span class="o">-&gt;</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">LOOKUP_FOLLOW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥å¯¹è·¯å¾„çš„å†™æƒé™ï¼Œä»¥ç¡®ä¿èƒ½å¤Ÿç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="nf">path_permission</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="n">MAY_WRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">path_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥è¯¥è·¯å¾„å¯¹åº”çš„ inode æ˜¯å¦ä¸ºå¥—æ¥å­—ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNREFUSED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">inode</span> <span class="o">=</span> <span class="nf">d_backing_inode</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">dentry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">S_ISSOCK</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">path_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æŸ¥æ‰¾ inode å¯¹åº”çš„å¥—æ¥å­—å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">sk</span> <span class="o">=</span> <span class="nf">unix_find_socket_byinode</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">path_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ç¡®ä¿å¥—æ¥å­—ç±»å‹ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTOTYPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">touch_atime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>  <span class="c1">// æ›´æ–°è®¿é—®æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">sock_put</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// é‡Šæ”¾è·¯å¾„èµ„æº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">sock_put</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// é‡Šæ”¾å¥—æ¥å­—å¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">sock_put</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">path_put</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// é‡Šæ”¾è·¯å¾„å¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">path_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è¿”å›é”™è¯¯æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="accept">accept()
</h3><blockquote>
<p>ä»ç›‘å¬å¥—æ¥å­—ä¸­æ¥å—ä¸€ä¸ªæ–°è¿æ¥ï¼Œå¹¶å°†æ–°è¿æ¥çš„å¥—æ¥å­—ä¿¡æ¯å¤åˆ¶åˆ°ä¼ å…¥çš„ä¸€ä¸ªæ–°çš„å¥—æ¥å­—</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">accept</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">__sys_accept4</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>accept()-&gt;__sys_accept4()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">__sys_accept4</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		  <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">f</span> <span class="o">=</span> <span class="nf">fdget</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ret</span> <span class="o">=</span> <span class="nf">__sys_accept4_file</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					 <span class="n">upeer_addrlen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fdput</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_accept4()-&gt;__sys_accept4_file()</p>
<p><code>__sys_accept4_file()</code> å‡½æ•°å®ç°äº†å¯¹å·²å­˜åœ¨å¥—æ¥å­—æ–‡ä»¶çš„ <code>accept</code> æ“ä½œï¼Œè¯¥å‡½æ•°ç”¨äºä»æ–‡ä»¶æè¿°ç¬¦ä¸­è·å–æ–°è¿æ¥ã€‚å®ƒå…è®¸å¯¹æ–°çš„å¥—æ¥å­—è®¾ç½®ä¸€äº›æ ‡å¿—ï¼Œæ¯”å¦‚éé˜»å¡å’Œå…³é—­æ–‡ä»¶æè¿°ç¬¦æ—¶è‡ªåŠ¨æ‰§è¡Œ <code>close</code>ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">__sys_accept4_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			      <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">newfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥ flagsï¼Œç¡®ä¿å®ƒä»¬æ˜¯åˆæ³•çš„ï¼Œä¸èƒ½æœ‰é™¤ SOCK_CLOEXEC å’Œ SOCK_NONBLOCK ä¹‹å¤–çš„å…¶ä»–æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SOCK_CLOEXEC</span> <span class="o">|</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœ SOCK_NONBLOCK ä¸ O_NONBLOCK ä¸ç›¸ç­‰ä¸”è®¾ç½®äº† SOCK_NONBLOCKï¼Œåˆ™è½¬æ¢ä¸º O_NONBLOCK
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">SOCK_NONBLOCK</span> <span class="o">!=</span> <span class="n">O_NONBLOCK</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SOCK_NONBLOCK</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SOCK_NONBLOCK</span><span class="p">)</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newfd</span> <span class="o">=</span> <span class="nf">get_unused_fd_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">newfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä½¿ç”¨ do_accept å‡½æ•°æ¥å—è¿æ¥ï¼Œè¿”å›æ–°çš„æ–‡ä»¶å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newfile</span> <span class="o">=</span> <span class="nf">do_accept</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå‡ºé”™ï¼Œåˆ™é‡Šæ”¾ä¹‹å‰è·å–çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">put_unused_fd</span><span class="p">(</span><span class="n">newfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†æ–°çš„æ–‡ä»¶å¯¹è±¡å®‰è£…åˆ°æ–°è·å–çš„æ–‡ä»¶æè¿°ç¬¦ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fd_install</span><span class="p">(</span><span class="n">newfd</span><span class="p">,</span> <span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">newfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sys_accept4_file()-&gt;do_accept()</p>
<p><code>do_accept()</code> å‡½æ•°ç”¨äºæ¥å—ä¼ å…¥çš„è¿æ¥è¯·æ±‚ï¼Œä¸ºæ–°çš„è¿æ¥åˆ›å»ºå¥—æ¥å­—ï¼Œå¹¶è¿”å›ä¸€ä¸ªä¸æ–°è¿æ¥å…³è”çš„æ–‡ä»¶å¯¹è±¡ã€‚è¯¥å‡½æ•°æ˜¯å¤„ç† <code>accept</code> ç³»ç»Ÿè°ƒç”¨çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œä¸»è¦è´Ÿè´£èµ„æºçš„åˆ†é…å’Œè¿æ¥çš„å»ºç«‹ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">do_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">file_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_sockaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="n">newsock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»æ–‡ä»¶å¯¹è±¡è·å–å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">sock</span> <span class="o">=</span> <span class="nf">sock_from_file</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOTSOCK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸ºæ–°çš„è¿æ¥åˆ†é…å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newsock</span> <span class="o">=</span> <span class="nf">sock_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newsock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENFILE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–åŸå§‹å¥—æ¥å­—çš„æ“ä½œæŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ops</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®æ–°å¥—æ¥å­—çš„ç±»å‹å’Œæ“ä½œæŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newsock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsock</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æˆ‘ä»¬ä¸éœ€è¦è°ƒç”¨ try_module_getï¼Œå› ä¸ºç›‘å¬å¥—æ¥å­— (sock) å·²ç»æŒæœ‰äº†
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åè®®æ¨¡å— (sock-&gt;ops-&gt;owner)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">__module_get</span><span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸ºæ–°å¥—æ¥å­—åˆ†é…æ–‡ä»¶å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ç»™å®šçš„æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">newfile</span> <span class="o">=</span> <span class="nf">sock_alloc_file</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot_creator</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼Œç¡®ä¿å¯ä»¥æ¥å—è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">newsock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨å¥—æ¥å­—çš„ accept æ“ä½œä»¥å»ºç«‹æ–°è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="nf">accept</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">newsock</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|</span> <span class="n">file_flags</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœéœ€è¦ï¼Œè·å–å¯¹ç­‰ç«¯çš„åœ°å€ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">upeer_sockaddr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">len</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="nf">getname</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNABORTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">move_addr_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">upeer_sockaddr</span><span class="p">,</span> <span class="n">upeer_addrlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ–‡ä»¶æ ‡å¿—ä¸ä¼šé€šè¿‡ accept() ç»§æ‰¿ï¼Œè¿™ä¸å…¶ä»–æ“ä½œç³»ç»Ÿä¸åŒã€‚ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">newfile</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_fd</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é‡Šæ”¾æ–°æ–‡ä»¶å¯¹è±¡çš„å¼•ç”¨ï¼Œé‡Šæ”¾èµ„æº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fput</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>do_accept()-&gt;unix_accept()</p>
<p><code>unix_accept()</code> å‡½æ•°ç”¨äºå®ç° UNIX domain socket çš„ <code>accept</code> æ“ä½œï¼Œå®ƒä»ç›‘å¬å¥—æ¥å­—ä¸­æ¥å—ä¸€ä¸ªæ–°è¿æ¥ï¼Œå¹¶å°†æ–°è¿æ¥çš„å¥—æ¥å­—ä¿¡æ¯å¤åˆ¶åˆ°ä¼ å…¥çš„ <code>newsock</code> ä¸­ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">newsock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">kern</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå¥—æ¥å­—ç±»å‹ä¸æ˜¯ SOCK_STREAM æˆ– SOCK_SEQPACKETï¼Œåˆ™è¿”å›ä¸æ”¯æŒçš„é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_STREAM</span> <span class="o">&amp;&amp;</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå¥—æ¥å­—çŠ¶æ€ä¸æ˜¯ TCP_LISTENï¼Œåˆ™è¿”å›æ— æ•ˆå‚æ•°é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœå¥—æ¥å­—çŠ¶æ€ä¸º TCP_LISTENï¼Œå®ƒåœ¨æ­¤å¤„ä¸ä¼šæ”¹å˜ï¼ˆæš‚æ—¶...ï¼‰ï¼Œå› æ­¤ä¸éœ€è¦åŠ é”ã€‚ */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°è¯•ä»ç›‘å¬å¥—æ¥å­—çš„æ¥æ”¶é˜Ÿåˆ—ä¸­è·å–æ•°æ®åŒ…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_recv_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">?</span> <span class="nl">MSG_DONTWAIT</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæ¥æ”¶é˜Ÿåˆ—ä¸ºç©ºå¹¶ä¸”å‘ç”Ÿæ¥æ”¶å…³é—­ï¼Œè¿”å›é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–æ–°è¿æ¥çš„å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">tsk</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">skb_free_datagram</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å”¤é†’ç­‰å¾…è¿æ¥çš„è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer_wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†æ–°è¿æ¥çš„å¥—æ¥å­—é™„åŠ åˆ°ä¼ å…¥çš„ newsock ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">newsock</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SS_CONNECTED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_sock_inherit_flags</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">newsock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sock_graft</span><span class="p">(</span><span class="n">tsk</span><span class="p">,</span> <span class="n">newsock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">tsk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="write">write()
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">write</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">size_t</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ksys_write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>write()-&gt;ksys_write()</p>
<p><code>ksys_write()</code> æ˜¯ Linux å†…æ ¸ä¸­å®ç°çš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°ï¼Œç”¨äºå¤„ç†æ¥è‡ªç”¨æˆ·æ€çš„ <code>write()</code> ç³»ç»Ÿè°ƒç”¨ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå®ƒæ¥æ”¶äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ <code>fd</code>ã€ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒº <code>buf</code> ä»¥åŠå†™å…¥çš„å­—èŠ‚æ•° <code>count</code>ï¼Œå¹¶é€šè¿‡ç›¸åº”çš„æ–‡ä»¶ç³»ç»Ÿæ¥å£å°†æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶æˆ–è®¾å¤‡ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">ksys_write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fdget_pos</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¡®ä¿æ–‡ä»¶æè¿°ç¬¦æœ‰æ•ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// file_ppos(f.file)ï¼šè¯¥å‡½æ•°ç”¨äºè·å–æ–‡ä»¶çš„å½“å‰åç§»é‡æŒ‡é’ˆã€‚å¯¹äºæŸäº›æ–‡ä»¶ç±»å‹ï¼ˆå¦‚å¸¸è§„æ–‡ä»¶ï¼‰ï¼Œåç§»é‡éœ€è¦ä¸æ–­æ›´æ–°ï¼Œè€Œå¯¹äºæŸäº›ç‰¹æ®Šæ–‡ä»¶ï¼ˆå¦‚ socketï¼‰ï¼Œå¯èƒ½ä¸éœ€è¦åç§»é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="nf">file_ppos</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæ–‡ä»¶æŒ‡é’ˆå­˜åœ¨ï¼Œè®¾ç½®å†™å…¥çš„èµ·å§‹ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">ppos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒç”¨ vfs_write è¿›è¡Œå®é™…çš„å†™å…¥æ“ä½œï¼Œå…·ä½“çš„å†™å…¥æ“ä½œå°†ç”±ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿæˆ–è®¾å¤‡é©±åŠ¨æ¥å®ç°ï¼Œä¾‹å¦‚å­—ç¬¦è®¾å¤‡ã€å—è®¾å¤‡ã€ç½‘ç»œå¥—æ¥å­—ç­‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ret</span> <span class="o">=</span> <span class="nf">vfs_write</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ›´æ–°æ–‡ä»¶çš„åç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ppos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// é‡Šæ”¾æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">fdput_pos</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ksys_write()-&gt;vfs_write()</p>
<p><code>vfs_write()</code> æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºå¤„ç†æ–‡ä»¶å†™å…¥æ“ä½œçš„è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰æ¥å£å‡½æ•°ã€‚å®ƒæ¥æ”¶ä¸€ä¸ª <code>struct file</code> æŒ‡é’ˆã€ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºã€è¦å†™å…¥çš„å­—èŠ‚æ•°ä»¥åŠæ–‡ä»¶çš„åç§»é‡æŒ‡é’ˆï¼Œè´Ÿè´£æ‰§è¡Œå®é™…çš„æ•°æ®å†™å…¥æ“ä½œã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vfs_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å…·æœ‰å†™æƒé™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯ä»¥å†™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_CAN_WRITE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºæ˜¯å¦å¯è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="o">!</span><span class="nf">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// éªŒè¯å†™å…¥åŒºåŸŸæ˜¯å¦åˆæ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">rw_verify_area</span><span class="p">(</span><span class="n">WRITE</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// é™åˆ¶å†™å…¥å­—èŠ‚æ•°ï¼Œé¿å…è¿‡å¤§çš„å†™å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_RW_COUNT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">count</span> <span class="o">=</span>  <span class="n">MAX_RW_COUNT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// file_start_write()ï¼šç”¨äºæ–‡ä»¶ç³»ç»Ÿçš„å¹¶å‘æ§åˆ¶ï¼Œå¼€å§‹å†™æ“ä½œã€‚æŸäº›æ–‡ä»¶ç³»ç»Ÿéœ€è¦è¿™ç§æœºåˆ¶æ¥ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">file_start_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨å…·ä½“çš„å†™å…¥å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="nf">write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>  <span class="c1">// æ—§ç‰ˆå†™å…¥æ¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">write_iter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">new_sync_write</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>     <span class="c1">// æ–°ç‰ˆå†™å…¥æ¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå†™å…¥æˆåŠŸï¼Œè¿›è¡Œé€šçŸ¥å’Œæ›´æ–°ç»Ÿè®¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fsnotify_modify</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">add_wchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ›´æ–°å†™å…¥ç³»ç»Ÿè°ƒç”¨è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">inc_syscw</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»“æŸå†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">file_end_write</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>vfs_write()-&gt;sock_write_iter()</p>
<p><code>sock_write_iter()</code> æ˜¯ç”¨äºå®ç°å¥—æ¥å­—æ–‡ä»¶å†™å…¥çš„å‡½æ•°ï¼Œæ”¯æŒé€šè¿‡<strong>è¿­ä»£æ¥å£</strong> (<code>write_iter</code>)æ¥å®Œæˆå†™å…¥æ“ä½œã€‚è¯¥å‡½æ•°ä»ç”¨æˆ·ç©ºé—´è·å–æ•°æ®å¹¶å†™å…¥åˆ°ä¸ä¹‹å…³è”çš„å¥—æ¥å­—ä¸­ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sock_write_iter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iov_iter</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">msg_iter</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="p">.</span><span class="n">msg_iocb</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæ–‡ä»¶åç§»é‡ä¸ä¸º0ï¼Œåˆ™è¿”å›-ESPIPEé”™è¯¯ï¼Œå› ä¸ºå¥—æ¥å­—æ˜¯æµå¼æ–‡ä»¶ï¼Œä¸æ”¯æŒä½ç½®è°ƒæ•´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæ–‡ä»¶æ˜¯éé˜»å¡æ¨¡å¼æˆ–è€…IOCBæ ‡å¿—è®¾ç½®äº†ä¸ç­‰å¾…ï¼Œåˆ™è®¾ç½®æ¶ˆæ¯æ ‡å¿—MSG_DONTWAIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">||</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_flags</span> <span class="o">&amp;</span> <span class="n">IOCB_NOWAIT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå¥—æ¥å­—ç±»å‹æ˜¯é¡ºåºåŒ…ï¼ˆSOCK_SEQPACKETï¼‰ï¼Œè®¾ç½®æ¶ˆæ¯æ ‡å¿—MSG_EOR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SOCK_SEQPACKET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">MSG_EOR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨å†…æ ¸å‡½æ•°å‘é€æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">res</span> <span class="o">=</span> <span class="nf">__sock_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ›´æ–°è¿­ä»£å™¨çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">from</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sock_sendmsg()-&gt;__sock_sendmsg()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">__sock_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span> <span class="o">?:</span> <span class="nf">sock_sendmsg_nosec</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>__sock_sendmsg()-&gt;sock_sendmsg_nosec()</p>
<p><code>sock_sendmsg_nosec()</code> æ˜¯ä¸€ä¸ªå†…æ ¸ä¸­çš„é™æ€å†…è”å‡½æ•°ï¼Œä¸»è¦ç”¨äºå‘é€æ¶ˆæ¯ï¼ˆ<code>sendmsg</code>ï¼‰çš„æ“ä½œã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†ç”¨æˆ·ç©ºé—´çš„æ¶ˆæ¯å°è£…åï¼Œé€šè¿‡è°ƒç”¨å¥—æ¥å­—åè®®çš„å‘é€å‡½æ•°ï¼Œå°†æ•°æ®å‘é€åˆ°ç›¸åº”çš„ç½‘ç»œæ ˆä¸­ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sock_sendmsg_nosec</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// READ_ONCE(sock-&gt;ops)-&gt;sendmsgï¼šä½¿ç”¨ READ_ONCE è¯»å–å¥—æ¥å­—çš„æ“ä½œç»“æ„ä½“ï¼ˆsock-&gt;opsï¼‰ä¸­çš„ sendmsg å‡½æ•°æŒ‡é’ˆï¼Œç¡®ä¿è¯»å–çš„åŸå­æ€§ã€‚sendmsg æ˜¯ä¸åŒåè®®çš„å®ç°å‡½æ•°ï¼Œè¿™é‡Œé€šè¿‡åŠ¨æ€åˆ¤æ–­åè®®ç±»å‹å¹¶è°ƒç”¨åˆé€‚çš„ sendmsg å‡½æ•°ï¼Œå…ˆè°ƒç”¨sock-&gt;ops-&gt;sendmsgï¼Œè‹¥ä¸ºç©ºï¼Œåˆ™ä¼šè°ƒç”¨IPv4 æˆ– IPv6 ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">INDIRECT_CALL_INET</span><span class="p">(</span><span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">,</span> <span class="n">inet6_sendmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="n">inet_sendmsg</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIOCBQUEUED</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">trace_sock_send_length_enabled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nf">call_trace_sock_send_length</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_sendmsg_nosec()-&gt;unix_stream_sendmsg()</p>
<p><code>unix_stream_sendmsg()</code> æ˜¯ç”¨äº Unix åŸŸå¥—æ¥å­—çš„æ•°æ®å‘é€å‡½æ•°ï¼Œæ”¯æŒæµå¼ (<code>SOCK_STREAM</code>) å¥—æ¥å­—ã€‚å®ƒè´Ÿè´£å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®é€šè¿‡å¥—æ¥å­—å‘é€ç»™å·²è¿æ¥çš„å¦ä¸€ç«¯ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_sendmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">other</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">scm_cookie</span> <span class="n">scm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">fds_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">data_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç­‰å¾… Unix åƒåœ¾å›æ”¶å®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wait_for_unix_gc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤„ç†æ§åˆ¶ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="nf">scm_send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸æ”¯æŒ MSG_OOBï¼ˆå¸¦å¤–æ•°æ®ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">len</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// éªŒè¯æ˜¯å¦æœ‰ç›®æ ‡è¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_namelen</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">==</span> <span class="n">TCP_ESTABLISHED</span> <span class="o">?</span> <span class="o">-</span><span class="nl">EISCONN</span> <span class="p">:</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">other</span> <span class="o">=</span> <span class="nf">unix_peer</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">other</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥å‘é€ç«¯æ˜¯å¦å·²ç»å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">SEND_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">pipe_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¾ªç¯å‘é€æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">sent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_SPLICE_PAGES</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä½¿ç”¨ splice æ–¹æ³•åˆ†é…å‘é€ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skb</span> <span class="o">=</span> <span class="nf">sock_alloc_send_pskb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä»¥å‘é€ç¼“å†²åŒºçš„ä¸€åŠå¤§å°ä¸ºæœ€å¤§å€¼ï¼Œé¿å…é˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">size</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// é™åˆ¶ size ä»¥ä¿è¯å¯ä»¥è¿›è¡Œ order-0 åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">size</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nf">SKB_MAX_HEAD</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">UNIX_SKB_FRAGS_SZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">data_len</span> <span class="o">=</span> <span class="kt">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="nf">SKB_MAX_HEAD</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="n">data_len</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">data_len</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// åˆ†é…å‘é€ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">skb</span> <span class="o">=</span> <span class="nf">sock_alloc_send_pskb</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="nf">get_order</span><span class="p">(</span><span class="n">UNIX_SKB_FRAGS_SZ</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†æ–‡ä»¶æè¿°ç¬¦ä»…åœ¨ç¬¬ä¸€ä¸ªç¼“å†²åŒºä¸­å‘é€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">err</span> <span class="o">=</span> <span class="nf">unix_scm_to_skb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">!</span><span class="n">fds_sent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">fds_sent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä½¿ç”¨ splice è¿›è¡Œæ•°æ®æ‹·è´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_SPLICE_PAGES</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">err</span> <span class="o">=</span> <span class="nf">skb_splice_from_iter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iter</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_allocation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">size</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">refcount_add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="n">data_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å°†æ•°æ®ä»è¿­ä»£å™¨æ‹·è´åˆ°å‘é€ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">err</span> <span class="o">=</span> <span class="nf">skb_copy_datagram_from_iter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_iter</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// é”ä½å¯¹ç«¯å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå¯¹ç«¯å¥—æ¥å­—å·²å…³é—­ï¼Œè·³è½¬åˆ°é”™è¯¯å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nf">sock_flag</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">pipe_err_free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// æ·»åŠ å‡­æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">maybe_add_creds</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">scm_stat_add</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†æ•°æ®åŒ…åŠ å…¥åˆ°å¯¹ç«¯çš„æ¥æ”¶é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// é€šçŸ¥å¯¹ç«¯æœ‰æ–°æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">other</span><span class="o">-&gt;</span><span class="nf">sk_data_ready</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">sent</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>    <span class="c1">// å¤„ç†å¸¦å¤–æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">err</span> <span class="o">=</span> <span class="nf">queue_oob</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">fds_sent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sent</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é”€æ¯æ§åˆ¶ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">pipe_err_free</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">pipe_err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå‘é€å¤±è´¥ï¼Œä¸”é MSG_NOSIGNALï¼Œåˆ™å‘é€ SIGPIPE ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">MSG_NOSIGNAL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">send_sig</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">out_err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">sent</span> <span class="o">?</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_stream_sendmsgå‡½æ•°ä¸­å°†å°†æ•°æ®ä»è¿­ä»£å™¨æ‹·è´åˆ°skbä¸­æœ‰ä¸¤ç§ä¸åŒçš„æ–¹æ³•ï¼šä½¿ç”¨spliceæ–¹æ³•(skb_splice_from_iter)å’Œæ™®é€šæ–¹æ³•(skb_copy_datagram_from_iter)</p>
<p>æ³¨ï¼šspliceæ–¹æ³•ä¼šåœ¨å¯ç”¨MSG_SPLICE_PAGESé€‰é¡¹æ—¶ä½¿ç”¨ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬ä»‹ç»æ™®é€šæ–¹æ³• skb_copy_datagram_from_iter()</p>
<p><code>skb_copy_datagram_from_iter()</code> æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºå°†æ•°æ®ä» <code>iov_iter</code> è¿­ä»£å™¨å¤åˆ¶åˆ°å¥—æ¥å­—ç¼“å†²åŒº (<code>sk_buff</code>) ä¸­çš„å‡½æ•°ã€‚å®ƒç”¨äºå¤„ç†æ•°æ®çš„æ‹·è´è¿‡ç¨‹ï¼Œå°†ç”¨æˆ·ç©ºé—´æˆ–å†…æ ¸ä¸­çš„æ•°æ®ä¼ é€’åˆ° <code>sk_buff</code>ï¼Œä»¥ä¾¿è¿›è¡Œè¿›ä¸€æ­¥çš„ç½‘ç»œä¼ è¾“æˆ–å¤„ç†ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">skb_copy_datagram_from_iter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				 <span class="k">struct</span> <span class="n">iov_iter</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				 <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="nf">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">copy</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag_iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Copy header. */</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// é¦–å…ˆå°†å¤´éƒ¨æ•°æ®å¤åˆ¶åˆ°ç¼“å†²åŒºä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">copy</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_from_iter</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">from</span><span class="p">)</span> <span class="o">!=</span> <span class="n">copy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">offset</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Copy paged appendix. Hmm... why does this look so complicated? */</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¤„ç†é¡µç‰‡æ®µçš„æ•°æ®æ‹·è´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">const</span> <span class="kt">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nf">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">WARN_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nf">skb_frag_size</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">copy</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">size_t</span> <span class="n">copied</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">copy</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">copied</span> <span class="o">=</span> <span class="nf">copy_page_from_iter</span><span class="p">(</span><span class="nf">skb_frag_page</span><span class="p">(</span><span class="n">frag</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">					  <span class="nf">skb_frag_off</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					  <span class="n">copy</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">!=</span> <span class="n">copy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">offset</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">start</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Copy data from skb fragments (e.g., GSO fragments) */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">skb_walk_frags</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">frag_iter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">WARN_ON</span><span class="p">(</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">frag_iter</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">copy</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copy</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">copy</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">skb_copy_datagram_from_iter</span><span class="p">(</span><span class="n">frag_iter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="n">offset</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							<span class="n">from</span><span class="p">,</span> <span class="n">copy</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">fault</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-=</span> <span class="n">copy</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">offset</span> <span class="o">+=</span> <span class="n">copy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">start</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">fault</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="read">read()
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ksys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>read()-&gt;ksys_read()</p>
<p><code>ksys_read</code> å‡½æ•°æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºè¯»å–æ–‡ä»¶æè¿°ç¬¦å†…å®¹çš„å‡½æ•°ã€‚å®ƒçš„ç›®çš„æ˜¯ä»æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦ (<code>fd</code>) ä¸­è¯»å–æ•°æ®åˆ°ç”¨æˆ·æä¾›çš„ç¼“å†²åŒº (<code>buf</code>) ä¸­ï¼Œå¹¶è¿”å›è¯»å–çš„å­—èŠ‚æ•°ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">ksys_read</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span> <span class="o">=</span> <span class="nf">fdget_pos</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">ppos</span> <span class="o">=</span> <span class="nf">file_ppos</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ppos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">ppos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒç”¨ vfs_read() å‡½æ•°æ‰§è¡Œå®é™…çš„æ–‡ä»¶è¯»å–æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="nf">vfs_read</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ppos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fdput_pos</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ksys_read()-&gt;vfs_read()</p>
<p><code>vfs_read</code> å‡½æ•°è´Ÿè´£ä»æ–‡ä»¶å¯¹è±¡è¯»å–æ•°æ®å¹¶å°†å…¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºä¸­ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">ssize_t</span> <span class="nf">vfs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="kt">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯è¯»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å…è®¸è¯»å–æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_CAN_READ</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºçš„æœ‰æ•ˆæ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="o">!</span><span class="nf">access_ok</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// è°ƒç”¨ rw_verify_area() éªŒè¯è¯»å–çš„åŒºåŸŸæ˜¯å¦åˆæ³•ï¼Œä¸»è¦ç”¨äºæ£€æŸ¥æ–‡ä»¶çš„åç§»é‡å’Œè¯»å–çš„å­—èŠ‚æ•°æ˜¯å¦è¶…å‡ºäº†æ–‡ä»¶è¾¹ç•Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ret</span> <span class="o">=</span> <span class="nf">rw_verify_area</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é™åˆ¶è¯»å–å­—èŠ‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_RW_COUNT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">count</span> <span class="o">=</span>  <span class="n">MAX_RW_COUNT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// æ‰§è¡Œè¯»å–æ“ä½œ,è¿™é‡Œä¼šè°ƒç”¨sock_read_iter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="c1">//æ—§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="nf">read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read_iter</span><span class="p">)</span> <span class="c1">//æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ret</span> <span class="o">=</span> <span class="nf">new_sync_read</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ›´æ–°è¯»å–çš„ç»Ÿè®¡ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">fsnotify_access</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">add_rchar</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">inc_syscr</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>vfs_read()-&gt;sock_read_iter()</p>
<p><code>sock_read_iter()</code> æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºå¤„ç†å¥—æ¥å­—è¯»å–æ“ä½œçš„å‡½æ•°ã€‚å®ƒç”¨äºä»å¥—æ¥å­—ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å°†æ•°æ®å†™å…¥ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºä¸­ã€‚è¿™ä¸ªå‡½æ•°åˆ©ç”¨ <code>kiocb</code> å’Œ <code>iov_iter</code> ç»“æ„æ¥æ”¯æŒå¼‚æ­¥å’Œå‘é‡åŒ–çš„ I/O æ“ä½œã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sock_read_iter</span><span class="p">(</span><span class="k">struct</span> <span class="n">kiocb</span> <span class="o">*</span><span class="n">iocb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iov_iter</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_filp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{.</span><span class="n">msg_iter</span> <span class="o">=</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="p">.</span><span class="n">msg_iocb</span> <span class="o">=</span> <span class="n">iocb</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæ–‡ä»¶æ ‡å¿—åŒ…å« O_NONBLOCK æˆ– iocb ä¸­çš„æ ‡å¿—åŒ…å« IOCB_NOWAITï¼Œåˆ™è®¾ç½®éé˜»å¡æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span> <span class="o">||</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_flags</span> <span class="o">&amp;</span> <span class="n">IOCB_NOWAIT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span> <span class="o">=</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¡®ä¿åç§»é‡ä¸º 0ï¼Œå› ä¸º socket ä¸èƒ½è¿›è¡Œåç§»è¯»å†™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">iocb</span><span class="o">-&gt;</span><span class="n">ki_pos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœè¿­ä»£å™¨æ²¡æœ‰æ•°æ®éœ€è¦å†™å…¥ï¼Œç›´æ¥è¿”å› 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">iov_iter_count</span><span class="p">(</span><span class="n">to</span><span class="p">))</span>    <span class="cm">/* Match SYS5 behaviour */</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨ sock_recvmsg æ¥æ¥æ”¶æ¶ˆæ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">res</span> <span class="o">=</span> <span class="nf">sock_recvmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ›´æ–°è¿­ä»£å™¨çš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">msg_iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_read_iter()-&gt;sock_recvmsg()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">sock_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="nf">security_socket_recvmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span> <span class="o">?:</span> <span class="nf">sock_recvmsg_nosec</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_recvmsg()-&gt;sock_recvmsg_nosec()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sock_recvmsg_nosec</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">INDIRECT_CALL_INET</span><span class="p">(</span><span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">recvmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="n">inet6_recvmsg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="n">inet_recvmsg</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				     <span class="nf">msg_data_left</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">trace_sock_recv_length_enabled</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="nf">call_trace_sock_recv_length</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>sock_recvmsg_nosec()-&gt;unix_stream_recvmsg()</p>
<p><code>unix_stream_recvmsg()</code> æ˜¯ Linux å†…æ ¸ä¸­å¤„ç† UNIX åŸŸå¥—æ¥å­—æµç±»å‹çš„æ¶ˆæ¯æ¥æ”¶å‡½æ•°ã€‚å®ƒä¸»è¦ç”¨äºä»æµå¼ UNIX åŸŸå¥—æ¥å­—ä¸­æ¥æ”¶æ•°æ®å¹¶å¡«å……åˆ° <code>msghdr</code> ç»“æ„ä¸­ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_recvmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msghdr</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_stream_read_state</span> <span class="n">state</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">recv_actor</span> <span class="o">=</span> <span class="n">unix_stream_read_actor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">sock</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_BPF_SYSCALL
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="k">struct</span> <span class="n">proto</span> <span class="o">*</span><span class="n">prot</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å¦‚æœå¥—æ¥å­—åè®®ä¸æ˜¯ UNIX åŸŸåè®®ï¼Œåˆ™è°ƒç”¨å…¶ä»–åè®®çš„ recvmsg æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">prot</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">unix_stream_proto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">prot</span><span class="o">-&gt;</span><span class="nf">recvmsg</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="c1">// è°ƒç”¨é€šç”¨çš„ UNIX æµè¯»å–å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nf">unix_stream_read_generic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>unix_stream_recvmsg()-&gt;unix_stream_read_generic()</p>
<p><code>unix_stream_read_generic()</code> æ˜¯ä¸€ä¸ªç”¨äºä» UNIX åŸŸå¥—æ¥å­—æµä¸­è¯»å–æ•°æ®çš„å‡½æ•°ã€‚å®ƒç®¡ç†ä»å†…æ ¸ä¸­çš„å¥—æ¥å­—ç¼“å†²åŒº (<code>sk_buff</code>) ä¸­è¯»å–æ•°æ®çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå¹¶å¤„ç†å¤šä¸ªå¤æ‚åœºæ™¯ï¼ŒåŒ…æ‹¬éé˜»å¡è¯»å–ã€æ¥æ”¶å¤–å¸¦æ•°æ®ï¼ˆOOBï¼‰ã€ç­‰å¾…æ•°æ®å¯ç”¨ç­‰ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">unix_stream_read_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">unix_stream_read_state</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				    <span class="kt">bool</span> <span class="n">freezable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">scm_cookie</span> <span class="n">scm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">unix_sock</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nf">unix_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">noblock</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_DONTWAIT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">check_creds</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span> <span class="n">timeo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">skip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_state</span> <span class="o">!=</span> <span class="n">TCP_ESTABLISHED</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_OOB</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="n">err</span> <span class="o">=</span> <span class="nf">unix_stream_recv_urg</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// è·å– socket è¯»å–çš„ä½æ°´ä½æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">target</span> <span class="o">=</span> <span class="nf">sock_rcvlowat</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_WAITALL</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">timeo</span> <span class="o">=</span> <span class="nf">sock_rcvtimeo</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">noblock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scm</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// åŠ é”ä»¥é˜²æ­¢åœ¨è¯»å–è¿‡ç¨‹ä¸­å‘ç”Ÿé˜Ÿåˆ—æ··ä¹±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">skip</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="nf">sk_peek_offset</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="kt">bool</span> <span class="n">drop_skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">redo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// é”å®šå¥—æ¥å­—çš„çŠ¶æ€ä»¥è¿›è¡Œå®‰å…¨çš„æ•°æ®è¯»å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_DEAD</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">last</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">last_len</span> <span class="o">=</span> <span class="n">last</span> <span class="o">?</span> <span class="n">last</span><span class="o">-&gt;</span><span class="nl">len</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if IS_ENABLED(CONFIG_AF_UNIX_OOB)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">skb</span> <span class="o">=</span> <span class="nf">manage_oob</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sk</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">copied</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">copied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">redo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nl">again</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// æ£€æŸ¥ socket é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">err</span> <span class="o">=</span> <span class="nf">sock_error</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// æ£€æŸ¥æ¥æ”¶ç«¯å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// ç­‰å¾…æ•°æ®åˆ°æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="n">timeo</span> <span class="o">=</span> <span class="nf">unix_stream_data_wait</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">timeo</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">						      <span class="n">last_len</span><span class="p">,</span> <span class="n">freezable</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">err</span> <span class="o">=</span> <span class="nf">sock_intr_errno</span><span class="p">(</span><span class="n">timeo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">redo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">unlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//  å¾ªç¯å¤„ç† sk_buff æ•°æ®ï¼Œæ‰¾åˆ°è¦å¼€å§‹è¯»å–çš„ skbï¼Œå¹¶è·³è¿‡å·²è¢«è¯»å–çš„æ•°æ®ã€‚skip æ˜¯éœ€è¦è·³è¿‡çš„æ•°æ®å­—èŠ‚æ•°ï¼Œå®ƒé€šè¿‡ä¸æ¯ä¸ª skb çš„é•¿åº¦æ¯”è¾ƒï¼Œå†³å®šæ˜¯å¦éœ€è¦è·³è¿‡å½“å‰çš„ skbï¼Œç›´åˆ°æ‰¾åˆ°éœ€è¦è¯»å–çš„ skbã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">while</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&gt;=</span> <span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">skip</span> <span class="o">-=</span> <span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">last</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">last_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_peek_next</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// æ£€æŸ¥å¹¶è®¾ç½®æ¶ˆæ¯å‘é€è€…çš„å‡­æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">check_creds</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">unix_skb_scm_eq</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSCRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">			   <span class="nf">test_bit</span><span class="p">(</span><span class="n">SOCK_PASSPIDFD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">scm_set_cred</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">pid</span><span class="p">,</span> <span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">uid</span><span class="p">,</span> <span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">gid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_set_secdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">check_creds</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// å°†åœ°å€ä¿¡æ¯å¤åˆ¶åˆ°æ¶ˆæ¯ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">DECLARE_SOCKADDR</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="o">*</span><span class="p">,</span> <span class="n">sunaddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">					 <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_copy_addr</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">sunaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ç¡®å®šæœ¬æ¬¡è¦è¯»å–çš„æ•°æ®é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">chunk</span> <span class="o">=</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skip</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">skb_get</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// recv_actor æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œç”¨äºå°†æ•°æ®ä» sk_buff å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// recv_actor ä¼šè¯»å–ä»åç§»é‡ skip å¼€å§‹çš„ chunk å­—èŠ‚çš„æ•°æ®åˆ°æŒ‡å®šçš„ç¼“å†²åŒºï¼Œé€šå¸¸ç”± unix_stream_read_actor æŒ‡å‘çš„å‡½æ•°æ¥å®Œæˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">chunk</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="nf">recv_actor</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">drop_skb</span> <span class="o">=</span> <span class="o">!</span><span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">chunk</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">copied</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="n">copied</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">copied</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">size</span> <span class="o">-=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">drop_skb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// æ ‡è®°è¢«è¯»å–çš„éƒ¨åˆ†ï¼Œå°†å·²è¯»å–çš„æ•°æ®ä»ç¼“å†²åŒºä¸­æ ‡è®°ä¸ºå·²æ¶ˆè´¹ï¼Œå¹¶è°ƒæ•´åç§»é‡ï¼Œå¦‚æœè¯»å–å®Œæ¯•åˆ™å°† skb ä»é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶é‡Šæ”¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MSG_PEEK</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">consumed</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">sk_peek_offset_bwd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nf">scm_stat_del</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="nf">unix_detach_fds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">unix_skb_len</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">consume_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">scm</span><span class="p">.</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nf">unix_peek_fds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">sk_peek_offset_fwd</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="nf">UNIXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">).</span><span class="n">fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">last</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">last_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_lock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">skb</span> <span class="o">=</span> <span class="nf">skb_peek_next</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_receive_queue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">unix_state_unlock</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">iolock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">scm_recv_unix</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scm</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="nf">scm_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">copied</span> <span class="o">?</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å‡ ä¸ªå¥—æ¥å­—ç»“æ„ä¹‹é—´çš„åŒºåˆ«å¦‚ä¸‹è¡¨æ‰€ç¤º</p>
</blockquote>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">åç§°</th>
          <th style="text-align: left">ç±»å‹</th>
          <th style="text-align: left">ä½ç½®</th>
          <th style="text-align: left">ä¸»è¦åŠŸèƒ½</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong><code>socket</code></strong></td>
          <td style="text-align: left">ç”¨æˆ·ç©ºé—´ç»“æ„</td>
          <td style="text-align: left">ç”¨æˆ·ç©ºé—´</td>
          <td style="text-align: left">ç”±åº”ç”¨ç¨‹åºåˆ›å»ºå’Œæ“ä½œçš„ç½‘ç»œå¥—æ¥å­—æ¥å£ï¼Œæä¾›å¯¹å¤–é€šä¿¡åŠŸèƒ½ã€‚</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>sock</code></strong></td>
          <td style="text-align: left">å†…æ ¸ç©ºé—´ç»“æ„</td>
          <td style="text-align: left">å†…æ ¸ç©ºé—´</td>
          <td style="text-align: left">å†…æ ¸ä¸­çš„å¥—æ¥å­—è¡¨ç¤ºï¼Œå°è£…å…·ä½“åè®®æ ˆçš„å®ç°ï¼Œè´Ÿè´£ç®¡ç†ç½‘ç»œè¿æ¥å’Œæ•°æ®ä¼ è¾“ã€‚</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>unix_sock</code></strong></td>
          <td style="text-align: left">å†…æ ¸ç©ºé—´ç»“æ„ï¼ˆ<code>sock</code>çš„å­ç±»ï¼‰</td>
          <td style="text-align: left">å†…æ ¸ç©ºé—´</td>
          <td style="text-align: left">ä¸“ç”¨äº Unix åŸŸå¥—æ¥å­—ï¼Œå­˜å‚¨ç‰¹å®šäº Unix åŸŸå¥—æ¥å­—çš„æ•°æ®ï¼ˆå¦‚è·¯å¾„ã€åœ°å€ç­‰ï¼‰ã€‚</td>
      </tr>
  </tbody>
</table></div>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ipc/">IPC</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            æœ€åæ›´æ–°äº 2024-12-15
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist", "waline-container"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/">
        
        
            <div class="article-image">
                <img src="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/1.dc5e838b8c6aae5fdbcc6d3483dda94f_hu11388172370948836222.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æºç åˆ†æåŠæ€»ç»“"
                        
                        data-hash="md5-3F6Di4xqrl/bzG00g92pTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æºç åˆ†æåŠæ€»ç»“</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E8%B0%83%E7%A0%94/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E8%B0%83%E7%A0%94/1.456b8b62f4e93ff289a0752cb9a275a0_hu14772543834815088792.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post åŠ å¯†ç®—æ³•è°ƒç ”"
                        
                        data-hash="md5-RWuLYvTpP/KJoHUsuaJ1oA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">åŠ å¯†ç®—æ³•è°ƒç ”</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }

    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":"æ„Ÿè°¢æ‚¨çš„è¯„è®º"},"pageview":true,"requiredMeta":["nick"],"serverURL":"https://waline.chenyuan1125.top","visitor":true});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Lee
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
