<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="6.6内核下的IPC浅析">
<meta name="keywords" content="IPC、源码分析、调研"><title>进程间通信（IPC）源码分析及总结</title>

<link rel='canonical' href='/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/'>

<link rel="stylesheet" href="/scss/style.min.1d7a77f66a9605dfbac1c7922a91290042c454a1166056d913fcbcea340dd583.css"><meta property='og:title' content="进程间通信（IPC）源码分析及总结">
<meta property='og:description' content="6.6内核下的IPC浅析">
<meta property='og:url' content='/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/'>
<meta property='og:site_name' content='辰远'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='IPC' /><meta property='article:published_time' content='2024-08-08T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-12-15T20:46:51&#43;08:00'/><meta property='og:image' content='/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/1.jpg' />
<meta name="twitter:title" content="进程间通信（IPC）源码分析及总结">
<meta name="twitter:description" content="6.6内核下的IPC浅析"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/1.jpg' />

<link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu4999655723030452168.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">🍥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">辰远</a></h1>
            <h2 class="site-description">天将降大任于斯人也</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='/'
                        
                        title="首页&amp;关于"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/chenyuan1125'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>主页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>关于</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>链接</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="/en/" >English</option>
                                
                                    <option value="/" selected>中文</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#进程间通信ipc源码分析">进程间通信（IPC）源码分析</a>
      <ol>
        <li><a href="#ipc目录源码分析"><strong>IPC目录源码分析</strong>：</a>
          <ol>
            <li><a href="#消息队列">消息队列</a></li>
            <li><a href="#信号量">信号量</a></li>
            <li><a href="#共享内存">共享内存</a></li>
          </ol>
        </li>
        <li><a href="#其它ipc相关源码">其它IPC相关源码</a>
          <ol>
            <li><a href="#1-管道pipe和命名管道named-pipe">1. 管道（Pipe）和命名管道（Named Pipe）</a></li>
            <li><a href="#2-套接字socket">2. 套接字（Socket）</a></li>
            <li><a href="#3-信号signal">3. 信号（Signal）</a></li>
          </ol>
        </li>
        <li><a href="#ipc安全增强方法">IPC安全增强方法</a></li>
        <li><a href="#参考资料"><strong>参考资料：</strong></a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/">
                <img src="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/1_hu11915558973417613344.jpg"
                        srcset="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/1_hu11915558973417613344.jpg 800w, /p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/1_hu7569197827863855277.jpg 1600w"
                        width="800" 
                        height="500" 
                        loading="lazy"
                        alt="Featured image of post 进程间通信（IPC）源码分析及总结" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%97%A5%E5%B8%B8%E7%A0%94%E7%A9%B6/" style="background-color: #364073; color: #fff;">
                日常研究
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/">进程间通信（IPC）源码分析及总结</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            6.6内核下的IPC浅析
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-08-08</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 25 分钟
                </time>
            </div>
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
  <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
  <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
</svg>
                <time class="article-words">
                    12299字
                </time>
        </div>
        

    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="进程间通信ipc源码分析">进程间通信（IPC）源码分析
</h2><p>本调研报告主要分析6.6内核版本的IPC源码部分。</p>
<p>**进程间通信（IPC，InterProcess Communication）**是指在不同进程之间传播或交换信息。IPC的方式通常有管道（包括无名管道和命名管道）、消息队列、信号量、共享存储、Socket、Streams等。其中 Socket和Streams支持不同主机上的两个进程IPC。</p>
<ol>
<li>管道pipe：管道是一种半双工的通信方式，数据只能单向流动，而且只能在具有亲缘关系的进程间使用。进程的亲缘关系通常是指父子进程关系。</li>
<li>消息队列MessageQueue：消息队列是由消息的链表，存放在内核中并由消息队列标识符标识。消息队列克服了信号传递信息少、管道只能承载无格式字节流以及缓冲区大小受限等缺点。</li>
<li>共享内存SharedMemory：共享内存就是映射一段能被其他进程所访问的内存，这段共享内存由一个进程创建，但多个进程都可以访问。共享内存是最快的 IPC 方式，它是针对其他进程间通信方式运行效率低而专门设计的。它往往与其他通信机制，如信号量，配合使用，来实现进程间的同步和通信。</li>
<li>信号 ( signal ) ： 信号是一种比较复杂的通信方式，用于通知接收进程某个事件已经发生。</li>
<li>信号量Semaphore：信号量是一个计数器，可以用来控制多个进程对共享资源的访问。它常作为一种锁机制，防止某进程正在访问共享资源时，其他进程也访问该资源。因此，主要作为进程间以及同一进程内不同线程之间的同步手段。</li>
<li>套接字Socket：套接字也是一种进程间通信机制，与其他通信机制不同的是，它可用于不同及其间的进程通信</li>
</ol>
<p>IPC（Inter-Process Communication，进程间通信）相关的代码主要位于内核源码树的<code>ipc</code>目录下（主要是信号量、共享内存以及消息队列），管道和命名管道的实现主要在<code>fs/pipe.c</code>文件中，套接字主要分布在<code>net</code>目录下。</p>
<h3 id="ipc目录源码分析"><strong>IPC目录源码分析</strong>：
</h3><p><strong>compat.c</strong>：</p>
<ul>
<li>这个文件包含了兼容性代码，确保IPC机制在不同版本的Linux内核或不同硬件架构上正常工作。</li>
</ul>
<p><strong>ipc_sysctl.c</strong>：</p>
<ul>
<li>这个文件管理IPC的系统控制（sysctl）接口。Sysctl允许在运行时读取和修改内核参数，这个文件处理与IPC相关的参数。</li>
</ul>
<p><strong>mq_sysctl.c</strong>：</p>
<ul>
<li>类似于<code>ipc_sysctl.c</code>，但专门用于消息队列（MQ）。它管理消息队列IPC机制的sysctl接口参数。</li>
</ul>
<p><strong>mqueue.c</strong>：</p>
<ul>
<li>这个文件实现了消息队列功能。消息队列用于在进程之间发送和接收消息，提供一种IPC方法。</li>
</ul>
<p><strong>msg.c</strong>：</p>
<ul>
<li>这个文件可能处理System V消息队列的实现，这是类Unix操作系统中另一种消息传递IPC机制。</li>
</ul>
<p><strong>msgutil.c</strong>：</p>
<ul>
<li>包含消息队列的实用函数。这些函数可能协助完成消息队列的常见操作，例如创建、删除和管理消息缓冲区。</li>
</ul>
<p><strong>namespace.c</strong>：</p>
<ul>
<li>
<p>IPC命名空间，管理IPC命名空间的创建、销毁及相关操作。</p>
</li>
<li>
<p>核心函数：</p>
<p>1、<code>inc_ipc_namespaces</code> 和 <code>dec_ipc_namespaces</code></p>
<p>这两个函数用于增加和减少IPC命名空间的引用计数，确保正确管理命名空间的生命周期。</p>
<p>2、<code>create_ipc_ns</code>创建一个新的IPC命名空间，包括初始化相关的数据结构和资源</p>
<p>3、<code>copy_ipcs</code></p>
<p>这个函数在创建新进程时复制IPC命名空间。如果<code>CLONE_NEWIPC</code>标志被设置，则创建新的命名空间，否则返回现有的命名空间。</p>
<p>4、<code>free_ipcs</code></p>
<p>这个函数释放某个命名空间中的所有IPC资源。</p>
<p>5、<code>free_ipc_ns</code></p>
<p>这个函数释放IPC命名空间，包括相关资源的清理工作。</p>
<p>6、<code>put_ipc_ns</code></p>
<p>这个函数用于减少IPC命名空间的引用计数，并在引用计数为0时释放命名空间。</p>
<p>7、<code>ipcns_get</code>, <code>ipcns_put</code>, <code>ipcns_install</code>, <code>ipcns_owner</code></p>
<p>这些函数是针对IPC命名空间的操作接口，提供了获取、释放、安装和获取所有者等功能。</p>
</li>
</ul>
<p><strong>sem.c</strong>：</p>
<ul>
<li>这个文件实现了信号量功能，一种用于控制多个进程对共享资源访问的同步机制。</li>
</ul>
<p><strong>shm.c</strong>：</p>
<ul>
<li>这个文件处理共享内存段，允许多个进程访问相同的内存空间进行IPC。共享内存是最快的IPC机制之一。</li>
</ul>
<p><strong>syscall.c</strong>：</p>
<ul>
<li>
<p>实现了一个旧的SysV IPC系统调用多路复用器 <code>sys_ipc</code>，并提供了一个新的系统调用 <code>ksys_ipc</code> 来处理各种IPC操作。这些操作包括信号量、消息队列和共享内存的创建、控制和操作。代码还包含了兼容性处理，以支持32位和64位系统之间的交互。</p>
</li>
<li>
<p>核心函数：</p>
<p>1、 <code>ksys_ipc</code> 函数</p>
<p><code>ksys_ipc</code> 是实际处理IPC请求的核心函数。它根据传入的 <code>call</code> 参数确定具体的IPC操作，并调用相应的内核函数来处理具体的IPC操作。</p>
<p>2、<code>compat_ksys_ipc</code>函数</p>
<p>与上面那个函数一样，不过是做了一些兼容性处理。</p>
<p>3、这个宏定义了一个新的系统调用 <code>ipc</code>，它接收6个参数，并将这些参数传递给 <code>ksys_ipc</code> 函数进行处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">SYSCALL_DEFINE6</span><span class="p">(</span><span class="n">ipc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">third</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="n">fifth</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">ksys_ipc</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">fifth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><strong>util.c</strong>：</p>
<ul>
<li>
<p>包含在不同IPC机制中共享的实用函数。这些函数可能包括内存分配、错误处理或其他通用任务的辅助函数。用于初始化和管理 Linux 系统的 System V IPC（进程间通信）机制的一个模块。System V IPC 包括信号量（sem）、消息队列（msg）和共享内存（shm）。代码涉及 IPC 对象的创建、查找、权限检查、以及 ID 管理等操作。</p>
</li>
<li>
<p>核心函数:</p>
<p>1、结构体定义</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">ipc_proc_iface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">ids</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_proc_iface</code> 结构体定义了在 <code>/proc</code> 文件系统中显示 IPC 信息的接口。</p>
<p>2、初始化函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ipc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">proc_mkdir</span><span class="p">(</span><span class="s">&#34;sysvipc&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">sem_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">msg_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">shm_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">device_initcall</span><span class="p">(</span><span class="n">ipc_init</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_init</code> 函数用于初始化 IPC 子系统，创建 <code>/proc/sysvipc</code> 目录，并调用信号量、消息队列和共享内存的初始化函数。</p>
<p>3、哈希表参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rhashtable_params</span> <span class="n">ipc_kht_params</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">head_offset</span> <span class="o">=</span> <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kern_ipc_perm</span><span class="p">,</span> <span class="n">khtnode</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">key_offset</span> <span class="o">=</span> <span class="nf">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kern_ipc_perm</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="nf">sizeof_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">kern_ipc_perm</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">.</span><span class="n">automatic_shrinking</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_kht_params</code> 定义了 IPC 对象哈希表的参数，包括头部偏移、键偏移和键长度。</p>
<p>4、IPC ID 初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ipc_init_ids</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">rhashtable_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">key_ht</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipc_kht_params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">idr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">ipcs_idr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">max_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">last_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_CHECKPOINT_RESTORE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">next_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_init_ids</code> 函数初始化 IPC 标识符集，设置初始值并初始化哈希表和 ID 管理器。</p>
<p>5、进程接口初始化</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_PROC_FS
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">proc_ops</span> <span class="n">sysvipc_proc_ops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">__init</span> <span class="nf">ipc_init_proc_interface</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ids</span><span class="p">,</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pde</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_proc_iface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">iface</span> <span class="o">=</span> <span class="nf">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iface</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iface</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">show</span> <span class="o">=</span> <span class="n">show</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pde</span> <span class="o">=</span> <span class="nf">proc_create_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sysvipc_proc_ops</span><span class="p">,</span> <span class="n">iface</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pde</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">kfree</span><span class="p">(</span><span class="n">iface</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_init_proc_interface</code> 函数创建 <code>/proc</code> 文件系统中的 IPC 信息接口。</p>
<p>6、查找 IPC 键</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="nf">ipc_findkey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="kt">key_t</span> <span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ipcp</span> <span class="o">=</span> <span class="nf">rhashtable_lookup_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">key_ht</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">ipc_kht_params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipcp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_lock_object</span><span class="p">(</span><span class="n">ipcp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">ipcp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_findkey</code> 函数在哈希表中查找给定键的 IPC 对象，并返回该对象。</p>
<p>7、ID 分配</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ipc_idr_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">next_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_CHECKPOINT_RESTORE
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="n">next_id</span> <span class="o">=</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">next_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">next_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">next_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">max_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">max_idx</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">ipc_min_cycle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">max_idx</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">max_idx</span><span class="p">,</span> <span class="n">ipc_mni</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">idx</span> <span class="o">=</span> <span class="nf">idr_alloc_cyclic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">ipcs_idr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">last_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">ids</span><span class="o">-&gt;</span><span class="n">seq</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&gt;=</span> <span class="nf">ipcid_seq_max</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">					<span class="n">ids</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="n">ids</span><span class="o">-&gt;</span><span class="n">last_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">new</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">idr_replace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">ipcs_idr</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">new</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="nf">ipcid_to_seqx</span><span class="p">(</span><span class="n">next_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">idx</span> <span class="o">=</span> <span class="nf">idr_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">ipcs_idr</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="nf">ipcid_to_idx</span><span class="p">(</span><span class="n">next_id</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_NOWAIT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">new</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&lt;&lt;</span> <span class="nf">ipcmni_seq_shift</span><span class="p">())</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_idr_alloc</code> 函数将一个新的IPC对象添加到IDR中，并且分配新的 IPC ID和设置 IPC 对象的序列号。</p>
<p>8、添加一个IPC对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">ipc_addid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">new</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">kuid_t</span> <span class="n">euid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">kgid_t</span> <span class="n">egid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">refcount_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;</span> <span class="n">ipc_mni</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">limit</span> <span class="o">=</span> <span class="n">ipc_mni</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">idr_preload</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="nf">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">current_euid_egid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">euid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">egid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">new</span><span class="o">-&gt;</span><span class="n">cuid</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">euid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">new</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">cgid</span> <span class="o">=</span> <span class="n">egid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">new</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">idx</span> <span class="o">=</span> <span class="nf">ipc_idr_alloc</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">idr_preload_end</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">!=</span> <span class="n">IPC_PRIVATE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">rhashtable_insert_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">key_ht</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">khtnode</span><span class="p">,</span> <span class="n">ipc_kht_params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">ipcs_idr</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">idx</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">new</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">max_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">ids</span><span class="o">-&gt;</span><span class="n">max_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_addid</code> 函数将新的 IPC 对象添加到 IDR，并在哈希表中插入该对象。</p>
<p>8、新建 IPC 对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">ipcget_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipc_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="nf">getnew</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipcget_new</code> 函数创建一个新的 IPC 对象。</p>
<p>9、检查 IPC 权限</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">ipc_check_perms</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipc_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ipcp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">flg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="nf">associate</span><span class="p">(</span><span class="n">ipcp</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">flg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_check_perms</code> 函数检查 IPC 对象的权限。</p>
<p>10、获取公共 IPC 对象</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">ipcget_public</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipc_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">flg</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">flg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">ipcp</span> <span class="o">=</span> <span class="nf">ipc_findkey</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ipcp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flg</span> <span class="o">&amp;</span> <span class="n">IPC_CREAT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="nf">getnew</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">flg</span> <span class="o">&amp;</span> <span class="n">IPC_CREAT</span> <span class="o">&amp;&amp;</span> <span class="n">flg</span> <span class="o">&amp;</span> <span class="n">IPC_EXCL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="nf">ipc_check_perms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ipcp</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="n">ipcp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">rwsem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipcget</code> 函数是 IPC 对象的入口函数，根据键值决定是获取现有对象还是创建新对象。</p>
<p>11、从哈希表中移除ipc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">ipc_kht_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">!=</span> <span class="n">IPC_PRIVATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WARN_ON_ONCE</span><span class="p">(</span><span class="nf">rhashtable_remove_fast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">key_ht</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">khtnode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				       <span class="n">ipc_kht_params</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_kht_remove</code>函数用于从哈希表移除ipc</p>
<p>12、删除ipc</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ipc_rmid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="o">*</span><span class="n">ipcp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="nf">ipcid_to_idx</span><span class="p">(</span><span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">WARN_ON_ONCE</span><span class="p">(</span><span class="nf">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">ipcs_idr</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ipcp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_kht_remove</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">ipcp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">in_use</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ipcp</span><span class="o">-&gt;</span><span class="n">deleted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">max_idx</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">idx</span> <span class="o">=</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">max_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">idx</span> <span class="o">=</span> <span class="nf">ipc_search_maxidx</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">ids</span><span class="o">-&gt;</span><span class="n">max_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ipc_rmid</code>函数用于移除ipc</p>
<p><strong>其余函数未全部列出</strong></p>
</li>
</ul>
<p><strong>util.h</strong>：</p>
<ul>
<li>与<code>util.c</code>相关的头文件。它声明了<code>util.c</code>中定义的函数和变量，使它们对IPC子系统的其他部分可访问</li>
</ul>
<p>Linux 内核提供了多种 IPC 机制，其中System V IPC 包括：System V 信号量、System V消息队列、System V 共享内存。这三种通信机制有很多相似之处。</p>
<p><img src="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/assets/1642296-20231130110247534-1932712565.png"
	width="897"
	height="321"
	srcset="/p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/assets/1642296-20231130110247534-1932712565_hu14328424408300395368.png 480w, /p/%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1ipc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%8F%8A%E6%80%BB%E7%BB%93/assets/1642296-20231130110247534-1932712565_hu3407486723773563772.png 1024w"
	loading="lazy"
	
		alt="img"
	
	
		class="gallery-image" 
		data-flex-grow="279"
		data-flex-basis="670px"
	
></p>
<p>创建流程如下：</p>
<p><img src="https://img.ffutop.com/DED2216C-127B-4036-84D8-33A2E44C5B33.png"
	
	
	
	loading="lazy"
	
		alt="ipc"
	
	
></p>
<h4 id="消息队列">消息队列
</h4><p><strong>消息队列</strong>，是消息的链接表，存放在内核中。一个消息队列由一个标识符（即队列ID）来标识。</p>
<p>消息队列（Message Queue,简称MQ）是由内核管理的消息链接表，由消息队列标识符标识，标识符简称队列ID。消息队列提供了进程之间单向传送数据的方法，每个消息包含有一个正的长整型类型的数据段、一个非负的长度以及实际数据字节数（对应于长度），消息队列总字节数是有上限的，系统上消息队列总数也有上限。</p>
<p>MQ传递的是消息，也就是进程间需要传递的数据，系统内核中有很多MQ，这些MQ采用链表实现并由系统内核维护，每个MQ用消息队列描述符（qid)来区分，每个MQ 的pid具有唯一性。</p>
<p><img src="https://img.ffutop.com/409ECF12-A0E5-4B0F-AD96-FE9EA73FD972.png"
	
	
	
	loading="lazy"
	
		alt="img"
	
	
></p>
<h5 id="原型">原型
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1">#include &lt;sys/msg.h&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">创建或打开消息队列：成功返回队列</span><span class="n">ID</span><span class="err">，失败返回</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">msgget</span><span class="p">(</span><span class="n">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="ne">int</span> <span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">添加消息：成功返回</span><span class="mi">0</span><span class="err">，失败返回</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">msgsnd</span><span class="p">(</span><span class="ne">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">const</span> <span class="n">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="ne">int</span> <span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">读取消息：成功返回消息数据的长度，失败返回</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">msgrcv</span><span class="p">(</span><span class="ne">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">long</span> <span class="n">type</span><span class="p">,</span><span class="ne">int</span> <span class="n">flag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">控制消息队列：成功返回</span><span class="mi">0</span><span class="err">，失败返回</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="ne">int</span> <span class="n">msgctl</span><span class="p">(</span><span class="ne">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="ne">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">struct</span> <span class="n">msqid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在以下两种情况下，<code>msgget</code>将创建一个新的消息队列：</p>
<ul>
<li>如果没有与键值key相对应的消息队列，并且flag中包含了<code>IPC_CREAT</code>标志位。</li>
<li>key参数为<code>IPC_PRIVATE</code>。</li>
</ul>
<p>函数<code>msgrcv</code>在读取消息队列时，type参数有下面几种情况：</p>
<ul>
<li><code>type == 0</code>，返回队列中的第一个消息；</li>
<li><code>type &gt; 0</code>，返回队列中消息类型为 type 的第一个消息；</li>
<li><code>type &lt; 0</code>，返回队列中消息类型值小于或等于 type 绝对值的消息，如果有多个，则取类型值最小的消息。</li>
</ul>
<h5 id="主要结构体">主要结构体
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* one msq_queue structure for each present queue on the system */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">msg_queue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="n">q_perm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span> <span class="n">q_stime</span><span class="p">;</span>		<span class="cm">/* last msgsnd time */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span> <span class="n">q_rtime</span><span class="p">;</span>		<span class="cm">/* last msgrcv time */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span> <span class="n">q_ctime</span><span class="p">;</span>		<span class="cm">/* last change time */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_cbytes</span><span class="p">;</span>		<span class="cm">/* current number of bytes on queue */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_qnum</span><span class="p">;</span>		<span class="cm">/* number of messages in queue */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">q_qbytes</span><span class="p">;</span>		<span class="cm">/* max number of bytes on queue */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">q_lspid</span><span class="p">;</span>		<span class="cm">/* pid of last msgsnd */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">q_lrpid</span><span class="p">;</span>		<span class="cm">/* last receive pid */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">q_messages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">q_receivers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">q_senders</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* one msg_receiver structure for each sleeping receiver */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">msg_receiver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">r_list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">r_tsk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>			<span class="n">r_mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span>			<span class="n">r_msgtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span>			<span class="n">r_maxsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">msg_msg</span>		<span class="o">*</span><span class="n">r_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* one msg_sender for each sleeping sender */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">msg_sender</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">task_struct</span>	<span class="o">*</span><span class="n">tsk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">size_t</span>                  <span class="n">msgsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="核心函数">核心函数
</h5><p><code>msgget</code>函数实现负责创建或打开消息队列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">ksys_msgget</span><span class="p">(</span><span class="kt">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipc_ops</span> <span class="n">msg_ops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">getnew</span> <span class="o">=</span> <span class="n">newque</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">associate</span> <span class="o">=</span> <span class="n">security_msg_queue_associate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_params</span> <span class="n">msg_params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">msg_params</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">msg_params</span><span class="p">.</span><span class="n">flg</span> <span class="o">=</span> <span class="n">msgflg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ipcget</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="nf">msg_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">msg_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>msgsnd</code>函数实际由<code>do_msgsnd</code>函数实现，负责对消息的发送。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">do_msgsnd</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">long</span> <span class="n">mtype</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mtext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DEFINE_WAKE_Q</span><span class="p">(</span><span class="n">wake_q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">msgsz</span> <span class="o">&gt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmax</span> <span class="o">||</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">msgsz</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">msqid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">mtype</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">msg</span> <span class="o">=</span> <span class="nf">load_msg</span><span class="p">(</span><span class="n">mtext</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_type</span> <span class="o">=</span> <span class="n">mtype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span> <span class="o">=</span> <span class="n">msgsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">msq</span> <span class="o">=</span> <span class="nf">msq_obtain_object_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_unlock1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_lock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">msg_sender</span> <span class="n">s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">S_IWUGO</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* raced with RMID? */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">ipc_valid_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">security_msg_queue_msgsnd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">msg_fits_inqueue</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* queue full, wait: */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">IPC_NOWAIT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* enqueue the sender and prepare to block */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ss_add</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">ipc_rcu_getref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="nf">schedule</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_lock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_rcu_putref</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">msg_rcu_free</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* raced with RMID? */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">ipc_valid_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ss_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTNOHAND</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_update_pid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lspid</span><span class="p">,</span> <span class="nf">task_tgid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_stime</span> <span class="o">=</span> <span class="nf">ktime_get_real_seconds</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">pipelined_send</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wake_q</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* no one is waiting for this message, enqueue it */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_messages</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span> <span class="o">+=</span> <span class="n">msgsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">percpu_counter_add_local</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">percpu_msg_bytes</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">percpu_counter_add_local</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">percpu_msg_hdrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">wake_up_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wake_q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>msgrcv</code>函数实际由<code>do_msgr</code>cv函数实现，实现对消息的接收。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">do_msgrcv</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">bufsz</span><span class="p">,</span> <span class="kt">long</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	       <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">msg_handler</span><span class="p">)(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">msg_queue</span> <span class="o">*</span><span class="n">msq</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">msg_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">copy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DEFINE_WAKE_Q</span><span class="p">(</span><span class="n">wake_q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">msqid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">bufsz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_COPY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_EXCEPT</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">IPC_NOWAIT</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">copy</span> <span class="o">=</span> <span class="nf">prepare_copy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="kt">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">bufsz</span><span class="p">,</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">msg_ctlmax</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">copy</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">mode</span> <span class="o">=</span> <span class="nf">convert_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msgtyp</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">msq</span> <span class="o">=</span> <span class="nf">msq_obtain_object_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free_copy</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">msq</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">msg_receiver</span> <span class="n">msr_d</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">msg</span> <span class="o">=</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EACCES</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_lock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* raced with RMID? */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">ipc_valid_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">msg</span> <span class="o">=</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EIDRM</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">msg</span> <span class="o">=</span> <span class="nf">find_msg</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msgtyp</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * Found a suitable message.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * Unlink it from the queue.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 */</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">((</span><span class="n">bufsz</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_NOERROR</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">msg</span> <span class="o">=</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">E2BIG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * If we are copying, then do not unlink message and do
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * not update queue parameters.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 */</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_COPY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">msg</span> <span class="o">=</span> <span class="nf">copy_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">copy</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nf">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_qnum</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_rtime</span> <span class="o">=</span> <span class="nf">ktime_get_real_seconds</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="nf">ipc_update_pid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_lrpid</span><span class="p">,</span> <span class="nf">task_tgid</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_cbytes</span> <span class="o">-=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="nf">percpu_counter_sub_local</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">percpu_msg_bytes</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">m_ts</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">percpu_counter_sub_local</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns</span><span class="o">-&gt;</span><span class="n">percpu_msg_hdrs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">ss_wakeup</span><span class="p">(</span><span class="n">msq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wake_q</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* No message waiting. Wait for a message */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">IPC_NOWAIT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">msg</span> <span class="o">=</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMSG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_receivers</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">msr_d</span><span class="p">.</span><span class="n">r_tsk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">msr_d</span><span class="p">.</span><span class="n">r_msgtype</span> <span class="o">=</span> <span class="n">msgtyp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">msr_d</span><span class="p">.</span><span class="n">r_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">msgflg</span> <span class="o">&amp;</span> <span class="n">MSG_NOERROR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">msr_d</span><span class="p">.</span><span class="n">r_maxsize</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">msr_d</span><span class="p">.</span><span class="n">r_maxsize</span> <span class="o">=</span> <span class="n">bufsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* memory barrier not require due to ipc_lock_object() */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">WRITE_ONCE</span><span class="p">(</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_msg</span><span class="p">,</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/* memory barrier not required, we own ipc_lock_object() */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="nf">schedule</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Lockless receive, part 1:
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * We don&#39;t hold a reference to the queue and getting a
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * reference would defeat the idea of a lockless operation,
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * thus the code relies on rcu to guarantee the existence of
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * msq:
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Prior to destruction, expunge_all(-EIRDM) changes r_msg.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Thus if r_msg is -EAGAIN, then the queue not yet destroyed.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Lockless receive, part 2:
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * The work in pipelined_send() and expunge_all():
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * - Set pointer to message
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * - Queue the receiver task for later wakeup
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * - Wake up the process after the lock is dropped.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 *
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Should the process wake up before this wakeup (due to a
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * signal) it will either see the message and continue ...
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="n">msg</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* see MSG_BARRIER for purpose/pairing */</span>
</span></span><span class="line"><span class="cl">			<span class="nf">smp_acquire__after_ctrl_dep</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		 <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		  * ... or see -EAGAIN, acquire the lock to check the message
</span></span></span><span class="line"><span class="cl"><span class="cm">		  * again.
</span></span></span><span class="line"><span class="cl"><span class="cm">		  */</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_lock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">msg</span> <span class="o">=</span> <span class="nf">READ_ONCE</span><span class="p">(</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msr_d</span><span class="p">.</span><span class="n">r_list</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">msg</span> <span class="o">=</span> <span class="nf">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ERESTARTNOHAND</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">out_unlock0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msq</span><span class="o">-&gt;</span><span class="n">q_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">wake_up_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wake_q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">free_copy</span><span class="p">(</span><span class="n">copy</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">bufsz</span> <span class="o">=</span> <span class="nf">msg_handler</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">bufsz</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">free_msg</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">bufsz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">ksys_msgrcv</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msgbuf</span> <span class="n">__user</span> <span class="o">*</span><span class="n">msgp</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msgsz</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		 <span class="kt">long</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msgflg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">do_msgrcv</span><span class="p">(</span><span class="n">msqid</span><span class="p">,</span> <span class="n">msgp</span><span class="p">,</span> <span class="n">msgsz</span><span class="p">,</span> <span class="n">msgtyp</span><span class="p">,</span> <span class="n">msgflg</span><span class="p">,</span> <span class="n">do_msg_fill</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ksys_msgctl</code>函数负责控制消息队列，根据具体cmd选择不同的操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">ksys_msgctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">msqid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">msqid_ds</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">msqid64_ds</span> <span class="n">msqid64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">msqid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_INFO</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">MSG_INFO</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">msginfo</span> <span class="n">msginfo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">msgctl_info</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msginfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msginfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">msginfo</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">MSG_STAT</span><span class="p">:</span>	<span class="cm">/* msqid is an index rather than a msg queue id */</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">MSG_STAT_ANY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_STAT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">msgctl_stat</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msqid64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_msqid_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msqid64</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_SET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_msqid_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msqid64</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">msgctl_down</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msqid64</span><span class="p">.</span><span class="n">msg_perm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				   <span class="n">msqid64</span><span class="p">.</span><span class="n">msg_qbytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_RMID</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">msgctl_down</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">msqid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="信号量">信号量
</h4><p>**信号量（semaphore）**与已经介绍过的 IPC 结构不同，它是一个计数器。信号量用于实现进程间的互斥与同步，而不是用于存储进程间通信数据。</p>
<h5 id="特点"><strong>特点</strong>
</h5><ol>
<li>信号量用于进程间同步，若要在进程间传递数据需要结合<em>共享内存</em>。</li>
<li>信号量基于操作系统的 PV 操作，程序对信号量的操作都是原子操作。</li>
<li>每次对信号量的 PV 操作不仅限于对信号量值加 1 或减 1，而且可以加减任意正整数。</li>
<li>支持信号量组。</li>
</ol>
<p><img src="https://img.ffutop.com/7A24F185-3480-4C29-A006-C66BB54E046F.png"
	
	
	
	loading="lazy"
	
		alt="img"
	
	
></p>
<h5 id="结构体"><strong>结构体</strong>
</h5><p>最简单的信号量是只能取 0 和 1 的变量，这也是信号量最常见的一种形式，叫做<strong>二值信号量（Binary Semaphore）</strong>。而可以取多个正整数的信号量被称为通用信号量。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* One semaphore structure for each semaphore in the system. */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">sem</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>	<span class="n">semval</span><span class="p">;</span>		<span class="cm">/* current value */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * PID of the process that last modified the semaphore. For
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * Linux, specifically these are:
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *  - semop
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *  - semctl, via SETVAL and SETALL.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *  - at task exit when performing undo adjustments (see exit_sem).
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">pid</span> <span class="o">*</span><span class="n">sempid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>	<span class="cm">/* spinlock for fine-grained semtimedop */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">pending_alter</span><span class="p">;</span> <span class="cm">/* pending single-sop operations */</span>
</span></span><span class="line"><span class="cl">					<span class="cm">/* that alter the semaphore */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">pending_const</span><span class="p">;</span> <span class="cm">/* pending single-sop operations */</span>
</span></span><span class="line"><span class="cl">					<span class="cm">/* that do not alter the semaphore*/</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span>	 <span class="n">sem_otime</span><span class="p">;</span>	<span class="cm">/* candidate for sem_otime */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* One sem_array data structure for each set of semaphores in the system. */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">sem_array</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">kern_ipc_perm</span>	<span class="n">sem_perm</span><span class="p">;</span>	<span class="cm">/* permissions .. see ipc.h */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span>		<span class="n">sem_ctime</span><span class="p">;</span>	<span class="cm">/* create/last semctl() time */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">pending_alter</span><span class="p">;</span>	<span class="cm">/* pending operations */</span>
</span></span><span class="line"><span class="cl">						<span class="cm">/* that alter the array */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">pending_const</span><span class="p">;</span>	<span class="cm">/* pending complex operations */</span>
</span></span><span class="line"><span class="cl">						<span class="cm">/* that do not alter semvals */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list_id</span><span class="p">;</span>	<span class="cm">/* undo requests on this array */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>			<span class="n">sem_nsems</span><span class="p">;</span>	<span class="cm">/* no. of semaphores in array */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>			<span class="n">complex_count</span><span class="p">;</span>	<span class="cm">/* pending complex operations */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">use_global_lock</span><span class="p">;</span><span class="cm">/* &gt;0: global lock required */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sem</span>		<span class="n">sems</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="核心函数-1"><strong>核心函数</strong>
</h5><p><code>semget</code>函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">ksys_semget</span><span class="p">(</span><span class="kt">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nsems</span><span class="p">,</span> <span class="kt">int</span> <span class="n">semflg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipc_ops</span> <span class="n">sem_ops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">getnew</span> <span class="o">=</span> <span class="n">newary</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">associate</span> <span class="o">=</span> <span class="n">security_sem_associate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">more_checks</span> <span class="o">=</span> <span class="n">sem_more_checks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_params</span> <span class="n">sem_params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">nsems</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nsems</span> <span class="o">&gt;</span> <span class="n">ns</span><span class="o">-&gt;</span><span class="n">sc_semmsl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sem_params</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sem_params</span><span class="p">.</span><span class="n">flg</span> <span class="o">=</span> <span class="n">semflg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sem_params</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">nsems</span> <span class="o">=</span> <span class="n">nsems</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ipcget</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="nf">sem_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">sem_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sem_params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>perform_atomic_semop</code>函数，尝试在给定的数组上进行信号量操作（PV操作），遍历两次队列确保整个操作顺利完成。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * perform_atomic_semop[_slow] - Attempt to perform semaphore
</span></span></span><span class="line"><span class="cl"><span class="cm"> *                               operations on a given array.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @sma: semaphore array
</span></span></span><span class="line"><span class="cl"><span class="cm"> * @q: struct sem_queue that describes the operation
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Caller blocking are as follows, based the value
</span></span></span><span class="line"><span class="cl"><span class="cm"> * indicated by the semaphore operation (sem_op):
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  (1) &gt;0 never blocks.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  (2)  0 (wait-for-zero operation): semval is non-zero.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *  (3) &lt;0 attempting to decrement semval to a value smaller than zero.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Returns 0 if the operation was possible.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Returns 1 if the operation is impossible, the caller must sleep.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Returns &lt;0 for error codes.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">perform_atomic_semop</span><span class="p">(</span><span class="k">struct</span> <span class="n">sem_array</span> <span class="o">*</span><span class="n">sma</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sem_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">sem_op</span><span class="p">,</span> <span class="n">nsops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sembuf</span> <span class="o">*</span><span class="n">sop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sem</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sembuf</span> <span class="o">*</span><span class="n">sops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">sem_undo</span> <span class="o">*</span><span class="n">un</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sops</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">sops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">nsops</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">nsops</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">un</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">undo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dupsop</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">perform_atomic_semop_slow</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * We scan the semaphore set twice, first to ensure that the entire
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * operation can succeed, therefore avoiding any pointless writes
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * to shared memory and having to undo such changes in order to block
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * until the operations can go through.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">sop</span> <span class="o">=</span> <span class="n">sops</span><span class="p">;</span> <span class="n">sop</span> <span class="o">&lt;</span> <span class="n">sops</span> <span class="o">+</span> <span class="n">nsops</span><span class="p">;</span> <span class="n">sop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="nf">array_index_nospec</span><span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">,</span> <span class="n">sma</span><span class="o">-&gt;</span><span class="n">sem_nsems</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">curr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sma</span><span class="o">-&gt;</span><span class="n">sems</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">sem_op</span> <span class="o">=</span> <span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">result</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">semval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sem_op</span> <span class="o">&amp;&amp;</span> <span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">would_block</span><span class="p">;</span> <span class="cm">/* wait-for-zero */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">result</span> <span class="o">+=</span> <span class="n">sem_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">would_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">SEMVMX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_flg</span> <span class="o">&amp;</span> <span class="n">SEM_UNDO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">undo</span> <span class="o">=</span> <span class="n">un</span><span class="o">-&gt;</span><span class="n">semadj</span><span class="p">[</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">]</span> <span class="o">-</span> <span class="n">sem_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="cm">/* Exceeding the undo range is an error. */</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">undo</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">-</span><span class="n">SEMAEM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">undo</span> <span class="o">&gt;</span> <span class="n">SEMAEM</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="n">sop</span> <span class="o">=</span> <span class="n">sops</span><span class="p">;</span> <span class="n">sop</span> <span class="o">&lt;</span> <span class="n">sops</span> <span class="o">+</span> <span class="n">nsops</span><span class="p">;</span> <span class="n">sop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">curr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sma</span><span class="o">-&gt;</span><span class="n">sems</span><span class="p">[</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">sem_op</span> <span class="o">=</span> <span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_flg</span> <span class="o">&amp;</span> <span class="n">SEM_UNDO</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kt">int</span> <span class="n">undo</span> <span class="o">=</span> <span class="n">un</span><span class="o">-&gt;</span><span class="n">semadj</span><span class="p">[</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">]</span> <span class="o">-</span> <span class="n">sem_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="n">un</span><span class="o">-&gt;</span><span class="n">semadj</span><span class="p">[</span><span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">undo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">curr</span><span class="o">-&gt;</span><span class="n">semval</span> <span class="o">+=</span> <span class="n">sem_op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_update_pid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">sempid</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">would_block</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="n">q</span><span class="o">-&gt;</span><span class="n">blocking</span> <span class="o">=</span> <span class="n">sop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">sop</span><span class="o">-&gt;</span><span class="n">sem_flg</span> <span class="o">&amp;</span> <span class="n">IPC_NOWAIT</span> <span class="o">?</span> <span class="o">-</span><span class="nl">EAGAIN</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>ksys_semctl</code>函数，该函数用来控制信号量，它与共享内存的shmctl函数和消息队列的msgctl相似</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">ksys_semctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">semid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">semnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">semid64_ds</span> <span class="n">semid64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">semid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_INFO</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SEM_INFO</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">semctl_info</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">semid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_STAT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SEM_STAT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SEM_STAT_ANY</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">semctl_stat</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">semid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">semid64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_semid_to_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">semid64</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">GETALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">GETVAL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">GETPID</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">GETNCNT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">GETZCNT</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SETALL</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">semctl_main</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">semid</span><span class="p">,</span> <span class="n">semnum</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">SETVAL</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#if defined(CONFIG_64BIT) &amp;&amp; defined(__BIG_ENDIAN)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="cm">/* big-endian 64bit */</span>
</span></span><span class="line"><span class="cl">		<span class="n">val</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#else
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="cm">/* 32bit or little-endian 64bit */</span>
</span></span><span class="line"><span class="cl">		<span class="n">val</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>		<span class="k">return</span> <span class="nf">semctl_setval</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">semid</span><span class="p">,</span> <span class="n">semnum</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_SET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">copy_semid_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">semid64</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">fallthrough</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nl">IPC_RMID</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">semctl_down</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">semid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">semid64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="共享内存">共享内存
</h4><p><strong>共享内存（Shared Memory）</strong>，指两个或多个进程共享一个给定的存储区。</p>
<h5 id="特点-1"><strong>特点</strong>
</h5><ol>
<li>共享内存是最快的一种 IPC，因为进程是直接对内存进行存取。</li>
<li>共享内存操作默认不阻塞，如果多个进程同时读写共享内存，可能出现数据混乱，共享内存需要借助其他机制来保证进程间的数据同步，比如：信号量，共享内存内部没有提供这种机制。</li>
</ol>
<p><img src="https://img.ffutop.com/85BB67B8-0EE1-4657-8242-760645A06ED1.png"
	
	
	
	loading="lazy"
	
		alt="img"
	
	
></p>
<h5 id="核心函数-2"><strong>核心函数</strong>
</h5><ol>
<li><strong>创建共享内存段 (<code>shmget</code>)</strong>：
<ul>
<li><code>shmget</code> 系统调用创建新的共享内存段，分配对应的物理内存，并初始化相关的结构体信息。</li>
</ul>
</li>
<li><strong>附加共享内存段 (<code>shmat</code>)</strong>：
<ul>
<li><code>shmat</code> 系统调用将共享内存段映射到调用进程的地址空间中，更新附加计数和时间戳。</li>
</ul>
</li>
<li><strong>分离共享内存段 (<code>shmdt</code>)</strong>：
<ul>
<li><code>shmdt</code> 系统调用将共享内存段从调用进程的地址空间中解除映射，更新附加计数和时间戳。</li>
</ul>
</li>
<li><strong>控制共享内存段 (<code>shmctl</code>)</strong>：
<ul>
<li><code>shmctl</code> 系统调用用于控制共享内存段，例如设置权限、删除共享内存段等。</li>
</ul>
</li>
</ol>
<h5 id="主要结构体-1"><strong>主要结构体</strong>
</h5><p>结构体 <code>shmid_kernel</code></p>
<p>共享内存段在内核中使用 <code>shmid_kernel</code> 结构体表示，该结构体定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">shmid_kernel</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">kern_ipc_perm</span> <span class="n">shm_perm</span><span class="p">;</span> <span class="cm">/* 权限结构体 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">shm_file</span><span class="p">;</span>         <span class="cm">/* 对应的文件 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">size_t</span> <span class="n">shm_segsz</span><span class="p">;</span>              <span class="cm">/* 段大小 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">user_struct</span> <span class="o">*</span><span class="n">shm_creator</span><span class="p">;</span> <span class="cm">/* 创建者 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">user_struct</span> <span class="o">*</span><span class="n">shm_last_attach</span><span class="p">;</span> <span class="cm">/* 最后一次附加的用户 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">shm_rmid_work</span><span class="p">;</span> <span class="cm">/* 删除工作 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">shm_nattch</span><span class="p">;</span>               <span class="cm">/* 当前附加的进程数 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span> <span class="n">shm_atim</span><span class="p">;</span>            <span class="cm">/* 最后附加时间 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span> <span class="n">shm_dtim</span><span class="p">;</span>            <span class="cm">/* 最后分离时间 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">time64_t</span> <span class="n">shm_ctim</span><span class="p">;</span>            <span class="cm">/* 最后改变时间 */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">pid_t</span> <span class="n">shm_cprid</span><span class="p">;</span>              <span class="cm">/* 创建者 PID */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">pid_t</span> <span class="n">shm_lprid</span><span class="p">;</span>              <span class="cm">/* 最后附加或分离的 PID */</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="详细分析"><strong>详细分析</strong>
</h5><p>实际源码中的函数名需要加上ksys_前缀，原因大概是为了区分内核内部调用和用户空间接口，ksys_shmget函数封装的一层后变成了shmget函数。</p>
<p>使用 <code>ksys_</code> 前缀可以清楚地将内核内部函数与用户空间系统调用接口区分开来。用户空间程序调用的是无前缀的系统调用（例如 <code>sys_open</code>），而内核内部模块或函数调用的是 <code>ksys_open</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">shmget</span><span class="p">,</span> <span class="kt">key_t</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">shmflg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ksys_shmget</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">shmflg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>1、共享内存的创建</strong></p>
<p>创建共享内存段的主要函数是 <code>shmget</code>。</p>
<p>实际调用的函数是<code>ipcget()</code>。共享内存、信号量、消息队列三种对象创建的时候都会调用这个函数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">ksys_shmget</span><span class="p">(</span><span class="kt">key_t</span> <span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ipc_ops</span> <span class="n">shm_ops</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">getnew</span> <span class="o">=</span> <span class="n">newseg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">associate</span> <span class="o">=</span> <span class="n">security_shm_associate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">more_checks</span> <span class="o">=</span> <span class="n">shm_more_checks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_params</span> <span class="n">shm_params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">shm_params</span><span class="p">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">shm_params</span><span class="p">.</span><span class="n">flg</span> <span class="o">=</span> <span class="n">shmflg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">shm_params</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">ipcget</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="nf">shm_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">shm_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shm_params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>参数:</p>
<p>key: 类型 key_t 是个整形数，通过这个key可以创建或者打开一块共享内存，该参数的值一定要大于0</p>
<p>size: 创建共享内存的时候，指定共享内存的大小，如果是打开一块存在的共享内存，size 是没有意义的</p>
<p>shmflg：创建共享内存的时候指定的属性</p>
<ul>
<li>IPC_CREAT: 创建新的共享内存，如果创建共享内存，需要指定对共享内存的操作权限，比如：IPC_CREAT | 0664</li>
<li>IPC_EXCL: 检测共享内存是否已经存在了，必须和 IPC_CREAT 一起使用</li>
</ul>
<p>返回值：共享内存创建或者打开成功返回标识共享内存的唯一的 ID，失败返回 - 1.</p>
<p>我们回头来看看<code>shmget()</code>究竟干了啥，首先看一下<code>ipcget()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">ipcget</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="k">const</span> <span class="k">struct</span> <span class="n">ipc_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ipc_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">==</span> <span class="n">IPC_PRIVATE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">ipcget_new</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nf">ipcget_public</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果传进来的参数是<code>IPC_PRIVATE</code>（这个宏的值是0）的话，无论是什么mode，都会创建一块新的共享内存。如果非0，则会去已有的共享内存中找有没有这个key的，有就返回，没有就新建。</p>
<p><strong>2、共享内存的关联</strong></p>
<p>关联共享内存段的主要函数是 <code>shmat</code>，它的逻辑全在<code>do_shmat()</code>中，所以我们直接看这个函数。</p>
<p>首先检查shmaddr的合法性并进行对齐，即调整为shmlba的整数倍。如果传入addr是0，前面检查部分只会加上一个MAP_SHARED标志，因为后面的mmap会自动为其分配地址。然后从那一段两行的注释开始，函数通过shmid尝试获取共享内存对象，并进行权限检查。然后修改shp中的一些数据，比如连接进程数加一。然后是通过<code>alloc_file_clone()</code>创建真正的要做mmap的file。在mmap之前还要对地址空间进行检查，检查是否和别的地址重叠，是否够用。实际的映射工作就在<code>do_mmap()</code>函数中做了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">do_shmat</span><span class="p">(</span><span class="kt">int</span> <span class="n">shmid</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">shmaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shmflg</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	      <span class="n">ulong</span> <span class="o">*</span><span class="n">raddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">shmlba</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">shmid_kernel</span> <span class="o">*</span><span class="n">shp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">shmaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span>    <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">MAP_SHARED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">acc_mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">shm_file_data</span> <span class="o">*</span><span class="n">sfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">f_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">populate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">shmid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">shmlba</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">shmflg</span> <span class="o">&amp;</span> <span class="n">SHM_RND</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="n">addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">shmlba</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>  <span class="cm">/* round down */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">				<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">				 * Ensure that the round-down is non-nil
</span></span></span><span class="line"><span class="cl"><span class="cm">				 * when remapping. This can happen for
</span></span></span><span class="line"><span class="cl"><span class="cm">				 * cases when addr &lt; shmlba.
</span></span></span><span class="line"><span class="cl"><span class="cm">				 */</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">shmflg</span> <span class="o">&amp;</span> <span class="n">SHM_REMAP</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifndef __ARCH_FORCE_SHMLBA
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>				<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">flags</span> <span class="o">|=</span> <span class="n">MAP_FIXED</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">shmflg</span> <span class="o">&amp;</span> <span class="n">SHM_REMAP</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">shmflg</span> <span class="o">&amp;</span> <span class="n">SHM_RDONLY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">prot</span> <span class="o">=</span> <span class="n">PROT_READ</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">acc_mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">f_flags</span> <span class="o">=</span> <span class="n">O_RDONLY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">prot</span> <span class="o">=</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">acc_mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUGO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">f_flags</span> <span class="o">=</span> <span class="n">O_RDWR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">shmflg</span> <span class="o">&amp;</span> <span class="n">SHM_EXEC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">prot</span> <span class="o">|=</span> <span class="n">PROT_EXEC</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">acc_mode</span> <span class="o">|=</span> <span class="n">S_IXUGO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * We cannot rely on the fs check since SYSV IPC does have an
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * additional creator id...
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">ns</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">ipc_ns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_lock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">shp</span> <span class="o">=</span> <span class="nf">shm_obtain_object_check</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">shmid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">ipcperms</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">,</span> <span class="n">acc_mode</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="nf">security_shm_shmat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">,</span> <span class="n">shmaddr</span><span class="p">,</span> <span class="n">shmflg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_lock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* check if shm_destroy() is tearing down shp */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">ipc_valid_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * We need to take a reference to the real shm file to prevent the
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * pointer from becoming stale in cases where the lifetime of the outer
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * file extends beyond that of the shm segment.  It&#39;s not usually
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * possible, but it can happen during remap_file_pages() emulation as
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * that unmaps the memory, then does -&gt;mmap() via file reference only.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * We&#39;ll deny the -&gt;mmap() if the shm segment was since removed, but to
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * detect shm ID reuse we need to compare the file pointers.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">base</span> <span class="o">=</span> <span class="nf">get_file</span><span class="p">(</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_nattch</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">size</span> <span class="o">=</span> <span class="nf">i_size_read</span><span class="p">(</span><span class="nf">file_inode</span><span class="p">(</span><span class="n">base</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ipc_unlock_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sfd</span> <span class="o">=</span> <span class="nf">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sfd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fput</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_nattch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">file</span> <span class="o">=</span> <span class="nf">alloc_file_clone</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">f_flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			  <span class="nf">is_file_hugepages</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">				<span class="o">&amp;</span><span class="nl">shm_file_operations_huge</span> <span class="p">:</span>
</span></span><span class="line"><span class="cl">				<span class="o">&amp;</span><span class="n">shm_file_operations</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">kfree</span><span class="p">(</span><span class="n">sfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fput</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_nattch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">sfd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_perm</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sfd</span><span class="o">-&gt;</span><span class="n">ns</span> <span class="o">=</span> <span class="nf">get_ipc_ns</span><span class="p">(</span><span class="n">ns</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">sfd</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">sfd</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">sfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="nf">security_mmap_file</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_fput</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">mmap_write_lock_killable</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">goto</span> <span class="n">out_fput</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">shmflg</span> <span class="o">&amp;</span> <span class="n">SHM_REMAP</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">find_vma_intersection</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">goto</span> <span class="n">invalid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">addr</span> <span class="o">=</span> <span class="nf">do_mmap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">prot</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">populate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">raddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR_VALUE</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nl">invalid</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">mmap_write_unlock</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">populate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nf">mm_populate</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">populate</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_fput</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">fput</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_nattch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="nf">shm_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">).</span><span class="n">rwsem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">shp</span> <span class="o">=</span> <span class="nf">shm_lock</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">shmid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">shp</span><span class="o">-&gt;</span><span class="n">shm_nattch</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">shm_may_destroy</span><span class="p">(</span><span class="n">shp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nf">shm_destroy</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">shp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="nf">shm_unlock</span><span class="p">(</span><span class="n">shp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="nf">shm_ids</span><span class="p">(</span><span class="n">ns</span><span class="p">).</span><span class="n">rwsem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">out_unlock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="nf">rcu_read_unlock</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3、共享内存的解除关联</strong></p>
<p>当进程不需要再操作共享内存，可以让进程和共享内存解除关联，另外如果没有执行该操作，进程退出之后，结束的进程和共享内存的关联也就自动解除了。</p>
<p>这个函数先找到传入的shmaddr对应的虚拟内存数据结构vma，检查它的地址是不是正确的，然后调用<code>do_vma_munmap()</code>函数断开对共享内存的连接。注意此操作并不会销毁共享内存，即使没有进程连接到它也不会，只有手动调用<code>shmctl(id, IPC_RMID, NULL)</code>才能销毁。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">COMPAT_SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">shmat</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">shmid</span><span class="p">,</span> <span class="kt">compat_uptr_t</span><span class="p">,</span> <span class="n">shmaddr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">shmflg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">long</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">err</span> <span class="o">=</span> <span class="nf">do_shmat</span><span class="p">(</span><span class="n">shmid</span><span class="p">,</span> <span class="nf">compat_ptr</span><span class="p">(</span><span class="n">shmaddr</span><span class="p">),</span> <span class="n">shmflg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">,</span> <span class="n">COMPAT_SHMLBA</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">force_successful_syscall_return</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * detach and kill segment if marked destroyed.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * The work is done in shm_close.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">ksys_shmdt</span><span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">shmaddr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">mm_struct</span> <span class="o">*</span><span class="n">mm</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">shmaddr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_MMU
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="kt">loff_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">VMA_ITERATOR</span><span class="p">(</span><span class="n">vmi</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">mmap_write_lock_killable</span><span class="p">(</span><span class="n">mm</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * This function tries to be smart and unmap shm segments that
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * were modified by partial mlock or munmap calls:
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * - It first determines the size of the shm segment that should be
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *   unmapped: It searches for a vma that is backed by shm and that
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *   started at address shmaddr. It records it&#39;s size and then unmaps
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *   it.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * - Then it unmaps all shm vmas that started at shmaddr and that
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *   are within the initially determined size and that are from the
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *   same shm segment from which we determined the size.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * Errors from do_munmap are ignored: the function only fails if
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * it&#39;s called with invalid parameters or if it&#39;s called to unmap
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * a part of a vma. Both calls in this function are for full vmas,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * the parameters are directly copied from the vma itself and always
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * valid - therefore do_munmap cannot fail. (famous last words?)
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * If it had been mremap()&#39;d, the starting address would not
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * match the usual checks anyway. So assume all vma&#39;s are
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * above the starting address given.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#ifdef CONFIG_MMU
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="nf">for_each_vma</span><span class="p">(</span><span class="n">vmi</span><span class="p">,</span> <span class="n">vma</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * Check if the starting address would match, i.e. it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * a fragment created by mprotect() and/or munmap(), or it
</span></span></span><span class="line"><span class="cl"><span class="cm">		 * otherwise it starts at this address with no hassles.
</span></span></span><span class="line"><span class="cl"><span class="cm">		 */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">shm_vm_ops</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">			<span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">-</span> <span class="n">addr</span><span class="p">)</span><span class="o">/</span><span class="n">PAGE_SIZE</span> <span class="o">==</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * Record the file of the shm segment being
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * unmapped.  With mremap(), someone could place
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * page from another segment but with equal offsets
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * in the range we are unmapping.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 */</span>
</span></span><span class="line"><span class="cl">			<span class="n">file</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">size</span> <span class="o">=</span> <span class="nf">i_size_read</span><span class="p">(</span><span class="nf">file_inode</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">			<span class="nf">do_vma_munmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmi</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				      <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * We discovered the size of the shm segment, so
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * break out of here and fall through to the next
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * loop that uses the size information to stop
</span></span></span><span class="line"><span class="cl"><span class="cm">			 * searching for matching vma&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="cm">			 */</span>
</span></span><span class="line"><span class="cl">			<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">vma</span> <span class="o">=</span> <span class="nf">vma_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * We need look no further than the maximum address a fragment
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * could possibly have landed at. Also cast things to loff_t to
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * prevent overflows and make comparisons vs. equal-width types.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="n">size</span> <span class="o">=</span> <span class="nf">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">loff_t</span><span class="p">)(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* finding a matching vma now does not alter retval */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">shm_vm_ops</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">		    <span class="p">((</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">-</span> <span class="n">addr</span><span class="p">)</span><span class="o">/</span><span class="n">PAGE_SIZE</span> <span class="o">==</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">		    <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span> <span class="o">==</span> <span class="n">file</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">do_vma_munmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmi</span><span class="p">,</span> <span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				      <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">vma</span> <span class="o">=</span> <span class="nf">vma_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vmi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#else	</span><span class="cm">/* CONFIG_MMU */</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>	<span class="n">vma</span> <span class="o">=</span> <span class="nf">vma_lookup</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* under NOMMU conditions, the exact address to be destroyed must be
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * given
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">==</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">shm_vm_ops</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">do_munmap</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">mmap_write_unlock</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>参数：shmat () 函数的返回值，共享内存的起始地址</p>
<p>返回值：关联解除成功返回 0，失败返回 - 1</p>
<p><strong>4、删除共享内存</strong></p>
<p>shmctl () 函数是一个多功能函数，可以设置、获取共享内存的状态也可以将共享内存标记为删除状态。当共享内存被标记为删除状态之后，并不会马上被删除，直到所有的进程全部和共享内存解除关联，共享内存才会被删除。因为通过 shmctl () 函数只是能够标记删除共享内存，所以在程序中多次调用该操作是没有关系的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// 共享内存控制函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">shmctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">shmid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">shmid_ds</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 参数 struct shmid_ds 结构体原型          
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="n">shmid_ds</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">ipc_perm</span> <span class="n">shm_perm</span><span class="p">;</span>    <span class="cm">/* Ownership and permissions */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span>          <span class="n">shm_segsz</span><span class="p">;</span>   <span class="cm">/* Size of segment (bytes) */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">time_t</span>          <span class="n">shm_atime</span><span class="p">;</span>   <span class="cm">/* Last attach time */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">time_t</span>          <span class="n">shm_dtime</span><span class="p">;</span>   <span class="cm">/* Last detach time */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">time_t</span>          <span class="n">shm_ctime</span><span class="p">;</span>   <span class="cm">/* Last change time */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span>           <span class="n">shm_cpid</span><span class="p">;</span>    <span class="cm">/* PID of creator */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span>           <span class="n">shm_lpid</span><span class="p">;</span>    <span class="cm">/* PID of last shmat(2)/shmdt(2) */</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 引用计数, 多少个进程和共享内存进行了关联
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">shmatt_t</span>        <span class="n">shm_nattch</span><span class="p">;</span>  <span class="cm">/* 记录了有多少个进程和当前共享内存进行了管联 */</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>参数:</p>
<p>shmid: 要操作的共享内存的 ID, 是 shmget () 函数的返回值</p>
<p>cmd: 要做的操作，比如</p>
<p>IPC_STAT: 得到当前共享内存的状态</p>
<p>IPC_SET: 设置共享内存的状态</p>
<p>IPC_RMID: 标记共享内存要被删除了</p>
<p>buf:</p>
<p>cmd==IPC_STAT, 作为传出参数，会得到共享内存的相关属性信息</p>
<p>cmd==IPC_SET, 作为传入参，将用户的自定义属性设置到共享内存中</p>
<p>cmd==IPC_RMID, buf 就没意义了，这时候 buf 指定为 NULL 即可</p>
<p>返回值：函数调用成功返回值大于等于 0，调用失败返回 - 1</p>
<h5 id="现有安全保护机制">现有安全保护机制
</h5><p><strong>1、权限控制</strong></p>
<p><code>ipc_perm</code> 结构包含了用户 ID、组 ID 以及权限位，可以用来控制谁可以访问、修改或删除共享内存段。</p>
<p><strong>2、安全模块（LSM）框架</strong></p>
<p>Linux 内核中的安全模块（LSM）框架提供了钩子（hook），可以在各种系统调用和内核事件中插入自定义的安全检查。（在内核源码树/security/security.c中）例如，<code>shmat</code> 系统调用中的安全检查：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">int security_shmat(struct shmid_kernel *shp, char __user *shmaddr, int shmflg)
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">    return call_int_hook(shmat, 0, shp, shmaddr, shmflg);
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3、命名空间隔离</strong></p>
<p>使用命名空间（Namespace）来隔离 IPC 资源。每个 IPC 命名空间都有自己的共享内存段、消息队列和信号量集合。这可以防止不同容器或进程组之间的 IPC 资源冲突或未授权访问</p>
<p><strong>4、地址空间随机化（ASLR）</strong></p>
<p><strong>5、内存保护机制</strong></p>
<p>使用内存保护机制，如不可执行（non-executable，NX）位和只读（read-only）保护，来防止代码注入和数据篡改。</p>
<h3 id="其它ipc相关源码">其它IPC相关源码
</h3><h4 id="1-管道pipe和命名管道named-pipe">1. 管道（Pipe）和命名管道（Named Pipe）
</h4><p>管道和命名管道的实现主要在<code>fs/pipe.c</code>文件中。</p>
<p><strong>功能</strong>：</p>
<ul>
<li>管道提供单向的数据流，适用于父子进程之间的通信。</li>
<li>命名管道（FIFO）类似于管道，但它存在于文件系统中，可以用于任意进程间的通信。</li>
</ul>
<p><strong>实现分析</strong>：</p>
<ul>
<li>使用循环缓冲区实现数据的读写。</li>
<li>提供了创建、读、写、关闭等系统调用接口。</li>
</ul>
<p><strong>相关文件</strong>：</p>
<ul>
<li><code>fs/pipe.c</code></li>
<li><code>include/linux/pipe_fs_i.h</code></li>
</ul>
<h4 id="2-套接字socket">2. 套接字（Socket）
</h4><p>套接字是网络通信和进程间通信的重要机制，其实现涉及多个文件，分布在<code>net</code>目录下。</p>
<p><strong>功能</strong>：</p>
<ul>
<li>套接字用于通过网络进行进程间通信，支持多种协议（如TCP、UDP）。</li>
<li>也可以用于本地进程间通信（UNIX域套接字）。</li>
</ul>
<p><strong>实现分析</strong>：</p>
<ul>
<li>套接字的核心实现包括协议族（如AF_INET、AF_UNIX）的具体实现。</li>
<li>提供创建、绑定、监听、接受、发送、关闭等系统调用接口。</li>
</ul>
<p><strong>相关文件</strong>：</p>
<ul>
<li><code>net/socket.c</code></li>
<li><code>net/unix/af_unix.c</code></li>
<li><code>include/net/sock.h</code></li>
</ul>
<h4 id="3-信号signal">3. 信号（Signal）
</h4><p>信号是用于异步通知进程的一种机制。</p>
<p><strong>功能</strong>：</p>
<ul>
<li>向进程发送异步通知，用于中断、终止、定时等操作。</li>
</ul>
<p><strong>实现分析</strong>：</p>
<ul>
<li>内核维护信号队列，当进程处于适当状态时，处理挂起的信号。</li>
<li>提供信号的发送、处理、阻塞、忽略等功能。</li>
</ul>
<p><strong>相关文件</strong>：</p>
<ul>
<li><code>kernel/signal.c</code></li>
<li><code>include/linux/signal.h</code></li>
</ul>
<h3 id="ipc安全增强方法">IPC安全增强方法
</h3><p>要对进程间通信（IPC）机制进行安全增强，需要考虑多方面的安全威胁，并采取相应的安全措施。这些措施可以从以下几个方面来实现：</p>
<ol>
<li><strong>访问控制和权限管理</strong></li>
</ol>
<ul>
<li><strong>使用权限控制</strong>：对共享内存、消息队列、信号量等 IPC 资源进行严格的权限控制，确保只有授权的进程可以访问。</li>
<li><strong>用户和组权限</strong>：通过设置 IPC 对象的所有者、所属组和访问权限（读、写、执行），控制哪些用户和组可以访问这些 IPC 资源。</li>
</ul>
<ol start="2">
<li><strong>数据加密</strong></li>
</ol>
<ul>
<li><strong>加密传输的数据</strong>：对于在 IPC 通道中传输的数据，使用加密技术（如 AES、RSA 等）进行加密，防止数据在传输过程中被窃取或篡改。</li>
<li><strong>加密共享内存</strong>：在写入共享内存的数据之前对其进行加密，并在读取时解密。</li>
</ul>
<ol start="3">
<li><strong>数据完整性</strong></li>
</ol>
<ul>
<li><strong>数据校验</strong>：使用哈希函数（如 SHA-256）或消息认证码（MAC）来校验数据的完整性，确保数据在传输过程中未被篡改。</li>
<li><strong>数字签名</strong>：对重要数据进行数字签名，验证数据的来源和完整性。</li>
</ul>
<ol start="4">
<li><strong>防止资源滥用</strong></li>
</ol>
<ul>
<li><strong>限制资源使用</strong>：设置合理的资源限制（如共享内存大小、消息队列长度、信号量数量），防止进程滥用资源导致系统崩溃或性能下降。</li>
<li><strong>超时机制</strong>：对 IPC 操作设置超时，避免进程因等待资源而无限阻塞。</li>
</ul>
<ol start="5">
<li><strong>审计和日志记录</strong></li>
</ol>
<ul>
<li><strong>记录操作日志</strong>：对所有 IPC 操作进行日志记录，记录操作的时间、类型、发起进程和目标进程等信息，以便在发生安全事件时进行追踪和分析。</li>
<li><strong>定期审计</strong>：定期检查和分析日志，发现异常或可疑的行为，及时采取措施。</li>
</ul>
<ol start="6">
<li><strong>隔离和沙箱</strong></li>
</ol>
<ul>
<li><strong>进程隔离</strong>：使用容器（如 Docker）或虚拟化技术，将进程隔离在不同的沙箱中，限制其访问系统资源的能力。</li>
<li><strong>安全上下文</strong>：在安全上下文中运行进程，限制其权限和资源访问能力，防止其对系统造成破坏。</li>
</ul>
<h3 id="参考资料"><strong>参考资料：</strong>
</h3><p>http://39.105.211.21:8080/132K3/kernel/src/branch/OLK-6.6-dev-k1/ipc</p>
<p><a class="link" href="https://github.com/torvalds/linux/tree/v6.6/ipc"  target="_blank" rel="noopener"
    >linux/ipc at v6.6 · torvalds/linux (github.com)</a></p>
<p><a class="link" href="https://songlee24.github.io/2015/04/21/linux-IPC/"  target="_blank" rel="noopener"
    >【Linux编程】进程间通信（IPC）  (songlee24.github.io)</a></p>
<p><a class="link" href="https://www.ffutop.com/posts/2019-05-27-understand-kernel-11/"  target="_blank" rel="noopener"
    >理解 Linux Kernel (11) - 进程间通信 (ffutop.com)</a></p>
<p><a class="link" href="https://segmentfault.com/a/1190000003860236"  target="_blank" rel="noopener"
    >阅读 Linux 内核源码——共享内存 - SegmentFault</a></p>
<p><a class="link" href="https://www.cnblogs.com/zhuchunlin/p/17032854.html"  target="_blank" rel="noopener"
    >Linux - 进程间通信（IPC）共享内存(cnblogs.com)</a></p>
<p><a class="link" href="https://www.cnblogs.com/zhuchunlin/p/17034191.html"  target="_blank" rel="noopener"
    >信号量(cnblogs.com)</a></p>
<p><a class="link" href="https://www.cnblogs.com/zhuchunlin/p/17034190.html"  target="_blank" rel="noopener"
    >Linux - 进程间通信（IPC）消息队列</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ipc/">IPC</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            最后更新于 2024-12-15
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist", "waline-container"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/">
        
        
            <div class="article-image">
                <img src="/p/unix-domain-socket%E6%BA%90%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%88%86%E6%9E%90olk-6.6/1.accea6f5271e3d195e76bf7dc0ce31bf_hu18051829005473063406.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Unix Domain Socket源码实现分析(OLK 6.6)"
                        
                        data-hash="md5-rM6m9ScePRledr99wM4xvw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Unix Domain Socket源码实现分析(OLK 6.6)</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E8%B0%83%E7%A0%94/">
        
        
            <div class="article-image">
                <img src="/p/%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95%E8%B0%83%E7%A0%94/1.456b8b62f4e93ff289a0752cb9a275a0_hu14772543834815088792.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post 加密算法调研"
                        
                        data-hash="md5-RWuLYvTpP/KJoHUsuaJ1oA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">加密算法调研</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }

    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":"感谢您的评论"},"pageview":true,"requiredMeta":["nick"],"serverURL":"https://waline.chenyuan1125.top","visitor":true});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Lee
    </section>
    
    <section class="powerby">
        使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
