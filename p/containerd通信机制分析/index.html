<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="æ·±å…¥åˆ†æcontainerdæºç ">
<meta name="keywords" content="æºç åˆ†æã€uds"><title>containerdé€šä¿¡æœºåˆ¶åˆ†æ</title>

<link rel='canonical' href='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.1d7a77f66a9605dfbac1c7922a91290042c454a1166056d913fcbcea340dd583.css"><meta property='og:title' content="containerdé€šä¿¡æœºåˆ¶åˆ†æ">
<meta property='og:description' content="æ·±å…¥åˆ†æcontainerdæºç ">
<meta property='og:url' content='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/'>
<meta property='og:site_name' content='è¾°è¿œ'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='containerd' /><meta property='article:published_time' content='2024-10-23T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-12-11T19:43:23&#43;08:00'/><meta property='og:image' content='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1.jpg' />
<meta name="twitter:title" content="containerdé€šä¿¡æœºåˆ¶åˆ†æ">
<meta name="twitter:description" content="æ·±å…¥åˆ†æcontainerdæºç "><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1.jpg' />

<link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu4999655723030452168.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="//localhost:1313/">è¾°è¿œ</a></h1>
            <h2 class="site-description">å¤©å°†é™å¤§ä»»äºæ–¯äººä¹Ÿ</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='/'
                        
                        title="é¦–é¡µ&amp;å…³äº"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/chenyuan1125'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>é“¾æ¥</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="//localhost:1313/en/" >English</option>
                                
                                    <option value="//localhost:1313/" selected>ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ç®€è¿°">ç®€è¿°</a></li>
    <li><a href="#grpcæ¡†æ¶åŸç†">gRPCæ¡†æ¶åŸç†</a>
      <ol>
        <li><a href="#grpc-çš„å·¥ä½œæµç¨‹">gRPC çš„å·¥ä½œæµç¨‹</a>
          <ol>
            <li><a href="#æœåŠ¡å®šä¹‰ä¸æ¥å£ç”Ÿæˆ">æœåŠ¡å®šä¹‰ä¸æ¥å£ç”Ÿæˆ</a></li>
            <li><a href="#grpc-æœåŠ¡çš„å®ç°">gRPC æœåŠ¡çš„å®ç°</a></li>
            <li><a href="#grpc-é€šä¿¡æœºåˆ¶">gRPC é€šä¿¡æœºåˆ¶</a></li>
            <li><a href="#å…³é”®åº”ç”¨åœºæ™¯">å…³é”®åº”ç”¨åœºæ™¯</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#grpcä¸­ä½¿ç”¨udsçš„åœºæ™¯">gRPCä¸­ä½¿ç”¨UDSçš„åœºæ™¯</a>
      <ol>
        <li><a href="#containerd-å®ˆæŠ¤è¿›ç¨‹ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡"><code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡</a></li>
        <li><a href="#containerd-shim-ä¸-containerd-å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡"><code>containerd-shim</code> ä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</a></li>
        <li><a href="#containerd-æ’ä»¶ä¸å¤–éƒ¨æœåŠ¡çš„é€šä¿¡"><code>containerd</code> æ’ä»¶ä¸å¤–éƒ¨æœåŠ¡çš„é€šä¿¡</a></li>
        <li><a href="#å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡">å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</a></li>
      </ol>
    </li>
    <li><a href="#containerdæºç åˆ†æ">containerdæºç åˆ†æ</a>
      <ol>
        <li><a href="#containerdå¯åŠ¨æµç¨‹">containerdå¯åŠ¨æµç¨‹</a></li>
        <li><a href="#clientä¸containerdå®ˆæŠ¤è¿›ç¨‹çš„é€šä¿¡">clientä¸containerdå®ˆæŠ¤è¿›ç¨‹çš„é€šä¿¡</a></li>
      </ol>
    </li>
    <li><a href="#grpcæ¡†æ¶ä¸­çš„rpcé€šä¿¡">gRPCæ¡†æ¶ä¸­çš„RPCé€šä¿¡</a>
      <ol>
        <li><a href="#grpc-go-ä¸­-rpc-é€šä¿¡">gRPC-Go ä¸­ RPC é€šä¿¡</a>
          <ol>
            <li><a href="#goç‰ˆæœ¬grpcé€šä¿¡æœºåˆ¶æ¦‚è¿°">Goç‰ˆæœ¬gRPCé€šä¿¡æœºåˆ¶æ¦‚è¿°</a></li>
            <li><a href="#goç‰ˆæœ¬grpcæºç ç»“æ„">Goç‰ˆæœ¬gRPCæºç ç»“æ„</a></li>
            <li><a href="#grpc-go-ä¸­-rpc-é€šä¿¡æµç¨‹çš„æºç åˆ†æ">gRPC-Go ä¸­ RPC é€šä¿¡æµç¨‹çš„æºç åˆ†æ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#containerdä¸containerd-shimé€šä¿¡æœºåˆ¶">Containerdä¸Containerd-shimé€šä¿¡æœºåˆ¶</a>
      <ol>
        <li><a href="#ttrpc">ttRPC</a></li>
        <li><a href="#unix-åŸŸå¥—æ¥å­—">Unix åŸŸå¥—æ¥å­—</a></li>
        <li><a href="#å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†">å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†</a></li>
        <li><a href="#å®¹å™¨ä¸å®ˆæŠ¤è¿›ç¨‹çš„åˆ†ç¦»">å®¹å™¨ä¸å®ˆæŠ¤è¿›ç¨‹çš„åˆ†ç¦»</a></li>
      </ol>
    </li>
    <li><a href="#containerd-shimä¸containeré€šä¿¡æœºåˆ¶">Containerd-shimä¸Containeré€šä¿¡æœºåˆ¶</a>
      <ol>
        <li><a href="#é€šä¿¡æµç¨‹">é€šä¿¡æµç¨‹</a></li>
        <li><a href="#æºç è§£æ">æºç è§£æ</a></li>
      </ol>
    </li>
    <li><a href="#å®¹å™¨å¯åŠ¨æµç¨‹åˆ†æ">å®¹å™¨å¯åŠ¨æµç¨‹åˆ†æ</a></li>
    <li><a href="#é—®é¢˜ä¸è§£ç­”">é—®é¢˜ä¸è§£ç­”</a></li>
    <li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/">
                <img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1_hu15168000030692408952.jpg"
                        srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1_hu15168000030692408952.jpg 800w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1_hu16839679216868040932.jpg 1600w"
                        width="800" 
                        height="419" 
                        loading="lazy"
                        alt="Featured image of post containerdé€šä¿¡æœºåˆ¶åˆ†æ" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%8A%80%E6%9C%AF%E6%A1%86%E6%9E%B6/" style="background-color: #D81A31; color: #fff;">
                æŠ€æœ¯æ¡†æ¶
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/">containerdé€šä¿¡æœºåˆ¶åˆ†æ</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            æ·±å…¥åˆ†æcontainerdæºç 
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-10-23</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 57 åˆ†é’Ÿ
                </time>
            </div>
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
  <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
  <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
</svg>
                <time class="article-words">
                    28084å­—
                </time>
        </div>
        

    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="containerdé€šä¿¡æœºåˆ¶">containerdé€šä¿¡æœºåˆ¶
</h1><h2 id="ç®€è¿°">ç®€è¿°
</h2><p>Containerd æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿï¼ˆå®¹å™¨ï¼‰é¢†åŸŸè¡Œä¸šæ ‡å‡†å®¹å™¨è¿è¡Œæ—¶ã€‚ä»¥æ“ä½œç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹æ–¹å¼æä¾›æœåŠ¡ï¼Œç®¡ç†ä¸€å°æœºå™¨ä¸Šæ¯ä¸ªå®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>é•œåƒä¸‹è½½å’Œå­˜å‚¨ã€‚</li>
<li>å®¹å™¨ rootfs ï¼ˆæ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰çš„ç”Ÿæˆã€‚</li>
<li>å®¹å™¨çš„å¯åŠ¨å’Œå®ˆæŠ¤ã€‚</li>
<li>å®¹å™¨çš„ä½çº§å­˜å‚¨å’Œé™„åŠ ç½‘ç»œã€‚</li>
</ul>
<p>Containerd æ˜¯ CNCF æ¯•ä¸šé¡¹ç›®ï¼Œæ˜¯ Kubernetes å’Œ Docker çš„é»˜è®¤å®¹å™¨è¿è¡Œæ—¶ã€‚</p>
<p>Containerd å®ˆæŠ¤è¿›ç¨‹é»˜è®¤æä¾›äº†ä¸¤å¥— APIï¼š</p>
<ul>
<li>Containerd åŸç”Ÿ GRPC API ï¼ˆ<a class="link" href="https://github.com/containerd/containerd/blob/v1.7.0/api/README.md"  target="_blank" rel="noopener"
    >æºç </a>ï¼‰ï¼Œå¹¶æä¾›äº† Go SDK ï¼ˆå‚è§ï¼š<a class="link" href="https://github.com/containerd/containerd/blob/v1.7.0/client.go"  target="_blank" rel="noopener"
    >æºç </a>ï¼‰ï¼ŒDocker ä»¥è¯¥æ–¹å¼é›†æˆ Containerdã€‚</li>
<li>Kubernetes çš„ CRI GRPC APIï¼ˆ<a class="link" href="https://github.com/containerd/containerd/blob/main/pkg/cri/cri.go"  target="_blank" rel="noopener"
    >æºç </a>ï¼‰ï¼Œå½¢æ€ä¸Šé€šè¿‡ Containerd Plugin çš„æ–¹å¼æä¾›æœåŠ¡ï¼ˆåŸç”Ÿæ’ä»¶ï¼Œæ‰“åŒ…åˆ°äº† Containerd äºŒè¿›åˆ¶ä¸­ï¼‰ï¼Œæ¶æ„å‚è§ï¼š<a class="link" href="https://github.com/containerd/containerd/blob/v1.7.0/docs/cri/architecture.md"  target="_blank" rel="noopener"
    >docs</a>ã€‚Kubernetes ä»¥è¯¥æ–¹å¼é›†æˆ Containerdã€‚</li>
</ul>
<p>åœ¨åº•å±‚å®¹å™¨è¿è¡Œæ—¶æ–¹é¢ï¼ŒContainerd é‡‡ç”¨ <a class="link" href="https://github.com/opencontainers/runtime-spec"  target="_blank" rel="noopener"
    >OCI-runtime</a> æ ‡å‡†ï¼Œé»˜è®¤ä½¿ç”¨ runc ä½œä¸ºè¿è¡Œæ—¶ã€‚</p>
<p>ç®€å•æ¦‚è¿°å…¸å‹åœºæ™¯ä¸­ Kubernetesã€Containerdã€Runc çš„ å±‚çº§å…³ç³»å¦‚ä¸‹ï¼š</p>
<ul>
<li>Kubernetes è´Ÿè´£é›†ç¾¤ï¼ˆå¤šèŠ‚ç‚¹ï¼‰çš„è°ƒåº¦å’Œç®¡ç†ï¼Œåœ¨å•ä¸ªèŠ‚ç‚¹ï¼Œé€šè¿‡ Kubelet ç»„ä»¶é€šè¿‡ CRI GRPC æ¥å£è°ƒç”¨ Containerdã€‚</li>
<li>Containerd æä¾›å•ä¸ªèŠ‚ç‚¹çš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬é•œåƒã€å­˜å‚¨ã€rootfsã€ç½‘ç»œï¼Œå¯åŠ¨å®¹å™¨æ˜¯ Containerd é€šè¿‡ <a class="link" href="https://github.com/opencontainers/runtime-spec"  target="_blank" rel="noopener"
    >OCI-runtime</a> æ ‡å‡†è°ƒç”¨ runcã€‚</li>
<li>Runc å®¹å™¨å¼•å¯¼å™¨ï¼Œè´Ÿè´£æ ¹æ®ä¸€ä¸ªå®¹å™¨çš„å…·ä½“é…ç½®ï¼Œåœ¨æŒ‡å®š rootfs ä¸Šå¼•å¯¼å¯åŠ¨ä¸€ä¸ªå®¹å™¨è¿›ç¨‹ã€‚</li>
</ul>
<p><img src="https://containerd.io/img/architecture.png"
	
	
	
	loading="lazy"
	
		alt="img"
	
	
></p>
<h2 id="grpcæ¡†æ¶åŸç†">gRPCæ¡†æ¶åŸç†
</h2><p>gRPCï¼ˆGoogle Remote Procedure Callï¼‰æ˜¯ä¸€ä¸ªç°ä»£åŒ–ã€é«˜æ€§èƒ½çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æ¶ï¼Œè®¾è®¡ç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°è·¨ç½‘ç»œã€è·¨è¯­è¨€çš„æœåŠ¡è°ƒç”¨ã€‚å®ƒåˆ©ç”¨äº† HTTP/2 å’Œ Protocol Buffersï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§ç®€ä¾¿çš„æ–¹å¼æ¥è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ã€‚ä¸‹é¢æ˜¯ gRPC çš„åŸºæœ¬åŸç†åŠå…¶å…³é”®ç»„ä»¶ã€‚</p>
<h3 id="grpc-çš„å·¥ä½œæµç¨‹">gRPC çš„å·¥ä½œæµç¨‹
</h3><h4 id="æœåŠ¡å®šä¹‰ä¸æ¥å£ç”Ÿæˆ">æœåŠ¡å®šä¹‰ä¸æ¥å£ç”Ÿæˆ
</h4><ul>
<li>
<p><strong>Protocol Buffers å®šä¹‰æœåŠ¡</strong>: <code>containerd</code> ä½¿ç”¨ Protocol Buffersï¼ˆprotobufï¼‰æ¥å®šä¹‰ gRPC æœåŠ¡ã€‚è¿™äº›æœåŠ¡æ¥å£å’Œæ¶ˆæ¯ç»“æ„é€šå¸¸å®šä¹‰åœ¨ <code>.proto</code> æ–‡ä»¶ä¸­ã€‚ä¾‹å¦‚ï¼Œ<code>containers.proto</code> æ–‡ä»¶å®šä¹‰äº†å®¹å™¨ç®¡ç†çš„æœåŠ¡æ¥å£ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">protobufCopy codesyntax = &#34;proto3&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">service Containers {
</span></span><span class="line"><span class="cl">    rpc Create (CreateContainerRequest) returns (CreateContainerResponse);
</span></span><span class="line"><span class="cl">    rpc Start (StartContainerRequest) returns (StartContainerResponse);
</span></span><span class="line"><span class="cl">    rpc Stop (StopContainerRequest) returns (StopContainerResponse);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">message CreateContainerRequest {
</span></span><span class="line"><span class="cl">    string id = 1;
</span></span><span class="line"><span class="cl">    // å…¶ä»–å­—æ®µ...
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">message CreateContainerResponse {
</span></span><span class="line"><span class="cl">    // å“åº”å­—æ®µ...
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç </strong>: ä½¿ç”¨ <code>protoc</code> ç¼–è¯‘å™¨ï¼Œ<code>.proto</code> æ–‡ä»¶ä¼šç”Ÿæˆç›¸åº”çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç ã€‚å¯¹äº <code>containerd</code>ï¼Œè¿™äº›ç”Ÿæˆçš„ä»£ç æ˜¯ä¸ <code>containerd</code> æ ¸å¿ƒåŠŸèƒ½é›†æˆåœ¨ä¸€èµ·çš„ï¼Œå®¢æˆ·ç«¯ä»£ç é€šå¸¸ç”±å¤–éƒ¨å·¥å…·æˆ–æœåŠ¡ä½¿ç”¨ã€‚</p>
</li>
</ul>
<h4 id="grpc-æœåŠ¡çš„å®ç°">gRPC æœåŠ¡çš„å®ç°
</h4><ul>
<li>
<p><strong>æœåŠ¡å®ç°</strong>: <code>containerd</code> ä¸­æ¯ä¸ª gRPC æœåŠ¡éƒ½æœ‰ä¸€ä¸ªå…·ä½“çš„å®ç°ï¼Œè¿™äº›å®ç°è´Ÿè´£å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚æœåŠ¡çš„å®ç°é€šå¸¸ä½äº <code>containerd</code> çš„ <code>services</code> ç›®å½•ä¸­ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">containersServer</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">ç›¸å…³å­—æ®µå’Œä¾èµ–æ³¨å…¥</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">containersServer</span><span class="p">)</span> <span class="n">Create</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">CreateContainerRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">CreateContainerResponse</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">å®ç°å®¹å™¨åˆ›å»ºé€»è¾‘</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">containersServer</span><span class="p">)</span> <span class="n">Start</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">StartContainerRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">StartContainerResponse</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">å®ç°å®¹å™¨å¯åŠ¨é€»è¾‘</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">å…¶ä»–æœåŠ¡æ–¹æ³•</span><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>æœåŠ¡æ³¨å†Œ</strong>: åœ¨ <code>containerd</code> å¯åŠ¨æ—¶ï¼ŒgRPC æœåŠ¡å™¨ä¼šå¯åŠ¨å¹¶ç›‘å¬ä¸€ä¸ª Unix Domain Socket (UDS) åœ°å€æˆ– TCP ç«¯å£ï¼Œç„¶åå°†æ‰€æœ‰çš„æœåŠ¡æ³¨å†Œåˆ° gRPC æœåŠ¡å™¨ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">grpcServer := grpc.NewServer()
</span></span><span class="line"><span class="cl">containerspb.RegisterContainersServer(grpcServer, &amp;containersService)
</span></span><span class="line"><span class="cl">// æ³¨å†Œå…¶ä»–æœåŠ¡...
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="grpc-é€šä¿¡æœºåˆ¶">gRPC é€šä¿¡æœºåˆ¶
</h4><ul>
<li><strong>è¯·æ±‚çš„å‘é€ä¸æ¥æ”¶</strong>: å®¢æˆ·ç«¯é€šè¿‡ç”Ÿæˆçš„ gRPC å®¢æˆ·ç«¯ä»£ç å‘ <code>containerd</code> å‘é€è¯·æ±‚ã€‚è¯·æ±‚é€šè¿‡ gRPC æ¡†æ¶åœ¨å®¢æˆ·ç«¯è¿›è¡Œåºåˆ—åŒ–ï¼ˆä½¿ç”¨ Protocol Buffersï¼‰ï¼Œç„¶åé€šè¿‡åº•å±‚ä¼ è¾“åè®®ï¼ˆé€šå¸¸æ˜¯ HTTP/2 over Unix Domain Socketsï¼‰å‘é€åˆ° <code>containerd</code>ã€‚</li>
<li><strong>æœåŠ¡å™¨ç«¯å¤„ç†</strong>: <code>containerd</code> çš„ gRPC æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå°†å…¶ååºåˆ—åŒ–ä¸ºç›¸åº”çš„æ¶ˆæ¯å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å¯¹åº”æœåŠ¡çš„å®ç°æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œæˆåï¼Œå“åº”ç»“æœå†é€šè¿‡ gRPC è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li><strong>è¿æ¥ç®¡ç†</strong>: gRPC æ”¯æŒé•¿è¿æ¥ï¼Œå¤šä¸ªè¯·æ±‚å¯ä»¥åœ¨åŒä¸€ä¸ªè¿æ¥ä¸­å¹¶å‘è¿›è¡Œã€‚å¯¹äºæœ¬åœ°é€šä¿¡ï¼Œ<code>containerd</code> é€šå¸¸ä½¿ç”¨ Unix Domain Sockets (UDS) ä½œä¸ºä¼ è¾“å±‚ï¼Œæå‡é€šä¿¡æ•ˆç‡å¹¶å¢å¼ºå®‰å…¨æ€§ã€‚</li>
</ul>
<h4 id="å…³é”®åº”ç”¨åœºæ™¯">å…³é”®åº”ç”¨åœºæ™¯
</h4><ul>
<li><strong>å®¢æˆ·ç«¯ä¸ <code>containerd</code> çš„é€šä¿¡</strong>: å¤–éƒ¨å®¢æˆ·ç«¯ï¼ˆå¦‚ <code>ctr</code> å·¥å…·æˆ– Docker å¼•æ“ï¼‰é€šè¿‡ gRPC ä¸ <code>containerd</code> è¿›è¡Œé€šä¿¡ï¼Œæ‰§è¡Œå®¹å™¨çš„åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ç­‰æ“ä½œã€‚</li>
<li><strong><code>containerd</code> æ’ä»¶çš„é›†æˆ</strong>: æ’ä»¶é€šè¿‡ gRPC æä¾›æœåŠ¡æ¥å£ï¼Œ<code>containerd</code> æ ¸å¿ƒé€šè¿‡è°ƒç”¨è¿™äº›æ¥å£æ¥ç®¡ç†é•œåƒã€å¿«ç…§å’Œå®¹å™¨è¿è¡Œæ—¶ç­‰ã€‚</li>
<li><strong><code>containerd-shim</code> ä¸ <code>containerd</code> çš„é€šä¿¡</strong>: <code>containerd-shim</code> è¿›ç¨‹è´Ÿè´£ç®¡ç†æ¯ä¸ªå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸ <code>containerd</code> æ ¸å¿ƒé€šè¿‡ gRPC é€šä¿¡æ¥æŠ¥å‘Šå®¹å™¨çŠ¶æ€ã€æ¥æ”¶ç®¡ç†å‘½ä»¤ç­‰ã€‚</li>
</ul>
<h2 id="grpcä¸­ä½¿ç”¨udsçš„åœºæ™¯">gRPCä¸­ä½¿ç”¨UDSçš„åœºæ™¯
</h2><p>åœ¨ <code>containerd</code> ä¸­ï¼ŒUnix Domain Sockets (UDS) é€šä¿¡é€šå¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š</p>
<h3 id="containerd-å®ˆæŠ¤è¿›ç¨‹ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡"><code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡
</h3><ul>
<li><strong>åœºæ™¯</strong>: <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ä¸å¤–éƒ¨å®¢æˆ·ç«¯ï¼ˆå¦‚ <code>ctr</code> å·¥å…·æˆ– Docker å¼•æ“ï¼‰ä¹‹é—´çš„é€šä¿¡ã€‚</li>
<li><strong>ä¾‹å­</strong>: å½“ Docker å¼•æ“éœ€è¦ä¸ <code>containerd</code> äº¤äº’æ—¶ï¼Œå®ƒé€šè¿‡ gRPC è¿æ¥åˆ° <code>containerd</code> çš„ UDS åœ°å€ï¼Œå¦‚ <code>/run/containerd/containerd.sock</code>ï¼Œä»¥è¯·æ±‚ç®¡ç†å®¹å™¨ã€é•œåƒã€å¿«ç…§ç­‰æ“ä½œã€‚</li>
<li>è¯¦ç»†æè¿°:
<ul>
<li><code>containerd</code> å¯åŠ¨æ—¶ï¼Œä¼šåœ¨é…ç½®çš„åœ°å€ï¼ˆé€šå¸¸æ˜¯ <code>/run/containerd/containerd.sock</code>ï¼‰ä¸Šåˆ›å»ºä¸€ä¸ª UDS ç›‘å¬å™¨ã€‚</li>
<li>Docker å¼•æ“æˆ–å…¶ä»–å®¢æˆ·ç«¯é€šè¿‡ gRPC è¿æ¥åˆ°è¿™ä¸ª UDS åœ°å€æ¥ä¸ <code>containerd</code> äº¤äº’ã€‚</li>
<li>è¿™ç§æ–¹å¼é¿å…äº†ç½‘ç»œå¼€é”€ï¼Œå¹¶é™åˆ¶äº†é€šä¿¡åªèƒ½å‘ç”Ÿåœ¨æœ¬åœ°ä¸»æœºä¸Šï¼Œæé«˜äº†å®‰å…¨æ€§ã€‚</li>
</ul>
</li>
</ul>
<h3 id="containerd-shim-ä¸-containerd-å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡"><code>containerd-shim</code> ä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡
</h3><ul>
<li><strong>åœºæ™¯</strong>: æ¯ä¸ªå®¹å™¨éƒ½æœ‰ä¸€ä¸ª <code>containerd-shim</code> è¿›ç¨‹ï¼Œ<code>containerd-shim</code> è´Ÿè´£ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ <code>containerd-shim</code> ä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ä¹Ÿæ˜¯é€šè¿‡ UDS å®ç°çš„ã€‚</li>
<li><strong>ä¾‹å­</strong>: å½“ <code>containerd</code> å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨æ—¶ï¼Œå®ƒä¼šåˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªå¯¹åº”çš„ <code>containerd-shim</code> è¿›ç¨‹ã€‚<code>containerd-shim</code> é€šè¿‡ä¸€ä¸ª UDS ä¸ <code>containerd</code> è¿›è¡Œé€šä¿¡ï¼Œä»¥æŠ¥å‘Šå®¹å™¨çš„çŠ¶æ€å’Œæ¥å—å‘½ä»¤ã€‚</li>
<li>è¯¦ç»†æè¿°:
<ul>
<li><code>containerd-shim</code> è¿›ç¨‹ä¼šä¸ºæ¯ä¸ªå®¹å™¨åˆ›å»ºä¸€ä¸ª UDSï¼Œç”¨äºä¸ <code>containerd</code> äº¤äº’ã€‚</li>
<li>é€šè¿‡è¿™ä¸ª UDSï¼Œ<code>containerd</code> å¯ä»¥å‘ <code>containerd-shim</code> å‘é€æŒ‡ä»¤ï¼Œå¦‚å¯åŠ¨æˆ–åœæ­¢å®¹å™¨ï¼Œå¹¶æ¥æ”¶æ¥è‡ª <code>containerd-shim</code> çš„çŠ¶æ€æ›´æ–°ã€‚</li>
</ul>
</li>
</ul>
<h3 id="containerd-æ’ä»¶ä¸å¤–éƒ¨æœåŠ¡çš„é€šä¿¡"><code>containerd</code> æ’ä»¶ä¸å¤–éƒ¨æœåŠ¡çš„é€šä¿¡
</h3><ul>
<li><strong>åœºæ™¯</strong>: æŸäº›æ’ä»¶å¯èƒ½ä½œä¸ºå¤–éƒ¨æœåŠ¡è¿è¡Œï¼Œéœ€è¦é€šè¿‡ UDS ä¸ <code>containerd</code> é€šä¿¡ã€‚</li>
<li><strong>ä¾‹å­</strong>: ä¸€äº›å¤–éƒ¨å­˜å‚¨æ’ä»¶å¯èƒ½ç‹¬ç«‹è¿è¡Œå¹¶é€šè¿‡ UDS æš´éœ²å…¶ gRPC æœåŠ¡ï¼Œ<code>containerd</code> é€šè¿‡è¿æ¥è¿™ä¸ª UDS æ¥è°ƒç”¨æ’ä»¶çš„æœåŠ¡ã€‚</li>
<li>è¯¦ç»†æè¿°:
<ul>
<li>æ’ä»¶å¯ä»¥åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­è¿è¡Œï¼Œé€šè¿‡ UDS æš´éœ²å…¶æœåŠ¡æ¥å£ã€‚</li>
<li><code>containerd</code> è¿æ¥åˆ°è¿™äº› UDS åœ°å€æ¥ä¸æ’ä»¶äº¤äº’ï¼Œæ‰§è¡Œè¯¸å¦‚å­˜å‚¨ç®¡ç†æˆ–ç½‘ç»œç®¡ç†ç­‰æ“ä½œã€‚</li>
</ul>
</li>
</ul>
<h3 id="å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡">å®ˆæŠ¤è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡
</h3><ul>
<li><strong>åœºæ™¯</strong>: å¦‚æœéœ€è¦åœ¨å¤šä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼ˆä¾‹å¦‚ <code>containerd</code> å’Œå…¶ä»–ä¾èµ–æœåŠ¡ï¼‰ä¹‹é—´å»ºç«‹å®‰å…¨ä¸”é«˜æ•ˆçš„æœ¬åœ°é€šä¿¡ï¼Œå¯ä»¥ä½¿ç”¨ UDSã€‚</li>
<li><strong>ä¾‹å­</strong>: åœ¨ä¸€äº›å¤æ‚çš„é›†ç¾¤ç¯å¢ƒä¸­ï¼Œ<code>containerd</code> å¯èƒ½éœ€è¦ä¸å…¶ä»–å®ˆæŠ¤è¿›ç¨‹ï¼ˆå¦‚ CRI-Oã€etcd ç­‰ï¼‰è¿›è¡Œæœ¬åœ°é€šä¿¡ï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿå¯èƒ½ä½¿ç”¨ UDSã€‚</li>
<li>è¯¦ç»†æè¿°:
<ul>
<li>å¤šä¸ªå®ˆæŠ¤è¿›ç¨‹åœ¨åŒä¸€å°ä¸»æœºä¸Šè¿è¡Œæ—¶ï¼Œé€šè¿‡ UDS é€šä¿¡ï¼Œé¿å…äº†ä½¿ç”¨ TCP/IP å¸¦æ¥çš„ç½‘ç»œå¼€é”€å’Œå®‰å…¨é£é™©ã€‚</li>
</ul>
</li>
</ul>
<h2 id="containerdæºç åˆ†æ">containerdæºç åˆ†æ
</h2><h3 id="containerdå¯åŠ¨æµç¨‹">containerdå¯åŠ¨æµç¨‹
</h3><blockquote>
<p>æ–‡ä»¶è·¯å¾„ï¼š<code>containerd/cmd/containerd/main.go</code>ï¼Œæ•´ä¸ªç¨‹åºä»è¿™é‡Œå¼€å§‹å¯åŠ¨ï¼Œè°ƒç”¨command.App()å‡½æ•°ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;crypto&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/containerd/containerd/v2/cmd/containerd/command&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/containerd/containerd/v2/internal/hasher&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/containerd/containerd/v2/cmd/containerd/builtins&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">crypto</span><span class="p">.</span><span class="nf">RegisterHash</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">SHA256</span><span class="p">,</span> <span class="nx">hasher</span><span class="p">.</span><span class="nx">NewSHA256</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">command</span><span class="p">.</span><span class="nf">App</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;containerd: %s\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>æ–‡ä»¶è·¯å¾„ï¼š<code>containerd/cmd/containerd/command/main.go</code>ï¼Œè¯¥æ–‡ä»¶ä¸»è¦ç”¨äºå®ç° <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹çš„å¯åŠ¨å’Œç®¡ç†é€»è¾‘ã€‚è¯¥ä»£ç åŒ…æ‹¬äº†å¦‚ä½•åˆå§‹åŒ– <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ã€è§£æå‘½ä»¤è¡Œå‚æ•°ã€è®¾ç½®é…ç½®é¡¹ï¼Œä»¥åŠå¤„ç†ä¿¡å·å’ŒæœåŠ¡ç»ˆæ­¢ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// App returns a *cli.App instance.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">App</span><span class="p">()</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">App</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">NewApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;containerd&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="nx">version</span><span class="p">.</span><span class="nx">Version</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Usage</span> <span class="p">=</span> <span class="nx">usage</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Flags</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Flags</span><span class="p">,</span> <span class="nf">serviceFlags</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Commands</span> <span class="p">=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">configCommand</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">publishCommand</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ociHook</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Action</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cliContext</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">start</span>       <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">signals</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">serverC</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">config</span>      <span class="p">=</span> <span class="nf">defaultConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Â·Â·Â·æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nf">isLocalAddress</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">GID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeDebug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for metrics endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// setup the ttrpc endpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main ttrpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tl</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTTRPC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for TCP grpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTCP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// setup the main grpc endpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeGRPC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">readyC</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">server</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nb">close</span><span class="p">(</span><span class="nx">readyC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">app</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="nx">serveFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Addr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;serving...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serveFunc</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;serve failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//Â·Â·Â·æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç 
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è¯¦ç»†åˆ†æï¼ˆæˆ‘åªæŒ‘äº›é‡ç‚¹çš„åˆ†æï¼‰ï¼š</strong></p>
<p><strong>ä¸»é€»è¾‘ (<code>app.Action</code>)</strong></p>
<blockquote>
<p><code>app.Action</code> ä¸­çš„ä¸»é€»è¾‘æ˜¯ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å®ƒåŒ…æ‹¬åˆå§‹åŒ–ä¸Šä¸‹æ–‡ã€åŠ è½½å’Œåº”ç”¨é…ç½®ã€å¯åŠ¨ gRPC å’Œ TTRPC æœåŠ¡ã€ä¿¡å·å¤„ç†ï¼Œä»¥åŠæœ€ç»ˆçš„æœåŠ¡å¯åŠ¨å’Œç®¡ç†ã€‚ä»¥ä¸‹æ˜¯å¯¹ä¸»é€»è¾‘çš„è¯¦ç»†åˆ†æï¼š</p>
</blockquote>
<ol>
<li>
<p><strong>åˆå§‹åŒ–</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">start</span>       <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">signals</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">serverC</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span>      <span class="p">=</span> <span class="nf">defaultConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ—¶é—´è®°å½• (<code>start</code>)</strong>: è®°å½•å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨çš„æ—¶é—´ï¼Œç”¨äºåç»­æ—¥å¿—è®°å½•å¯åŠ¨è€—æ—¶ã€‚</p>
<p><strong>ä¿¡å·é€šé“ (<code>signals</code>)</strong>: åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºä¸º 2048 çš„é€šé“ï¼Œç”¨äºæ¥æ”¶ç³»ç»Ÿä¿¡å·ï¼Œå¦‚ <code>SIGTERM</code> æˆ– <code>SIGHUP</code>ï¼Œä»¥ä¾¿è¿›è¡Œä¼˜é›…çš„å…³é—­æ“ä½œã€‚</p>
<p><strong>æœåŠ¡å™¨é€šé“ (<code>serverC</code>)</strong>: ç”¨äºåœ¨å¼‚æ­¥åˆå§‹åŒ–å®Œæˆåä¼ é€’ <code>containerd</code> æœåŠ¡å™¨å®ä¾‹ã€‚</p>
<p><strong>ä¸Šä¸‹æ–‡ (<code>ctx, cancel</code>)</strong>: ä½¿ç”¨ <code>context.WithCancel</code> åˆ›å»ºä¸€ä¸ªå¯å–æ¶ˆçš„ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿åœ¨éœ€è¦æ—¶èƒ½å¤Ÿå–æ¶ˆæ‰€æœ‰ä¸ä¸Šä¸‹æ–‡å…³è”çš„æ“ä½œã€‚</p>
<p><strong>é…ç½® (<code>config</code>)</strong>: è°ƒç”¨ <code>defaultConfig()</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªé»˜è®¤é…ç½®å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨åŠ è½½çš„é…ç½®é€‰é¡¹ã€‚</p>
</li>
<li>
<p><strong>åŠ è½½å’Œåº”ç”¨é…ç½®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">configPath</span> <span class="o">:=</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">configPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">||</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">IsSet</span><span class="p">(</span><span class="s">&#34;config&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srvconfig</span><span class="p">.</span><span class="nf">LoadConfig</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">configPath</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>é…ç½®æ–‡ä»¶è·¯å¾„</strong>: ä»å‘½ä»¤è¡Œå‚æ•°ä¸­è·å–é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆ<code>configPath</code>ï¼‰ï¼Œé»˜è®¤æƒ…å†µä¸‹æŒ‡å‘ <code>/etc/containerd/config.toml</code> æˆ–å…¶ä»–é»˜è®¤è·¯å¾„ã€‚</p>
<p><strong>æ£€æŸ¥é…ç½®æ–‡ä»¶å­˜åœ¨æ€§</strong>: ä½¿ç”¨ <code>os.Stat</code> æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæˆ–è€…ç”¨æˆ·æ˜¯å¦æ˜ç¡®æŒ‡å®šäº†é…ç½®æ–‡ä»¶è·¯å¾„ã€‚å¦‚æœå­˜åœ¨æˆ–æŒ‡å®šäº†è·¯å¾„ï¼Œè°ƒç”¨ <code>srvconfig.LoadConfig</code> åŠ è½½é…ç½®æ–‡ä»¶åˆ° <code>config</code> å¯¹è±¡ä¸­ã€‚</p>
<p><strong>é”™è¯¯å¤„ç†</strong>: å¦‚æœåŠ è½½é…ç½®å¤±è´¥ï¼Œç«‹å³è¿”å›é”™è¯¯å¹¶ç»ˆæ­¢å¯åŠ¨æµç¨‹ã€‚</p>
</li>
<li>
<p><strong>ç¡®ä¿å¿…è¦é…ç½®å­˜åœ¨</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;grpc address cannot be empty: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrInvalidArgument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="o">+</span> <span class="s">&#34;.ttrpc&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">UID</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">GID</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>éªŒè¯ gRPC åœ°å€</strong>: ç¡®ä¿ gRPC æœåŠ¡çš„åœ°å€å·²åœ¨é…ç½®ä¸­è®¾ç½®ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™è¿”å›é”™è¯¯ï¼Œå› ä¸º gRPC åœ°å€æ˜¯ <code>containerd</code> æœåŠ¡çš„å…³é”®é…ç½®ã€‚</li>
<li><strong>è®¾ç½® TTRPC åœ°å€</strong>: å¦‚æœ TTRPC åœ°å€æœªé…ç½®ï¼Œåˆ™ä½¿ç”¨ gRPC åœ°å€é™„åŠ  <code>.ttrpc</code> ä½œä¸ºé»˜è®¤åœ°å€ï¼Œå¹¶å¤åˆ¶ gRPC çš„ç”¨æˆ· ID å’Œç»„ ID è®¾ç½®ã€‚</li>
</ul>
</li>
<li>
<p><strong>å¤„ç†æœåŠ¡æ³¨å†Œå’Œä¿¡å·</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">stop</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">registerUnregisterService</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">stop</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">done</span> <span class="o">:=</span> <span class="nf">handleSignals</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">signals</span><span class="p">,</span> <span class="nx">serverC</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">signals</span><span class="p">,</span> <span class="nx">handledSignals</span><span class="o">...</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>æœåŠ¡æ³¨å†Œ/æ³¨é”€</strong>: è°ƒç”¨ <code>registerUnregisterService</code> å‡½æ•°ï¼Œå¤„ç† Windows æœåŠ¡çš„æ³¨å†Œæˆ–æ³¨é”€ã€‚å¦‚æœå¤„ç†å®Œæ¯•åˆ™ç»ˆæ­¢ç¨‹åºï¼ˆç”¨äºåœ¨ Windows ä¸Šæ“ä½œæœåŠ¡æ§åˆ¶ç®¡ç†å™¨ï¼‰ã€‚</li>
<li><strong>ä¿¡å·å¤„ç†</strong>: è°ƒç”¨ <code>handleSignals</code> å‡½æ•°ï¼Œè®¾ç½®ä¿¡å·å¤„ç†å™¨ <code>done</code>ï¼Œç”¨äºå¤„ç†æ¥è‡ªç³»ç»Ÿçš„ä¿¡å·ï¼ˆå¦‚ <code>SIGTERM</code>ã€<code>SIGINT</code>ï¼‰ã€‚ç„¶åè°ƒç”¨ <code>signal.Notify</code>ï¼Œå°†æŒ‡å®šçš„ä¿¡å·æ³¨å†Œåˆ° <code>signals</code> é€šé“ä¸­ï¼Œä»¥ä¾¿åœ¨æ¥æ”¶åˆ°ä¿¡å·æ—¶è§¦å‘ç›¸åº”çš„æ“ä½œã€‚</li>
</ul>
</li>
<li>
<p><strong>å¯åŠ¨ <code>containerd</code> æœåŠ¡å™¨</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">srvResp</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span>   <span class="o">*</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">chsrv</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">srvResp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">chsrv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">chsrv</span> <span class="o">&lt;-</span> <span class="nx">srvResp</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">err</span><span class="p">}:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">launchService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="nx">server</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">chsrv</span> <span class="o">&lt;-</span> <span class="nx">srvResp</span><span class="p">{</span><span class="nx">s</span><span class="p">:</span> <span class="nx">server</span><span class="p">}:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>å¼‚æ­¥åˆå§‹åŒ–æœåŠ¡å™¨</strong>: ä½¿ç”¨ goroutine å¼‚æ­¥åˆå§‹åŒ– <code>containerd</code> æœåŠ¡å™¨ï¼Œé¿å…åœ¨ä¸»çº¿ç¨‹ä¸­é˜»å¡ï¼Œä¾‹å¦‚åœ¨ Bolt æ•°æ®åº“åˆå§‹åŒ–è¿‡ç¨‹ä¸­ã€‚</li>
<li><strong>åˆ›å»º <code>containerd</code> æœåŠ¡å™¨</strong>: è°ƒç”¨ <code>server.New</code> ä½¿ç”¨é…ç½®åˆå§‹åŒ– <code>containerd</code> æœåŠ¡å™¨å®ä¾‹ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œé€šè¿‡ <code>chsrv</code> é€šé“è¿”å›é”™è¯¯å¹¶é€€å‡ºã€‚</li>
<li><strong>å¯åŠ¨æœåŠ¡</strong>: å¦‚æœéœ€è¦ï¼Œè°ƒç”¨ <code>launchService</code> å¯åŠ¨ <code>containerd</code> æœåŠ¡å™¨ä½œä¸º Windows æœåŠ¡ï¼ˆä»…åœ¨ Windows å¹³å°ä¸Šï¼‰ã€‚</li>
<li><strong>åœæ­¢æœåŠ¡å™¨</strong>: ç›‘å¬ <code>ctx.Done()</code> ä¿¡å·ï¼Œå½“ä¸Šä¸‹æ–‡è¢«å–æ¶ˆæ—¶ï¼Œè°ƒç”¨ <code>server.Stop</code> åœæ­¢æœåŠ¡å™¨ã€‚</li>
</ul>
<p>è¿›ä¸€æ­¥åˆ†æ<code>server.New()</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨<code>containerd/cmd/containerd/server/server.go</code>ä¸­ã€‚</p>
<blockquote>
<p>è¿™ä¸ªå‡½æ•°ç”¨äºåˆ›å»ºå’Œåˆå§‹åŒ– gRPC æœåŠ¡å™¨çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å®ƒæ¶‰åŠé…ç½®çš„è¿ç§»ã€æ’ä»¶çš„åŠ è½½ä¸åˆå§‹åŒ–ã€gRPC æœåŠ¡çš„æ³¨å†Œï¼Œä»¥åŠå…¶ä»–æœåŠ¡å™¨è®¾ç½®ã€‚ï¼ˆæˆ‘è¿™é‡Œåªåˆ†æäº†éƒ¨åˆ†é‡è¦æºç ï¼‰</p>
</blockquote>
<p><strong>(1)é…ç½®è¿ç§»</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">currentVersion</span> <span class="p">&lt;</span> <span class="nx">version</span><span class="p">.</span><span class="nx">ConfigVersion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Migrate config to latest version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t1</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">MigrateConfig</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">migrationT</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">t1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ç‰ˆæœ¬æ£€æŸ¥ä¸è¿ç§»</strong>ï¼šå¦‚æœå½“å‰é…ç½®çš„ç‰ˆæœ¬ä½äºç³»ç»Ÿè¦æ±‚çš„ç‰ˆæœ¬ï¼Œåˆ™è¿›è¡Œé…ç½®è¿ç§»ã€‚è¿ç§»æ—¶é—´è¢«è®°å½•åœ¨ <code>migrationT</code> ä¸­ã€‚</p>
</li>
<li>
<p><strong>é…ç½®è¿ç§»</strong>ï¼šé€šè¿‡ <code>config.MigrateConfig(ctx)</code> æ–¹æ³•è¿›è¡Œè¿ç§»ï¼Œå°†é…ç½®æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚</p>
</li>
</ul>
<p><strong>(2)é…ç½® Stream å¤„ç†å™¨</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">config</span><span class="p">.</span><span class="nx">StreamProcessors</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">diff</span><span class="p">.</span><span class="nf">RegisterProcessor</span><span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nf">BinaryHandler</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Returns</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Accepts</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Env</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>æ³¨å†Œæµå¤„ç†å™¨</strong>ï¼šæ ¹æ®é…ç½®ä¸­çš„ <code>StreamProcessors</code> æ³¨å†Œæµå¤„ç†å™¨ï¼Œè¿™äº›å¤„ç†å™¨ç”¨äºå¤„ç†æ•°æ®æµã€‚</li>
</ul>
<p><strong>(3)ã€åˆå§‹åŒ– gRPC æœåŠ¡å™¨</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">serverOpts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">grpc</span><span class="p">.</span><span class="nf">StatsHandler</span><span class="p">(</span><span class="nx">otelgrpc</span><span class="p">.</span><span class="nf">NewServerHandler</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">grpc</span><span class="p">.</span><span class="nf">ChainStreamInterceptor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">streamNamespaceInterceptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prometheusServerMetrics</span><span class="p">.</span><span class="nf">StreamServerInterceptor</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">grpc</span><span class="p">.</span><span class="nf">ChainUnaryInterceptor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unaryNamespaceInterceptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prometheusServerMetrics</span><span class="p">.</span><span class="nf">UnaryServerInterceptor</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>gRPC æœåŠ¡å™¨é€‰é¡¹</strong>ï¼šé…ç½® gRPC æœåŠ¡å™¨çš„é€‰é¡¹ï¼Œå¦‚ç»Ÿè®¡å¤„ç†ç¨‹åºã€æ‹¦æˆªå™¨ç­‰ã€‚è¿™äº›æ‹¦æˆªå™¨å¯ä»¥ç”¨äºå¤„ç†å‘½åç©ºé—´ã€ç›‘æ§ç­‰ã€‚</li>
</ul>
<p><strong>(4)ã€æ³¨å†ŒæœåŠ¡</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">service</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">grpcServices</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">grpcServer</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>å¯åŠ¨ gRPC å’Œå…¶ä»–æœåŠ¡ï¼ˆé‡ç‚¹ï¼‰</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">isLocalAddress</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">GID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeDebug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for metrics endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main ttrpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tl</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTTRPC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for TCP grpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTCP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeGRPC</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>å¯åŠ¨è°ƒè¯•æœåŠ¡</strong>: å¦‚æœé…ç½®äº†è°ƒè¯•åœ°å€ï¼Œè°ƒç”¨ <code>serve</code> å¯åŠ¨è°ƒè¯•æœåŠ¡ (<code>ServeDebug</code>)ã€‚</li>
<li><strong>å¯åŠ¨åº¦é‡æœåŠ¡</strong>: å¦‚æœé…ç½®äº†åº¦é‡åœ°å€ï¼Œè°ƒç”¨ <code>serve</code> å¯åŠ¨åº¦é‡æœåŠ¡ (<code>ServeMetrics</code>)ã€‚</li>
<li><strong>å¯åŠ¨ TTRPC æœåŠ¡</strong>: ä½¿ç”¨ <code>sys.GetLocalListener</code> è·å–æœ¬åœ°ç›‘å¬å™¨å¹¶å¯åŠ¨ TTRPC æœåŠ¡ (<code>ServeTTRPC</code>)ã€‚</li>
<li><strong>å¯åŠ¨ gRPC æœåŠ¡</strong>: å¦‚æœé…ç½®äº† TCP gRPC åœ°å€ï¼Œåˆ™é€šè¿‡ TCP å¯åŠ¨ gRPC æœåŠ¡ (<code>ServeTCP</code>)ã€‚åŒæ—¶ï¼Œè¿˜ä¼šä¸ºä¸»è¦çš„ gRPC æœåŠ¡é…ç½® Unix Domain Socket (UDS) å¹¶å¯åŠ¨æœåŠ¡ (<code>ServeGRPC</code>)ã€‚</li>
</ul>
</li>
<li>
<p><strong>æœåŠ¡å¯åŠ¨ä¸å¤„ç†</strong></p>
<blockquote>
<p><code>serve</code> å‡½æ•°ç”¨äºå¯åŠ¨æŒ‡å®šçš„æœåŠ¡ï¼Œæ¥å—ä¸€ä¸ªç›‘å¬å™¨ <code>l</code> å’Œä¸€ä¸ªæœåŠ¡å‡½æ•° <code>serveFunc</code> ä½œä¸ºå‚æ•°ã€‚å®ƒåœ¨æ–°çš„ goroutine ä¸­æ‰§è¡ŒæœåŠ¡å‡½æ•°ï¼Œå¹¶åœ¨æœåŠ¡ç»“æŸåå…³é—­ç›‘å¬å™¨ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="nx">serveFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Addr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;serving...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serveFunc</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;serve failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p><strong>åœ¨å¯åŠ¨ gRPC ä¸­è°ƒç”¨äº†<code>sys.GetLocalListener()</code>ï¼Œè¿™ä¸ªå‡½æ•°åœ¨ä¸‹é¢çš„å‡½æ•°ä¸­è¢«å®šä¹‰ã€‚</strong></p>
<blockquote>
<p>æ–‡ä»¶è·¯å¾„ï¼š<code>containerd/pkg/sys/socket_unix.go</code>ï¼Œè¿™ä¸ªæ–‡ä»¶æ¶‰åŠåˆ°äº†udsæ–‡ä»¶çš„åˆ›å»ºã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;path/filepath&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;golang.org/x/sys/unix&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// CreateUnixSocket creates a unix socket and returns the listener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// BSDs have a 104 limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">104</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%q: unix socket path too long (&gt; 104)&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Unlink</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// GetLocalListener returns a listener out of a unix socket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure parent directory is created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0770</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è¯¦ç»†åˆ†æï¼š</strong></p>
<p><strong><code>CreateUnixSocket</code> å‡½æ•°</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// BSDs have a 104 limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">104</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%q: unix socket path too long (&gt; 104)&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Unlink</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>CreateUnixSocket</code> å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ª Unix Domain Socketï¼Œå¹¶è¿”å›ä¸€ä¸ªç”¨äºç›‘å¬è¿æ¥çš„ <code>net.Listener</code> å®ä¾‹ã€‚</p>
<p>è¯¦ç»†åˆ†æï¼š</p>
<ul>
<li><strong>è·¯å¾„é•¿åº¦æ£€æŸ¥</strong>ï¼šé¦–å…ˆï¼Œå‡½æ•°æ£€æŸ¥å¥—æ¥å­—è·¯å¾„çš„é•¿åº¦æ˜¯å¦è¶…è¿‡äº† 104 ä¸ªå­—ç¬¦ã€‚è¿™æ˜¯å› ä¸ºåœ¨ä¸€äº› BSD ç³»ç»Ÿä¸­ï¼ŒUnix Domain Socket çš„è·¯å¾„é•¿åº¦é™åˆ¶ä¸º 104 ä¸ªå­—ç¬¦ã€‚å¦‚æœè·¯å¾„å¤ªé•¿ï¼Œå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li>
<li><strong>åˆ›å»ºçˆ¶ç›®å½•</strong>ï¼šä½¿ç”¨ <code>os.MkdirAll</code> åˆ›å»º Unix Socket çš„çˆ¶ç›®å½•ã€‚å¦‚æœè¯¥ç›®å½•ä¸å­˜åœ¨ï¼Œ<code>MkdirAll</code> ä¼šé€’å½’åœ°åˆ›å»ºç›®å½•ã€‚ç›®å½•æƒé™è®¾ç½®ä¸º <code>0660</code>ã€‚</li>
<li><strong>åˆ é™¤ç°æœ‰çš„ Unix Socket æ–‡ä»¶</strong>ï¼šè°ƒç”¨ <code>unix.Unlink</code> å°è¯•åˆ é™¤æŒ‡å®šè·¯å¾„ä¸Šçš„ç°æœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œä»¥ç¡®ä¿æ–°åˆ›å»ºçš„å¥—æ¥å­—æ–‡ä»¶ä¸ä¼šä¸æ—§æ–‡ä»¶å†²çªã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œ<code>Unlink</code> ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œä½†å¦‚æœé”™è¯¯ç±»å‹æ˜¯ <code>os.IsNotExist</code>ï¼Œè¡¨ç¤ºæ–‡ä»¶æœ¬æ¥å°±ä¸å­˜åœ¨ï¼Œè¿™æ—¶ä¼šå¿½ç•¥è¿™ä¸ªé”™è¯¯ã€‚</li>
<li><strong>åˆ›å»º Unix Socket</strong>ï¼šæœ€åï¼Œä½¿ç”¨ <code>net.Listen(&quot;unix&quot;, path)</code> åˆ›å»ºä¸€ä¸ª Unix Domain Socketï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>net.Listener</code>ï¼Œä¾›åç»­ä½¿ç”¨ã€‚</li>
</ul>
<p><strong><code>GetLocalListener</code> å‡½æ•°</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure parent directory is created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>GetLocalListener</code> å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæœ¬åœ°çš„ Unix Domain Socket ç›‘å¬å™¨ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„æƒé™å’Œæ‰€æœ‰è€…ä¿¡æ¯ã€‚</p>
<p>è¯¦ç»†åˆ†æï¼š</p>
<ul>
<li><strong>åˆ›å»ºçˆ¶ç›®å½•</strong>ï¼šè°ƒç”¨ <code>mkdirAs</code> å‡½æ•°ç¡®ä¿ Unix Socket çš„çˆ¶ç›®å½•å·²ç»åˆ›å»ºï¼Œå¹¶è®¾ç½®äº†é€‚å½“çš„ç”¨æˆ· ID (<code>uid</code>) å’Œç»„ ID (<code>gid</code>)ã€‚</li>
<li><strong>åˆ›å»º Unix Socket</strong>ï¼šä½¿ç”¨ <code>CreateUnixSocket</code> å‡½æ•°åˆ›å»º Unix Domain Socketã€‚</li>
<li><strong>è®¾ç½®æƒé™</strong>ï¼šä½¿ç”¨ <code>os.Chmod</code> è®¾ç½® Unix Socket æ–‡ä»¶çš„æƒé™ä¸º <code>0660</code>ï¼Œå³æ–‡ä»¶æ‰€æœ‰è€…å’Œç»„æˆå‘˜å¯è¯»å†™ï¼Œå…¶ä»–ç”¨æˆ·æ— æƒé™ã€‚</li>
<li><strong>è®¾ç½®æ‰€æœ‰è€…</strong>ï¼šä½¿ç”¨ <code>os.Chown</code> å°† Unix Socket æ–‡ä»¶çš„æ‰€æœ‰è€…å’Œç»„è®¾ç½®ä¸ºæŒ‡å®šçš„ <code>uid</code> å’Œ <code>gid</code>ã€‚</li>
<li><strong>è¿”å›ç›‘å¬å™¨</strong>ï¼šå¦‚æœæ‰€æœ‰æ“ä½œéƒ½æˆåŠŸï¼Œè¿”å›åˆ›å»ºçš„ <code>net.Listener</code> å®ä¾‹ã€‚å¦‚æœåœ¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œå…³é—­å·²åˆ›å»ºçš„ç›‘å¬å™¨ï¼Œå¹¶è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<p><strong><code>mkdirAs</code> å‡½æ•°</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0770</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>mkdirAs</code> å‡½æ•°ç”¨äºåˆ›å»ºæŒ‡å®šçš„ç›®å½•ï¼Œå¹¶è®¾ç½®è¯¥ç›®å½•çš„æ‰€æœ‰è€…å’Œæƒé™ã€‚</p>
<p>è¯¦ç»†åˆ†æï¼š</p>
<ul>
<li><strong>æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨</strong>ï¼šä½¿ç”¨ <code>os.Stat</code> æ£€æŸ¥ç›®æ ‡ç›®å½•æ˜¯å¦å·²ç»å­˜åœ¨ã€‚å¦‚æœç›®å½•å­˜åœ¨ï¼Œè¿”å›è¯¥ç›®å½•çš„çŠ¶æ€ä¿¡æ¯æˆ–é”™è¯¯ã€‚å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œã€‚</li>
<li><strong>åˆ›å»ºç›®å½•</strong>ï¼šä½¿ç”¨ <code>os.MkdirAll</code> åˆ›å»ºç›®æ ‡ç›®å½•ï¼Œå¹¶å°†æƒé™è®¾ç½®ä¸º <code>0770</code>ï¼ˆå³æ‰€æœ‰è€…å’Œç»„æˆå‘˜å¯ä»¥è¯»å†™æ‰§è¡Œï¼Œå…¶ä»–ç”¨æˆ·æ— æƒé™ï¼‰ã€‚</li>
<li><strong>è®¾ç½®æ‰€æœ‰è€…</strong>ï¼šä½¿ç”¨ <code>os.Chown</code> å°†ç›®å½•çš„æ‰€æœ‰è€…å’Œç»„è®¾ç½®ä¸ºæŒ‡å®šçš„ <code>uid</code> å’Œ <code>gid</code>ã€‚</li>
<li><strong>è¿”å›ç»“æœ</strong>ï¼šå¦‚æœæ‰€æœ‰æ“ä½œéƒ½æˆåŠŸï¼Œè¿”å› <code>nil</code>ã€‚å¦‚æœä»»ä½•æ­¥éª¤å‡ºé”™ï¼Œåˆ™è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h3 id="clientä¸containerdå®ˆæŠ¤è¿›ç¨‹çš„é€šä¿¡">clientä¸containerdå®ˆæŠ¤è¿›ç¨‹çš„é€šä¿¡
</h3><blockquote>
<p>æ–‡ä»¶è·¯å¾„ï¼šcontainerd/client/client.goï¼Œè¿™æ®µä»£ç æ˜¯ <code>containerd</code> é¡¹ç›®ä¸­ <code>client</code> åŒ…çš„å®ç°ï¼Œè´Ÿè´£åˆ›å»ºä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹é€šä¿¡çš„å®¢æˆ·ç«¯å®ä¾‹ã€‚å®ƒåŒ…å«äº†ä¸ <code>containerd</code> è¿›è¡Œ gRPC é€šä¿¡çš„åŸºç¡€è®¾æ–½ï¼Œæä¾›äº†ä¸€ç»„æ–¹æ³•ï¼Œç”¨äºä¸ <code>containerd</code> çš„å„ç§æœåŠ¡è¿›è¡Œäº¤äº’ï¼Œä¾‹å¦‚å®¹å™¨ç®¡ç†ã€é•œåƒç®¡ç†ã€å¿«ç…§ç®¡ç†ç­‰ã€‚</p>
</blockquote>
<ol>
<li><strong><code>Client</code> ç»“æ„ä½“</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Client</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="nx">connMu</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">conn</span>      <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span>
</span></span><span class="line"><span class="cl">	<span class="nx">runtime</span>   <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">defaultns</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">platform</span>  <span class="nx">platforms</span><span class="p">.</span><span class="nx">MatchComparer</span>
</span></span><span class="line"><span class="cl">	<span class="nx">connector</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>services</code></strong>: å†…åµŒçš„ <code>services</code> ç»“æ„ä½“ï¼ŒåŒ…å«äº†ä¸ <code>containerd</code> æœåŠ¡é€šä¿¡çš„å…·ä½“æ–¹æ³•ï¼Œå¦‚ <code>ContainerService</code>ã€<code>ImageService</code> ç­‰ã€‚</li>
<li><strong><code>conn</code></strong>: ä¸€ä¸ª gRPC è¿æ¥å¯¹è±¡ï¼Œç”¨äºä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹é€šä¿¡ã€‚</li>
<li><strong><code>connMu</code></strong>: ä¸€ä¸ªäº’æ–¥é”ï¼Œç”¨äºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¿æŠ¤ <code>conn</code> å¯¹è±¡çš„å¹¶å‘è®¿é—®ã€‚</li>
<li><strong><code>runtime</code></strong>: è¡¨ç¤ºå½“å‰ä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ã€‚</li>
<li><strong><code>defaultns</code></strong>: å®¢æˆ·ç«¯çš„é»˜è®¤å‘½åç©ºé—´ã€‚</li>
<li><strong><code>platform</code></strong>: å¹³å°åŒ¹é…å™¨ï¼Œç”¨äºç¡®å®šè¿è¡Œåœ¨ç‰¹å®šå¹³å°ä¸Šçš„å®¹å™¨ã€‚</li>
<li><strong><code>connector</code></strong>: ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºé‡æ–°è¿æ¥åˆ° <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ã€‚</li>
</ul>
<ol start="2">
<li><strong><code>New</code> å‡½æ•°</strong></li>
</ol>
<p><code>New</code> å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Client</code> å®ä¾‹ï¼Œè¿æ¥åˆ°æŒ‡å®šçš„ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹åœ°å€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">address</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">copts</span> <span class="nx">clientOpts</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">copts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">defaultns</span><span class="p">:</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">platforms</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">services</span> <span class="p">=</span> <span class="o">*</span><span class="nx">copts</span><span class="p">.</span><span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span> <span class="o">:=</span> <span class="nx">backoff</span><span class="p">.</span><span class="nx">DefaultConfig</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span><span class="p">.</span><span class="nx">MaxDelay</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span>
</span></span><span class="line"><span class="cl">		<span class="nx">connParams</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ConnectParams</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Backoff</span><span class="p">:</span> <span class="nx">backoffConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">DialOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithTransportCredentials</span><span class="p">(</span><span class="nx">insecure</span><span class="p">.</span><span class="nf">NewCredentials</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithConnectParams</span><span class="p">(</span><span class="nx">connParams</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithContextDialer</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nx">ContextDialer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallRecvMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxRecvMsgSize</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallSendMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxSendMsgSize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">unary</span><span class="p">,</span> <span class="nx">stream</span> <span class="o">:=</span> <span class="nf">newNSInterceptors</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainUnaryInterceptor</span><span class="p">(</span><span class="nx">unary</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainStreamInterceptor</span><span class="p">(</span><span class="nx">stream</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">connector</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nf">DialAddress</span><span class="p">(</span><span class="nx">address</span><span class="p">),</span> <span class="nx">gopts</span><span class="o">...</span><span class="p">)</span> <span class="c1">//gRPCè¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to dial %q: %w&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">conn</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">connector</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connector</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">,</span> <span class="nx">connector</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no grpc connection or services is available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// check namespace labels for default runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetLabel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntimeNSLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">label</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">label</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>é€‰é¡¹è§£æ</strong>: <code>copts</code> ç”¨äºå­˜å‚¨å®¢æˆ·ç«¯é…ç½®é€‰é¡¹ï¼Œé€šè¿‡ä¼ å…¥çš„ <code>opts</code> è¿›è¡Œè§£æé…ç½®ã€‚</li>
<li><strong>é»˜è®¤é…ç½®è®¾ç½®</strong>: å¦‚æœæœªæŒ‡å®šè¿è¡Œæ—¶ã€å¹³å°ç­‰é€‰é¡¹ï¼Œä½¿ç”¨é»˜è®¤å€¼è¿›è¡Œåˆå§‹åŒ–ã€‚</li>
<li>gRPC è¿æ¥:
<ul>
<li>é…ç½®äº†è¿æ¥å‚æ•°å’Œæ‹¨å·é€‰é¡¹ï¼ˆå¦‚è¶…æ—¶ã€TLSã€å®‰å…¨å‡­è¯ç­‰ï¼‰ã€‚</li>
<li>ä½¿ç”¨ <code>grpc.NewClient</code> å»ºç«‹åˆ° <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹çš„ gRPC è¿æ¥ã€‚</li>
<li>è¿æ¥æˆåŠŸåï¼Œä¿å­˜è¿æ¥å¯¹è±¡ <code>conn</code> å’Œé‡æ–°è¿æ¥çš„å‡½æ•° <code>connector</code>ã€‚</li>
</ul>
</li>
<li><strong>å‘½åç©ºé—´æ ‡ç­¾æ£€æŸ¥</strong>: å¦‚æœæ²¡æœ‰æŒ‡å®šè¿è¡Œæ—¶ï¼Œå¹¶ä¸”è®¾ç½®äº†é»˜è®¤å‘½åç©ºé—´ï¼Œä¼šå°è¯•ä»å‘½åç©ºé—´æ ‡ç­¾ä¸­è·å–é»˜è®¤è¿è¡Œæ—¶ã€‚</li>
<li><strong>é”™è¯¯å¤„ç†</strong>: å¦‚æœæ— æ³•å»ºç«‹ gRPC è¿æ¥ï¼Œæˆ–æœªæä¾›è¿æ¥æˆ–æœåŠ¡ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</li>
</ul>
<ol start="3">
<li><strong><code>NewWithConn</code> å‡½æ•°</strong></li>
</ol>
<p><code>NewWithConn</code> å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªä¸ç°æœ‰çš„ gRPC è¿æ¥å…³è”çš„ <code>Client</code> å®ä¾‹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewWithConn</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">copts</span> <span class="nx">clientOpts</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">copts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">defaultns</span><span class="p">:</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">:</span>      <span class="nx">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runtime</span><span class="p">:</span>   <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">platforms</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// check namespace labels for default runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetLabel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntimeNSLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">label</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">label</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">services</span> <span class="p">=</span> <span class="o">*</span><span class="nx">copts</span><span class="p">.</span><span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å‚æ•°è¯´æ˜:
<ul>
<li><strong><code>conn</code></strong>: ä¸€ä¸ªç°æœ‰çš„ gRPC è¿æ¥å®ä¾‹ã€‚</li>
<li><strong><code>opts</code></strong>: å¯é€‰çš„å®¢æˆ·ç«¯é…ç½®é€‰é¡¹ã€‚</li>
</ul>
</li>
<li>åˆå§‹åŒ–:
<ul>
<li>ä¸ <code>New</code> å‡½æ•°ç±»ä¼¼ï¼Œåˆå§‹åŒ– <code>Client</code> å®ä¾‹ï¼Œè®¾ç½®é»˜è®¤è¿è¡Œæ—¶å’Œå¹³å°ã€‚</li>
<li>å¦‚æœä¼ å…¥äº†æœåŠ¡é…ç½® <code>services</code>ï¼Œåˆ™ä½¿ç”¨è¯¥é…ç½®ã€‚</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong><code>Reconnect</code> å‡½æ•°</strong></li>
</ol>
<p><code>Reconnect</code> å‡½æ•°ç”¨äºé‡æ–°å»ºç«‹ä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹çš„ gRPC è¿æ¥ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Reconnect</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connector</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to reconnect to containerd, no connector available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">connector</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="p">=</span> <span class="nx">conn</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>é”å®šè¿æ¥</strong>: ä½¿ç”¨ <code>connMu</code> äº’æ–¥é”æ¥é˜²æ­¢å¹¶å‘ä¿®æ”¹ <code>conn</code> å¯¹è±¡ã€‚</li>
<li><strong>å…³é—­æ—§è¿æ¥</strong>: å…³é—­ç°æœ‰çš„ gRPC è¿æ¥ã€‚</li>
<li><strong>é‡æ–°è¿æ¥</strong>: ä½¿ç”¨ <code>connector</code> å‡½æ•°é‡æ–°å»ºç«‹è¿æ¥ï¼Œå¹¶å°†æ–°è¿æ¥èµ‹å€¼ç»™ <code>conn</code>ã€‚</li>
</ul>
<ol start="5">
<li><strong><code>IsServing</code> å‡½æ•°</strong></li>
</ol>
<p><code>IsServing</code> å‡½æ•°ç”¨äºæ£€æŸ¥ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¹¶è¿”å› <code>SERVING</code> çŠ¶æ€ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">IsServing</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no grpc connection available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">HealthService</span><span class="p">().</span><span class="nf">Check</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">grpc_health_v1</span><span class="p">.</span><span class="nx">HealthCheckRequest</span><span class="p">{},</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WaitForReady</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Status</span> <span class="o">==</span> <span class="nx">grpc_health_v1</span><span class="p">.</span><span class="nx">HealthCheckResponse_SERVING</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>é”å®šè¿æ¥</strong>: ç¡®ä¿åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€æ—¶ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹ <code>conn</code> å¯¹è±¡ã€‚</li>
<li><strong>å¥åº·æ£€æŸ¥</strong>: è°ƒç”¨ <code>HealthService().Check</code> æ–¹æ³•ï¼Œæ£€æŸ¥ <code>containerd</code> çš„å¥åº·çŠ¶æ€ï¼Œç¡®å®šæœåŠ¡æ˜¯å¦å¯ç”¨ã€‚</li>
<li><strong>è¿”å›å€¼</strong>: å¦‚æœæœåŠ¡æ­£åœ¨è¿è¡Œå¹¶è¿”å› <code>SERVING</code> çŠ¶æ€ï¼Œåˆ™è¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code> å’Œé”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<p>åœ¨ <code>containerd</code> çš„ä»£ç ä¸­ï¼Œè°ƒç”¨ <code>grpc.NewClient</code> å‡½æ•°å®é™…ä¸Šæ˜¯ç›´æ¥ä½¿ç”¨ gRPC åº“ä¸­çš„è¿™ä¸ªå‡½æ•°æ¥åˆ›å»º gRPC å®¢æˆ·ç«¯è¿æ¥ã€‚è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šåˆ›å»ºå’Œç®¡ç†ä¸ <code>containerd</code> æœåŠ¡å™¨çš„ gRPC è¿æ¥ï¼Œä¸‹ä¸€éƒ¨åˆ†å°†è¯¦ç»†åˆ†ægRPCæ¡†æ¶ã€‚</p>
<blockquote>
<p>æºç é“¾æ¥ï¼š<a class="link" href="https://github.com/grpc/grpc-go/blob/v1.65.0/clientconn.go#L588"  target="_blank" rel="noopener"
    >grpc-go/clientconn.go at v1.65.0 Â· grpc/grpc-go (github.com)</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">target</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">DialOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ClientConn</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">target</span><span class="p">:</span> <span class="nx">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conns</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">addrConn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dopts</span><span class="p">:</span>  <span class="nf">defaultDialOptions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">retryThrottler</span><span class="p">.</span><span class="nf">Store</span><span class="p">((</span><span class="o">*</span><span class="nx">retryThrottler</span><span class="p">)(</span><span class="kc">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">safeConfigSelector</span><span class="p">.</span><span class="nf">UpdateConfigSelector</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">defaultConfigSelector</span><span class="p">{</span><span class="kc">nil</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Apply dial options.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">disableGlobalOpts</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.(</span><span class="o">*</span><span class="nx">disableGlobalDialOptions</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">disableGlobalOpts</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">disableGlobalOpts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">globalDialOptions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opt</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opt</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Determine the resolver to use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">initParsedTargetAndResolverBuilder</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">globalPerTargetDialOptions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opt</span><span class="p">.</span><span class="nf">DialOptionForTarget</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">.</span><span class="nx">URL</span><span class="p">).</span><span class="nf">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">chainUnaryClientInterceptors</span><span class="p">(</span><span class="nx">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">chainStreamClientInterceptors</span><span class="p">(</span><span class="nx">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">validateTransportCredentials</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfigRawJSON</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scpr</span> <span class="o">:=</span> <span class="nf">parseServiceConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfigRawJSON</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">maxCallAttempts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">scpr</span><span class="p">.</span><span class="nx">Err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s: %v&#34;</span><span class="p">,</span> <span class="nx">invalidDefaultServiceConfigErrPrefix</span><span class="p">,</span> <span class="nx">scpr</span><span class="p">.</span><span class="nx">Err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfig</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">scpr</span><span class="p">.</span><span class="nx">Config</span><span class="p">.(</span><span class="o">*</span><span class="nx">ServiceConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">mkp</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">KeepaliveParams</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">initAuthority</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Register ClientConn with channelz. Note that this is only done after
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// channel creation cannot fail.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cc</span><span class="p">.</span><span class="nf">channelzRegistration</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">channelz</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;parsed dial target is: %#v&#34;</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">channelz</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;Channel authority set to %q&#34;</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">authority</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">csMgr</span> <span class="p">=</span> <span class="nf">newConnectivityStateManager</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">pickerWrapper</span> <span class="p">=</span> <span class="nf">newPickerWrapper</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">StatsHandlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nf">initIdleStateLocked</span><span class="p">()</span> <span class="c1">// Safe to call without the lock, since nothing else has a reference to cc.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cc</span><span class="p">.</span><span class="nx">idlenessMgr</span> <span class="p">=</span> <span class="nx">idle</span><span class="p">.</span><span class="nf">NewManager</span><span class="p">((</span><span class="o">*</span><span class="nx">idler</span><span class="p">)(</span><span class="nx">cc</span><span class="p">),</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">idleTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ gRPC æ¡†æ¶ä¸­ï¼Œ<code>NewClient</code> å‡½æ•°è´Ÿè´£ä¸ºç»™å®šçš„ç›®æ ‡ URI åˆ›å»ºä¸€ä¸ª gRPC â€œé€šé“â€ï¼ˆå³ <code>ClientConn</code>ï¼‰ã€‚<code>ClientConn</code> æ˜¯ gRPC å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œå®ƒå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºå¤šä¸ªå®é™…è¿æ¥ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š</p>
<ol>
<li><strong>è§£æç›®æ ‡ URI</strong>ï¼šæ ¹æ®ç›®æ ‡ URI çš„æ–¹æ¡ˆï¼ˆå¦‚ <code>dns://</code> æˆ– <code>passthrough://</code>ï¼‰ï¼Œé€‰æ‹©åˆé€‚çš„è§£æå™¨æ¥è§£ææœåŠ¡åœ°å€ã€‚</li>
<li><strong>é…ç½®è¿æ¥å‚æ•°</strong>ï¼šåº”ç”¨å„ç§æ‹¨å·é€‰é¡¹ï¼ˆå¦‚å®‰å…¨å‡­è¯ã€è´Ÿè½½å‡è¡¡ç­–ç•¥ã€é‡è¯•ç­–ç•¥ç­‰ï¼‰ï¼Œå¹¶åˆå§‹åŒ– <code>ClientConn</code> çš„çŠ¶æ€ã€‚</li>
<li><strong>åˆ›å»ºè¿æ¥</strong>ï¼šåœ¨åå°å°è¯•ä¸ç›®æ ‡åœ°å€å»ºç«‹è¿æ¥ï¼Œå¹¶æ ¹æ®è¿æ¥çŠ¶æ€æ›´æ–° <code>ClientConn</code> çš„çŠ¶æ€ã€‚</li>
<li><strong>ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸ</strong>ï¼šåœ¨è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œ<code>ClientConn</code> ä¼šè‡ªåŠ¨å¤„ç†è¿æ¥å¤±è´¥ã€é‡è¿ã€è´Ÿè½½å‡è¡¡ç­‰é€»è¾‘ã€‚</li>
</ol>
<h2 id="grpcæ¡†æ¶ä¸­çš„rpcé€šä¿¡">gRPCæ¡†æ¶ä¸­çš„RPCé€šä¿¡
</h2><h3 id="grpc-go-ä¸­-rpc-é€šä¿¡">gRPC-Go ä¸­ RPC é€šä¿¡
</h3><h4 id="goç‰ˆæœ¬grpcé€šä¿¡æœºåˆ¶æ¦‚è¿°">Goç‰ˆæœ¬gRPCé€šä¿¡æœºåˆ¶æ¦‚è¿°
</h4><p>åœ¨ gRPC-Go ä¸­ï¼Œå®¢æˆ·ç«¯å‘èµ·çš„æ¯ä¸€ä¸ª RPC è°ƒç”¨éƒ½ä¼šæ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li><strong>å‘èµ· RPC è¯·æ±‚</strong>ï¼šå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ª RPC è°ƒç”¨ï¼Œå¹¶å‘é€å…ƒæ•°æ®å’Œè¯·æ±‚æ•°æ®ã€‚</li>
<li><strong>æœåŠ¡å™¨å¤„ç†è¯·æ±‚</strong>ï¼šæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œå¤„ç†å¹¶ç”Ÿæˆå“åº”ã€‚</li>
<li><strong>å‘é€å“åº”</strong>ï¼šæœåŠ¡å™¨å°†å“åº”å‘é€å›å®¢æˆ·ç«¯ã€‚</li>
<li><strong>æ¥æ”¶å“åº”</strong>ï¼šå®¢æˆ·ç«¯æ¥æ”¶åˆ°å“åº”ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚</li>
</ol>
<h4 id="goç‰ˆæœ¬grpcæºç ç»“æ„">Goç‰ˆæœ¬gRPCæºç ç»“æ„
</h4><p>gRPC-Go çš„æºç ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ¨¡å—ï¼š</p>
<ul>
<li><strong>transport</strong>ï¼šè´Ÿè´£åº•å±‚ HTTP/2 ä¼ è¾“çš„å®ç°ã€‚</li>
<li><strong>stream</strong>ï¼šç®¡ç†å’Œæ§åˆ¶ gRPC çš„æµã€‚</li>
<li><strong>server</strong> å’Œ <strong>client</strong>ï¼šåˆ†åˆ«ç®¡ç† gRPC æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li><strong>codec</strong>ï¼šç”¨äºæ¶ˆæ¯çš„ç¼–ç å’Œè§£ç ã€‚</li>
</ul>
<h4 id="grpc-go-ä¸­-rpc-é€šä¿¡æµç¨‹çš„æºç åˆ†æ">gRPC-Go ä¸­ RPC é€šä¿¡æµç¨‹çš„æºç åˆ†æ
</h4><h5 id="clientconn-çš„åˆå§‹åŒ–"><strong><code>ClientConn</code> çš„åˆå§‹åŒ–</strong>
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">target</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">DialOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ClientConn</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">target</span><span class="p">:</span> <span class="nx">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conns</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">addrConn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dopts</span><span class="p">:</span>  <span class="nf">defaultDialOptions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£æ target åœ°å€ï¼Œé€‰æ‹©åˆé€‚çš„ resolver (è§£æå™¨)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">initParsedTargetAndResolverBuilder</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–è¿æ¥ç®¡ç†å’Œè´Ÿè½½å‡è¡¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cc</span><span class="p">.</span><span class="nx">csMgr</span> <span class="p">=</span> <span class="nf">newConnectivityStateManager</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span><span class="p">.</span><span class="nx">pickerWrapper</span> <span class="p">=</span> <span class="nf">newPickerWrapper</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">StatsHandlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="rpc-è¯·æ±‚çš„å‘èµ·"><strong>RPC è¯·æ±‚çš„å‘èµ·</strong>
</h5><p>åœ¨ gRPC-Go ä¸­ï¼ŒRPC è¯·æ±‚çš„å‘èµ·ä¸»è¦é€šè¿‡ <code>invoke</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•ä½äº <code>google.golang.org/grpc</code> åŒ…çš„ <code>call.go</code> æ–‡ä»¶ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">invoke</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">reply</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newClientStream</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">unaryStreamDesc</span><span class="p">,</span> <span class="nx">cc</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">SendMsg</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">RecvMsg</span><span class="p">(</span><span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>invoke</code> æ–¹æ³•æ˜¯å®¢æˆ·ç«¯æ‰§è¡Œå•ä¸ª RPC è°ƒç”¨çš„å…¥å£ã€‚å®ƒé¦–å…ˆé€šè¿‡ <code>newClientStream</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯æµï¼ˆ<code>ClientStream</code>ï¼‰ï¼Œç„¶åå‘é€æ¶ˆæ¯å¹¶æ¥æ”¶å“åº”ã€‚</p>
<h5 id="åˆ›å»º-clientstream"><strong>åˆ›å»º ClientStream</strong>
</h5><p><code>newClientStream</code> çš„å®ç°ä½äº <code>google.golang.org/grpc</code> åŒ…çš„ <code>stream.go</code> æ–‡ä»¶ä¸­ï¼Œå®ƒè´Ÿè´£åˆå§‹åŒ– gRPC çš„æµï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newClientStream</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">desc</span> <span class="o">*</span><span class="nx">StreamDesc</span><span class="p">,</span> <span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">ClientStream</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ– streamï¼Œè®¾ç½®ä¼ è¾“å±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">getTransport</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// å¼€å§‹æµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">NewStream</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">clientStream</span><span class="p">{</span><span class="nx">s</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">desc</span><span class="p">:</span> <span class="nx">desc</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œçš„ <code>NewStream</code> æ–¹æ³•æ˜¯ç”± <code>transport</code> å±‚æ¥å¤„ç†çš„ï¼Œå®ƒå°†åˆ›å»ºä¸€ä¸ªæ–°çš„ HTTP/2 æµï¼Œç”¨äºåç»­çš„æ¶ˆæ¯ä¼ è¾“ã€‚</p>
<h5 id="ä¼ è¾“å±‚transport-layer"><strong>ä¼ è¾“å±‚ï¼ˆTransport Layerï¼‰</strong>
</h5><p>åœ¨ gRPC-Go ä¸­ï¼Œä¼ è¾“å±‚çš„æ ¸å¿ƒå®ç°ä½äº <code>transport/http2_client.go</code> ä¸­ã€‚è¿™ä¸ªæ–‡ä»¶åŒ…å«äº† gRPC ä½¿ç”¨ HTTP/2 è¿›è¡Œæ•°æ®ä¼ è¾“çš„æ ¸å¿ƒé€»è¾‘ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">http2Client</span><span class="p">)</span> <span class="nf">NewStream</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">callHdr</span> <span class="o">*</span><span class="nx">CallHdr</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">Stream</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»º HTTP/2 æµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Stream</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span><span class="p">.</span><span class="nx">activeStreams</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">s</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å‘é€è¯·æ±‚å¤´éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">framer</span><span class="p">.</span><span class="nf">writeHeaders</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>NewStream</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„ HTTP/2 æµï¼Œå¹¶é€šè¿‡ <code>writeHeaders</code> æ–¹æ³•å°† gRPC è¯·æ±‚çš„å…ƒæ•°æ®å‘é€åˆ°æœåŠ¡å™¨ã€‚</p>
<h5 id="æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶"><strong>æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶</strong>
</h5><p>åœ¨å®¢æˆ·ç«¯æµä¸­ï¼Œæ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶é€šè¿‡ <code>SendMsg</code> å’Œ <code>RecvMsg</code> æ–¹æ³•æ¥å®Œæˆï¼Œè¿™äº›æ–¹æ³•åŒæ ·ä½äº <code>stream.go</code> æ–‡ä»¶ä¸­ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//(cs *clientStream) SendMsg(m any) (err error)å‡½æ•°gRPC-Go å®¢æˆ·ç«¯ç”¨äºå‘é€æ¶ˆæ¯çš„æ ¸å¿ƒæ–¹æ³•ã€‚å®ƒæ‰§è¡Œäº†ä»æ¶ˆæ¯å‡†å¤‡åˆ°å®é™…å‘é€çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œå¹¶å¤„ç†é”™è¯¯å’Œé‡è¯•é€»è¾‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">clientStream</span><span class="p">)</span> <span class="nf">SendMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//é”™è¯¯å¤„ç†çš„ defer é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cs</span><span class="p">.</span><span class="nf">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">sentLast</span> <span class="p">{</span>   <span class="c1">//é˜²æ­¢é‡å¤è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Internal</span><span class="p">,</span> <span class="s">&#34;SendMsg called after CloseSend&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ClientStreams</span> <span class="p">{</span>   <span class="c1">//å¤„ç†éå®¢æˆ·ç«¯æµå¼çš„ RPC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cs</span><span class="p">.</span><span class="nx">sentLast</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// load hdr, payload, data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">hdr</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">prepareMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">codec</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">cp</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">comp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">//å‡†å¤‡æ¶ˆæ¯æ•°æ®ï¼Œæ¯”å¦‚ç¼–ç ä»€ä¹ˆçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// TODO(dfawley): should we be checking len(data) instead?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">&gt;</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxSendMessageSize</span> <span class="p">{</span>  <span class="c1">//æ£€æŸ¥æ¶ˆæ¯å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">ResourceExhausted</span><span class="p">,</span> <span class="s">&#34;trying to send message larger than max (%d vs. %d)&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxSendMessageSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">op</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>   <span class="c1">//æ¶ˆæ¯å‘é€é€»è¾‘å’Œé‡è¯•æœºåˆ¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nf">sendMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">withRetry</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">bufferForRetryLocked</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">hdr</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span> <span class="nx">op</span><span class="p">)</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">//äºŒè¿›åˆ¶æ—¥å¿—è®°å½•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cm</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ClientMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">OnClientSide</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Message</span><span class="p">:</span>      <span class="nx">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//func (cs *clientStream) RecvMsg(m any) error æ˜¯ gRPC-Go å®¢æˆ·ç«¯ç”¨äºæ¥æ”¶æœåŠ¡å™¨å“åº”æ¶ˆæ¯çš„æ ¸å¿ƒæ–¹æ³•ã€‚è¿™ä¸ªå‡½æ•°åœ¨å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡å™¨çš„å“åº”æ—¶æ‰§è¡Œï¼Œå¹¶åŒ…æ‹¬äº†é”™è¯¯å¤„ç†ã€é‡è¯•æœºåˆ¶ã€ä»¥åŠæ—¥å¿—è®°å½•ç­‰åŠŸèƒ½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">clientStream</span><span class="p">)</span> <span class="nf">RecvMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//äºŒè¿›åˆ¶æ—¥å¿—è®°å½•åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">serverHeaderBinlogged</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="c1">// Call Header() to binary log header if it&#39;s not already logged.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cs</span><span class="p">.</span><span class="nf">Header</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æ¥æ”¶ä¿¡æ¯çš„åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">recvInfo</span> <span class="o">*</span><span class="nx">payloadInfo</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">recvInfo</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">payloadInfo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æ¶ˆæ¯æ¥æ”¶é€»è¾‘åŠé‡è¯•æœºåˆ¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">withRetry</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nf">recvMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">recvInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">commitAttemptLocked</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//äºŒè¿›åˆ¶æ—¥å¿—è®°å½•å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sm</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ServerMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">OnClientSide</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Message</span><span class="p">:</span>      <span class="nx">recvInfo</span><span class="p">.</span><span class="nx">uncompressedBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç»“æŸæµæˆ–å¤„ç†é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ServerStreams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// err != nil or non-server-streaming indicates end of stream.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cs</span><span class="p">.</span><span class="nf">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„<code>SendMsg</code> å’Œ <code>RecvMsg</code> æ–¹æ³•å®é™…è°ƒç”¨äº†æ›´åº•å±‚çš„<code>sendMsg</code>å’Œ<code>recvMsg</code>ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//sendMsg å‡½æ•°çš„ä¸»è¦èŒè´£æ˜¯å°†ç¼–ç åçš„æ¶ˆæ¯é€šè¿‡åº•å±‚ä¼ è¾“å±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œå¹¶å¤„ç†å‘é€è¿‡ç¨‹ä¸­çš„é”™è¯¯å’Œç»Ÿè®¡ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="nf">sendMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">,</span> <span class="nx">payld</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cs</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cs</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">payload</span><span class="p">{</span><span class="nx">sent</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">msg</span><span class="p">:</span> <span class="nx">m</span><span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">,</span> <span class="nx">payld</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">transport</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Last</span><span class="p">:</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ClientStreams</span><span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ClientStreams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// For non-client-streaming RPCs, we return nil instead of EOF on error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// because the generated code requires it.  finish is not called; RecvMsg()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// will call it with the stream&#39;s status independently.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">statsHandlers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nf">outPayload</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">payld</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">IsOn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">IncrMsgSent</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//recvMsg å‡½æ•°çš„ä¸»è¦èŒè´£æ˜¯ä»æœåŠ¡å™¨æ¥æ”¶æ¶ˆæ¯å¹¶è§£ç ï¼ŒåŒæ—¶å¤„ç†æ¥æ”¶è¿‡ç¨‹ä¸­çš„é”™è¯¯ã€è§£å‹ç¼©å’Œç»Ÿè®¡ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="nf">recvMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">payInfo</span> <span class="o">*</span><span class="nx">payloadInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cs</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cs</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">statsHandlers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">payInfo</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">payInfo</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">payloadInfo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">decompSet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Block until we receive headers containing received message encoding.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">ct</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">();</span> <span class="nx">ct</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">ct</span> <span class="o">!=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">Identity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">ct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// No configured decompressor, or it does not match the incoming
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// message encoding; attempt to find a registered compressor that does.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">a</span><span class="p">.</span><span class="nx">dc</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">				<span class="nx">a</span><span class="p">.</span><span class="nx">decomp</span> <span class="p">=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nf">GetCompressor</span><span class="p">(</span><span class="nx">ct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// No compression is used; disable our decompressor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">a</span><span class="p">.</span><span class="nx">dc</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Only initialize this state once per stream.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">a</span><span class="p">.</span><span class="nx">decompSet</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nf">recv</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">codec</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxReceiveMessageSize</span><span class="p">,</span> <span class="nx">payInfo</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">decomp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">statusErr</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">statusErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">statusErr</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="c1">// indicates successful end of stream.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">toRPCErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">payload</span><span class="p">{</span><span class="nx">sent</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">msg</span><span class="p">:</span> <span class="nx">m</span><span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">statsHandlers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">InPayload</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Client</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">RecvTime</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Payload</span><span class="p">:</span>  <span class="nx">m</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// TODO truncate large payload.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">Data</span><span class="p">:</span>             <span class="nx">payInfo</span><span class="p">.</span><span class="nx">uncompressedBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">WireLength</span><span class="p">:</span>       <span class="nx">payInfo</span><span class="p">.</span><span class="nx">compressedLength</span> <span class="o">+</span> <span class="nx">headerLen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">CompressedLength</span><span class="p">:</span> <span class="nx">payInfo</span><span class="p">.</span><span class="nx">compressedLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Length</span><span class="p">:</span>           <span class="nb">len</span><span class="p">(</span><span class="nx">payInfo</span><span class="p">.</span><span class="nx">uncompressedBytes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">IsOn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">IncrMsgRecv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ServerStreams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Subsequent messages should be received by subsequent RecvMsg calls.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Special handling for non-server-stream rpcs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This recv expects EOF or errors, so we don&#39;t collect inPayload.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nf">recv</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">codec</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxReceiveMessageSize</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">decomp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">toRPCErr</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;grpc: client streaming protocol violation: get &lt;nil&gt;, want &lt;EOF&gt;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Err</span><span class="p">()</span> <span class="c1">// non-server streaming Recv returns nil on success
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">toRPCErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æœåŠ¡å™¨ç«¯çš„å¤„ç†"><strong>æœåŠ¡å™¨ç«¯çš„å¤„ç†</strong>
</h5><p>åœ¨æœåŠ¡å™¨ç«¯ï¼ŒRPC è°ƒç”¨çš„å¤„ç†é€šè¿‡ <code>handleStream</code> å‡½æ•°è¿›è¡Œç®¡ç†ã€‚è¿™ä¸ªå‡½æ•°ä½äº <code>server.go</code> æ–‡ä»¶ä¸­ï¼Œ<code>handleStream</code> æ–¹æ³•å¤„ç†ä¼ å…¥çš„æµï¼Œè§£æå®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„æœåŠ¡æ–¹æ³•æ¥ç”Ÿæˆå“åº”ã€‚</p>
<p><strong>ä¸Šä¸‹æ–‡åˆå§‹åŒ–å’Œè¿½è¸ªä¿¡æ¯</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">ctx</span> <span class="p">=</span> <span class="nf">contextWithServer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">ti</span> <span class="o">*</span><span class="nx">traceInfo</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">EnableTracing</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tr</span> <span class="o">:=</span> <span class="nf">newTrace</span><span class="p">(</span><span class="s">&#34;grpc.Recv.&#34;</span><span class="o">+</span><span class="nf">methodFamily</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">()),</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nf">newTraceContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">traceInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tr</span><span class="p">:</span> <span class="nx">tr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">firstLine</span><span class="p">:</span> <span class="nx">firstLine</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">client</span><span class="p">:</span>     <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">remoteAddr</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Peer</span><span class="p">().</span><span class="nx">Addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">dl</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Deadline</span><span class="p">();</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">firstLine</span><span class="p">.</span><span class="nx">deadline</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">dl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ä¸Šä¸‹æ–‡å‡†å¤‡</strong>ï¼šä»æµä¸­æå–å‡ºä¸Šä¸‹æ–‡ï¼Œå¹¶å°†æœåŠ¡å™¨ç›¸å…³çš„ä¿¡æ¯æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚</li>
<li><strong>è¿½è¸ªä¿¡æ¯</strong>ï¼šå¦‚æœå¯ç”¨äº†è¿½è¸ªï¼ˆ<code>EnableTracing</code>ï¼‰ï¼Œå‡½æ•°ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿½è¸ªå¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚è¿½è¸ªå¯¹è±¡ç”¨äºè®°å½•è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹å’Œç›¸å…³çš„å…ƒæ•°æ®ï¼ˆå¦‚å®¢æˆ·ç«¯åœ°å€ã€æˆªæ­¢æ—¶é—´ç­‰ï¼‰ã€‚</li>
</ul>
<p><strong>è§£ææ–¹æ³•åç§°</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">sm</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">sm</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">sm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sm</span> <span class="p">=</span> <span class="nx">sm</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">pos</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">LastIndex</span><span class="p">(</span><span class="nx">sm</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// å¤„ç†é”™è¯¯çš„è¯·æ±‚æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fmtStringer</span><span class="p">{</span><span class="s">&#34;Malformed method name %q&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">any</span><span class="p">{</span><span class="nx">sm</span><span class="p">}},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">errDesc</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;malformed method name: %q&#34;</span><span class="p">,</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="nx">errDesc</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fmtStringer</span><span class="p">{</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">any</span><span class="p">{</span><span class="nx">err</span><span class="p">}},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">channelz</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;grpc: Server.handleStream failed to write status: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">service</span> <span class="o">:=</span> <span class="nx">sm</span><span class="p">[:</span><span class="nx">pos</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">method</span> <span class="o">:=</span> <span class="nx">sm</span><span class="p">[</span><span class="nx">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>æ–¹æ³•åç§°è§£æ</strong>ï¼šä»è¯·æ±‚çš„ <code>Method</code> ä¸­è§£æå‡ºæœåŠ¡åå’Œæ–¹æ³•åã€‚å¦‚æœè§£æå¤±è´¥ï¼ˆä¾‹å¦‚æ–¹æ³•åç§°æ ¼å¼ä¸æ­£ç¡®ï¼‰ï¼Œåˆ™ç«‹å³è¿”å›ä¸€ä¸ª <code>Unimplemented</code> é”™è¯¯çŠ¶æ€ã€‚</li>
</ul>
<p><strong>å¤„ç†å…ƒæ•°æ®å’Œç»Ÿè®¡ä¿¡æ¯</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">md</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">FromIncomingContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statsHandlers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">sh</span><span class="p">.</span><span class="nf">TagRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">RPCTagInfo</span><span class="p">{</span><span class="nx">FullMethodName</span><span class="p">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">()})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">InHeader</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span>  <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">RemoteAddr</span><span class="p">:</span>  <span class="nx">t</span><span class="p">.</span><span class="nf">Peer</span><span class="p">().</span><span class="nx">Addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LocalAddr</span><span class="p">:</span>   <span class="nx">t</span><span class="p">.</span><span class="nf">Peer</span><span class="p">().</span><span class="nx">LocalAddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Compression</span><span class="p">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">WireLength</span><span class="p">:</span>  <span class="nx">stream</span><span class="p">.</span><span class="nf">HeaderWireLength</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Header</span><span class="p">:</span>      <span class="nx">md</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">stream</span><span class="p">.</span><span class="nf">SetContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>å…ƒæ•°æ®æå–</strong>ï¼šä»ä¸Šä¸‹æ–‡ä¸­æå–å…ƒæ•°æ®ï¼ˆ<code>metadata</code>ï¼‰ï¼Œä¾‹å¦‚è¯·æ±‚å¤´ä¸­çš„ä¿¡æ¯ã€‚</li>
<li><strong>ç»Ÿè®¡å¤„ç†</strong>ï¼šéå†æ‰€æœ‰å·²é…ç½®çš„ç»Ÿè®¡å¤„ç†å™¨ï¼Œå¹¶è°ƒç”¨å®ƒä»¬æ¥è®°å½•æ­¤æ¬¡ RPC è°ƒç”¨çš„ç»Ÿè®¡æ•°æ®ã€‚</li>
</ul>
<p><strong>æ ¹æ®æ–¹æ³•åç§°é€‰æ‹©å¤„ç†å™¨</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">srv</span><span class="p">,</span> <span class="nx">knownService</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">services</span><span class="p">[</span><span class="nx">service</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">knownService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">methods</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">processUnaryRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">srv</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">ti</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">sd</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">streams</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">processStreamingRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">srv</span><span class="p">,</span> <span class="nx">sd</span><span class="p">,</span> <span class="nx">ti</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>æœåŠ¡å’Œæ–¹æ³•æŸ¥æ‰¾</strong>ï¼šæ ¹æ®è§£æå‡ºçš„æœåŠ¡åå’Œæ–¹æ³•åï¼Œåœ¨æ³¨å†Œçš„æœåŠ¡ä¸­æŸ¥æ‰¾å¯¹åº”çš„æœåŠ¡å¯¹è±¡å’Œæ–¹æ³•ã€‚</li>
<li><strong>å¤„ç†è¯·æ±‚</strong>ï¼šå¦‚æœæ‰¾åˆ°å¯¹åº”çš„å¤„ç†å™¨ï¼Œåˆ™è°ƒç”¨ <code>processUnaryRPC</code> æˆ– <code>processStreamingRPC</code> æ¥å¤„ç†è¯·æ±‚ã€‚è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«ç”¨äºå¤„ç†å•å‘ RPC å’Œæµå¼ RPCã€‚</li>
</ul>
<p><strong>å¤„ç†æœªçŸ¥æœåŠ¡æˆ–æ–¹æ³•</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">unknownDesc</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">unknownStreamDesc</span><span class="p">;</span> <span class="nx">unknownDesc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">processStreamingRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">unknownDesc</span><span class="p">,</span> <span class="nx">ti</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">errDesc</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">knownService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">errDesc</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unknown service %v&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">errDesc</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unknown method %v for service %v&#34;</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyPrintf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="nx">errDesc</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fmtStringer</span><span class="p">{</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">any</span><span class="p">{</span><span class="nx">err</span><span class="p">}},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">channelz</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;grpc: Server.handleStream failed to write status: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>å¤„ç†æœªçŸ¥æœåŠ¡æˆ–æ–¹æ³•</strong>ï¼šå¦‚æœæœåŠ¡æˆ–æ–¹æ³•æœªæ‰¾åˆ°ï¼Œå‡½æ•°ä¼šè¿”å›ä¸€ä¸ª <code>Unimplemented</code> çŠ¶æ€ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡æˆ–æ–¹æ³•ä¸å­˜åœ¨ã€‚å¦‚æœé…ç½®äº† <code>unknownStreamDesc</code>ï¼Œå°†è°ƒç”¨å…¶å¤„ç†å™¨æ¥å¤„ç†æœªçŸ¥çš„è¯·æ±‚ï¼Œå¦åˆ™ç›´æ¥è¿”å›é”™è¯¯ã€‚</li>
</ul>
<p>æˆ‘ä»¬è¿™é‡Œç»§ç»­å¾€ä¸‹åˆ†æ<code>processStreamingRPC</code>å‡½æ•°</p>
<blockquote>
<p><code>processStreamingRPC</code> æ˜¯ gRPC-Go æœåŠ¡å™¨ç«¯å¤„ç†æµå¼ RPC è¯·æ±‚çš„å…³é”®å‡½æ•°ã€‚å®ƒè´Ÿè´£å¤„ç†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„åŒå‘æˆ–å•å‘æµå¼ RPC è°ƒç”¨ã€‚è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„ä¸»è¦ä»»åŠ¡åŒ…æ‹¬ï¼šåˆå§‹åŒ–ä¸Šä¸‹æ–‡å’Œæµã€å¤„ç†å‹ç¼©å’Œè§£å‹ç¼©ã€è°ƒç”¨å®é™…çš„ RPC æ–¹æ³•å¤„ç†å™¨ï¼Œå¹¶åœ¨å®Œæˆåè®°å½•æ—¥å¿—å’ŒçŠ¶æ€ã€‚</p>
</blockquote>
<p><strong>1ã€å‡½æ•°ç»“æ„æ¦‚è¿°</strong></p>
<p><code>processStreamingRPC</code> å¤„ç†æµå¼ RPC çš„æ ¸å¿ƒé€»è¾‘å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p>
<ol>
<li>åˆå§‹åŒ–ä¸Šä¸‹æ–‡å’Œè¿½è¸ªä¿¡æ¯ã€‚</li>
<li>åˆå§‹åŒ–æµï¼ˆ<code>serverStream</code>ï¼‰å¯¹è±¡ã€‚</li>
<li>å¤„ç†å‹ç¼©å’Œè§£å‹ç¼©é€»è¾‘ã€‚</li>
<li>è°ƒç”¨å®é™…çš„ RPC å¤„ç†å™¨ã€‚</li>
<li>å¤„ç† RPC è°ƒç”¨åçš„æ¸…ç†å’Œæ—¥å¿—è®°å½•ã€‚</li>
</ol>
<p><strong>2ã€å…³é”®æ­¥éª¤è§£æ</strong></p>
<p><strong>åˆå§‹åŒ–ä¸Šä¸‹æ–‡å’Œè¿½è¸ªä¿¡æ¯</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">IsOn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">incrCallsStarted</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">shs</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statsHandlers</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">statsBegin</span> <span class="o">*</span><span class="nx">stats</span><span class="p">.</span><span class="nx">Begin</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">shs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">beginTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">statsBegin</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">Begin</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">BeginTime</span><span class="p">:</span>      <span class="nx">beginTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsClientStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ClientStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsServerStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ServerStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">shs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">statsBegin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">ctx</span> <span class="p">=</span> <span class="nf">NewContextWithServerTransportStream</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">stream</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>è¿½è¸ªå’Œç»Ÿè®¡ä¿¡æ¯</strong>ï¼šå¦‚æœå¯ç”¨äº† <code>channelz</code>ï¼ŒæœåŠ¡å™¨ä¼šå¢åŠ å¯åŠ¨çš„ RPC è°ƒç”¨è®¡æ•°ã€‚ç„¶åï¼Œå¦‚æœæœ‰é…ç½®ç»Ÿè®¡å¤„ç†å™¨ï¼Œä¼šè®°å½• RPC è°ƒç”¨çš„å¼€å§‹æ—¶é—´å’Œå…¶ä»–å…ƒæ•°æ®ã€‚</li>
<li><strong>ä¸Šä¸‹æ–‡åˆå§‹åŒ–</strong>ï¼šé€šè¿‡ <code>NewContextWithServerTransportStream</code> å‡½æ•°å°†æµå¯¹è±¡åŠ å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œä¾¿äºåç»­å¤„ç†ã€‚</li>
</ul>
<p>åˆå§‹åŒ– <code>serverStream</code> å¯¹è±¡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ss := &amp;serverStream{
</span></span><span class="line"><span class="cl">	ctx:                   ctx,
</span></span><span class="line"><span class="cl">	t:                     t,
</span></span><span class="line"><span class="cl">	s:                     stream,
</span></span><span class="line"><span class="cl">	p:                     &amp;parser{r: stream, recvBufferPool: s.opts.recvBufferPool},
</span></span><span class="line"><span class="cl">	codec:                 s.getCodec(stream.ContentSubtype()),
</span></span><span class="line"><span class="cl">	maxReceiveMessageSize: s.opts.maxReceiveMessageSize,
</span></span><span class="line"><span class="cl">	maxSendMessageSize:    s.opts.maxSendMessageSize,
</span></span><span class="line"><span class="cl">	trInfo:                trInfo,
</span></span><span class="line"><span class="cl">	statsHandler:          shs,
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>åˆ›å»º <code>serverStream</code></strong>ï¼š<code>serverStream</code> æ˜¯ gRPC-Go ç”¨äºå¤„ç†æµå¼ RPC è¯·æ±‚çš„æ ¸å¿ƒå¯¹è±¡ã€‚å®ƒåŒ…å«äº†ä¸å½“å‰æµç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¦‚ä¸Šä¸‹æ–‡ã€ä¼ è¾“å±‚ã€ç¼–è§£ç å™¨ç­‰ã€‚</li>
</ul>
<p><strong>å¤„ç†å‹ç¼©å’Œè§£å‹ç¼©é€»è¾‘</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rc</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">();</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dc</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">rc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">dc</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dc</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">Identity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">decomp</span> <span class="p">=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nf">GetCompressor</span><span class="p">(</span><span class="nx">rc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">decomp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">st</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Newf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="s">&#34;grpc: Decompressor is not installed for grpc-encoding %q&#34;</span><span class="p">,</span> <span class="nx">rc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">cp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">cp</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">cp</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">sendCompressorName</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">cp</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">rc</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">();</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">Identity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">comp</span> <span class="p">=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nf">GetCompressor</span><span class="p">(</span><span class="nx">rc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">comp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">sendCompressorName</span> <span class="p">=</span> <span class="nx">rc</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>è§£å‹ç¼©è®¾ç½®</strong>ï¼šæ£€æŸ¥å®¢æˆ·ç«¯è¯·æ±‚ä¸­ä½¿ç”¨çš„å‹ç¼©æ–¹æ³•ï¼Œå¦‚æœæœåŠ¡å™¨ç«¯é…ç½®äº†å¯¹åº”çš„è§£å‹ç¼©å™¨ï¼Œåˆ™è®¾ç½®åœ¨ <code>serverStream</code> å¯¹è±¡ä¸­ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„è§£å‹ç¼©å™¨ï¼Œåˆ™è¿”å› <code>Unimplemented</code> é”™è¯¯ã€‚</li>
<li><strong>å‹ç¼©è®¾ç½®</strong>ï¼šå¦‚æœæœåŠ¡å™¨é…ç½®äº†å‹ç¼©å™¨ï¼Œæˆ–è€…å®¢æˆ·ç«¯è¯·æ±‚ä¸­æŒ‡å®šäº†å‹ç¼©æ–¹æ³•ï¼ŒæœåŠ¡å™¨ä¼šå°è¯•ä½¿ç”¨ç›¸åŒçš„å‹ç¼©æ–¹æ³•å“åº”ã€‚</li>
</ul>
<p><strong>è°ƒç”¨å®é™…çš„ RPC å¤„ç†å™¨</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">appErr</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">server</span> <span class="nx">any</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">info</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">serviceImpl</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">streamInt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">appErr</span> <span class="p">=</span> <span class="nx">sd</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">ss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">StreamServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span>     <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsClientStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ClientStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsServerStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ServerStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">appErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nf">streamInt</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>å®é™…è°ƒç”¨</strong>ï¼šè¿™é‡Œæ ¹æ®æ˜¯å¦é…ç½®äº†æ‹¦æˆªå™¨ï¼ˆ<code>streamInt</code>ï¼‰æ¥å†³å®šå¦‚ä½•è°ƒç”¨å®é™…çš„ RPC å¤„ç†å™¨ï¼ˆ<code>Handler</code>ï¼‰ã€‚å¦‚æœæœ‰æ‹¦æˆªå™¨ï¼Œå¤„ç†å™¨ä¼šè¢«æ‹¦æˆªå™¨åŒ…è£…ï¼›å¦åˆ™ç›´æ¥è°ƒç”¨å¤„ç†å™¨ã€‚</li>
<li><strong><code>Handler</code> å‡½æ•°</strong>ï¼š<code>Handler</code> æ˜¯ç”¨æˆ·å®šä¹‰çš„å¤„ç†æµå¼ RPC è¯·æ±‚çš„å‡½æ•°ï¼Œå®ƒä¼šåœ¨æœåŠ¡å™¨ç«¯å¤„ç†ä»å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„æ•°æ®æµï¼Œå¹¶æ ¹æ®é€»è¾‘ç”Ÿæˆå“åº”ã€‚</li>
</ul>
<p><strong>å¤„ç† RPC è°ƒç”¨åçš„æ¸…ç†å’Œæ—¥å¿—è®°å½•</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">appErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">appStatus</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">FromError</span><span class="p">(</span><span class="nx">appErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">appStatus</span> <span class="p">=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">FromContextError</span><span class="p">(</span><span class="nx">appErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">appErr</span> <span class="p">=</span> <span class="nx">appStatus</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="nf">stringer</span><span class="p">(</span><span class="nx">appStatus</span><span class="p">.</span><span class="nf">Message</span><span class="p">()),</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">st</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ServerTrailer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Trailer</span><span class="p">:</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Trailer</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Err</span><span class="p">:</span>     <span class="nx">appErr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">appStatus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">appErr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="nf">stringer</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">),</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">st</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ServerTrailer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Trailer</span><span class="p">:</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Trailer</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Err</span><span class="p">:</span>     <span class="nx">appErr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">statusOK</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå¦‚æœå¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œå‡½æ•°ä¼šå°†é”™è¯¯è½¬æ¢ä¸º gRPC çŠ¶æ€ç å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li><strong>æ—¥å¿—å’Œè¿½è¸ª</strong>ï¼šè®°å½•å¤„ç†è¿‡ç¨‹ä¸­çš„æ—¥å¿—å’Œè¿½è¸ªä¿¡æ¯ï¼ˆå¦‚é”™è¯¯ä¿¡æ¯ã€å“åº”çŠ¶æ€ç­‰ï¼‰ï¼Œç¡®ä¿åœ¨è°ƒè¯•æˆ–ç›‘æ§æ—¶æœ‰å……åˆ†çš„ä¸Šä¸‹æ–‡ã€‚</li>
<li><strong>è¿”å›çŠ¶æ€</strong>ï¼šå‡½æ•°æœ€åä¼šé€šè¿‡ <code>WriteStatus</code> å°†å¤„ç†ç»“æœçš„çŠ¶æ€ç å†™å›å®¢æˆ·ç«¯ã€‚</li>
</ul>
<p><strong>æ¥ç€åˆ†æ<code>sd.Handler</code> çš„æ¥æº</strong></p>
<p>åœ¨ gRPC ä¸­ï¼ŒæœåŠ¡å’Œæ–¹æ³•çš„å®šä¹‰é€šå¸¸æ˜¯åœ¨ <code>.proto</code> æ–‡ä»¶ä¸­å®šä¹‰çš„ï¼Œä¹‹åé€šè¿‡ gRPC ç¼–è¯‘å™¨ç”Ÿæˆç›¸åº”çš„ Go ä»£ç ã€‚åœ¨ç”Ÿæˆçš„ä»£ç ä¸­ï¼Œæ¯ä¸ªæœåŠ¡æ–¹æ³•éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„ <code>Handler</code> å‡½æ•°ã€‚è¿™ä¸ª <code>Handler</code> å‡½æ•°ä¼šåœ¨æœåŠ¡æ³¨å†Œæ—¶è¢«ä¼ é€’ç»™ gRPC æœåŠ¡å™¨ã€‚ï¼ˆ<strong>æ‰€ä»¥containerdä¸­çš„æœåŠ¡éƒ½æ˜¯é€šè¿‡handleræ¥å¤„ç†çš„ï¼Œè€Œéæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼ŒåŒæ—¶è¿™é‡Œä¸å‰é¢å½¢æˆäº†é—­ç¯ï¼Œåœ¨containerdçš„å¯åŠ¨ä¸­æœ‰æ¶‰åŠåˆ°æœåŠ¡æ³¨å†Œ</strong>ï¼‰</p>
<ul>
<li><strong><code>sd</code> å¯¹è±¡</strong>ï¼š<code>sd</code> æ˜¯ <code>*StreamDesc</code> ç±»å‹çš„å¯¹è±¡ï¼Œæè¿°äº†æµå¼ RPC æ–¹æ³•çš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬æ˜¯å¦æ˜¯å®¢æˆ·ç«¯æµã€æ˜¯å¦æ˜¯æœåŠ¡å™¨ç«¯æµï¼Œä»¥åŠå¤„ç†è¯¥ RPC è°ƒç”¨çš„ <code>Handler</code> å‡½æ•°ã€‚</li>
<li><strong><code>Handler</code> å­—æ®µ</strong>ï¼š<code>sd.Handler</code> æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œç”¨äºå¤„ç†ç‰¹å®šçš„æµå¼ RPC è¯·æ±‚ã€‚è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æˆ·åœ¨æœåŠ¡æ³¨å†Œæ—¶æä¾›çš„ï¼Œç”¨äºæ‰§è¡Œå®é™…çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
</ul>
<h2 id="containerdä¸containerd-shimé€šä¿¡æœºåˆ¶">Containerdä¸Containerd-shimé€šä¿¡æœºåˆ¶
</h2><p><code>containerd-shim</code> å’Œ <code>containerd</code> ä¹‹é—´çš„é€šä¿¡æ˜¯å®¹å™¨è¿è¡Œæ—¶çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œç¡®ä¿å®¹å™¨çš„åˆ›å»ºã€ç®¡ç†å’Œåˆ é™¤ç­‰æ“ä½œèƒ½å¤Ÿé¡ºåˆ©è¿›è¡Œã€‚å®ƒä»¬ä¹‹é—´çš„é€šä¿¡ä¸»è¦é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œï¼š</p>
<h3 id="ttrpc">ttRPC
</h3><p><code>containerd</code> å’Œ <code>containerd-shim</code> ä¹‹é—´çš„é€šä¿¡ä¸»è¦é€šè¿‡ä¸€ç§ç§°ä¸º <code>ttRPC</code> çš„è½»é‡çº§ RPC æ¡†æ¶è¿›è¡Œã€‚<code>ttRPC</code> æ˜¯ <code>containerd</code> é¡¹ç›®ä¸­å¼•å…¥çš„ï¼Œä¸“é—¨è®¾è®¡ç”¨äºé«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ï¼Œç‰¹åˆ«æ˜¯åœ¨åŒä¸€ä¸»æœºä¸Šè¿è¡Œçš„è¿›ç¨‹ä¹‹é—´ã€‚</p>
<ul>
<li>ttRPC:
<ul>
<li><code>ttRPC</code> æ˜¯ <code>containerd</code> å›¢é˜Ÿå¼€å‘çš„ä¸€ç§ä¼˜åŒ–åçš„ RPC æ¡†æ¶ï¼Œæ—¨åœ¨æä¾›æ¯” gRPC æ›´ä½çš„å»¶è¿Ÿå’Œæ›´å°çš„å¼€é”€ã€‚å®ƒç›´æ¥é€šè¿‡ Unix åŸŸå¥—æ¥å­—è¿›è¡Œé€šä¿¡ï¼Œæ²¡æœ‰ HTTP/2 çš„å¼€é”€ã€‚</li>
<li><code>containerd</code> ä½¿ç”¨ <code>ttRPC</code> æ¥å‘ <code>containerd-shim</code> å‘é€æ§åˆ¶å‘½ä»¤ï¼Œå¦‚å¯åŠ¨ã€åœæ­¢ã€æŒ‚èµ·å’Œåˆ é™¤å®¹å™¨ã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨<code>containerd</code>ä¸­æ˜¯è¿™æ ·å¯åŠ¨çš„</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main ttrpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tl</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTTRPC</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="unix-åŸŸå¥—æ¥å­—">Unix åŸŸå¥—æ¥å­—
</h3><p><code>containerd</code> å’Œ <code>containerd-shim</code> ä¹‹é—´çš„é€šä¿¡é€šå¸¸é€šè¿‡ Unix åŸŸå¥—æ¥å­—è¿›è¡Œã€‚è¿™ç§é€šä¿¡æ–¹å¼éå¸¸é€‚åˆåŒä¸€ä¸»æœºä¸Šçš„è¿›ç¨‹é—´é€šä¿¡ï¼Œå…·æœ‰ä½å»¶è¿Ÿå’Œé«˜æ•ˆçš„ç‰¹ç‚¹ã€‚</p>
<ul>
<li>Unix åŸŸå¥—æ¥å­—:
<ul>
<li>åœ¨å¯åŠ¨æ—¶ï¼Œ<code>containerd-shim</code> è¿›ç¨‹ä¼šé€šè¿‡ä¸€ä¸ªä¸“ç”¨çš„ Unix åŸŸå¥—æ¥å­—ä¸ <code>containerd</code> å»ºç«‹é€šä¿¡ã€‚</li>
<li>è¿™ä¸ªå¥—æ¥å­—é€šå¸¸ä½äº <code>/run/containerd/</code> æˆ– <code>/run/containerd/io.containerd.runtime.v2.linux/</code> ç›®å½•ä¸‹ï¼Œå¹¶å¸¦æœ‰å®¹å™¨ ID ç›¸å…³çš„å‘½åã€‚</li>
</ul>
</li>
</ul>
<h3 id="å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†">å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
</h3><p><code>containerd</code> é€šè¿‡ <code>ttRPC</code> å’Œ Unix åŸŸå¥—æ¥å­—ä¸ <code>containerd-shim</code> è¿›è¡Œé€šä¿¡ï¼Œä»¥ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<ul>
<li>å®¹å™¨åˆ›å»º:
<ul>
<li>å½“ <code>containerd</code> æ”¶åˆ°åˆ›å»ºå®¹å™¨çš„è¯·æ±‚æ—¶ï¼Œå®ƒä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ <code>containerd-shim</code> è¿›ç¨‹ã€‚è¿™ä¸ªè¿›ç¨‹è´Ÿè´£åœ¨ <code>runc</code> æˆ–å…¶ä»– OCI å…¼å®¹çš„è¿è¡Œæ—¶ä¸Šè¿è¡Œå®¹å™¨ã€‚</li>
</ul>
</li>
<li>å®¹å™¨ç®¡ç†:
<ul>
<li><code>containerd-shim</code> è¿›ç¨‹è´Ÿè´£å¤„ç†å®¹å™¨çš„æ ‡å‡†è¾“å…¥/è¾“å‡ºæµã€ä¿¡å·ç®¡ç†ä»¥åŠå…¶ä»–ä¸å®¹å™¨ç›¸å…³çš„æ“ä½œã€‚<code>containerd</code> é€šè¿‡ <code>ttRPC</code> å‘ <code>containerd-shim</code> å‘é€å‘½ä»¤ï¼ˆå¦‚å¯åŠ¨ã€åœæ­¢å®¹å™¨ï¼‰ã€‚</li>
</ul>
</li>
<li>å®¹å™¨åˆ é™¤:
<ul>
<li>å½“å®¹å™¨é€€å‡ºæ—¶ï¼Œ<code>containerd-shim</code> è¿›ç¨‹å°†ç»§ç»­è¿è¡Œï¼Œç›´åˆ° <code>containerd</code> é€šè¿‡ <code>ttRPC</code> å‘½ä»¤å‘ŠçŸ¥ <code>containerd-shim</code> è¿›ç¨‹å¯ä»¥å®‰å…¨é€€å‡ºã€‚è¿™ç¡®ä¿äº†å³ä½¿ <code>containerd</code> å´©æºƒï¼Œå®¹å™¨è¿›ç¨‹ä¹Ÿä¸ä¼šè¢«ç»ˆæ­¢ã€‚</li>
</ul>
</li>
</ul>
<h3 id="å®¹å™¨ä¸å®ˆæŠ¤è¿›ç¨‹çš„åˆ†ç¦»">å®¹å™¨ä¸å®ˆæŠ¤è¿›ç¨‹çš„åˆ†ç¦»
</h3><p><code>containerd-shim</code> çš„å­˜åœ¨è¿˜ä½¿å¾—å®¹å™¨ä¸ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹åˆ†ç¦»ã€‚è¿™æ„å‘³ç€ï¼š</p>
<ul>
<li>ç‹¬ç«‹æ€§:
<ul>
<li>å³ä½¿ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹å´©æºƒæˆ–é‡å¯ï¼Œå·²ç»è¿è¡Œçš„å®¹å™¨ä»ç„¶èƒ½å¤Ÿç»§ç»­è¿è¡Œï¼Œå› ä¸ºå®ƒä»¬ç”±ç‹¬ç«‹çš„ <code>containerd-shim</code> è¿›ç¨‹ç®¡ç†ã€‚</li>
</ul>
</li>
<li>å‡å°‘ä¾èµ–:
<ul>
<li>è¿™ç§æ¶æ„å‡å°‘äº†å¯¹å•ç‚¹æ•…éšœçš„ä¾èµ–ï¼Œå¢å¼ºäº†å®¹å™¨è¿è¡Œçš„ç¨³å®šæ€§ã€‚</li>
</ul>
</li>
</ul>
<h2 id="containerd-shimä¸containeré€šä¿¡æœºåˆ¶">Containerd-shimä¸Containeré€šä¿¡æœºåˆ¶
</h2><h3 id="é€šä¿¡æµç¨‹">é€šä¿¡æµç¨‹
</h3><p><code>containerd</code> é€šè¿‡ä¸€ä¸ª<code>runtime</code>æ¥å®ç°å¯¹å¤šä¸ªå®¹å™¨çš„æ§åˆ¶ï¼Œä¾‹å¦‚ createã€start å’Œ stopã€‚</p>
<p>é€šä¿¡æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ¥è‡ª <code>containerd</code> çš„åˆ›å»ºå®¹å™¨çš„å®¢æˆ·ç«¯è¯·æ±‚</li>
<li><code>containerd</code> è®¾ç½®å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶åˆ›å»ºå¿…è¦çš„é…ç½®ä¿¡æ¯</li>
<li><code>containerd</code> è°ƒç”¨ shimï¼ŒåŒ…æ‹¬å®¹å™¨é…ç½®ï¼Œè¿™ä¸ªå®¹å™¨é…ç½®å†³å®šæ˜¯å¯åŠ¨æ–°çš„å¥—æ¥å­—ä¾¦å¬å™¨ï¼ˆshimä¸container 1ï¼š1ï¼‰è¿˜æ˜¯ä½¿ç”¨ç°æœ‰çš„å¥—æ¥å­—ä¾¦å¬å™¨ï¼ˆ1ï¼šå¤šï¼‰
<ul>
<li>å¦‚æœä½¿ç”¨ç°æœ‰å¥—æ¥å­—ï¼Œåˆ™è¿”å›ç°æœ‰ socket çš„åœ°å€å¹¶é€€å‡º</li>
<li>å¦‚æœæ˜¯ä½¿ç”¨æ–°çš„å¥—æ¥å­—ï¼Œåˆ™shim
<ul>
<li>a. åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹æ¥ä¾¦å¬å¥—æ¥å­—ä¸­æ¥è‡ª <code>containerd</code> çš„ ttRPC å‘½ä»¤</li>
<li>b. å°†è¯¥å¥—æ¥å­—çš„åœ°å€è¿”å›ç»™ <code>containerd</code></li>
<li>c. é€€å‡º</li>
</ul>
</li>
</ul>
</li>
<li><code>containerd</code> å‘ shim å‘é€ä¸€ä¸ªå‘½ä»¤æ¥å¯åŠ¨å®¹å™¨</li>
<li><code>containerd</code> é€šè¿‡ API è°ƒç”¨<code>runtime</code>æ¥åˆ›å»º/å¯åŠ¨/åœæ­¢å®¹å™¨</li>
</ol>
<p>ä½†æ˜¯ï¼Œ<code>containerd</code> æœ¬èº«å®é™…ä¸Šå¹¶ä¸ç›´æ¥è°ƒç”¨è¿è¡Œæ—¶æ¥å¯åŠ¨å®¹å™¨ã€‚ç›¸åï¼Œå®ƒæœŸæœ›è°ƒç”¨è¿è¡Œæ—¶ï¼Œè¿™å°†æš´éœ²ä¸€ä¸ªå¥—æ¥å­— ï¼Œ åœ¨ç±» Unix ç³»ç»Ÿä¸Šæ˜¯ Unix åŸŸï¼Œåœ¨ Windows ä¸Šåä¸º pipeï¼Œ å¹¶é€šè¿‡è¯¥å¥—æ¥å­—ä¸Šçš„ ttRPC ä¾¦å¬å®¹å™¨å‘½ä»¤ã€‚</p>
<p>è¿è¡Œæ—¶æœ‰ä¸¤ç§å¸¸è§çš„æ¨¡å¼ï¼š</p>
<ul>
<li>ä¸€ä¸ªç”¨äºè¿è¡Œæ—¶çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®ƒæ—¢ä¾¦å¬å¥—æ¥å­—åˆåˆ›å»º/å¯åŠ¨/åœæ­¢å®¹å™¨</li>
<li>ä¸€ä¸ªåˆ†ç¦»çš„ Shim äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨äºä¾¦å¬å¥—æ¥å­—ï¼Œå¹¶è°ƒç”¨ä¸€ä¸ªå•ç‹¬çš„è¿è¡Œæ—¶å¼•æ“æ¥åˆ›å»º/å¯åŠ¨/åœæ­¢å®¹å™¨</li>
</ul>
<p>ä½¿ç”¨å•ç‹¬çš„â€œshim + engineâ€æ¨¡å¼æ˜¯å› ä¸ºå®ƒå¯ä»¥æ›´è½»æ¾åœ°é›†æˆå®ç°ç‰¹å®šè¿è¡Œæ—¶å¼•æ“è§„èŒƒï¼ˆå¦‚ <a class="link" href="https://github.com/opencontainers/runtime-spec"  target="_blank" rel="noopener"
    >OCI è¿è¡Œæ—¶è§„èŒƒ</a>ï¼‰çš„ä¸åŒè¿è¡Œæ—¶ã€‚ttRPC åè®®å¯ä»¥é€šè¿‡ä¸€ä¸ª<code>runtime shim</code>è¿›è¡Œå¤„ç†ï¼Œè€Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„è¿è¡Œæ—¶å¼•æ“å®ç°ï¼Œåªè¦å®ƒä»¬å®ç° OCI è¿è¡Œæ—¶è§„èŒƒå³å¯ã€‚</p>
<p>æœ€å¸¸ç”¨çš„è¿è¡Œæ—¶å¼•æ“æ˜¯ runcï¼Œå®ƒå®æ–½ OCI è¿è¡Œæ—¶è§„èŒƒã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶å¼•æ“ï¼Œå› æ­¤ <code>containerd</code> ä¸ä¼šç›´æ¥è°ƒç”¨å®ƒ;ç›¸åï¼Œå®ƒç”± Shim è°ƒç”¨ï¼Œè¯¥ Shim ä¾¦å¬å¥—æ¥å­—å¹¶è°ƒç”¨è¿è¡Œæ—¶å¼•æ“ã€‚</p>
<p>ä»¥ä¸‹åºåˆ—å›¾æ˜¾ç¤ºäº†æ‰§è¡Œ <code>ctr run</code> å‘½ä»¤æ—¶çš„æ“ä½œæµç¨‹ã€‚</p>
<p><img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240909175413949.png"
	width="1601"
	height="3024"
	srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240909175413949_hu14605848158616288619.png 480w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240909175413949_hu1695372946056556433.png 1024w"
	loading="lazy"
	
		alt="ctr runæ“ä½œæµç¨‹"
	
	
		class="gallery-image" 
		data-flex-grow="52"
		data-flex-basis="127px"
	
></p>
<h3 id="æºç è§£æ">æºç è§£æ
</h3><blockquote>
<p>shimå¯åŠ¨å…¥å£ï¼šcontainerd/cmd/containerd-shim-runc-v2/main.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewShimManager</span><span class="p">(</span><span class="s">&#34;io.containerd.runc.v2&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Runå‡½æ•°ï¼šcontainerd/pkg/shim/shim.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run initializes and runs a shim server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">manager</span> <span class="nx">Manager</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">BinaryOpts</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">config</span> <span class="nx">Config</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">WithLogger</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;runtime&#34;</span><span class="p">,</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">Name</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">manager</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;%s: %s&#34;</span><span class="p">,</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">Name</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>shimçœŸæ­£å¯åŠ¨ï¼š</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//shim å¯åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">manager</span> <span class="nx">Manager</span><span class="p">,</span> <span class="nx">config</span> <span class="nx">Config</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">setRuntime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Handle explicit actions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="nx">action</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="s">&#34;delete&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="s">&#34;start&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">StartOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Address</span><span class="p">:</span>      <span class="nx">addressFlag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">TTRPCAddress</span><span class="p">:</span> <span class="nx">ttrpcAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Debug</span><span class="p">:</span>        <span class="nx">debugFlag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ç¬¬ä¸€ä¸ªå¯åŠ¨çš„shimæ¥æ”¶çš„action å°±æ˜¯ startã€‚è¿™é‡Œå¯åŠ¨ç¬¬äºŒä¸ªshimã€‚addressæ˜¯æ ¹æ®nså’Œidå“ˆå¸Œå‡ºæ¥çš„ï¼Œä¼šä¼ é€’ç»™ç¬¬äºŒä¸ªshim,ç¬¬äºŒä¸ªshimä¼šä»¥è¿™ä¸ªåœ°å€èµ·ä¸€ä¸ªserverï¼ŒåŒæ—¶ä¼šé€šè¿‡stdoutå‘é€ç»™containerdï¼ˆå› ä¸ºcå¯åŠ¨çš„æœ¬è¿›ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥æ”¶åˆ°ï¼‰ï¼Œè¿™å°±æ˜¯containerdå’Œç¬¬äºŒä¸ªshimäº¤æµçš„.sockåœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">params</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to marshal bootstrap params to json: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">unaryInterceptor</span> <span class="o">:=</span> <span class="nf">chainUnaryServerInterceptors</span><span class="p">(</span><span class="nx">ttrpcUnaryInterceptors</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newServer</span><span class="p">(</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nf">WithUnaryServerInterceptor</span><span class="p">(</span><span class="nx">unaryInterceptor</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed creating server: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">srv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ttrpcServices</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to register service: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">signals</span><span class="p">,</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">Shutdown</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">shutdown</span><span class="p">.</span><span class="nx">ErrShutdown</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">cleanupSockets</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å¯åŠ¨ç¬¬äºŒä¸ªshimï¼š</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰æ„æ€åœ°æ–¹æ˜¯ç¬¬äºŒä¸ªshimå¦‚ä½•è·å–è‡ªèº«ä½œä¸ºserverçš„socketåœ°å€ã€‚ä»ä»£ç ä¸Šçœ‹æ˜¯é€šè¿‡æŠŠå¥—æ¥å­—è½¬æ¢æˆæ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™ç¬¬äºŒä¸ªshimï¼Œç„¶åç¬¬äºŒä¸ªshimå†è¿˜åŸæˆlistenerå®ç°çš„ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">StartOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">BootstrapParams</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">params</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">BootstrapParams</span>
</span></span><span class="line"><span class="cl">	<span class="nx">params</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">	<span class="nx">params</span><span class="p">.</span><span class="nx">Protocol</span> <span class="p">=</span> <span class="s">&#34;ttrpc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newCommand</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TTRPCAddress</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Debug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">grouping</span> <span class="o">:=</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">	<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readSpec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">sockets</span> <span class="p">[]</span><span class="o">*</span><span class="nx">shimSocket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newShimSocket</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">grouping</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">params</span><span class="p">.</span><span class="nx">Address</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">addr</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sockets</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">sockets</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span><span class="p">.</span><span class="nx">ExtraFiles</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">ExtraFiles</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">goruntime</span><span class="p">.</span><span class="nf">LockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;SCHED_CORE&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">schedcore</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">schedcore</span><span class="p">.</span><span class="nx">ProcessGroup</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;enable sched core support: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">goruntime</span><span class="p">.</span><span class="nf">UnlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯åŠ¨æˆåŠŸåï¼Œç¬¬ä¸€ä¸ª shim é€€å‡ºï¼Œæ‰§è¡Œæ¸…ç†æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cmd</span><span class="p">.</span><span class="nx">Process</span><span class="p">.</span><span class="nf">Kill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// make sure to wait after start
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">params</span><span class="p">.</span><span class="nx">Address</span> <span class="p">=</span> <span class="nx">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">addr</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>shim socketå¥—æ¥å­—åˆ›å»ºï¼š</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//shim socketåˆ›å»º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newShimSocket</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">debug</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">shimSocket</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">address</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">SocketAddress</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">debug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">socket</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">NewSocket</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">shimSocket</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">addr</span><span class="p">:</span> <span class="nx">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">:</span>    <span class="nx">socket</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">File</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">f</span> <span class="p">=</span> <span class="nx">f</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>SocketAddressï¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ä½äº<code>/run/containerd/s/&lt;å“ˆå¸Œå€¼&gt;</code>ä¸‹çš„Unix å¥—æ¥å­—åœ°å€</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// SocketAddress returns a socket address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">SocketAddress</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">socketPath</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">debug</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nf">NamespaceRequired</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">socketPath</span><span class="p">,</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">debug</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">path</span> <span class="p">=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s">&#34;debug&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span> <span class="o">:=</span> <span class="nx">sha256</span><span class="p">.</span><span class="nf">Sum256</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unix://%s/%x&#34;</span><span class="p">,</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">socketRoot</span><span class="p">,</span> <span class="s">&#34;s&#34;</span><span class="p">),</span> <span class="nx">d</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>NewSocketï¼šè®¾ç½®sockæ–‡ä»¶æƒé™</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//çœŸæ­£çš„socketåˆ›å»º
</span></span></span><span class="line"><span class="cl"><span class="c1">// NewSocket returns a new socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSocket</span><span class="p">(</span><span class="nx">address</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UnixListener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sock</span>       <span class="p">=</span> <span class="nf">socket</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">path</span>       <span class="p">=</span> <span class="nx">sock</span><span class="p">.</span><span class="nf">path</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">isAbstract</span> <span class="p">=</span> <span class="nx">sock</span><span class="p">.</span><span class="nf">isAbstract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">perm</span>       <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">FileMode</span><span class="p">(</span><span class="mo">0600</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Darwin needs +x to access socket, otherwise it&#39;ll fail with &#34;bind: permission denied&#34; when running as non-root.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;darwin&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">perm</span> <span class="p">=</span> <span class="mo">0700</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">isAbstract</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">perm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;mkdir failed for %s: %w&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">isAbstract</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">perm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">os</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sock</span><span class="p">.</span><span class="nf">path</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;chmod failed for %s: %w&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UnixListener</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>serveå‡½æ•°ï¼Œå¯åŠ¨ <code>ttrpc</code> æœåŠ¡ï¼Œå¹¶æä¾›RPCæœåŠ¡ï¼š</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// serve serves the ttrpc API over a unix socket in the current working directory
</span></span></span><span class="line"><span class="cl"><span class="c1">// and blocks until the context is canceled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="nx">signals</span> <span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="nx">shutdown</span> <span class="kd">func</span><span class="p">())</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dump</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">setupDumpStacks</span><span class="p">(</span><span class="nx">dump</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">path</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getwd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆ›å»º Unix å¥—æ¥å­—ç›‘å¬å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serveListener</span><span class="p">(</span><span class="nx">socketFlag</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯åŠ¨ ttrpc æœåŠ¡å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">net</span><span class="p">.</span><span class="nx">ErrClosed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;containerd-shim: ttrpc server failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nf">handleExitSignals</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">shutdown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">reap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">signals</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>åˆ›å»ºä¸€ä¸ªç”¨äºç›‘å¬ Unix å¥—æ¥å­—çš„ <code>net.Listener</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// serve()ä¼šæœ€ç»ˆè°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥å¯åŠ¨æœåŠ¡ç›‘å¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">serveListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fd</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//åˆ›å»ºç›‘å¬å™¨çš„é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span>   <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¤„ç†ç»§æ‰¿çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//os.NewFile(fd, &#34;socket&#34;) å°†æ–‡ä»¶æè¿°ç¬¦ fd å°è£…æˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//ä¸€ä¸ª*os.File å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ net.FileListener å°†å…¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//è½¬æ¢ä¸º net.Listenerï¼Œè¿™æ ·å¯ä»¥é€šè¿‡å¥—æ¥å­—è¿›è¡Œé€šä¿¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">FileListener</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">NewFile</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="s">&#34;socket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">path</span> <span class="p">=</span> <span class="s">&#34;[inherited from parent]&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">//åˆ›å»ºæ–°çš„ Unix å¥—æ¥å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">socketPathLimit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%q: unix socket path too long (&gt; %d)&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">socketPathLimit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;serving api on socket&#34;</span><span class="p">)</span><span class="err">Â·</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>å›åˆ°serveå‡½æ•°ï¼Œcontainerd-shimä»¥æ³¨å†ŒæœåŠ¡çš„å½¢å¼æ¥å¯¹containerdæä¾›å®¹å™¨ç›¸å…³æ“ä½œï¼Œä¸‹é¢æ˜¯ç›¸å…³æœåŠ¡æ³¨å†Œçš„æºç ï¼Œå¯ä»¥çœ‹åˆ°shimé€šè¿‡è°ƒç”¨<code>runc</code>å®¹å™¨è¿è¡Œæ—¶æ¥åˆ›å»ºå®¹å™¨ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskAPI</span><span class="p">.</span><span class="nf">RegisterTTRPCTaskService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create a new initial process and container with the underlying OCI runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">platform</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">containers</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskCreate</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskIO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>        <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The following line cannot return an error as the only state in which that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// could happen would also cause the container.Pid() call above to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// nil-deference panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">proc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ³¨ï¼šshimåˆ›å»ºçš„ä¸containerdé€šä¿¡çš„sockæ–‡ä»¶çš„modeä¸º0600ï¼Œå®é™…æƒ…å†µä¸æºç ä¸€è‡´ã€‚</strong></p>
<p><img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240918162254734.png"
	width="728"
	height="132"
	srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240918162254734_hu1991328956554458519.png 480w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240918162254734_hu9702084743628895238.png 1024w"
	loading="lazy"
	
		alt="sockæ–‡ä»¶æƒé™"
	
	
		class="gallery-image" 
		data-flex-grow="551"
		data-flex-basis="1323px"
	
></p>
<h2 id="å®¹å™¨å¯åŠ¨æµç¨‹åˆ†æ">å®¹å™¨å¯åŠ¨æµç¨‹åˆ†æ
</h2><p>åˆ†ææµç¨‹å›¾å¦‚ä¸‹ï¼Œtask.Startæ²¡æœ‰å¾€ä¸‹åˆ†æï¼Œå®ƒçš„å‡½æ•°ä¼ é€’æµç¨‹ä¸Newtaskç±»ä¼¼ã€‚</p>
<p><img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/%E6%97%A0%E6%A0%87%E9%A2%98.png"
	width="4552"
	height="3158"
	srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/%E6%97%A0%E6%A0%87%E9%A2%98_hu3418511777243317462.png 480w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/%E6%97%A0%E6%A0%87%E9%A2%98_hu7513606798315144493.png 1024w"
	loading="lazy"
	
		alt="ctræŒ‡ä»¤è§£æå›¾"
	
	
		class="gallery-image" 
		data-flex-grow="144"
		data-flex-basis="345px"
	
></p>
<blockquote>
<p>ctrè§£æå‘½ä»¤</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//è°ƒç”¨command.NewClient()-&gt;client.LoadContainer()-&gt;NewTask()-&gt;task.Start()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	1ã€command.NewClient() åˆ›å»ºcontainerd client
</span></span></span><span class="line"><span class="cl"><span class="cm">	2ã€LoadContainer()
</span></span></span><span class="line"><span class="cl"><span class="cm">	3ã€NewTask()
</span></span></span><span class="line"><span class="cl"><span class="cm">	4ã€task.Start()
</span></span></span><span class="line"><span class="cl"><span class="cm">	//å¦‚æœæ”¶åˆ°é€€å‡ºä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="cm">	5ã€task.Delete(ctx)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">startCommand</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span><span class="p">:</span>      <span class="s">&#34;start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Usage</span><span class="p">:</span>     <span class="s">&#34;Start a container that has been created&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ArgsUsage</span><span class="p">:</span> <span class="s">&#34;CONTAINER&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Flags</span><span class="p">:</span> <span class="nb">append</span><span class="p">(</span><span class="nx">platformStartFlags</span><span class="p">,</span> <span class="p">[]</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Flag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">BoolFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;null-io&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;Send all IO to /dev/null&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">StringFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;log-uri&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;Log uri&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">StringFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;fifo-dir&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;Directory used for storing IO FIFOs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">StringFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;pid-file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;File path to write the task&#39;s pid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">BoolFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>    <span class="s">&#34;detach&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Aliases</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;d&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span>   <span class="s">&#34;Detach from the task after it has started execution&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span><span class="o">...</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Action</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cliContext</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span>    <span class="kt">error</span>
</span></span><span class="line"><span class="cl">			<span class="nx">id</span>     <span class="p">=</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">Args</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">detach</span> <span class="p">=</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;detach&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;container id must be provided&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">commands</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">LoadContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Spec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">tty</span>    <span class="p">=</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Process</span><span class="p">.</span><span class="nx">Terminal</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span>   <span class="p">=</span> <span class="nf">GetNewTaskOpts</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ioOpts</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">{</span><span class="nx">cio</span><span class="p">.</span><span class="nf">WithFIFODir</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;fifo-dir&#34;</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">con</span> <span class="nx">console</span><span class="p">.</span><span class="nx">Console</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">tty</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">con</span> <span class="p">=</span> <span class="nx">console</span><span class="p">.</span><span class="nf">Current</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">con</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">con</span><span class="p">.</span><span class="nf">SetRaw</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">task</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">con</span><span class="p">,</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;null-io&#34;</span><span class="p">),</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;log-uri&#34;</span><span class="p">),</span> <span class="nx">ioOpts</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">task</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">tty</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">HandleConsoleResize</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">con</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;console resize&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">sigc</span> <span class="o">:=</span> <span class="nx">commands</span><span class="p">.</span><span class="nf">ForwardAllSignals</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">task</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">commands</span><span class="p">.</span><span class="nf">StopCatch</span><span class="p">(</span><span class="nx">sigc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">status</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">statusC</span>
</span></span><span class="line"><span class="cl">		<span class="nx">code</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">task</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">code</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ã€containerd clientåˆ›å»º</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\cmd\ctr\commands\client.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// NewClient returns a new containerd client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">cliContext</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">timeoutOpt</span> <span class="o">:=</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;connect-timeout&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">timeoutOpt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">),</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nf">AppContext</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">suppressDeprecationWarnings</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">suppressDeprecationWarnings</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">IntrospectionService</span><span class="p">().</span><span class="nf">Server</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;Failed to check deprecations&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Deprecations</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;DEPRECATION: &#34;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1ã€å®é™…è°ƒç”¨Newå‡½æ•°åˆ›å»º</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\client\client.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// New returns a new containerd client that is connected to the containerd
</span></span></span><span class="line"><span class="cl"><span class="c1">// instance provided by address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">address</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">copts</span> <span class="nx">clientOpts</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">copts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">defaultns</span><span class="p">:</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">platforms</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">services</span> <span class="p">=</span> <span class="o">*</span><span class="nx">copts</span><span class="p">.</span><span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span> <span class="o">:=</span> <span class="nx">backoff</span><span class="p">.</span><span class="nx">DefaultConfig</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span><span class="p">.</span><span class="nx">MaxDelay</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span>
</span></span><span class="line"><span class="cl">		<span class="nx">connParams</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ConnectParams</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Backoff</span><span class="p">:</span> <span class="nx">backoffConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">DialOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithTransportCredentials</span><span class="p">(</span><span class="nx">insecure</span><span class="p">.</span><span class="nf">NewCredentials</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithConnectParams</span><span class="p">(</span><span class="nx">connParams</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithContextDialer</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nx">ContextDialer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallRecvMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxRecvMsgSize</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallSendMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxSendMsgSize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">unary</span><span class="p">,</span> <span class="nx">stream</span> <span class="o">:=</span> <span class="nf">newNSInterceptors</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainUnaryInterceptor</span><span class="p">(</span><span class="nx">unary</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainStreamInterceptor</span><span class="p">(</span><span class="nx">stream</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">connector</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nf">DialAddress</span><span class="p">(</span><span class="nx">address</span><span class="p">),</span> <span class="nx">gopts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to dial %q: %w&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">conn</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">connector</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connector</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">,</span> <span class="nx">connector</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no grpc connection or services is available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// check namespace labels for default runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetLabel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntimeNSLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">label</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">label</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2ã€åŠ è½½container</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\client\client.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// LoadContainer loads an existing container from metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">LoadContainer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Container</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">span</span> <span class="o">:=</span> <span class="nx">tracing</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;client.LoadContainer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">span</span><span class="p">.</span><span class="nf">End</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ContainerService</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">SetAttributes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.id&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.image.ref&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Image</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.runtime.name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.snapshotter.name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Snapshotter</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.createdAt&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.updatedAt&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">UpdatedAt</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">containerFromRecord</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">r</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2ã€ContainerServiceå®é™…æ˜¯è°ƒç”¨çš„NewRemoteContainerStoreï¼Œè¿”å›NewContainersClient</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ContainerService returns the underlying container Store
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">ContainerService</span><span class="p">()</span> <span class="nx">containers</span><span class="p">.</span><span class="nx">Store</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">containerStore</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">containerStore</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">NewRemoteContainerStore</span><span class="p">(</span><span class="nx">containersapi</span><span class="p">.</span><span class="nf">NewContainersClient</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2ã€gRPCè°ƒç”¨containerdçš„containers.Getå‡½æ•°</p>
<p>containerd/containerd/api/services/containers/v1/containers_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">containersClient</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">GetContainerRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">GetContainerResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">GetContainerResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.services.containers.v1.Containers/Get&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2ã€containerdæ¥æ”¶å¹¶å¤„ç†è¯·æ±‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd/containerd/api/services/containers/v1/containers_grpc.pb.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">_Containers_Get_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">GetContainerRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">ContainersServer</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.services.containers.v1.Containers/Get&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">ContainersServer</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">GetContainerRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2ã€æ¥ç€è°ƒç”¨local.Get()å‡½æ•°å¤„ç†ï¼ˆè¿™é‡Œæœ‰ä¸ªå¯¹è±¡çš„è½¬æ¢ContainersServerè½¬æ¢åˆ°Serviceå†è½¬æ¢åˆ°localï¼‰</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd/containerd/api/services/containers/v1/containers_grpc.pb.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿™é‡Œè°ƒç”¨åº•å±‚çš„æ•°æ®åº“è·å–contianer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">local</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">GetContainerRequest</span><span class="p">,</span> <span class="nx">_</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">GetContainerResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">api</span><span class="p">.</span><span class="nx">GetContainerResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nf">withStoreView</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">Store</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">containerpb</span> <span class="o">:=</span> <span class="nf">containerToProto</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">container</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resp</span><span class="p">.</span><span class="nx">Container</span> <span class="p">=</span> <span class="nx">containerpb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€NewTaskåˆ›å»ºå®¹å™¨è¯·æ±‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\cmd\ctr\commands\tasks\tasks_unix.go
</span></span></span><span class="line"><span class="cl"><span class="c1">//NewTask creates a new task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">container</span> <span class="nx">containerd</span><span class="p">.</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">checkpoint</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">con</span> <span class="nx">console</span><span class="p">.</span><span class="nx">Console</span><span class="p">,</span> <span class="nx">nullIO</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">logURI</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ioOpts</span> <span class="p">[]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">NewTaskOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Task</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stdinC</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">stdinCloser</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">stdin</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">checkpoint</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">im</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">GetImage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">checkpoint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithTaskCheckpoint</span><span class="p">(</span><span class="nx">im</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Spec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">UIDMappings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithUIDOwner</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">UIDMappings</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">HostID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">GIDMappings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithGIDOwner</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">GIDMappings</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">HostID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">ioCreator</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">Creator</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">con</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">nullIO</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;tty and null-io cannot be used together&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nf">NewCreator</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">{</span><span class="nx">cio</span><span class="p">.</span><span class="nf">WithStreams</span><span class="p">(</span><span class="nx">con</span><span class="p">,</span> <span class="nx">con</span><span class="p">,</span> <span class="kc">nil</span><span class="p">),</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">WithTerminal</span><span class="p">},</span> <span class="nx">ioOpts</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">nullIO</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">NullIO</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">logURI</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">logURI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nf">LogURI</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nf">NewCreator</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">{</span><span class="nx">cio</span><span class="p">.</span><span class="nf">WithStreams</span><span class="p">(</span><span class="nx">stdinC</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">)},</span> <span class="nx">ioOpts</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ioCreator</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stdinC</span><span class="p">.</span><span class="nx">closer</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">CloseIO</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nx">WithStdinCloser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€è°ƒç”¨container.NewTaskå‡½æ•°</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\client\container.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">container</span><span class="p">)</span> <span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">ioCreate</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">Creator</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">NewTaskOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">Task</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">span</span> <span class="o">:=</span> <span class="nx">tracing</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;container.NewTask&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">span</span><span class="p">.</span><span class="nf">End</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ioCreate</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">i</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">i</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">i</span><span class="p">.</span><span class="nf">Config</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Terminal</span><span class="p">:</span>    <span class="nx">cfg</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdin</span><span class="p">:</span>       <span class="nx">cfg</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdout</span><span class="p">:</span>      <span class="nx">cfg</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stderr</span><span class="p">:</span>      <span class="nx">cfg</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">SnapshotKey</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Snapshotter</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to resolve rootfs mounts without snapshotter on container: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrInvalidArgument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// get the rootfs from the snapshotter and add it to the request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">getSnapshotter</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Snapshotter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mounts</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Mounts</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">SnapshotKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Spec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">mounts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">MountLabel</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">ml</span> <span class="o">:=</span> <span class="nx">label</span><span class="p">.</span><span class="nf">FormatMountLabel</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">MountLabel</span><span class="p">);</span> <span class="nx">ml</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">m</span><span class="p">.</span><span class="nx">Options</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">ml</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="nx">TaskInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runtime</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">info</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">info</span><span class="p">.</span><span class="nx">RootFS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span><span class="p">.</span><span class="nx">RuntimePath</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">RuntimePath</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">o</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Options</span> <span class="p">=</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalProto</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">task</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">io</span><span class="p">:</span>     <span class="nx">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">id</span><span class="p">:</span>     <span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">:</span>      <span class="nx">c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Checkpoint</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">SetAttributes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.container.id&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.request.options&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.runtime.name&#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">runtime</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">TaskService</span><span class="p">().</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">FromGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">AddEvent</span><span class="p">(</span><span class="s">&#34;task created&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.process.id&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Pid</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">pid</span> <span class="p">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Pid</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€Taskserviceè·å–TasksClientå®ä¾‹</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// TaskService returns the underlying TasksClient
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">TaskService</span><span class="p">()</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">TasksClient</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">taskService</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">taskService</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">NewTasksClient</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€é€šè¿‡gRPCå‘é€ç»™containerd</p>
<p>æºç è·¯å¾„ï¼šcontainerd/api/services/tasks/v1/tasks_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">tasksClient</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.services.tasks.v1.Tasks/Create&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€containerdæ¥æ”¶å¹¶å¤„ç†è¯·æ±‚</p>
<p>æºç è·¯å¾„ï¼šcontainerd/api/services/tasks/v1/tasks_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">_Tasks_Create_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TasksServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.services.tasks.v1.Tasks/Create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TasksServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€å®é™…è°ƒç”¨localçš„ç›¸å…³å‡½æ•°å¤„ç†ï¼ˆè¿™é‡Œä¹Ÿæœ‰å¯¹è±¡çš„è½¬æ¢ï¼‰</p>
<p>æºç è·¯å¾„ï¼šcontainerd/plugins/services/tasks/local.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">local</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">,</span> <span class="nx">_</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">getContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">checkpointPath</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIAddress</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIVersion</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskOptions</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">formatOptions</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">checkpointPath</span> <span class="p">=</span> <span class="nx">taskOptions</span><span class="p">.</span><span class="nx">CriuImagePath</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIAddress</span> <span class="p">=</span> <span class="nx">taskOptions</span><span class="p">.</span><span class="nx">TaskApiAddress</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIVersion</span> <span class="p">=</span> <span class="nx">taskOptions</span><span class="p">.</span><span class="nx">TaskApiVersion</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// jump get checkpointPath from checkpoint image
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">checkpointPath</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">checkpointPath</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirTemp</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;XDG_RUNTIME_DIR&#34;</span><span class="p">),</span> <span class="s">&#34;ctrd-checkpoint&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">MediaType</span> <span class="o">!=</span> <span class="nx">images</span><span class="p">.</span><span class="nx">MediaTypeContainerd1Checkpoint</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unsupported checkpoint type %q&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">MediaType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">ReaderAt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ocispec</span><span class="p">.</span><span class="nx">Descriptor</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">MediaType</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">MediaType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Digest</span><span class="p">:</span>      <span class="nx">digest</span><span class="p">.</span><span class="nf">Digest</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">Digest</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Size</span><span class="p">:</span>        <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">Size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Annotations</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">archive</span><span class="p">.</span><span class="nf">Apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">checkpointPath</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">reader</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reader</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Spec</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">IO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span>     <span class="nx">checkpointPath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Runtime</span><span class="p">:</span>        <span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">RuntimeOptions</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">TaskOptions</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SandboxID</span><span class="p">:</span>      <span class="nx">container</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Address</span><span class="p">:</span>        <span class="nx">taskAPIAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Version</span><span class="p">:</span>        <span class="nx">taskAPIVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">RuntimePath</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">Runtime</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">RuntimePath</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rtime</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">v2Runtime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rtime</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errdefs</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;task %s: %w&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrAlreadyExists</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rtime</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">labels</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;runtime&#34;</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">monitor</span><span class="p">.</span><span class="nf">Monitor</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">labels</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;monitor task: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">PID</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get task pid: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>         <span class="nx">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€è°ƒç”¨runtime.PlatformRuntime.createï¼ŒPlatformRuntimeæ¥å£å®é™…ç”±TaskManagerå®ç°ï¼Œä¹Ÿå°±æ˜¯TaskManager.Createã€‚Createå‡½æ•°çš„å…³é”®è°ƒç”¨æµç¨‹æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬ä¸€ä¸€åˆ†æã€‚</p>
<p>1.m.manager.Start()</p>
<p>2.newShimTask(shim)</p>
<p>3.shimTask.Create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//æºç è·¯å¾„ï¼šcontainerd\containerd\core\runtime\v2\task_manager.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// Create launches new shim instance and creates new task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">TaskManager</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">taskID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Task</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">bundle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewBundle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">taskID</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">bundle</span><span class="p">.</span><span class="nf">Delete</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">manager</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">taskID</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start shim: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Cast to shim task and call task service to create a new container task instance.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This will not be required once shim service / client implemented.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">shimTask</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newShimTask</span><span class="p">(</span><span class="nx">shim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// runc ignores silently features it doesn&#39;t know about, so for things that this is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// problematic let&#39;s check if this runc version supports them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">validateRuntimeFeatures</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to validate OCI runtime features: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">shimTask</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// NOTE: ctx contains required namespace information.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">m</span><span class="p">.</span><span class="nx">manager</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">taskID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">dctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">timeout</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span> <span class="nx">cleanupTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">sandboxed</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">errShim</span> <span class="o">:=</span> <span class="nx">shimTask</span><span class="p">.</span><span class="nb">delete</span><span class="p">(</span><span class="nx">dctx</span><span class="p">,</span> <span class="nx">sandboxed</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">errShim</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">IsDeadlineExceeded</span><span class="p">(</span><span class="nx">errShim</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">dctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">timeout</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span> <span class="nx">cleanupTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">shimTask</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">dctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">shimTask</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create shim task: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.1ã€m.manager.Start()è°ƒç”¨ShimManager.Start</p>
<p>containerd\containerd\core\runtime\v2\shim_manager.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start launches a new shim instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ShimManager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">bundle</span> <span class="o">*</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">ShimInstance</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// This container belongs to sandbox which supposed to be already started via sandbox API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">params</span> <span class="nx">shimbinary</span><span class="p">.</span><span class="nx">BootstrapParams</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// The address returned from sandbox controller should be in the form like ttrpc+unix://&lt;uds-path&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// or grpc+vsock://&lt;cid&gt;:&lt;port&gt;, we should get the protocol from the url first.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">protocol</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Cut</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="s">&#34;+&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;the scheme of sandbox address should be in &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">					<span class="s">&#34; the form of &lt;protocol&gt;+&lt;unix|vsock|tcp&gt;, i.e. ttrpc+unix or grpc+vsock&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">params</span> <span class="p">=</span> <span class="nx">shimbinary</span><span class="p">.</span><span class="nx">BootstrapParams</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Version</span><span class="p">:</span>  <span class="nb">int</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Version</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Protocol</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Address</span><span class="p">:</span>  <span class="nx">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// For those sandbox we can not get endpoint,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// fallback to legacy implementation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">process</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;can&#39;t find sandbox %s&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">,</span> <span class="nx">restoreErr</span> <span class="o">:=</span> <span class="nf">restoreBootstrapParams</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nf">Bundle</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">restoreErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get bootstrap &#34;</span><span class="o">+</span>
</span></span><span class="line"><span class="cl">					<span class="s">&#34;params of sandbox %s, %v, legacy restore error %v&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">restoreErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">params</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Write sandbox ID this task belongs to.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">bundle</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">&#34;sandbox&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">),</span> <span class="mo">0600</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeBootstrapParams</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">bundle</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">&#34;bootstrap.json&#34;</span><span class="p">),</span> <span class="nx">params</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to write bootstrap.json for bundle %s: %w&#34;</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadShim</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to load sandbox task %q: %w&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">shim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">shim</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">startShim</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">m</span><span class="p">.</span><span class="nf">cleanupShim</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">shim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">shim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to add task: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">shim</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.1ã€ä¸Šé¢å¦‚æœSandboxIDä¸ä¸ºç©ºï¼Œè°ƒç”¨loadShimå‡½æ•°åŠ è½½shimï¼Œå¦åˆ™è°ƒç”¨startShimå‡½æ•°å¯åŠ¨shimï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†æstartShimã€‚</p>
<p>æºç è·¯å¾„ï¼šcontainerd\containerd\core\runtime\v2\shim.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ShimManager</span><span class="p">)</span> <span class="nf">startShim</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bundle</span> <span class="o">*</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">shim</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nf">NamespaceRequired</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">WithLogger</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;namespace&#34;</span><span class="p">,</span> <span class="nx">ns</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">topts</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TaskOptions</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">topts</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">topts</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">()</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">topts</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">RuntimeOptions</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">runtimePath</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">resolveRuntimePath</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to resolve runtime path: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">b</span> <span class="o">:=</span> <span class="nf">shimBinary</span><span class="p">(</span><span class="nx">bundle</span><span class="p">,</span> <span class="nx">shimBinaryConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runtime</span><span class="p">:</span>      <span class="nx">runtimePath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">address</span><span class="p">:</span>      <span class="nx">m</span><span class="p">.</span><span class="nx">containerdAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ttrpcAddress</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">containerdTTRPCAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">env</span><span class="p">:</span>          <span class="nx">m</span><span class="p">.</span><span class="nx">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalProto</span><span class="p">(</span><span class="nx">topts</span><span class="p">),</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;shim disconnected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">cleanupAfterDeadShim</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">events</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Remove self from the runtime task list. Even though the cleanupAfterDeadShim()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// would publish taskExit event, but the shim.Delete() would always failed with ttrpc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// disconnect and there is no chance to remove this dead task from runtime task lists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Thus it&#39;s better to delete it here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;start failed: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">shim</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.2ã€newShimTask(shim)è°ƒç”¨NewTaskClient</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\core\runtime\v2\shim.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newShimTask</span><span class="p">(</span><span class="nx">shim</span> <span class="nx">ShimInstance</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">shimTask</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">version</span> <span class="o">:=</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">Endpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">shim</span><span class="p">.</span><span class="nf">Client</span><span class="p">(),</span> <span class="nx">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">shimTask</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ShimInstance</span><span class="p">:</span> <span class="nx">shim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">task</span><span class="p">:</span>         <span class="nx">taskClient</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.2ã€NewTaskClient()æ ¹æ®ä¼ å…¥çš„ç‰ˆæœ¬å·é€‰æ‹©ä¸åŒçš„é€šä¿¡æ¡†æ¶ä¸shimé€šä¿¡ï¼Œå¹¶è¿”å›ä¸€ä¸ªshimTaskå®ä¾‹</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\core\runtime\v2\bridge.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">client</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">version</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">TaskServiceClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Client</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">version</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ttrpcV2Bridge</span><span class="p">{</span><span class="nx">client</span><span class="p">:</span> <span class="nx">v2</span><span class="p">.</span><span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">c</span><span class="p">)},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">NewTTRPCTaskClient</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;containerd client supports only v2 and v3 TTRPC task client (got %d)&#34;</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConnInterface</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">version</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;containerd client supports only v3 GRPC task service (got %d)&#34;</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">grpcV3Bridge</span><span class="p">{</span><span class="nx">v3</span><span class="p">.</span><span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">c</span><span class="p">)},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unsupported shim client type %T&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€shimTask.Create(ctx, opts)åˆ›å»ºtask</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">shimTask</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Task</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">topts</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TaskOptions</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">topts</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">topts</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">()</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">topts</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">RuntimeOptions</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">task</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ID</span><span class="p">:</span>         <span class="nx">s</span><span class="p">.</span><span class="nf">ID</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>     <span class="nx">s</span><span class="p">.</span><span class="nf">Bundle</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdin</span><span class="p">:</span>      <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdout</span><span class="p">:</span>     <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stderr</span><span class="p">:</span>     <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Terminal</span><span class="p">:</span>   <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Options</span><span class="p">:</span>    <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalProto</span><span class="p">(</span><span class="nx">topts</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">FromGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€task.Createæ ¹æ®NewTaskClientä¼ å…¥çš„ç‰ˆæœ¬å·é€‰æ‹©è°ƒç”¨ä¸åŒçš„RPCï¼ˆè¿™ä¸ªNewTaskClientåœ¨å‰é¢newShimTaskå‡½æ•°è°ƒç”¨è¿‡ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©åˆ†ættrpctaskClient.Createï¼Œè¿™é‡Œè°ƒç”¨ttRPCæ¥å£å‘shimå‘å‡ºè¯·æ±‚ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\api\runtime\task\v3\shim_ttrpc.pb.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">ttrpctaskClient</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">CreateTaskResponse</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;containerd.task.v3.Task&#34;</span><span class="p">,</span> <span class="s">&#34;Create&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€shimåœ¨ä¹‹å‰å¯åŠ¨åä¼šè°ƒç”¨RegisterTTRPCæ³¨å†ŒæœåŠ¡ï¼Œæ‰€ä»¥ä¼šæ¥æ”¶åˆ°containerdå‘å‡ºçš„TTRPCè¯·æ±‚ï¼Œåœ¨è¿™é‡Œè¿›è¡Œå¤„ç†ã€‚</p>
<p>æºç è·¯å¾„ï¼šcontainerd\containerd\cmd\containerd-shim-runc-v2\task\service.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskAPI</span><span class="p">.</span><span class="nf">RegisterTTRPCTaskService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create a new initial process and container with the underlying OCI runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">platform</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">containers</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskCreate</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskIO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>        <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The following line cannot return an error as the only state in which that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// could happen would also cause the container.Pid() call above to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// nil-deference panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">proc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€æ¥ç€è°ƒç”¨runc.NewContainerå‡½æ•°</p>
<p>æºç è·¯å¾„ï¼šcontainerd\containerd\cmd\containerd-shim-runc-v2\runc\container.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// NewContainer returns a new runc container
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">platform</span> <span class="nx">stdio</span><span class="p">.</span><span class="nx">Platform</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">task</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nf">NamespaceRequired</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;create namespace: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">UnmarshalAny</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">v</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.(</span><span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">pmounts</span> <span class="p">[]</span><span class="nx">process</span><span class="p">.</span><span class="nx">Mount</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pmounts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">pmounts</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rootfs</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pmounts</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rootfs</span> <span class="p">=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="s">&#34;rootfs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Mkdir</span><span class="p">(</span><span class="nx">rootfs</span><span class="p">,</span> <span class="mo">0711</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">process</span><span class="p">.</span><span class="nx">CreateConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ID</span><span class="p">:</span>               <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>           <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Runtime</span><span class="p">:</span>          <span class="nx">opts</span><span class="p">.</span><span class="nx">BinaryName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>           <span class="nx">pmounts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Terminal</span><span class="p">:</span>         <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdin</span><span class="p">:</span>            <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdout</span><span class="p">:</span>           <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stderr</span><span class="p">:</span>           <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span>       <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ParentCheckpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ParentCheckpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Options</span><span class="p">:</span>          <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">WriteOptions</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// For historical reason, we write opts.BinaryName as well as the entire opts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">WriteRuntime</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">BinaryName</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">mounts</span> <span class="p">[]</span><span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pm</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pmounts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mounts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">mounts</span><span class="p">,</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">pm</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">pm</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">pm</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mount</span><span class="p">.</span><span class="nf">UnmountMounts</span><span class="p">(</span><span class="nx">mounts</span><span class="p">,</span> <span class="nx">rootfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;failed to cleanup rootfs mount&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mount</span><span class="p">.</span><span class="nf">All</span><span class="p">(</span><span class="nx">mounts</span><span class="p">,</span> <span class="nx">rootfs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to mount rootfs component: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newInit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="s">&#34;work&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">platform</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">container</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Container</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ID</span><span class="p">:</span>              <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>          <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">process</span><span class="p">:</span>         <span class="nx">p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">processes</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">process</span><span class="p">.</span><span class="nx">Process</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reservedProcess</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">pid</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">cg</span> <span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nf">Mode</span><span class="p">()</span> <span class="o">==</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nx">Unified</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">g</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cgroupsv2</span><span class="p">.</span><span class="nf">PidGroupPath</span><span class="p">(</span><span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;loading cgroup2 for %d&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">container</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cg</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cgroupsv2</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;loading cgroup2 for %d&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cg</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cgroup1</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">cgroup1</span><span class="p">.</span><span class="nf">PidPath</span><span class="p">(</span><span class="nx">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;loading cgroup for %d&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">container</span><span class="p">.</span><span class="nx">cgroup</span> <span class="p">=</span> <span class="nx">cg</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">container</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€æ¥ç€è°ƒç”¨newInit.Create</p>
<p>æºç è·¯å¾„ï¼šcontainerd\containerd\cmd\containerd-shim-runc-v2\process\init.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create the process with the provided config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Init</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">CreateConfig</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span>     <span class="kt">error</span>
</span></span><span class="line"><span class="cl">		<span class="nx">socket</span>  <span class="o">*</span><span class="nx">runc</span><span class="p">.</span><span class="nx">Socket</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pio</span>     <span class="o">*</span><span class="nx">processIO</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pidFile</span> <span class="p">=</span> <span class="nf">newPidFile</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//è¿™é‡Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„socketæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewTempConsoleSocket</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create OCI runtime console socket: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">pio</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">createIO</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">IoUID</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">IoGID</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">stdio</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create init process I/O: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">io</span> <span class="p">=</span> <span class="nx">pio</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">createCheckpointedState</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">pidFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">runc</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">PidFile</span><span class="p">:</span>      <span class="nx">pidFile</span><span class="p">.</span><span class="nf">Path</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">NoPivot</span><span class="p">:</span>      <span class="nx">p</span><span class="p">.</span><span class="nx">NoPivotRoot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">NoNewKeyring</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">NoNewKeyring</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">io</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">IO</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">socket</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">ConsoleSocket</span> <span class="p">=</span> <span class="nx">socket</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">runtimeError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;OCI runtime create failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">openStdin</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">socket</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">console</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">ReceiveMaster</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to retrieve console master: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">console</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Platform</span><span class="p">.</span><span class="nf">CopyConsole</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">console</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start console copy: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">console</span> <span class="p">=</span> <span class="nx">console</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pio</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start io pipe copy: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pidFile</span><span class="p">.</span><span class="nf">Read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to retrieve OCI runtime container pid: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nx">pid</span> <span class="p">=</span> <span class="nx">pid</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€æ¥ç€è°ƒç”¨runtime.Create</p>
<p>æºç è·¯å¾„ï¼šcontainerd\go-runc\runc.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create creates a new container and returns its pid if it was created successfully
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Runc</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">context</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">bundle</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;create&#34;</span><span class="p">,</span> <span class="s">&#34;--bundle&#34;</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">opts</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">CreateOpts</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">oargs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nf">args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">oargs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">command</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span><span class="p">.</span><span class="nx">ExtraFiles</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ExtraFiles</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">cmdOutput</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nf">putBuf</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">startCommand</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.(</span><span class="nx">StartCloser</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">CloseAfterStart</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">status</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">ec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s did not terminate successfully: %w&#34;</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="nx">ExitError</span><span class="p">{</span><span class="nx">status</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€æ¥ç€å¾€ä¸‹è°ƒç”¨runc.startCommand</p>
<p>æºç è·¯å¾„ï¼šcontainerd\go-runc\monitor.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Runc</span><span class="p">)</span> <span class="nf">startCommand</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">exec</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">)</span> <span class="p">(</span><span class="kd">chan</span> <span class="nx">Exit</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">PdeathSignal</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nf">StartLocked</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€å†å¾€ä¸‹è°ƒç”¨Monitor.Start</p>
<p>æºç è·¯å¾„ï¼šcontainerd\containerd\pkg\sys\reaper\reaper_unix.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start starts the command and registers the process with the reaper
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Monitor</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">exec</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">)</span> <span class="p">(</span><span class="kd">chan</span> <span class="nx">runc</span><span class="p">.</span><span class="nx">Exit</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ec</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">Unsubscribe</span><span class="p">(</span><span class="nx">ec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ec</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3ã€æ¥ç€å¾€ä¸‹è°ƒç”¨Cmd.Startï¼Œæœ€åè°ƒç”¨äº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨os.StartProcesså¯åŠ¨è¿›ç¨‹ã€‚</p>
<p>æºç è·¯å¾„ï¼šGo\src\os\exec\exec.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cmd</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Check for doubled Start calls before we defer failure cleanup. If the prior
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// call to Start succeeded, we don&#39;t want to spuriously close its pipes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Process</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;exec: already started&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">started</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">lp</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Path</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">Process</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">StartProcess</span><span class="p">(</span><span class="nx">lp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">argv</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">os</span><span class="p">.</span><span class="nx">ProcAttr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Dir</span><span class="p">:</span>   <span class="nx">c</span><span class="p">.</span><span class="nx">Dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Files</span><span class="p">:</span> <span class="nx">childFiles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Env</span><span class="p">:</span>   <span class="nx">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Sys</span><span class="p">:</span>   <span class="nx">c</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">started</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€Startå‡½æ•°è°ƒç”¨RPC</p>
<p>containerd/client/process.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start starts the exec process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">process</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">span</span> <span class="o">:=</span> <span class="nx">tracing</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;process.Start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">WithAttribute</span><span class="p">(</span><span class="s">&#34;process.id&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nf">ID</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">WithAttribute</span><span class="p">(</span><span class="s">&#34;process.task.id&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nf">ID</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">span</span><span class="p">.</span><span class="nf">End</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">TaskService</span><span class="p">().</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">StartRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ExecID</span><span class="p">:</span>      <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">io</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">FromGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">SetAttributes</span><span class="p">(</span><span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;process.pid&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Pid</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nx">pid</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Pid</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€RPCè¯·æ±‚shim</p>
<p>containerd/api/runtime/task/v3/shim_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">taskClient</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.task.v3.Task/Create&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">taskClient</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">StartRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">StartResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">StartResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.task.v3.Task/Start&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€shimæ”¶åˆ°è¯·æ±‚å¹¶è°ƒç”¨å¤„ç†å‡½æ•°</p>
<p>containerd/api/runtime/task/v3/shim_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">_Task_Create_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.task.v3.Task/Create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">_Task_Start_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">StartRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.task.v3.Task/Start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">StartRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3ã€å®é™…è°ƒç”¨çš„å¤„ç†å‡½æ•°</p>
<p>containerd/cmd/containerd-shim-runc-v2/task/service.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskAPI</span><span class="p">.</span><span class="nf">RegisterTTRPCTaskService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create a new initial process and container with the underlying OCI runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">platform</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">containers</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskCreate</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskIO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>        <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The following line cannot return an error as the only state in which that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// could happen would also cause the container.Pid() call above to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// nil-deference panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">proc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Start a process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">StartRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">StartResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">getContainer</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">cinit</span> <span class="o">*</span><span class="nx">runc</span><span class="p">.</span><span class="nx">Container</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cinit</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">initExited</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">containerInitExit</span><span class="p">[</span><span class="nx">container</span><span class="p">];</span> <span class="nx">initExited</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPCf</span><span class="p">(</span><span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrFailedPrecondition</span><span class="p">,</span> <span class="s">&#34;container %s init process is not running&#34;</span><span class="p">,</span> <span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">runningExecs</span><span class="p">[</span><span class="nx">container</span><span class="p">]</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="nx">cinit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If we failed to even start the process, s.runningExecs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// won&#39;t get decremented in s.handleProcessExit. We still need
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// to update it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">runningExecs</span><span class="p">[</span><span class="nx">container</span><span class="p">]</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">execCountSubscribers</span><span class="p">[</span><span class="nx">container</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nx">runningExecs</span><span class="p">[</span><span class="nx">container</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="s">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">cg</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Cgroup</span><span class="p">().(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">cgroup1</span><span class="p">.</span><span class="nx">Cgroup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">cg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;add cg to OOM monitor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">*</span><span class="nx">cgroupsv2</span><span class="p">.</span><span class="nx">Manager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">allControllers</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cg</span><span class="p">.</span><span class="nf">RootControllers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed to get root controllers&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cg</span><span class="p">.</span><span class="nf">ToggleControllers</span><span class="p">(</span><span class="nx">allControllers</span><span class="p">,</span> <span class="nx">cgroupsv2</span><span class="p">.</span><span class="nx">Enable</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">userns</span><span class="p">.</span><span class="nf">RunningInUserNS</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;failed to enable controllers (%v)&#34;</span><span class="p">,</span> <span class="nx">allControllers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to enable controllers (%v)&#34;</span><span class="p">,</span> <span class="nx">allControllers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">cg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;add cg to OOM monitor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskStart</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Pid</span><span class="p">:</span>         <span class="nb">uint32</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskExecStarted</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ExecID</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Pid</span><span class="p">:</span>         <span class="nb">uint32</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">StartResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é—®é¢˜ä¸è§£ç­”">é—®é¢˜ä¸è§£ç­”
</h2><p><strong>1ã€containerdçš„ gRPC ç›®å‰å¯ç”¨åŠ è§£å¯†ä¿æŠ¤é€šä¿¡ä¸å¦ï¼Ÿæ˜¯å¦æœ‰åŒå‘è®¤è¯ï¼Ÿ</strong></p>
<p>ç­”ï¼šåœ¨ <code>containerd</code> ä¸­ï¼ŒgRPC çš„åŠ å¯†æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶ä¸­çš„ TLS è®¾ç½®å®ç°çš„ã€‚ä½ å¯ä»¥åœ¨ <code>containerd</code> çš„é…ç½®æ–‡ä»¶ <code>/etc/containerd/config.toml</code> ä¸­é…ç½® TLS ç›¸å…³çš„é€‰é¡¹ã€‚</p>
<p>åœ¨ <code>config.toml</code> æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥ä¸º gRPC æœåŠ¡å¯ç”¨ TLSï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">grpc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;/run/containerd/containerd.sock&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># å¼€å¯TCPç›‘å¬ï¼Œé»˜è®¤æ˜¯å…³é—­çš„</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tcp_address</span> <span class="p">=</span> <span class="s2">&#34;0.0.0.0:2375&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># é…ç½®TLSè¯ä¹¦å’Œå¯†é’¥</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tls_cert</span> <span class="p">=</span> <span class="s2">&#34;/etc/containerd/tls/containerd.crt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tls_key</span> <span class="p">=</span> <span class="s2">&#34;/etc/containerd/tls/containerd.key&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># å¯é€‰çš„ï¼ŒCAè¯ä¹¦è·¯å¾„</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tls_ca</span> <span class="p">=</span> <span class="s2">&#34;/etc/containerd/tls/ca.crt&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>tls_cert</code> å’Œ <code>tls_key</code> æ˜¯æœåŠ¡å™¨çš„è¯ä¹¦å’Œç§é’¥æ–‡ä»¶ï¼Œ<code>containerd</code> å°†ä½¿ç”¨è¿™äº›æ–‡ä»¶æ¥åŠ å¯† gRPC é€šä¿¡ã€‚</p>
<p><code>tls_ca</code> æ˜¯å¯é€‰çš„ CA è¯ä¹¦ï¼Œç”¨äºéªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ï¼Œä»è€Œæ”¯æŒåŒå‘è®¤è¯ï¼ˆMutual TLS, mTLSï¼‰ã€‚</p>
<p><strong>2ã€2.1.4ä¸­æåˆ°â€œæ’ä»¶é€šè¿‡ gRPC æä¾›æœåŠ¡æ¥å£ï¼Œcontainerd æ ¸å¿ƒé€šè¿‡è°ƒç”¨è¿™äº›æ¥å£æ¥ç®¡ç†é•œåƒã€å¿«ç…§å’Œå®¹å™¨è¿è¡Œæ—¶ç­‰â€ã€‚</strong>
<strong>æ˜¯å¦æ„å‘³ç€containerdä¸æ’ä»¶ä¹‹é—´ä¹Ÿæ˜¯ä½¿ç”¨gRPCè¿›è¡Œçš„é€šä¿¡ï¼Ÿä¹Ÿå°±æ˜¯containerdå†…éƒ¨ä¹Ÿæœ‰gRPCé€šä¿¡ï¼Ÿ</strong></p>
<p>ç­”ï¼šcontainerdå†…éƒ¨åº”è¯¥ä¸æ˜¯gRPCé€šä¿¡ï¼ŒgRPCæ˜¯ä¸€ä¸ªRPCé€šä¿¡æ¡†æ¶ï¼Œä¸€èˆ¬ç”¨äºè¿›ç¨‹é—´ï¼Œåœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ä½¿ç”¨gRPCæ²¡æœ‰å¤ªå¤§çš„å¿…è¦ï¼Œä¸€ä¸ªè¿›ç¨‹å†…éƒ¨å„æ¨¡å—çš„é€šä¿¡åº”è¯¥æ˜¯é€šè¿‡æ¥å£å’Œç›´æ¥çš„å‡½æ•°è°ƒç”¨æ¥å®ç°å†…éƒ¨é€šä¿¡çš„ã€‚</p>
<p><strong>3ã€2.1.4 ä»¥åŠ 3.1 åˆ†åˆ«æåˆ°ï¼šâ€œå®ˆæŠ¤è¿›ç¨‹ä¸å¤–éƒ¨å®¢æˆ·ç«¯ï¼ˆå¦‚ ctr å·¥å…·æˆ– Docker å¼•æ“ï¼‰ä¹‹é—´çš„é€šä¿¡ â€ä½¿ç”¨ gRPC/UDS ï¼Ÿ</strong>
<strong>ç‰¹åˆ«æ˜¯ 3.1 å¦‚ä½•ç†è§£ï¼Ÿ3.1 åé¢æåˆ°ä¸€ä¸ªä¾‹å­ï¼ŒDockerå¼•æ“é€šè¿‡ gRPC è¿æ¥åˆ°å®ˆæŠ¤è¿›ç¨‹çš„UDSåœ°å€ï¼Œä»¥è¯·æ±‚ç®¡ç†å®¹å™¨ã€é•œåƒã€å¿«ç…§ç­‰æ“ä½œã€‚é—®ï¼šgRPC å¦‚ä½•è¿æ¥çš„è¿™ä¸ª UDS åœ°å€ï¼ˆæŠ€æœ¯åŸç†ï¼‰ï¼Ÿ</strong></p>
<p>ç­”ï¼šè¿™ä¸ªé—®é¢˜ç†è§£çš„å…³é”®ç‚¹åœ¨äºudsæ˜¯å¦‚ä½•ä¸gRPCç»“åˆä½¿ç”¨çš„ï¼Œcontainerdåœ¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨ <code>sys.GetLocalListener</code> æ¥ç›‘å¬ä¸€ä¸ª Unix Domain Socketã€‚ç„¶åå°†ç›‘å¬å™¨ä¼ é€’ç»™ <code>serve</code>å‡½æ•°å¤„ç†grpcè¯·æ±‚ã€‚ï¼ˆå…·ä½“çš„ä»£ç å¯ä»¥åœ¨4.1ä¸­æ‰¾åˆ°ï¼‰</p>
<p><img src="/assets/image-20240827113414851.png"
	
	
	
	loading="lazy"
	
		alt="ç›‘å¬uds"
	
	
></p>
<p><img src="/assets/image-20240826095151377.png"
	
	
	
	loading="lazy"
	
		alt="serveå‡½æ•°"
	
	
></p>
<p><strong>4ã€åˆ›å»ºçš„å®¹å™¨çš„æ‰€å± userã€group é»˜è®¤æ˜¯ä¸containerd åŒç»„åŒç”¨æˆ·å—ï¼Ÿ</strong></p>
<p>ç­”ï¼šæˆ‘åœ¨è¿™ä¸ªé—®é¢˜ä¸Šåšäº†ä¸€äº›å®éªŒæ¥éªŒè¯ã€‚é¦–å…ˆï¼Œåˆ›å»ºçš„å®¹å™¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„è‚¯å®šæ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œæ— è®ºæ˜¯åœ¨é•œåƒä¸­æŒ‡å®šï¼Œè¿˜æ˜¯åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™æŒ‡å®šï¼›ä½†é»˜è®¤ä¸æŒ‡å®šçš„æƒ…å†µä¸‹é•œåƒä¸€èˆ¬éƒ½æ˜¯å°†å®¹å™¨å†…çš„è¿›ç¨‹è®¾ç½®ä¸ºä»¥rootç”¨æˆ·è¿›è¡Œã€‚è¿™ä¹Ÿå°è¯äº†ä¸‹é¢è¿™å¥è¯ï¼šåœ¨ <code>containerd</code> ä¸­ï¼Œåˆ›å»ºçš„å®¹å™¨é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šè‡ªåŠ¨ç»§æ‰¿ <code>containerd</code> è¿›ç¨‹çš„ç”¨æˆ·ï¼ˆ<code>user</code>ï¼‰å’Œç»„ï¼ˆ<code>group</code>ï¼‰ã€‚ç›¸åï¼Œå®¹å™¨çš„ç”¨æˆ·å’Œç»„æ˜¯æ ¹æ®å®¹å™¨çš„é…ç½®ï¼ˆå¦‚ OCI è§„èŒƒï¼‰æ¥å†³å®šçš„ã€‚</p>
<p>ä¸‹é¢æ˜¯æˆ‘ä½¿ç”¨<code>containerd</code>åˆ›å»ºalpineæœåŠ¡å®¹å™¨çš„æƒé™çš„é…ç½®æ–‡ä»¶ï¼š</p>
<p><strong>5ã€3.3 æåˆ°â€œæ’ä»¶å¯èƒ½ä½œä¸ºå¤–éƒ¨æœåŠ¡è¿è¡Œï¼Œéœ€è¦é€šè¿‡ UDS ä¸ containerd é€šä¿¡ã€‚â€ï¼Œä¾‹å­ä»‹ç»ä¸­è¯´ï¼šâ€œå¤–éƒ¨å­˜å‚¨æ’ä»¶å¯èƒ½ç‹¬ç«‹è¿è¡Œå¹¶é€šè¿‡ UDS æš´éœ²å…¶ gRPC æœåŠ¡ï¼Œcontainerd é€šè¿‡è¿æ¥è¿™ä¸ª UDS æ¥è°ƒç”¨æ’ä»¶çš„æœåŠ¡ã€‚â€</strong>
<strong>é—®ï¼šcontainerd é€šè¿‡ UDS è¿æ¥å¤–éƒ¨æ’ä»¶ï¼Œå¤–éƒ¨æ’ä»¶æš´éœ²çš„ gRPC ç»™è°ï¼Ÿ</strong></p>
<p>ç­”ï¼šè¿™æ˜¯containerdå®˜æ–¹æ–‡æ¡£æŸ¥åˆ°çš„ï¼Œcontainerdé€šè¿‡gRPCè¿æ¥å¤–éƒ¨æ’ä»¶ï¼Œé‚£å¤–éƒ¨æ’ä»¶æš´éœ²çš„gRPCè‚¯å®šæ˜¯ç»™containerdçš„é…ç½®æ–‡ä»¶ã€‚</p>
<p><img src="/assets/image-20240826104113183.png"
	
	
	
	loading="lazy"
	
		alt="å¤–éƒ¨æ’ä»¶"
	
	
></p>
<p><img src="/assets/image-20240826104245632.png"
	
	
	
	loading="lazy"
	
		alt="ä»£ç†æ’ä»¶"
	
	
></p>
<p><strong>6ã€systemd æä¾›ä½¿ç”¨socket activationtæœºåˆ¶ï¼Œæ˜¯é’ˆå¯¹å†…æ ¸æ€è¿›ç¨‹è¿˜æ˜¯ç”¨æˆ·æ€è¿›ç¨‹ï¼Œäº¦æˆ–æ˜¯ä¸¤è€…éƒ½æ”¯æŒï¼Ÿ</strong></p>
<p>ç­”ï¼šé’ˆå¯¹ç”¨æˆ·æ€è¿›ç¨‹ã€‚</p>
<p><strong>7ã€containerdçš„socketæ–‡ä»¶çš„modeå’Œuidã€gidåˆ†åˆ«æ˜¯ï¼Ÿç”±è°è®¾ç½®è¯¥å†…å®¹ï¼Ÿ</strong></p>
<p>ç­”ï¼šå…·ä½“å›ç­”å¯ä»¥çœ‹é—®é¢˜9ï¼Œè‡³äºsocketæ–‡ä»¶çš„modeã€uidã€gidçš„è®¾ç½®è‚¯å®šæ˜¯ç”±containerdè‡ªå·±è®¾ç½®ï¼Œå…·ä½“å¯çœ‹æºç ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//é¦–å…ˆä¼ å…¥config.tomlä¸­è®¾ç½®çš„gidï¼Œuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="nx">ttrpc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">gid</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="nx">uid</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//æ¥ç€è°ƒç”¨GetLocalListener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//å†åˆ›å»ºsocketæ–‡ä»¶ï¼Œä¹‹åè°ƒç”¨chmodä¸º0660ï¼Œchownä¸ºä¸Šé¢ä¼ å…¥çš„gidã€uid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure parent directory is created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>8ã€rootæƒé™ä¸‹ï¼šcontainerdã€shimä»¥åŠå®¹å™¨çš„UIDã€GIDæ˜¯å¦éƒ½ä¸€æ ·ï¼Ÿå¦‚ä½•è®¾ç½®å®¹å™¨ä¸åŒçš„UIDã€GID</strong></p>
<p>ç­”ï¼šrootæƒé™ä¸‹containerdã€shimçš„UIDã€GIDéƒ½æ˜¯root</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hacker@LAPTOP-V47UU71B:/mnt/c/Users/L$ ps -eo pid,user,group,comm <span class="p">|</span> grep containerd
</span></span><span class="line"><span class="cl">    <span class="m">248</span> root     root     containerd
</span></span><span class="line"><span class="cl">   <span class="m">8561</span> root     root     containerd-shim
</span></span><span class="line"><span class="cl">  <span class="m">13295</span> root     root     containerd-shim
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦‚ä½•è®¾ç½®å®¹å™¨ä¸åŒçš„uidã€gidï¼Œå¯ä»¥åœ¨containerdåˆ›å»ºå®¹å™¨æ—¶æŒ‡å®šç”¨æˆ·åŠç”¨æˆ·ç»„ï¼Œæ¯”å¦‚æˆ‘çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„éƒ½æ˜¯1000ï¼Œæˆ‘å¯ä»¥è¿™ä¹ˆåˆ›å»ºå®¹å™¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hacker@LAPTOP-V47UU71B:/mnt/c/Users/L$ sudo ctr container create -u 1000:1000 m.daocloud.io/docker.io/library/alpine:latest mycont
</span></span><span class="line"><span class="cl">ainer
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿›å…¥å®¹å™¨åæŸ¥çœ‹id</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hacker@LAPTOP-V47UU71B:/mnt/c/Users/L$ sudo ctr task <span class="nb">exec</span> -t --exec-id exec-1 mycontainer /bin/sh
</span></span><span class="line"><span class="cl">~ $ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span><span class="m">1000</span> <span class="nv">gid</span><span class="o">=</span><span class="m">1000</span> <span class="nv">groups</span><span class="o">=</span><span class="m">1000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>9ã€å¦‚æœç”¨systemdå¯åŠ¨containerdå®ˆæŠ¤è¿›ç¨‹ä»¥åŠç”¨äºä¸containerdé€šä¿¡çš„clientè¿›ç¨‹ï¼Œé‚£ä¹ˆsocketæ–‡ä»¶æ˜¯ç”±systemdåˆ›å»ºè¿˜æ˜¯containerdåˆ›å»ºï¼Ÿ</strong></p>
<p>å¦‚æœä½¿ç”¨ systemd æ¥å¯åŠ¨ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ä»¥åŠç”¨äºä¸ <code>containerd</code> é€šä¿¡çš„å®¢æˆ·ç«¯è¿›ç¨‹ï¼Œå¹¶ä¸”å¯ç”¨äº† socket activation æœºåˆ¶ï¼ˆå¯ä»¥ä¸å¯åŠ¨ï¼‰ï¼Œé‚£ä¹ˆ socket æ–‡ä»¶å°†ç”± systemd åˆ›å»ºï¼Œè€Œä¸æ˜¯ <code>containerd</code>ã€‚</p>
<p><strong>ï¼ˆäº‹å®ä¸Šcontainerdåº”è¯¥æ˜¯ä¸æ”¯æŒsystemdçš„socket activationæœºåˆ¶çš„ï¼Œgithubä¹Ÿæœ‰äººæå‡ºè¿‡åœ¨containerdä¸­åŠ å…¥æ­¤æœºåˆ¶ï¼š<a class="link" href="https://github.com/containerd/containerd/issues/164"  target="_blank" rel="noopener"
    >add socket activation Â· Issue #164 Â· containerd/containerd (github.com)</a>ï¼‰</strong></p>
<p>ä¸€èˆ¬å¦‚æœæ”¯æŒsocket activationæœºåˆ¶çš„è¯ä¼šæœ‰ç±»ä¼¼ä¸‹å›¾çš„é€»è¾‘ï¼ŒæœåŠ¡å™¨ä¼šå…ˆè°ƒç”¨sd_listen_fdså‡½æ•°ï¼Œçœ‹systemdæ˜¯å¦åˆ›å»ºäº†socketæ–‡ä»¶ï¼Œå¦‚æœåˆ›å»ºäº†å°±ä¸ä¼šå†åˆ›å»ºäº†ã€‚æ‰€ä»¥å¦‚æœä½¿ç”¨systemçš„socket activationå¯åŠ¨è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±ä¸€å®šæ˜¯systemdåˆ›å»ºsocketæ–‡ä»¶ã€‚</p>
<p><img src="/assets/image-20240827232023457.png"
	
	
	
	loading="lazy"
	
		alt="socket activationä»£ç é€»è¾‘"
	
	
></p>
<p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><strong>systemd åˆ›å»º socket</strong>ï¼šåœ¨ socket activation æœºåˆ¶ä¸‹ï¼Œsystemd ä¼šé¦–å…ˆæ ¹æ®é…ç½®åˆ›å»ºä¸€ä¸ªç›‘å¬ socket æ–‡ä»¶ï¼Œå¹¶å°†å…¶ç½®äºç›‘å¬çŠ¶æ€ã€‚è¿™æ˜¯åœ¨ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨ä¹‹å‰å®Œæˆçš„ã€‚</li>
<li><strong>systemd å¯åŠ¨ containerd</strong>ï¼šå½“æœ‰å®¢æˆ·ç«¯è¿æ¥åˆ°ç”± systemd åˆ›å»ºçš„ socket æ—¶ï¼Œsystemd æ£€æµ‹åˆ°è¿æ¥è¯·æ±‚å¹¶å¯åŠ¨ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶å°†è¿™ä¸ª socket ä¼ é€’ç»™ <code>containerd</code>ã€‚</li>
<li><strong>containerd ä½¿ç”¨ socket</strong>ï¼š<code>containerd</code> å¯åŠ¨åï¼Œæ¥æ”¶ systemd ä¼ é€’çš„ socketï¼Œå¹¶ä½¿ç”¨è¯¥ socket æ¥å¤„ç†å®¢æˆ·ç«¯çš„é€šä¿¡è¯·æ±‚ã€‚</li>
</ol>
<p>ä¸ºäº†æ›´å¥½çš„ç†è§£ä¸ºä»€ä¹ˆæ˜¯systemdåˆ›å»ºæˆ‘ä»¬å†™ä¸€ä¸ªä½¿ç”¨ systemd å¯åŠ¨ <code>containerd</code> å®ˆæŠ¤è¿›ç¨‹å’Œå®¢æˆ·ç«¯è¿›ç¨‹çš„æµç¨‹ï¼š</p>
<p>1ã€åˆ›å»º systemd çš„ socket å•å…ƒæ–‡ä»¶</p>
<p>ä½ éœ€è¦ä¸º <code>containerd</code> åˆ›å»ºä¸€ä¸ª <code>.socket</code> å•å…ƒæ–‡ä»¶ï¼Œé€šå¸¸æ”¾åœ¨ <code>/etc/systemd/system/containerd.socket</code> æˆ– <code>/usr/lib/systemd/system/containerd.socket</code>ã€‚</p>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[Unit]
</span></span><span class="line"><span class="cl">Description=containerd Socket
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Socket]
</span></span><span class="line"><span class="cl">ListenStream=/run/containerd/containerd.sock
</span></span><span class="line"><span class="cl">SocketMode=0660
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Install]
</span></span><span class="line"><span class="cl">WantedBy=sockets.target
</span></span></code></pre></td></tr></table>
</div>
</div><p>2ã€åˆ›å»º systemd çš„ service å•å…ƒæ–‡ä»¶</p>
<p>ä½ éœ€è¦ç¡®ä¿ <code>containerd</code> çš„ <code>.service</code> å•å…ƒæ–‡ä»¶æ­£ç¡®é…ç½®ã€‚å¦‚æœé»˜è®¤çš„ service æ–‡ä»¶ä¸æ”¯æŒ socket activationï¼Œä½ å¯èƒ½éœ€è¦æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„ service æ–‡ä»¶ã€‚æ”¾åœ¨ <code>/etc/systemd/system/containerd.service</code> æˆ– <code>/usr/lib/systemd/system/containerd.service</code>ã€‚</p>
<p>ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Description</span><span class="o">=</span><span class="n">containerd</span> <span class="n">container</span> <span class="n">runtime</span>
</span></span><span class="line"><span class="cl"><span class="n">Documentation</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">containerd</span><span class="o">.</span><span class="n">io</span>
</span></span><span class="line"><span class="cl"><span class="n">Wants</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
</span></span><span class="line"><span class="cl"><span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Service</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">containerd</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span><span class="o">=</span><span class="n">notify</span>
</span></span><span class="line"><span class="cl"><span class="n">Restart</span><span class="o">=</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">LimitNOFILE</span><span class="o">=</span><span class="mi">1048576</span>
</span></span><span class="line"><span class="cl"><span class="n">LimitNPROC</span><span class="o">=</span><span class="n">infinity</span>
</span></span><span class="line"><span class="cl"><span class="n">LimitCORE</span><span class="o">=</span><span class="n">infinity</span>
</span></span><span class="line"><span class="cl"><span class="n">TasksMax</span><span class="o">=</span><span class="n">infinity</span>
</span></span><span class="line"><span class="cl"><span class="n">Delegate</span><span class="o">=</span><span class="n">yes</span>
</span></span><span class="line"><span class="cl"><span class="n">KillMode</span><span class="o">=</span><span class="n">process</span>
</span></span><span class="line"><span class="cl"><span class="n">OOMScoreAdjust</span><span class="o">=-</span><span class="mi">999</span>
</span></span><span class="line"><span class="cl"><span class="n">ExecStartPre</span><span class="o">=-/</span><span class="n">sbin</span><span class="o">/</span><span class="n">modprobe</span> <span class="n">overlay</span>
</span></span><span class="line"><span class="cl"><span class="n">ExecReload</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">kill</span> <span class="o">-</span><span class="n">s</span> <span class="n">HUP</span> <span class="o">$</span><span class="n">MAINPID</span>
</span></span><span class="line"><span class="cl"><span class="n">KillSignal</span><span class="o">=</span><span class="n">SIGTERM</span>
</span></span><span class="line"><span class="cl"><span class="n">TimeoutStartSec</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Install</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3ã€å¯ç”¨å¹¶å¯åŠ¨ socket å’Œ service</p>
<p>å¯ç”¨å¹¶å¯åŠ¨ socket å’Œ serviceï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo systemctl enable containerd.socket
</span></span><span class="line"><span class="cl">sudo systemctl start containerd.socket
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶ï¼Œsystemd ä¼šç›‘å¬ <code>/run/containerd/containerd.sock</code>ï¼Œå¹¶åœ¨æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶è‡ªåŠ¨å¯åŠ¨ <code>containerd</code> æœåŠ¡ã€‚</p>
<p><strong>10ã€OCI æ ‡å‡†æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p><strong>OCIï¼ˆOpen Container Initiativeï¼‰</strong> æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨å®šä¹‰å®¹å™¨è¿è¡Œæ—¶å’Œé•œåƒçš„æ ‡å‡†ã€‚å®ƒç”± Linux Foundation ç»„ç»‡ä¸»å¯¼ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªå…³é”®è§„èŒƒï¼š</p>
<ol>
<li><strong>OCI Runtime Specificationï¼ˆOCI è¿è¡Œæ—¶è§„èŒƒï¼‰</strong>ï¼š
<ul>
<li>è¿™ä¸ªè§„èŒƒå®šä¹‰äº†å®¹å™¨çš„è¿è¡Œæ—¶è¡Œä¸ºï¼ŒåŒ…æ‹¬å¦‚ä½•åˆ›å»ºã€é…ç½®ã€å¯åŠ¨ã€åœæ­¢å’Œåˆ é™¤å®¹å™¨ã€‚å®ƒå®šä¹‰äº†å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µï¼Œä»¥åŠå®¹å™¨è¿›ç¨‹çš„ç¯å¢ƒã€å‘½åç©ºé—´ã€cgroups ç­‰é…ç½®ã€‚</li>
</ul>
</li>
<li><strong>OCI Image Specificationï¼ˆOCI é•œåƒè§„èŒƒï¼‰</strong>ï¼š
<ul>
<li>è¿™ä¸ªè§„èŒƒå®šä¹‰äº†å®¹å™¨é•œåƒçš„æ ¼å¼åŠå…¶å†…å®¹ã€‚è¿™åŒ…æ‹¬å¦‚ä½•æ‰“åŒ…åº”ç”¨ç¨‹åºåŠå…¶ä¾èµ–é¡¹ï¼Œä»¥ä¾¿é•œåƒå¯ä»¥è¢«å„ç§å®¹å™¨è¿è¡Œæ—¶æ‹‰å–å’Œè§£å‹ï¼Œä»¥ä¸€è‡´çš„æ–¹å¼è¿è¡Œã€‚</li>
</ul>
</li>
</ol>
<p><strong>11ã€ä¸ºä»€ä¹ˆcontainerdæœ€ç»ˆè°ƒç”¨çš„æ˜¯net.listen()åˆ›å»ºsocketæ–‡ä»¶ï¼Ÿ</strong></p>
<p>å› ä¸ºnet.listen()è°ƒç”¨çš„æ˜¯Goæ ‡å‡†åº“netåŒ…ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼ŒGoå¯¹åº•å±‚udsçš„syscallåšäº†ä¸€ä¸ªå°è£…ï¼Œå®é™…åˆ›å»ºsocketæ–‡ä»¶è¿˜æ˜¯bindé˜¶æ®µï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹netçš„å®ç°ï¼Œæˆ‘ç¨å¾®çœ‹äº†ä¸€ä¸‹æºç ç¡®å®æ˜¯åšäº†å°è£…ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™
</h2><p><a class="link" href="https://github.com/containerd/containerd/blob/main/core/runtime/v2/README.md"  target="_blank" rel="noopener"
    >containerd-shimæ–‡æ¡£</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/containerd/">Containerd</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            æœ€åæ›´æ–°äº 2024-12-11
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

     
    
        
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }

    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":"æ„Ÿè°¢æ‚¨çš„è¯„è®º"},"pageview":true,"requiredMeta":["nick"],"serverURL":"https://chenyuan1125.top","visitor":true});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Lee
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
