<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Ê∑±ÂÖ•ÂàÜÊûêcontainerdÊ∫êÁ†Å">
<meta name="keywords" content="Ê∫êÁ†ÅÂàÜÊûê„ÄÅuds"><title>containerdÈÄö‰ø°Êú∫Âà∂ÂàÜÊûê</title>

<link rel='canonical' href='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.1d7a77f66a9605dfbac1c7922a91290042c454a1166056d913fcbcea340dd583.css"><meta property='og:title' content="containerdÈÄö‰ø°Êú∫Âà∂ÂàÜÊûê">
<meta property='og:description' content="Ê∑±ÂÖ•ÂàÜÊûêcontainerdÊ∫êÁ†Å">
<meta property='og:url' content='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/'>
<meta property='og:site_name' content='Ëæ∞Ëøú'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='containerd' /><meta property='article:published_time' content='2024-10-23T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2024-12-11T19:43:23&#43;08:00'/><meta property='og:image' content='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1.jpg' />
<meta name="twitter:title" content="containerdÈÄö‰ø°Êú∫Âà∂ÂàÜÊûê">
<meta name="twitter:description" content="Ê∑±ÂÖ•ÂàÜÊûêcontainerdÊ∫êÁ†Å"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='//localhost:1313/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1.jpg' />

<link rel="stylesheet" href="https://s1.hdslb.com/bfs/static/jinkela/long/font/regular.css" />
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu4999655723030452168.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="//localhost:1313/">Ëæ∞Ëøú</a></h1>
            <h2 class="site-description">Â§©Â∞ÜÈôçÂ§ß‰ªª‰∫éÊñØ‰∫∫‰πü</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='/'
                        
                        title="È¶ñÈ°µ&amp;ÂÖ≥‰∫é"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/chenyuan1125'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>ÈìæÊé•</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="//localhost:1313/en/" >English</option>
                                
                                    <option value="//localhost:1313/" selected>‰∏≠Êñá</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ÁÆÄËø∞">ÁÆÄËø∞</a></li>
    <li><a href="#grpcÊ°ÜÊû∂ÂéüÁêÜ">gRPCÊ°ÜÊû∂ÂéüÁêÜ</a>
      <ol>
        <li><a href="#grpc-ÁöÑÂ∑•‰ΩúÊµÅÁ®ã">gRPC ÁöÑÂ∑•‰ΩúÊµÅÁ®ã</a>
          <ol>
            <li><a href="#ÊúçÂä°ÂÆö‰πâ‰∏éÊé•Âè£ÁîüÊàê">ÊúçÂä°ÂÆö‰πâ‰∏éÊé•Âè£ÁîüÊàê</a></li>
            <li><a href="#grpc-ÊúçÂä°ÁöÑÂÆûÁé∞">gRPC ÊúçÂä°ÁöÑÂÆûÁé∞</a></li>
            <li><a href="#grpc-ÈÄö‰ø°Êú∫Âà∂">gRPC ÈÄö‰ø°Êú∫Âà∂</a></li>
            <li><a href="#ÂÖ≥ÈîÆÂ∫îÁî®Âú∫ÊôØ">ÂÖ≥ÈîÆÂ∫îÁî®Âú∫ÊôØ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#grpc‰∏≠‰ΩøÁî®udsÁöÑÂú∫ÊôØ">gRPC‰∏≠‰ΩøÁî®UDSÁöÑÂú∫ÊôØ</a>
      <ol>
        <li><a href="#containerd-ÂÆàÊä§ËøõÁ®ã‰∏éÂÆ¢Êà∑Á´Ø‰πãÈó¥ÁöÑÈÄö‰ø°"><code>containerd</code> ÂÆàÊä§ËøõÁ®ã‰∏éÂÆ¢Êà∑Á´Ø‰πãÈó¥ÁöÑÈÄö‰ø°</a></li>
        <li><a href="#containerd-shim-‰∏é-containerd-ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°"><code>containerd-shim</code> ‰∏é <code>containerd</code> ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°</a></li>
        <li><a href="#containerd-Êèí‰ª∂‰∏éÂ§ñÈÉ®ÊúçÂä°ÁöÑÈÄö‰ø°"><code>containerd</code> Êèí‰ª∂‰∏éÂ§ñÈÉ®ÊúçÂä°ÁöÑÈÄö‰ø°</a></li>
        <li><a href="#ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°">ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°</a></li>
      </ol>
    </li>
    <li><a href="#containerdÊ∫êÁ†ÅÂàÜÊûê">containerdÊ∫êÁ†ÅÂàÜÊûê</a>
      <ol>
        <li><a href="#containerdÂêØÂä®ÊµÅÁ®ã">containerdÂêØÂä®ÊµÅÁ®ã</a></li>
        <li><a href="#client‰∏écontainerdÂÆàÊä§ËøõÁ®ãÁöÑÈÄö‰ø°">client‰∏écontainerdÂÆàÊä§ËøõÁ®ãÁöÑÈÄö‰ø°</a></li>
      </ol>
    </li>
    <li><a href="#grpcÊ°ÜÊû∂‰∏≠ÁöÑrpcÈÄö‰ø°">gRPCÊ°ÜÊû∂‰∏≠ÁöÑRPCÈÄö‰ø°</a>
      <ol>
        <li><a href="#grpc-go-‰∏≠-rpc-ÈÄö‰ø°">gRPC-Go ‰∏≠ RPC ÈÄö‰ø°</a>
          <ol>
            <li><a href="#goÁâàÊú¨grpcÈÄö‰ø°Êú∫Âà∂Ê¶ÇËø∞">GoÁâàÊú¨gRPCÈÄö‰ø°Êú∫Âà∂Ê¶ÇËø∞</a></li>
            <li><a href="#goÁâàÊú¨grpcÊ∫êÁ†ÅÁªìÊûÑ">GoÁâàÊú¨gRPCÊ∫êÁ†ÅÁªìÊûÑ</a></li>
            <li><a href="#grpc-go-‰∏≠-rpc-ÈÄö‰ø°ÊµÅÁ®ãÁöÑÊ∫êÁ†ÅÂàÜÊûê">gRPC-Go ‰∏≠ RPC ÈÄö‰ø°ÊµÅÁ®ãÁöÑÊ∫êÁ†ÅÂàÜÊûê</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#containerd‰∏écontainerd-shimÈÄö‰ø°Êú∫Âà∂">Containerd‰∏éContainerd-shimÈÄö‰ø°Êú∫Âà∂</a>
      <ol>
        <li><a href="#ttrpc">ttRPC</a></li>
        <li><a href="#unix-ÂüüÂ•óÊé•Â≠ó">Unix ÂüüÂ•óÊé•Â≠ó</a></li>
        <li><a href="#ÂÆπÂô®ÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜ">ÂÆπÂô®ÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜ</a></li>
        <li><a href="#ÂÆπÂô®‰∏éÂÆàÊä§ËøõÁ®ãÁöÑÂàÜÁ¶ª">ÂÆπÂô®‰∏éÂÆàÊä§ËøõÁ®ãÁöÑÂàÜÁ¶ª</a></li>
      </ol>
    </li>
    <li><a href="#containerd-shim‰∏écontainerÈÄö‰ø°Êú∫Âà∂">Containerd-shim‰∏éContainerÈÄö‰ø°Êú∫Âà∂</a>
      <ol>
        <li><a href="#ÈÄö‰ø°ÊµÅÁ®ã">ÈÄö‰ø°ÊµÅÁ®ã</a></li>
        <li><a href="#Ê∫êÁ†ÅËß£Êûê">Ê∫êÁ†ÅËß£Êûê</a></li>
      </ol>
    </li>
    <li><a href="#ÂÆπÂô®ÂêØÂä®ÊµÅÁ®ãÂàÜÊûê">ÂÆπÂô®ÂêØÂä®ÊµÅÁ®ãÂàÜÊûê</a></li>
    <li><a href="#ÈóÆÈ¢ò‰∏éËß£Á≠î">ÈóÆÈ¢ò‰∏éËß£Á≠î</a></li>
    <li><a href="#ÂèÇËÄÉËµÑÊñô">ÂèÇËÄÉËµÑÊñô</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/">
                <img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1_hu15168000030692408952.jpg"
                        srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1_hu15168000030692408952.jpg 800w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/1_hu16839679216868040932.jpg 1600w"
                        width="800" 
                        height="419" 
                        loading="lazy"
                        alt="Featured image of post containerdÈÄö‰ø°Êú∫Âà∂ÂàÜÊûê" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%8A%80%E6%9C%AF%E6%A1%86%E6%9E%B6/" style="background-color: #D81A31; color: #fff;">
                ÊäÄÊúØÊ°ÜÊû∂
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/">containerdÈÄö‰ø°Êú∫Âà∂ÂàÜÊûê</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Ê∑±ÂÖ•ÂàÜÊûêcontainerdÊ∫êÁ†Å
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-10-23</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 57 ÂàÜÈíü
                </time>
            </div>
        
        <div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
  <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
  <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
</svg>
                <time class="article-words">
                    28084Â≠ó
                </time>
        </div>
        

    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="containerdÈÄö‰ø°Êú∫Âà∂">containerdÈÄö‰ø°Êú∫Âà∂
</h1><h2 id="ÁÆÄËø∞">ÁÆÄËø∞
</h2><p>Containerd ÊòØ‰∏Ä‰∏™‰∫ëÂéüÁîüÔºàÂÆπÂô®ÔºâÈ¢ÜÂüüË°å‰∏öÊ†áÂáÜÂÆπÂô®ËøêË°åÊó∂„ÄÇ‰ª•Êìç‰ΩúÁ≥ªÁªüÂÆàÊä§ËøõÁ®ãÊñπÂºèÊèê‰æõÊúçÂä°ÔºåÁÆ°ÁêÜ‰∏ÄÂè∞Êú∫Âô®‰∏äÊØè‰∏™ÂÆπÂô®ÁîüÂëΩÂë®ÊúüÔºåÂåÖÊã¨Ôºö</p>
<ul>
<li>ÈïúÂÉè‰∏ãËΩΩÂíåÂ≠òÂÇ®„ÄÇ</li>
<li>ÂÆπÂô® rootfs ÔºàÊ†πÊñá‰ª∂Á≥ªÁªüÔºâÁöÑÁîüÊàê„ÄÇ</li>
<li>ÂÆπÂô®ÁöÑÂêØÂä®ÂíåÂÆàÊä§„ÄÇ</li>
<li>ÂÆπÂô®ÁöÑ‰ΩéÁ∫ßÂ≠òÂÇ®ÂíåÈôÑÂä†ÁΩëÁªú„ÄÇ</li>
</ul>
<p>Containerd ÊòØ CNCF ÊØï‰∏öÈ°πÁõÆÔºåÊòØ Kubernetes Âíå Docker ÁöÑÈªòËÆ§ÂÆπÂô®ËøêË°åÊó∂„ÄÇ</p>
<p>Containerd ÂÆàÊä§ËøõÁ®ãÈªòËÆ§Êèê‰æõ‰∫Ü‰∏§Â•ó APIÔºö</p>
<ul>
<li>Containerd ÂéüÁîü GRPC API Ôºà<a class="link" href="https://github.com/containerd/containerd/blob/v1.7.0/api/README.md"  target="_blank" rel="noopener"
    >Ê∫êÁ†Å</a>ÔºâÔºåÂπ∂Êèê‰æõ‰∫Ü Go SDK ÔºàÂèÇËßÅÔºö<a class="link" href="https://github.com/containerd/containerd/blob/v1.7.0/client.go"  target="_blank" rel="noopener"
    >Ê∫êÁ†Å</a>ÔºâÔºåDocker ‰ª•ËØ•ÊñπÂºèÈõÜÊàê Containerd„ÄÇ</li>
<li>Kubernetes ÁöÑ CRI GRPC APIÔºà<a class="link" href="https://github.com/containerd/containerd/blob/main/pkg/cri/cri.go"  target="_blank" rel="noopener"
    >Ê∫êÁ†Å</a>ÔºâÔºåÂΩ¢ÊÄÅ‰∏äÈÄöËøá Containerd Plugin ÁöÑÊñπÂºèÊèê‰æõÊúçÂä°ÔºàÂéüÁîüÊèí‰ª∂ÔºåÊâìÂåÖÂà∞‰∫Ü Containerd ‰∫åËøõÂà∂‰∏≠ÔºâÔºåÊû∂ÊûÑÂèÇËßÅÔºö<a class="link" href="https://github.com/containerd/containerd/blob/v1.7.0/docs/cri/architecture.md"  target="_blank" rel="noopener"
    >docs</a>„ÄÇKubernetes ‰ª•ËØ•ÊñπÂºèÈõÜÊàê Containerd„ÄÇ</li>
</ul>
<p>Âú®Â∫ïÂ±ÇÂÆπÂô®ËøêË°åÊó∂ÊñπÈù¢ÔºåContainerd ÈááÁî® <a class="link" href="https://github.com/opencontainers/runtime-spec"  target="_blank" rel="noopener"
    >OCI-runtime</a> Ê†áÂáÜÔºåÈªòËÆ§‰ΩøÁî® runc ‰Ωú‰∏∫ËøêË°åÊó∂„ÄÇ</p>
<p>ÁÆÄÂçïÊ¶ÇËø∞ÂÖ∏ÂûãÂú∫ÊôØ‰∏≠ Kubernetes„ÄÅContainerd„ÄÅRunc ÁöÑ Â±ÇÁ∫ßÂÖ≥Á≥ªÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>Kubernetes Ë¥üË¥£ÈõÜÁæ§ÔºàÂ§öËäÇÁÇπÔºâÁöÑË∞ÉÂ∫¶ÂíåÁÆ°ÁêÜÔºåÂú®Âçï‰∏™ËäÇÁÇπÔºåÈÄöËøá Kubelet ÁªÑ‰ª∂ÈÄöËøá CRI GRPC Êé•Âè£Ë∞ÉÁî® Containerd„ÄÇ</li>
<li>Containerd Êèê‰æõÂçï‰∏™ËäÇÁÇπÁöÑÂÆπÂô®ÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜÔºåÂåÖÊã¨ÈïúÂÉè„ÄÅÂ≠òÂÇ®„ÄÅrootfs„ÄÅÁΩëÁªúÔºåÂêØÂä®ÂÆπÂô®ÊòØ Containerd ÈÄöËøá <a class="link" href="https://github.com/opencontainers/runtime-spec"  target="_blank" rel="noopener"
    >OCI-runtime</a> Ê†áÂáÜË∞ÉÁî® runc„ÄÇ</li>
<li>Runc ÂÆπÂô®ÂºïÂØºÂô®ÔºåË¥üË¥£Ê†πÊçÆ‰∏Ä‰∏™ÂÆπÂô®ÁöÑÂÖ∑‰ΩìÈÖçÁΩÆÔºåÂú®ÊåáÂÆö rootfs ‰∏äÂºïÂØºÂêØÂä®‰∏Ä‰∏™ÂÆπÂô®ËøõÁ®ã„ÄÇ</li>
</ul>
<p><img src="https://containerd.io/img/architecture.png"
	
	
	
	loading="lazy"
	
		alt="img"
	
	
></p>
<h2 id="grpcÊ°ÜÊû∂ÂéüÁêÜ">gRPCÊ°ÜÊû∂ÂéüÁêÜ
</h2><p>gRPCÔºàGoogle Remote Procedure CallÔºâÊòØ‰∏Ä‰∏™Áé∞‰ª£Âåñ„ÄÅÈ´òÊÄßËÉΩÁöÑËøúÁ®ãËøáÁ®ãË∞ÉÁî®ÔºàRPCÔºâÊ°ÜÊû∂ÔºåËÆæËÆ°Áî®‰∫éÂú®ÂàÜÂ∏ÉÂºèÁ≥ªÁªü‰∏≠ÂÆûÁé∞Ë∑®ÁΩëÁªú„ÄÅË∑®ËØ≠Ë®ÄÁöÑÊúçÂä°Ë∞ÉÁî®„ÄÇÂÆÉÂà©Áî®‰∫Ü HTTP/2 Âíå Protocol BuffersÔºå‰∏∫ÂºÄÂèëËÄÖÊèê‰æõ‰∫Ü‰∏ÄÁßçÁÆÄ‰æøÁöÑÊñπÂºèÊù•Ë∞ÉÁî®ËøúÁ®ãÊúçÂä°ÔºåÂ∞±ÂÉèË∞ÉÁî®Êú¨Âú∞ÂáΩÊï∞‰∏ÄÊ†∑„ÄÇ‰∏ãÈù¢ÊòØ gRPC ÁöÑÂü∫Êú¨ÂéüÁêÜÂèäÂÖ∂ÂÖ≥ÈîÆÁªÑ‰ª∂„ÄÇ</p>
<h3 id="grpc-ÁöÑÂ∑•‰ΩúÊµÅÁ®ã">gRPC ÁöÑÂ∑•‰ΩúÊµÅÁ®ã
</h3><h4 id="ÊúçÂä°ÂÆö‰πâ‰∏éÊé•Âè£ÁîüÊàê">ÊúçÂä°ÂÆö‰πâ‰∏éÊé•Âè£ÁîüÊàê
</h4><ul>
<li>
<p><strong>Protocol Buffers ÂÆö‰πâÊúçÂä°</strong>: <code>containerd</code> ‰ΩøÁî® Protocol BuffersÔºàprotobufÔºâÊù•ÂÆö‰πâ gRPC ÊúçÂä°„ÄÇËøô‰∫õÊúçÂä°Êé•Âè£ÂíåÊ∂àÊÅØÁªìÊûÑÈÄöÂ∏∏ÂÆö‰πâÂú® <code>.proto</code> Êñá‰ª∂‰∏≠„ÄÇ‰æãÂ¶ÇÔºå<code>containers.proto</code> Êñá‰ª∂ÂÆö‰πâ‰∫ÜÂÆπÂô®ÁÆ°ÁêÜÁöÑÊúçÂä°Êé•Âè£„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">protobufCopy codesyntax = &#34;proto3&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">service Containers {
</span></span><span class="line"><span class="cl">    rpc Create (CreateContainerRequest) returns (CreateContainerResponse);
</span></span><span class="line"><span class="cl">    rpc Start (StartContainerRequest) returns (StartContainerResponse);
</span></span><span class="line"><span class="cl">    rpc Stop (StopContainerRequest) returns (StopContainerResponse);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">message CreateContainerRequest {
</span></span><span class="line"><span class="cl">    string id = 1;
</span></span><span class="line"><span class="cl">    // ÂÖ∂‰ªñÂ≠óÊÆµ...
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">message CreateContainerResponse {
</span></span><span class="line"><span class="cl">    // ÂìçÂ∫îÂ≠óÊÆµ...
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ÁîüÊàêÂÆ¢Êà∑Á´ØÂíåÊúçÂä°Á´Ø‰ª£Á†Å</strong>: ‰ΩøÁî® <code>protoc</code> ÁºñËØëÂô®Ôºå<code>.proto</code> Êñá‰ª∂‰ºöÁîüÊàêÁõ∏Â∫îÁöÑÂÆ¢Êà∑Á´ØÂíåÊúçÂä°Á´Ø‰ª£Á†Å„ÄÇÂØπ‰∫é <code>containerd</code>ÔºåËøô‰∫õÁîüÊàêÁöÑ‰ª£Á†ÅÊòØ‰∏é <code>containerd</code> Ê†∏ÂøÉÂäüËÉΩÈõÜÊàêÂú®‰∏ÄËµ∑ÁöÑÔºåÂÆ¢Êà∑Á´Ø‰ª£Á†ÅÈÄöÂ∏∏Áî±Â§ñÈÉ®Â∑•ÂÖ∑ÊàñÊúçÂä°‰ΩøÁî®„ÄÇ</p>
</li>
</ul>
<h4 id="grpc-ÊúçÂä°ÁöÑÂÆûÁé∞">gRPC ÊúçÂä°ÁöÑÂÆûÁé∞
</h4><ul>
<li>
<p><strong>ÊúçÂä°ÂÆûÁé∞</strong>: <code>containerd</code> ‰∏≠ÊØè‰∏™ gRPC ÊúçÂä°ÈÉΩÊúâ‰∏Ä‰∏™ÂÖ∑‰ΩìÁöÑÂÆûÁé∞ÔºåËøô‰∫õÂÆûÁé∞Ë¥üË¥£Â§ÑÁêÜÊù•Ëá™ÂÆ¢Êà∑Á´ØÁöÑËØ∑Ê±ÇÂπ∂ÊâßË°åÁõ∏Â∫îÁöÑÊìç‰Ωú„ÄÇÊúçÂä°ÁöÑÂÆûÁé∞ÈÄöÂ∏∏‰Ωç‰∫é <code>containerd</code> ÁöÑ <code>services</code> ÁõÆÂΩï‰∏≠Ôºå‰∏ãÈù¢ÊòØ‰∏Ä‰∏™Á§∫‰æã„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">containersServer</span> <span class="n">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">Áõ∏ÂÖ≥Â≠óÊÆµÂíå‰æùËµñÊ≥®ÂÖ•</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">containersServer</span><span class="p">)</span> <span class="n">Create</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">CreateContainerRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">CreateContainerResponse</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">ÂÆûÁé∞ÂÆπÂô®ÂàõÂª∫ÈÄªËæë</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">containersServer</span><span class="p">)</span> <span class="n">Start</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">StartContainerRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">StartContainerResponse</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="err">ÂÆûÁé∞ÂÆπÂô®ÂêØÂä®ÈÄªËæë</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="err">ÂÖ∂‰ªñÊúçÂä°ÊñπÊ≥ï</span><span class="o">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ÊúçÂä°Ê≥®ÂÜå</strong>: Âú® <code>containerd</code> ÂêØÂä®Êó∂ÔºågRPC ÊúçÂä°Âô®‰ºöÂêØÂä®Âπ∂ÁõëÂê¨‰∏Ä‰∏™ Unix Domain Socket (UDS) Âú∞ÂùÄÊàñ TCP Á´ØÂè£ÔºåÁÑ∂ÂêéÂ∞ÜÊâÄÊúâÁöÑÊúçÂä°Ê≥®ÂÜåÂà∞ gRPC ÊúçÂä°Âô®‰∏≠„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">grpcServer := grpc.NewServer()
</span></span><span class="line"><span class="cl">containerspb.RegisterContainersServer(grpcServer, &amp;containersService)
</span></span><span class="line"><span class="cl">// Ê≥®ÂÜåÂÖ∂‰ªñÊúçÂä°...
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="grpc-ÈÄö‰ø°Êú∫Âà∂">gRPC ÈÄö‰ø°Êú∫Âà∂
</h4><ul>
<li><strong>ËØ∑Ê±ÇÁöÑÂèëÈÄÅ‰∏éÊé•Êî∂</strong>: ÂÆ¢Êà∑Á´ØÈÄöËøáÁîüÊàêÁöÑ gRPC ÂÆ¢Êà∑Á´Ø‰ª£Á†ÅÂêë <code>containerd</code> ÂèëÈÄÅËØ∑Ê±Ç„ÄÇËØ∑Ê±ÇÈÄöËøá gRPC Ê°ÜÊû∂Âú®ÂÆ¢Êà∑Á´ØËøõË°åÂ∫èÂàóÂåñÔºà‰ΩøÁî® Protocol BuffersÔºâÔºåÁÑ∂ÂêéÈÄöËøáÂ∫ïÂ±Ç‰º†ËæìÂçèËÆÆÔºàÈÄöÂ∏∏ÊòØ HTTP/2 over Unix Domain SocketsÔºâÂèëÈÄÅÂà∞ <code>containerd</code>„ÄÇ</li>
<li><strong>ÊúçÂä°Âô®Á´ØÂ§ÑÁêÜ</strong>: <code>containerd</code> ÁöÑ gRPC ÊúçÂä°Âô®Êé•Êî∂Âà∞ËØ∑Ê±ÇÂêéÔºåÂ∞ÜÂÖ∂ÂèçÂ∫èÂàóÂåñ‰∏∫Áõ∏Â∫îÁöÑÊ∂àÊÅØÂØπË±°ÔºåÂπ∂Ë∞ÉÁî®ÂØπÂ∫îÊúçÂä°ÁöÑÂÆûÁé∞ÊñπÊ≥ïËøõË°åÂ§ÑÁêÜ„ÄÇÂ§ÑÁêÜÂÆåÊàêÂêéÔºåÂìçÂ∫îÁªìÊûúÂÜçÈÄöËøá gRPC ËøîÂõûÁªôÂÆ¢Êà∑Á´Ø„ÄÇ</li>
<li><strong>ËøûÊé•ÁÆ°ÁêÜ</strong>: gRPC ÊîØÊåÅÈïøËøûÊé•ÔºåÂ§ö‰∏™ËØ∑Ê±ÇÂèØ‰ª•Âú®Âêå‰∏Ä‰∏™ËøûÊé•‰∏≠Âπ∂ÂèëËøõË°å„ÄÇÂØπ‰∫éÊú¨Âú∞ÈÄö‰ø°Ôºå<code>containerd</code> ÈÄöÂ∏∏‰ΩøÁî® Unix Domain Sockets (UDS) ‰Ωú‰∏∫‰º†ËæìÂ±ÇÔºåÊèêÂçáÈÄö‰ø°ÊïàÁéáÂπ∂Â¢ûÂº∫ÂÆâÂÖ®ÊÄß„ÄÇ</li>
</ul>
<h4 id="ÂÖ≥ÈîÆÂ∫îÁî®Âú∫ÊôØ">ÂÖ≥ÈîÆÂ∫îÁî®Âú∫ÊôØ
</h4><ul>
<li><strong>ÂÆ¢Êà∑Á´Ø‰∏é <code>containerd</code> ÁöÑÈÄö‰ø°</strong>: Â§ñÈÉ®ÂÆ¢Êà∑Á´ØÔºàÂ¶Ç <code>ctr</code> Â∑•ÂÖ∑Êàñ Docker ÂºïÊìéÔºâÈÄöËøá gRPC ‰∏é <code>containerd</code> ËøõË°åÈÄö‰ø°ÔºåÊâßË°åÂÆπÂô®ÁöÑÂàõÂª∫„ÄÅÂêØÂä®„ÄÅÂÅúÊ≠¢„ÄÅÂà†Èô§Á≠âÊìç‰Ωú„ÄÇ</li>
<li><strong><code>containerd</code> Êèí‰ª∂ÁöÑÈõÜÊàê</strong>: Êèí‰ª∂ÈÄöËøá gRPC Êèê‰æõÊúçÂä°Êé•Âè£Ôºå<code>containerd</code> Ê†∏ÂøÉÈÄöËøáË∞ÉÁî®Ëøô‰∫õÊé•Âè£Êù•ÁÆ°ÁêÜÈïúÂÉè„ÄÅÂø´ÁÖßÂíåÂÆπÂô®ËøêË°åÊó∂Á≠â„ÄÇ</li>
<li><strong><code>containerd-shim</code> ‰∏é <code>containerd</code> ÁöÑÈÄö‰ø°</strong>: <code>containerd-shim</code> ËøõÁ®ãË¥üË¥£ÁÆ°ÁêÜÊØè‰∏™ÂÆπÂô®ÁöÑÁîüÂëΩÂë®ÊúüÔºå‰∏é <code>containerd</code> Ê†∏ÂøÉÈÄöËøá gRPC ÈÄö‰ø°Êù•Êä•ÂëäÂÆπÂô®Áä∂ÊÄÅ„ÄÅÊé•Êî∂ÁÆ°ÁêÜÂëΩ‰ª§Á≠â„ÄÇ</li>
</ul>
<h2 id="grpc‰∏≠‰ΩøÁî®udsÁöÑÂú∫ÊôØ">gRPC‰∏≠‰ΩøÁî®UDSÁöÑÂú∫ÊôØ
</h2><p>Âú® <code>containerd</code> ‰∏≠ÔºåUnix Domain Sockets (UDS) ÈÄö‰ø°ÈÄöÂ∏∏Áî®‰∫é‰ª•‰∏ãÂú∫ÊôØÔºö</p>
<h3 id="containerd-ÂÆàÊä§ËøõÁ®ã‰∏éÂÆ¢Êà∑Á´Ø‰πãÈó¥ÁöÑÈÄö‰ø°"><code>containerd</code> ÂÆàÊä§ËøõÁ®ã‰∏éÂÆ¢Êà∑Á´Ø‰πãÈó¥ÁöÑÈÄö‰ø°
</h3><ul>
<li><strong>Âú∫ÊôØ</strong>: <code>containerd</code> ÂÆàÊä§ËøõÁ®ã‰∏éÂ§ñÈÉ®ÂÆ¢Êà∑Á´ØÔºàÂ¶Ç <code>ctr</code> Â∑•ÂÖ∑Êàñ Docker ÂºïÊìéÔºâ‰πãÈó¥ÁöÑÈÄö‰ø°„ÄÇ</li>
<li><strong>‰æãÂ≠ê</strong>: ÂΩì Docker ÂºïÊìéÈúÄË¶Å‰∏é <code>containerd</code> ‰∫§‰∫íÊó∂ÔºåÂÆÉÈÄöËøá gRPC ËøûÊé•Âà∞ <code>containerd</code> ÁöÑ UDS Âú∞ÂùÄÔºåÂ¶Ç <code>/run/containerd/containerd.sock</code>Ôºå‰ª•ËØ∑Ê±ÇÁÆ°ÁêÜÂÆπÂô®„ÄÅÈïúÂÉè„ÄÅÂø´ÁÖßÁ≠âÊìç‰Ωú„ÄÇ</li>
<li>ËØ¶ÁªÜÊèèËø∞:
<ul>
<li><code>containerd</code> ÂêØÂä®Êó∂Ôºå‰ºöÂú®ÈÖçÁΩÆÁöÑÂú∞ÂùÄÔºàÈÄöÂ∏∏ÊòØ <code>/run/containerd/containerd.sock</code>Ôºâ‰∏äÂàõÂª∫‰∏Ä‰∏™ UDS ÁõëÂê¨Âô®„ÄÇ</li>
<li>Docker ÂºïÊìéÊàñÂÖ∂‰ªñÂÆ¢Êà∑Á´ØÈÄöËøá gRPC ËøûÊé•Âà∞Ëøô‰∏™ UDS Âú∞ÂùÄÊù•‰∏é <code>containerd</code> ‰∫§‰∫í„ÄÇ</li>
<li>ËøôÁßçÊñπÂºèÈÅøÂÖç‰∫ÜÁΩëÁªúÂºÄÈîÄÔºåÂπ∂ÈôêÂà∂‰∫ÜÈÄö‰ø°Âè™ËÉΩÂèëÁîüÂú®Êú¨Âú∞‰∏ªÊú∫‰∏äÔºåÊèêÈ´ò‰∫ÜÂÆâÂÖ®ÊÄß„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="containerd-shim-‰∏é-containerd-ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°"><code>containerd-shim</code> ‰∏é <code>containerd</code> ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°
</h3><ul>
<li><strong>Âú∫ÊôØ</strong>: ÊØè‰∏™ÂÆπÂô®ÈÉΩÊúâ‰∏Ä‰∏™ <code>containerd-shim</code> ËøõÁ®ãÔºå<code>containerd-shim</code> Ë¥üË¥£ÁÆ°ÁêÜÂÆπÂô®ÁöÑÁîüÂëΩÂë®ÊúüÔºåËÄå <code>containerd-shim</code> ‰∏é <code>containerd</code> ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°‰πüÊòØÈÄöËøá UDS ÂÆûÁé∞ÁöÑ„ÄÇ</li>
<li><strong>‰æãÂ≠ê</strong>: ÂΩì <code>containerd</code> ÂêØÂä®‰∏Ä‰∏™Êñ∞ÁöÑÂÆπÂô®Êó∂ÔºåÂÆÉ‰ºöÂàõÂª∫Âπ∂ÂêØÂä®‰∏Ä‰∏™ÂØπÂ∫îÁöÑ <code>containerd-shim</code> ËøõÁ®ã„ÄÇ<code>containerd-shim</code> ÈÄöËøá‰∏Ä‰∏™ UDS ‰∏é <code>containerd</code> ËøõË°åÈÄö‰ø°Ôºå‰ª•Êä•ÂëäÂÆπÂô®ÁöÑÁä∂ÊÄÅÂíåÊé•ÂèóÂëΩ‰ª§„ÄÇ</li>
<li>ËØ¶ÁªÜÊèèËø∞:
<ul>
<li><code>containerd-shim</code> ËøõÁ®ã‰ºö‰∏∫ÊØè‰∏™ÂÆπÂô®ÂàõÂª∫‰∏Ä‰∏™ UDSÔºåÁî®‰∫é‰∏é <code>containerd</code> ‰∫§‰∫í„ÄÇ</li>
<li>ÈÄöËøáËøô‰∏™ UDSÔºå<code>containerd</code> ÂèØ‰ª•Âêë <code>containerd-shim</code> ÂèëÈÄÅÊåá‰ª§ÔºåÂ¶ÇÂêØÂä®ÊàñÂÅúÊ≠¢ÂÆπÂô®ÔºåÂπ∂Êé•Êî∂Êù•Ëá™ <code>containerd-shim</code> ÁöÑÁä∂ÊÄÅÊõ¥Êñ∞„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="containerd-Êèí‰ª∂‰∏éÂ§ñÈÉ®ÊúçÂä°ÁöÑÈÄö‰ø°"><code>containerd</code> Êèí‰ª∂‰∏éÂ§ñÈÉ®ÊúçÂä°ÁöÑÈÄö‰ø°
</h3><ul>
<li><strong>Âú∫ÊôØ</strong>: Êüê‰∫õÊèí‰ª∂ÂèØËÉΩ‰Ωú‰∏∫Â§ñÈÉ®ÊúçÂä°ËøêË°åÔºåÈúÄË¶ÅÈÄöËøá UDS ‰∏é <code>containerd</code> ÈÄö‰ø°„ÄÇ</li>
<li><strong>‰æãÂ≠ê</strong>: ‰∏Ä‰∫õÂ§ñÈÉ®Â≠òÂÇ®Êèí‰ª∂ÂèØËÉΩÁã¨Á´ãËøêË°åÂπ∂ÈÄöËøá UDS Êö¥Èú≤ÂÖ∂ gRPC ÊúçÂä°Ôºå<code>containerd</code> ÈÄöËøáËøûÊé•Ëøô‰∏™ UDS Êù•Ë∞ÉÁî®Êèí‰ª∂ÁöÑÊúçÂä°„ÄÇ</li>
<li>ËØ¶ÁªÜÊèèËø∞:
<ul>
<li>Êèí‰ª∂ÂèØ‰ª•Âú®‰∏çÂêåÁöÑËøõÁ®ã‰∏≠ËøêË°åÔºåÈÄöËøá UDS Êö¥Èú≤ÂÖ∂ÊúçÂä°Êé•Âè£„ÄÇ</li>
<li><code>containerd</code> ËøûÊé•Âà∞Ëøô‰∫õ UDS Âú∞ÂùÄÊù•‰∏éÊèí‰ª∂‰∫§‰∫íÔºåÊâßË°åËØ∏Â¶ÇÂ≠òÂÇ®ÁÆ°ÁêÜÊàñÁΩëÁªúÁÆ°ÁêÜÁ≠âÊìç‰Ωú„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°">ÂÆàÊä§ËøõÁ®ã‰πãÈó¥ÁöÑÈÄö‰ø°
</h3><ul>
<li><strong>Âú∫ÊôØ</strong>: Â¶ÇÊûúÈúÄË¶ÅÂú®Â§ö‰∏™ÂÆàÊä§ËøõÁ®ãÔºà‰æãÂ¶Ç <code>containerd</code> ÂíåÂÖ∂‰ªñ‰æùËµñÊúçÂä°Ôºâ‰πãÈó¥Âª∫Á´ãÂÆâÂÖ®‰∏îÈ´òÊïàÁöÑÊú¨Âú∞ÈÄö‰ø°ÔºåÂèØ‰ª•‰ΩøÁî® UDS„ÄÇ</li>
<li><strong>‰æãÂ≠ê</strong>: Âú®‰∏Ä‰∫õÂ§çÊùÇÁöÑÈõÜÁæ§ÁéØÂ¢É‰∏≠Ôºå<code>containerd</code> ÂèØËÉΩÈúÄË¶Å‰∏éÂÖ∂‰ªñÂÆàÊä§ËøõÁ®ãÔºàÂ¶Ç CRI-O„ÄÅetcd Á≠âÔºâËøõË°åÊú¨Âú∞ÈÄö‰ø°ÔºåËøôÁßçÊÉÖÂÜµ‰∏ã‰πüÂèØËÉΩ‰ΩøÁî® UDS„ÄÇ</li>
<li>ËØ¶ÁªÜÊèèËø∞:
<ul>
<li>Â§ö‰∏™ÂÆàÊä§ËøõÁ®ãÂú®Âêå‰∏ÄÂè∞‰∏ªÊú∫‰∏äËøêË°åÊó∂ÔºåÈÄöËøá UDS ÈÄö‰ø°ÔºåÈÅøÂÖç‰∫Ü‰ΩøÁî® TCP/IP Â∏¶Êù•ÁöÑÁΩëÁªúÂºÄÈîÄÂíåÂÆâÂÖ®È£éÈô©„ÄÇ</li>
</ul>
</li>
</ul>
<h2 id="containerdÊ∫êÁ†ÅÂàÜÊûê">containerdÊ∫êÁ†ÅÂàÜÊûê
</h2><h3 id="containerdÂêØÂä®ÊµÅÁ®ã">containerdÂêØÂä®ÊµÅÁ®ã
</h3><blockquote>
<p>Êñá‰ª∂Ë∑ØÂæÑÔºö<code>containerd/cmd/containerd/main.go</code>ÔºåÊï¥‰∏™Á®ãÂ∫è‰ªéËøôÈáåÂºÄÂßãÂêØÂä®ÔºåË∞ÉÁî®command.App()ÂáΩÊï∞„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;crypto&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/containerd/containerd/v2/cmd/containerd/command&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;github.com/containerd/containerd/v2/internal/hasher&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span> <span class="s">&#34;github.com/containerd/containerd/v2/cmd/containerd/builtins&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">crypto</span><span class="p">.</span><span class="nf">RegisterHash</span><span class="p">(</span><span class="nx">crypto</span><span class="p">.</span><span class="nx">SHA256</span><span class="p">,</span> <span class="nx">hasher</span><span class="p">.</span><span class="nx">NewSHA256</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">command</span><span class="p">.</span><span class="nf">App</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;containerd: %s\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Êñá‰ª∂Ë∑ØÂæÑÔºö<code>containerd/cmd/containerd/command/main.go</code>ÔºåËØ•Êñá‰ª∂‰∏ªË¶ÅÁî®‰∫éÂÆûÁé∞ <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÁöÑÂêØÂä®ÂíåÁÆ°ÁêÜÈÄªËæë„ÄÇËØ•‰ª£Á†ÅÂåÖÊã¨‰∫ÜÂ¶Ç‰ΩïÂàùÂßãÂåñ <code>containerd</code> ÂÆàÊä§ËøõÁ®ã„ÄÅËß£ÊûêÂëΩ‰ª§Ë°åÂèÇÊï∞„ÄÅËÆæÁΩÆÈÖçÁΩÆÈ°πÔºå‰ª•ÂèäÂ§ÑÁêÜ‰ø°Âè∑ÂíåÊúçÂä°ÁªàÊ≠¢„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// App returns a *cli.App instance.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">App</span><span class="p">()</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">App</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span> <span class="o">:=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">NewApp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="s">&#34;containerd&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="nx">version</span><span class="p">.</span><span class="nx">Version</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Usage</span> <span class="p">=</span> <span class="nx">usage</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Flags</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Flags</span><span class="p">,</span> <span class="nf">serviceFlags</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Commands</span> <span class="p">=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">configCommand</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">publishCommand</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ociHook</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">app</span><span class="p">.</span><span class="nx">Action</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cliContext</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">start</span>       <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">signals</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">serverC</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">config</span>      <span class="p">=</span> <span class="nf">defaultConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//¬∑¬∑¬∑Ê≠§Â§ÑÁúÅÁï•ÈÉ®ÂàÜ‰ª£Á†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="kd">var</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nf">isLocalAddress</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">GID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeDebug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for metrics endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// setup the ttrpc endpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main ttrpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tl</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTTRPC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for TCP grpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTCP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// setup the main grpc endpoint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeGRPC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">readyC</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">server</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nb">close</span><span class="p">(</span><span class="nx">readyC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}()</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">app</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="nx">serveFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Addr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;serving...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serveFunc</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;serve failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//¬∑¬∑¬∑Ê≠§Â§ÑÁúÅÁï•ÈÉ®ÂàÜ‰ª£Á†Å
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ËØ¶ÁªÜÂàÜÊûêÔºàÊàëÂè™Êåë‰∫õÈáçÁÇπÁöÑÂàÜÊûêÔºâÔºö</strong></p>
<p><strong>‰∏ªÈÄªËæë (<code>app.Action</code>)</strong></p>
<blockquote>
<p><code>app.Action</code> ‰∏≠ÁöÑ‰∏ªÈÄªËæëÊòØ <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÂêØÂä®ÁöÑÊ†∏ÂøÉÈÉ®ÂàÜ„ÄÇÂÆÉÂåÖÊã¨ÂàùÂßãÂåñ‰∏ä‰∏ãÊñá„ÄÅÂä†ËΩΩÂíåÂ∫îÁî®ÈÖçÁΩÆ„ÄÅÂêØÂä® gRPC Âíå TTRPC ÊúçÂä°„ÄÅ‰ø°Âè∑Â§ÑÁêÜÔºå‰ª•ÂèäÊúÄÁªàÁöÑÊúçÂä°ÂêØÂä®ÂíåÁÆ°ÁêÜ„ÄÇ‰ª•‰∏ãÊòØÂØπ‰∏ªÈÄªËæëÁöÑËØ¶ÁªÜÂàÜÊûêÔºö</p>
</blockquote>
<ol>
<li>
<p><strong>ÂàùÂßãÂåñ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">start</span>       <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">signals</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">2048</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">serverC</span>     <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span>      <span class="p">=</span> <span class="nf">defaultConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Êó∂Èó¥ËÆ∞ÂΩï (<code>start</code>)</strong>: ËÆ∞ÂΩïÂÆàÊä§ËøõÁ®ãÂêØÂä®ÁöÑÊó∂Èó¥ÔºåÁî®‰∫éÂêéÁª≠Êó•ÂøóËÆ∞ÂΩïÂêØÂä®ËÄóÊó∂„ÄÇ</p>
<p><strong>‰ø°Âè∑ÈÄöÈÅì (<code>signals</code>)</strong>: ÂàõÂª∫‰∏Ä‰∏™ÁºìÂÜ≤Âå∫‰∏∫ 2048 ÁöÑÈÄöÈÅìÔºåÁî®‰∫éÊé•Êî∂Á≥ªÁªü‰ø°Âè∑ÔºåÂ¶Ç <code>SIGTERM</code> Êàñ <code>SIGHUP</code>Ôºå‰ª•‰æøËøõË°å‰ºòÈõÖÁöÑÂÖ≥Èó≠Êìç‰Ωú„ÄÇ</p>
<p><strong>ÊúçÂä°Âô®ÈÄöÈÅì (<code>serverC</code>)</strong>: Áî®‰∫éÂú®ÂºÇÊ≠•ÂàùÂßãÂåñÂÆåÊàêÂêé‰º†ÈÄí <code>containerd</code> ÊúçÂä°Âô®ÂÆû‰æã„ÄÇ</p>
<p><strong>‰∏ä‰∏ãÊñá (<code>ctx, cancel</code>)</strong>: ‰ΩøÁî® <code>context.WithCancel</code> ÂàõÂª∫‰∏Ä‰∏™ÂèØÂèñÊ∂àÁöÑ‰∏ä‰∏ãÊñáÔºåÁ°Æ‰øùÂú®ÈúÄË¶ÅÊó∂ËÉΩÂ§üÂèñÊ∂àÊâÄÊúâ‰∏é‰∏ä‰∏ãÊñáÂÖ≥ËÅîÁöÑÊìç‰Ωú„ÄÇ</p>
<p><strong>ÈÖçÁΩÆ (<code>config</code>)</strong>: Ë∞ÉÁî® <code>defaultConfig()</code> ÂáΩÊï∞ÂàõÂª∫‰∏Ä‰∏™ÈªòËÆ§ÈÖçÁΩÆÂØπË±°ÔºåÁî®‰∫éÂ≠òÂÇ®Âä†ËΩΩÁöÑÈÖçÁΩÆÈÄâÈ°π„ÄÇ</p>
</li>
<li>
<p><strong>Âä†ËΩΩÂíåÂ∫îÁî®ÈÖçÁΩÆ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">configPath</span> <span class="o">:=</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;config&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">configPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">||</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">IsSet</span><span class="p">(</span><span class="s">&#34;config&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srvconfig</span><span class="p">.</span><span class="nf">LoadConfig</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">configPath</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑ</strong>: ‰ªéÂëΩ‰ª§Ë°åÂèÇÊï∞‰∏≠Ëé∑ÂèñÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑÔºà<code>configPath</code>ÔºâÔºåÈªòËÆ§ÊÉÖÂÜµ‰∏ãÊåáÂêë <code>/etc/containerd/config.toml</code> ÊàñÂÖ∂‰ªñÈªòËÆ§Ë∑ØÂæÑ„ÄÇ</p>
<p><strong>Ê£ÄÊü•ÈÖçÁΩÆÊñá‰ª∂Â≠òÂú®ÊÄß</strong>: ‰ΩøÁî® <code>os.Stat</code> Ê£ÄÊü•ÈÖçÁΩÆÊñá‰ª∂ÊòØÂê¶Â≠òÂú®ÔºåÊàñËÄÖÁî®Êà∑ÊòØÂê¶ÊòéÁ°ÆÊåáÂÆö‰∫ÜÈÖçÁΩÆÊñá‰ª∂Ë∑ØÂæÑ„ÄÇÂ¶ÇÊûúÂ≠òÂú®ÊàñÊåáÂÆö‰∫ÜË∑ØÂæÑÔºåË∞ÉÁî® <code>srvconfig.LoadConfig</code> Âä†ËΩΩÈÖçÁΩÆÊñá‰ª∂Âà∞ <code>config</code> ÂØπË±°‰∏≠„ÄÇ</p>
<p><strong>ÈîôËØØÂ§ÑÁêÜ</strong>: Â¶ÇÊûúÂä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•ÔºåÁ´ãÂç≥ËøîÂõûÈîôËØØÂπ∂ÁªàÊ≠¢ÂêØÂä®ÊµÅÁ®ã„ÄÇ</p>
</li>
<li>
<p><strong>Á°Æ‰øùÂøÖË¶ÅÈÖçÁΩÆÂ≠òÂú®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;grpc address cannot be empty: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrInvalidArgument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span> <span class="o">+</span> <span class="s">&#34;.ttrpc&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">UID</span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span> <span class="p">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">GID</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>È™åËØÅ gRPC Âú∞ÂùÄ</strong>: Á°Æ‰øù gRPC ÊúçÂä°ÁöÑÂú∞ÂùÄÂ∑≤Âú®ÈÖçÁΩÆ‰∏≠ËÆæÁΩÆ„ÄÇÂ¶ÇÊûúÊ≤°ÊúâËÆæÁΩÆÔºåÂàôËøîÂõûÈîôËØØÔºåÂõ†‰∏∫ gRPC Âú∞ÂùÄÊòØ <code>containerd</code> ÊúçÂä°ÁöÑÂÖ≥ÈîÆÈÖçÁΩÆ„ÄÇ</li>
<li><strong>ËÆæÁΩÆ TTRPC Âú∞ÂùÄ</strong>: Â¶ÇÊûú TTRPC Âú∞ÂùÄÊú™ÈÖçÁΩÆÔºåÂàô‰ΩøÁî® gRPC Âú∞ÂùÄÈôÑÂä† <code>.ttrpc</code> ‰Ωú‰∏∫ÈªòËÆ§Âú∞ÂùÄÔºåÂπ∂Â§çÂà∂ gRPC ÁöÑÁî®Êà∑ ID ÂíåÁªÑ ID ËÆæÁΩÆ„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>Â§ÑÁêÜÊúçÂä°Ê≥®ÂÜåÂíå‰ø°Âè∑</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">stop</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">registerUnregisterService</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Root</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">stop</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">done</span> <span class="o">:=</span> <span class="nf">handleSignals</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">signals</span><span class="p">,</span> <span class="nx">serverC</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">signals</span><span class="p">,</span> <span class="nx">handledSignals</span><span class="o">...</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÊúçÂä°Ê≥®ÂÜå/Ê≥®ÈîÄ</strong>: Ë∞ÉÁî® <code>registerUnregisterService</code> ÂáΩÊï∞ÔºåÂ§ÑÁêÜ Windows ÊúçÂä°ÁöÑÊ≥®ÂÜåÊàñÊ≥®ÈîÄ„ÄÇÂ¶ÇÊûúÂ§ÑÁêÜÂÆåÊØïÂàôÁªàÊ≠¢Á®ãÂ∫èÔºàÁî®‰∫éÂú® Windows ‰∏äÊìç‰ΩúÊúçÂä°ÊéßÂà∂ÁÆ°ÁêÜÂô®Ôºâ„ÄÇ</li>
<li><strong>‰ø°Âè∑Â§ÑÁêÜ</strong>: Ë∞ÉÁî® <code>handleSignals</code> ÂáΩÊï∞ÔºåËÆæÁΩÆ‰ø°Âè∑Â§ÑÁêÜÂô® <code>done</code>ÔºåÁî®‰∫éÂ§ÑÁêÜÊù•Ëá™Á≥ªÁªüÁöÑ‰ø°Âè∑ÔºàÂ¶Ç <code>SIGTERM</code>„ÄÅ<code>SIGINT</code>Ôºâ„ÄÇÁÑ∂ÂêéË∞ÉÁî® <code>signal.Notify</code>ÔºåÂ∞ÜÊåáÂÆöÁöÑ‰ø°Âè∑Ê≥®ÂÜåÂà∞ <code>signals</code> ÈÄöÈÅì‰∏≠Ôºå‰ª•‰æøÂú®Êé•Êî∂Âà∞‰ø°Âè∑Êó∂Ëß¶ÂèëÁõ∏Â∫îÁöÑÊìç‰Ωú„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÂêØÂä® <code>containerd</code> ÊúçÂä°Âô®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">srvResp</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span>   <span class="o">*</span><span class="nx">server</span><span class="p">.</span><span class="nx">Server</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">chsrv</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">srvResp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">chsrv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">chsrv</span> <span class="o">&lt;-</span> <span class="nx">srvResp</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">err</span><span class="p">}:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">launchService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">done</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="nx">server</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">chsrv</span> <span class="o">&lt;-</span> <span class="nx">srvResp</span><span class="p">{</span><span class="nx">s</span><span class="p">:</span> <span class="nx">server</span><span class="p">}:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂºÇÊ≠•ÂàùÂßãÂåñÊúçÂä°Âô®</strong>: ‰ΩøÁî® goroutine ÂºÇÊ≠•ÂàùÂßãÂåñ <code>containerd</code> ÊúçÂä°Âô®ÔºåÈÅøÂÖçÂú®‰∏ªÁ∫øÁ®ã‰∏≠ÈòªÂ°ûÔºå‰æãÂ¶ÇÂú® Bolt Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñËøáÁ®ã‰∏≠„ÄÇ</li>
<li><strong>ÂàõÂª∫ <code>containerd</code> ÊúçÂä°Âô®</strong>: Ë∞ÉÁî® <code>server.New</code> ‰ΩøÁî®ÈÖçÁΩÆÂàùÂßãÂåñ <code>containerd</code> ÊúçÂä°Âô®ÂÆû‰æã„ÄÇÂ¶ÇÊûúÂá∫Áé∞ÈîôËØØÔºåÈÄöËøá <code>chsrv</code> ÈÄöÈÅìËøîÂõûÈîôËØØÂπ∂ÈÄÄÂá∫„ÄÇ</li>
<li><strong>ÂêØÂä®ÊúçÂä°</strong>: Â¶ÇÊûúÈúÄË¶ÅÔºåË∞ÉÁî® <code>launchService</code> ÂêØÂä® <code>containerd</code> ÊúçÂä°Âô®‰Ωú‰∏∫ Windows ÊúçÂä°Ôºà‰ªÖÂú® Windows Âπ≥Âè∞‰∏äÔºâ„ÄÇ</li>
<li><strong>ÂÅúÊ≠¢ÊúçÂä°Âô®</strong>: ÁõëÂê¨ <code>ctx.Done()</code> ‰ø°Âè∑ÔºåÂΩì‰∏ä‰∏ãÊñáË¢´ÂèñÊ∂àÊó∂ÔºåË∞ÉÁî® <code>server.Stop</code> ÂÅúÊ≠¢ÊúçÂä°Âô®„ÄÇ</li>
</ul>
<p>Ëøõ‰∏ÄÊ≠•ÂàÜÊûê<code>server.New()</code>ÂáΩÊï∞ÔºåËøô‰∏™ÂáΩÊï∞Âú®<code>containerd/cmd/containerd/server/server.go</code>‰∏≠„ÄÇ</p>
<blockquote>
<p>Ëøô‰∏™ÂáΩÊï∞Áî®‰∫éÂàõÂª∫ÂíåÂàùÂßãÂåñ gRPC ÊúçÂä°Âô®ÁöÑÊ†∏ÂøÉÈÉ®ÂàÜ„ÄÇÂÆÉÊ∂âÂèäÈÖçÁΩÆÁöÑËøÅÁßª„ÄÅÊèí‰ª∂ÁöÑÂä†ËΩΩ‰∏éÂàùÂßãÂåñ„ÄÅgRPC ÊúçÂä°ÁöÑÊ≥®ÂÜåÔºå‰ª•ÂèäÂÖ∂‰ªñÊúçÂä°Âô®ËÆæÁΩÆ„ÄÇÔºàÊàëËøôÈáåÂè™ÂàÜÊûê‰∫ÜÈÉ®ÂàÜÈáçË¶ÅÊ∫êÁ†ÅÔºâ</p>
</blockquote>
<p><strong>(1)ÈÖçÁΩÆËøÅÁßª</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">currentVersion</span> <span class="p">&lt;</span> <span class="nx">version</span><span class="p">.</span><span class="nx">ConfigVersion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Migrate config to latest version
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t1</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">MigrateConfig</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">migrationT</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Since</span><span class="p">(</span><span class="nx">t1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><strong>ÁâàÊú¨Ê£ÄÊü•‰∏éËøÅÁßª</strong>ÔºöÂ¶ÇÊûúÂΩìÂâçÈÖçÁΩÆÁöÑÁâàÊú¨‰Ωé‰∫éÁ≥ªÁªüË¶ÅÊ±ÇÁöÑÁâàÊú¨ÔºåÂàôËøõË°åÈÖçÁΩÆËøÅÁßª„ÄÇËøÅÁßªÊó∂Èó¥Ë¢´ËÆ∞ÂΩïÂú® <code>migrationT</code> ‰∏≠„ÄÇ</p>
</li>
<li>
<p><strong>ÈÖçÁΩÆËøÅÁßª</strong>ÔºöÈÄöËøá <code>config.MigrateConfig(ctx)</code> ÊñπÊ≥ïËøõË°åËøÅÁßªÔºåÂ∞ÜÈÖçÁΩÆÊõ¥Êñ∞Âà∞ÊúÄÊñ∞ÁâàÊú¨„ÄÇ</p>
</li>
</ul>
<p><strong>(2)ÈÖçÁΩÆ Stream Â§ÑÁêÜÂô®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">config</span><span class="p">.</span><span class="nx">StreamProcessors</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">diff</span><span class="p">.</span><span class="nf">RegisterProcessor</span><span class="p">(</span><span class="nx">diff</span><span class="p">.</span><span class="nf">BinaryHandler</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Returns</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Accepts</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Args</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Env</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Ê≥®ÂÜåÊµÅÂ§ÑÁêÜÂô®</strong>ÔºöÊ†πÊçÆÈÖçÁΩÆ‰∏≠ÁöÑ <code>StreamProcessors</code> Ê≥®ÂÜåÊµÅÂ§ÑÁêÜÂô®ÔºåËøô‰∫õÂ§ÑÁêÜÂô®Áî®‰∫éÂ§ÑÁêÜÊï∞ÊçÆÊµÅ„ÄÇ</li>
</ul>
<p><strong>(3)„ÄÅÂàùÂßãÂåñ gRPC ÊúçÂä°Âô®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">serverOpts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">grpc</span><span class="p">.</span><span class="nf">StatsHandler</span><span class="p">(</span><span class="nx">otelgrpc</span><span class="p">.</span><span class="nf">NewServerHandler</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">grpc</span><span class="p">.</span><span class="nf">ChainStreamInterceptor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">streamNamespaceInterceptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prometheusServerMetrics</span><span class="p">.</span><span class="nf">StreamServerInterceptor</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">grpc</span><span class="p">.</span><span class="nf">ChainUnaryInterceptor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">unaryNamespaceInterceptor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prometheusServerMetrics</span><span class="p">.</span><span class="nf">UnaryServerInterceptor</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>gRPC ÊúçÂä°Âô®ÈÄâÈ°π</strong>ÔºöÈÖçÁΩÆ gRPC ÊúçÂä°Âô®ÁöÑÈÄâÈ°πÔºåÂ¶ÇÁªüËÆ°Â§ÑÁêÜÁ®ãÂ∫è„ÄÅÊã¶Êà™Âô®Á≠â„ÄÇËøô‰∫õÊã¶Êà™Âô®ÂèØ‰ª•Áî®‰∫éÂ§ÑÁêÜÂëΩÂêçÁ©∫Èó¥„ÄÅÁõëÊéßÁ≠â„ÄÇ</li>
</ul>
<p><strong>(4)„ÄÅÊ≥®ÂÜåÊúçÂä°</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">service</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">grpcServices</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nx">grpcServer</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ÂêØÂä® gRPC ÂíåÂÖ∂‰ªñÊúçÂä°ÔºàÈáçÁÇπÔºâ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">isLocalAddress</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">GID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Debug</span><span class="p">.</span><span class="nx">Address</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for debug endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeDebug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">Metrics</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for metrics endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeMetrics</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main ttrpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tl</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTTRPC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">TCPAddress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for TCP grpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTCP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeGRPC</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂêØÂä®Ë∞ÉËØïÊúçÂä°</strong>: Â¶ÇÊûúÈÖçÁΩÆ‰∫ÜË∞ÉËØïÂú∞ÂùÄÔºåË∞ÉÁî® <code>serve</code> ÂêØÂä®Ë∞ÉËØïÊúçÂä° (<code>ServeDebug</code>)„ÄÇ</li>
<li><strong>ÂêØÂä®Â∫¶ÈáèÊúçÂä°</strong>: Â¶ÇÊûúÈÖçÁΩÆ‰∫ÜÂ∫¶ÈáèÂú∞ÂùÄÔºåË∞ÉÁî® <code>serve</code> ÂêØÂä®Â∫¶ÈáèÊúçÂä° (<code>ServeMetrics</code>)„ÄÇ</li>
<li><strong>ÂêØÂä® TTRPC ÊúçÂä°</strong>: ‰ΩøÁî® <code>sys.GetLocalListener</code> Ëé∑ÂèñÊú¨Âú∞ÁõëÂê¨Âô®Âπ∂ÂêØÂä® TTRPC ÊúçÂä° (<code>ServeTTRPC</code>)„ÄÇ</li>
<li><strong>ÂêØÂä® gRPC ÊúçÂä°</strong>: Â¶ÇÊûúÈÖçÁΩÆ‰∫Ü TCP gRPC Âú∞ÂùÄÔºåÂàôÈÄöËøá TCP ÂêØÂä® gRPC ÊúçÂä° (<code>ServeTCP</code>)„ÄÇÂêåÊó∂ÔºåËøò‰ºö‰∏∫‰∏ªË¶ÅÁöÑ gRPC ÊúçÂä°ÈÖçÁΩÆ Unix Domain Socket (UDS) Âπ∂ÂêØÂä®ÊúçÂä° (<code>ServeGRPC</code>)„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÊúçÂä°ÂêØÂä®‰∏éÂ§ÑÁêÜ</strong></p>
<blockquote>
<p><code>serve</code> ÂáΩÊï∞Áî®‰∫éÂêØÂä®ÊåáÂÆöÁöÑÊúçÂä°ÔºåÊé•Âèó‰∏Ä‰∏™ÁõëÂê¨Âô® <code>l</code> Âíå‰∏Ä‰∏™ÊúçÂä°ÂáΩÊï∞ <code>serveFunc</code> ‰Ωú‰∏∫ÂèÇÊï∞„ÄÇÂÆÉÂú®Êñ∞ÁöÑ goroutine ‰∏≠ÊâßË°åÊúçÂä°ÂáΩÊï∞ÔºåÂπ∂Âú®ÊúçÂä°ÁªìÊùüÂêéÂÖ≥Èó≠ÁõëÂê¨Âô®„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="nx">serveFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Addr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;serving...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serveFunc</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;serve failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<p><strong>Âú®ÂêØÂä® gRPC ‰∏≠Ë∞ÉÁî®‰∫Ü<code>sys.GetLocalListener()</code>ÔºåËøô‰∏™ÂáΩÊï∞Âú®‰∏ãÈù¢ÁöÑÂáΩÊï∞‰∏≠Ë¢´ÂÆö‰πâ„ÄÇ</strong></p>
<blockquote>
<p>Êñá‰ª∂Ë∑ØÂæÑÔºö<code>containerd/pkg/sys/socket_unix.go</code>ÔºåËøô‰∏™Êñá‰ª∂Ê∂âÂèäÂà∞‰∫ÜudsÊñá‰ª∂ÁöÑÂàõÂª∫„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">sys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;path/filepath&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="s">&#34;golang.org/x/sys/unix&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// CreateUnixSocket creates a unix socket and returns the listener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// BSDs have a 104 limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">104</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%q: unix socket path too long (&gt; 104)&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Unlink</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// GetLocalListener returns a listener out of a unix socket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure parent directory is created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0770</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ËØ¶ÁªÜÂàÜÊûêÔºö</strong></p>
<p><strong><code>CreateUnixSocket</code> ÂáΩÊï∞</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// BSDs have a 104 limit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">104</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%q: unix socket path too long (&gt; 104)&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nf">Unlink</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>CreateUnixSocket</code> ÂáΩÊï∞Áî®‰∫éÂàõÂª∫‰∏Ä‰∏™ Unix Domain SocketÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™Áî®‰∫éÁõëÂê¨ËøûÊé•ÁöÑ <code>net.Listener</code> ÂÆû‰æã„ÄÇ</p>
<p>ËØ¶ÁªÜÂàÜÊûêÔºö</p>
<ul>
<li><strong>Ë∑ØÂæÑÈïøÂ∫¶Ê£ÄÊü•</strong>ÔºöÈ¶ñÂÖàÔºåÂáΩÊï∞Ê£ÄÊü•Â•óÊé•Â≠óË∑ØÂæÑÁöÑÈïøÂ∫¶ÊòØÂê¶Ë∂ÖËøá‰∫Ü 104 ‰∏™Â≠óÁ¨¶„ÄÇËøôÊòØÂõ†‰∏∫Âú®‰∏Ä‰∫õ BSD Á≥ªÁªü‰∏≠ÔºåUnix Domain Socket ÁöÑË∑ØÂæÑÈïøÂ∫¶ÈôêÂà∂‰∏∫ 104 ‰∏™Â≠óÁ¨¶„ÄÇÂ¶ÇÊûúË∑ØÂæÑÂ§™ÈïøÔºåÂáΩÊï∞‰ºöËøîÂõû‰∏Ä‰∏™ÈîôËØØ„ÄÇ</li>
<li><strong>ÂàõÂª∫Áà∂ÁõÆÂΩï</strong>Ôºö‰ΩøÁî® <code>os.MkdirAll</code> ÂàõÂª∫ Unix Socket ÁöÑÁà∂ÁõÆÂΩï„ÄÇÂ¶ÇÊûúËØ•ÁõÆÂΩï‰∏çÂ≠òÂú®Ôºå<code>MkdirAll</code> ‰ºöÈÄíÂΩíÂú∞ÂàõÂª∫ÁõÆÂΩï„ÄÇÁõÆÂΩïÊùÉÈôêËÆæÁΩÆ‰∏∫ <code>0660</code>„ÄÇ</li>
<li><strong>Âà†Èô§Áé∞ÊúâÁöÑ Unix Socket Êñá‰ª∂</strong>ÔºöË∞ÉÁî® <code>unix.Unlink</code> Â∞ùËØïÂà†Èô§ÊåáÂÆöË∑ØÂæÑ‰∏äÁöÑÁé∞ÊúâÊñá‰ª∂ÔºàÂ¶ÇÊûúÂ≠òÂú®ÔºâÔºå‰ª•Á°Æ‰øùÊñ∞ÂàõÂª∫ÁöÑÂ•óÊé•Â≠óÊñá‰ª∂‰∏ç‰ºö‰∏éÊóßÊñá‰ª∂ÂÜ≤Á™Å„ÄÇÂ¶ÇÊûúÊñá‰ª∂‰∏çÂ≠òÂú®Ôºå<code>Unlink</code> ‰ºöËøîÂõû‰∏Ä‰∏™ÈîôËØØÔºå‰ΩÜÂ¶ÇÊûúÈîôËØØÁ±ªÂûãÊòØ <code>os.IsNotExist</code>ÔºåË°®Á§∫Êñá‰ª∂Êú¨Êù•Â∞±‰∏çÂ≠òÂú®ÔºåËøôÊó∂‰ºöÂøΩÁï•Ëøô‰∏™ÈîôËØØ„ÄÇ</li>
<li><strong>ÂàõÂª∫ Unix Socket</strong>ÔºöÊúÄÂêéÔºå‰ΩøÁî® <code>net.Listen(&quot;unix&quot;, path)</code> ÂàõÂª∫‰∏Ä‰∏™ Unix Domain SocketÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™ <code>net.Listener</code>Ôºå‰æõÂêéÁª≠‰ΩøÁî®„ÄÇ</li>
</ul>
<p><strong><code>GetLocalListener</code> ÂáΩÊï∞</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure parent directory is created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>GetLocalListener</code> ÂáΩÊï∞Áî®‰∫éÂàõÂª∫‰∏Ä‰∏™Êú¨Âú∞ÁöÑ Unix Domain Socket ÁõëÂê¨Âô®ÔºåÂπ∂ËÆæÁΩÆÁõ∏Â∫îÁöÑÊùÉÈôêÂíåÊâÄÊúâËÄÖ‰ø°ÊÅØ„ÄÇ</p>
<p>ËØ¶ÁªÜÂàÜÊûêÔºö</p>
<ul>
<li><strong>ÂàõÂª∫Áà∂ÁõÆÂΩï</strong>ÔºöË∞ÉÁî® <code>mkdirAs</code> ÂáΩÊï∞Á°Æ‰øù Unix Socket ÁöÑÁà∂ÁõÆÂΩïÂ∑≤ÁªèÂàõÂª∫ÔºåÂπ∂ËÆæÁΩÆ‰∫ÜÈÄÇÂΩìÁöÑÁî®Êà∑ ID (<code>uid</code>) ÂíåÁªÑ ID (<code>gid</code>)„ÄÇ</li>
<li><strong>ÂàõÂª∫ Unix Socket</strong>Ôºö‰ΩøÁî® <code>CreateUnixSocket</code> ÂáΩÊï∞ÂàõÂª∫ Unix Domain Socket„ÄÇ</li>
<li><strong>ËÆæÁΩÆÊùÉÈôê</strong>Ôºö‰ΩøÁî® <code>os.Chmod</code> ËÆæÁΩÆ Unix Socket Êñá‰ª∂ÁöÑÊùÉÈôê‰∏∫ <code>0660</code>ÔºåÂç≥Êñá‰ª∂ÊâÄÊúâËÄÖÂíåÁªÑÊàêÂëòÂèØËØªÂÜôÔºåÂÖ∂‰ªñÁî®Êà∑Êó†ÊùÉÈôê„ÄÇ</li>
<li><strong>ËÆæÁΩÆÊâÄÊúâËÄÖ</strong>Ôºö‰ΩøÁî® <code>os.Chown</code> Â∞Ü Unix Socket Êñá‰ª∂ÁöÑÊâÄÊúâËÄÖÂíåÁªÑËÆæÁΩÆ‰∏∫ÊåáÂÆöÁöÑ <code>uid</code> Âíå <code>gid</code>„ÄÇ</li>
<li><strong>ËøîÂõûÁõëÂê¨Âô®</strong>ÔºöÂ¶ÇÊûúÊâÄÊúâÊìç‰ΩúÈÉΩÊàêÂäüÔºåËøîÂõûÂàõÂª∫ÁöÑ <code>net.Listener</code> ÂÆû‰æã„ÄÇÂ¶ÇÊûúÂú®ËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºåÂÖ≥Èó≠Â∑≤ÂàõÂª∫ÁöÑÁõëÂê¨Âô®ÔºåÂπ∂ËøîÂõûÈîôËØØ‰ø°ÊÅØ„ÄÇ</li>
</ul>
<p><strong><code>mkdirAs</code> ÂáΩÊï∞</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0770</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>mkdirAs</code> ÂáΩÊï∞Áî®‰∫éÂàõÂª∫ÊåáÂÆöÁöÑÁõÆÂΩïÔºåÂπ∂ËÆæÁΩÆËØ•ÁõÆÂΩïÁöÑÊâÄÊúâËÄÖÂíåÊùÉÈôê„ÄÇ</p>
<p>ËØ¶ÁªÜÂàÜÊûêÔºö</p>
<ul>
<li><strong>Ê£ÄÊü•ÁõÆÂΩïÊòØÂê¶Â≠òÂú®</strong>Ôºö‰ΩøÁî® <code>os.Stat</code> Ê£ÄÊü•ÁõÆÊ†áÁõÆÂΩïÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®„ÄÇÂ¶ÇÊûúÁõÆÂΩïÂ≠òÂú®ÔºåËøîÂõûËØ•ÁõÆÂΩïÁöÑÁä∂ÊÄÅ‰ø°ÊÅØÊàñÈîôËØØ„ÄÇÂ¶ÇÊûúÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÁªßÁª≠ÊâßË°å„ÄÇ</li>
<li><strong>ÂàõÂª∫ÁõÆÂΩï</strong>Ôºö‰ΩøÁî® <code>os.MkdirAll</code> ÂàõÂª∫ÁõÆÊ†áÁõÆÂΩïÔºåÂπ∂Â∞ÜÊùÉÈôêËÆæÁΩÆ‰∏∫ <code>0770</code>ÔºàÂç≥ÊâÄÊúâËÄÖÂíåÁªÑÊàêÂëòÂèØ‰ª•ËØªÂÜôÊâßË°åÔºåÂÖ∂‰ªñÁî®Êà∑Êó†ÊùÉÈôêÔºâ„ÄÇ</li>
<li><strong>ËÆæÁΩÆÊâÄÊúâËÄÖ</strong>Ôºö‰ΩøÁî® <code>os.Chown</code> Â∞ÜÁõÆÂΩïÁöÑÊâÄÊúâËÄÖÂíåÁªÑËÆæÁΩÆ‰∏∫ÊåáÂÆöÁöÑ <code>uid</code> Âíå <code>gid</code>„ÄÇ</li>
<li><strong>ËøîÂõûÁªìÊûú</strong>ÔºöÂ¶ÇÊûúÊâÄÊúâÊìç‰ΩúÈÉΩÊàêÂäüÔºåËøîÂõû <code>nil</code>„ÄÇÂ¶ÇÊûú‰ªª‰ΩïÊ≠•È™§Âá∫ÈîôÔºåÂàôËøîÂõûÁõ∏Â∫îÁöÑÈîôËØØ‰ø°ÊÅØ„ÄÇ</li>
</ul>
<h3 id="client‰∏écontainerdÂÆàÊä§ËøõÁ®ãÁöÑÈÄö‰ø°">client‰∏écontainerdÂÆàÊä§ËøõÁ®ãÁöÑÈÄö‰ø°
</h3><blockquote>
<p>Êñá‰ª∂Ë∑ØÂæÑÔºöcontainerd/client/client.goÔºåËøôÊÆµ‰ª£Á†ÅÊòØ <code>containerd</code> È°πÁõÆ‰∏≠ <code>client</code> ÂåÖÁöÑÂÆûÁé∞ÔºåË¥üË¥£ÂàõÂª∫‰∏é <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÈÄö‰ø°ÁöÑÂÆ¢Êà∑Á´ØÂÆû‰æã„ÄÇÂÆÉÂåÖÂê´‰∫Ü‰∏é <code>containerd</code> ËøõË°å gRPC ÈÄö‰ø°ÁöÑÂü∫Á°ÄËÆæÊñΩÔºåÊèê‰æõ‰∫Ü‰∏ÄÁªÑÊñπÊ≥ïÔºåÁî®‰∫é‰∏é <code>containerd</code> ÁöÑÂêÑÁßçÊúçÂä°ËøõË°å‰∫§‰∫íÔºå‰æãÂ¶ÇÂÆπÂô®ÁÆ°ÁêÜ„ÄÅÈïúÂÉèÁÆ°ÁêÜ„ÄÅÂø´ÁÖßÁÆ°ÁêÜÁ≠â„ÄÇ</p>
</blockquote>
<ol>
<li><strong><code>Client</code> ÁªìÊûÑ‰Ωì</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Client</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="nx">connMu</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">	<span class="nx">conn</span>      <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span>
</span></span><span class="line"><span class="cl">	<span class="nx">runtime</span>   <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">defaultns</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="nx">platform</span>  <span class="nx">platforms</span><span class="p">.</span><span class="nx">MatchComparer</span>
</span></span><span class="line"><span class="cl">	<span class="nx">connector</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>services</code></strong>: ÂÜÖÂµåÁöÑ <code>services</code> ÁªìÊûÑ‰ΩìÔºåÂåÖÂê´‰∫Ü‰∏é <code>containerd</code> ÊúçÂä°ÈÄö‰ø°ÁöÑÂÖ∑‰ΩìÊñπÊ≥ïÔºåÂ¶Ç <code>ContainerService</code>„ÄÅ<code>ImageService</code> Á≠â„ÄÇ</li>
<li><strong><code>conn</code></strong>: ‰∏Ä‰∏™ gRPC ËøûÊé•ÂØπË±°ÔºåÁî®‰∫é‰∏é <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÈÄö‰ø°„ÄÇ</li>
<li><strong><code>connMu</code></strong>: ‰∏Ä‰∏™‰∫íÊñ•ÈîÅÔºåÁî®‰∫éÂú®Â§öÁ∫øÁ®ãÁéØÂ¢É‰∏ã‰øùÊä§ <code>conn</code> ÂØπË±°ÁöÑÂπ∂ÂèëËÆøÈóÆ„ÄÇ</li>
<li><strong><code>runtime</code></strong>: Ë°®Á§∫ÂΩìÂâç‰ΩøÁî®ÁöÑÂÆπÂô®ËøêË°åÊó∂„ÄÇ</li>
<li><strong><code>defaultns</code></strong>: ÂÆ¢Êà∑Á´ØÁöÑÈªòËÆ§ÂëΩÂêçÁ©∫Èó¥„ÄÇ</li>
<li><strong><code>platform</code></strong>: Âπ≥Âè∞ÂåπÈÖçÂô®ÔºåÁî®‰∫éÁ°ÆÂÆöËøêË°åÂú®ÁâπÂÆöÂπ≥Âè∞‰∏äÁöÑÂÆπÂô®„ÄÇ</li>
<li><strong><code>connector</code></strong>: ‰∏Ä‰∏™ÂáΩÊï∞ÔºåÁî®‰∫éÈáçÊñ∞ËøûÊé•Âà∞ <code>containerd</code> ÂÆàÊä§ËøõÁ®ã„ÄÇ</li>
</ul>
<ol start="2">
<li><strong><code>New</code> ÂáΩÊï∞</strong></li>
</ol>
<p><code>New</code> ÂáΩÊï∞Áî®‰∫éÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ <code>Client</code> ÂÆû‰æãÔºåËøûÊé•Âà∞ÊåáÂÆöÁöÑ <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÂú∞ÂùÄ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">address</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">copts</span> <span class="nx">clientOpts</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">copts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">defaultns</span><span class="p">:</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">platforms</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">services</span> <span class="p">=</span> <span class="o">*</span><span class="nx">copts</span><span class="p">.</span><span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span> <span class="o">:=</span> <span class="nx">backoff</span><span class="p">.</span><span class="nx">DefaultConfig</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span><span class="p">.</span><span class="nx">MaxDelay</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span>
</span></span><span class="line"><span class="cl">		<span class="nx">connParams</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ConnectParams</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Backoff</span><span class="p">:</span> <span class="nx">backoffConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">DialOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithTransportCredentials</span><span class="p">(</span><span class="nx">insecure</span><span class="p">.</span><span class="nf">NewCredentials</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithConnectParams</span><span class="p">(</span><span class="nx">connParams</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithContextDialer</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nx">ContextDialer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallRecvMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxRecvMsgSize</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallSendMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxSendMsgSize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">unary</span><span class="p">,</span> <span class="nx">stream</span> <span class="o">:=</span> <span class="nf">newNSInterceptors</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainUnaryInterceptor</span><span class="p">(</span><span class="nx">unary</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainStreamInterceptor</span><span class="p">(</span><span class="nx">stream</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">connector</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nf">DialAddress</span><span class="p">(</span><span class="nx">address</span><span class="p">),</span> <span class="nx">gopts</span><span class="o">...</span><span class="p">)</span> <span class="c1">//gRPCËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to dial %q: %w&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">conn</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">connector</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connector</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">,</span> <span class="nx">connector</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no grpc connection or services is available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// check namespace labels for default runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetLabel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntimeNSLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">label</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">label</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÈÄâÈ°πËß£Êûê</strong>: <code>copts</code> Áî®‰∫éÂ≠òÂÇ®ÂÆ¢Êà∑Á´ØÈÖçÁΩÆÈÄâÈ°πÔºåÈÄöËøá‰º†ÂÖ•ÁöÑ <code>opts</code> ËøõË°åËß£ÊûêÈÖçÁΩÆ„ÄÇ</li>
<li><strong>ÈªòËÆ§ÈÖçÁΩÆËÆæÁΩÆ</strong>: Â¶ÇÊûúÊú™ÊåáÂÆöËøêË°åÊó∂„ÄÅÂπ≥Âè∞Á≠âÈÄâÈ°πÔºå‰ΩøÁî®ÈªòËÆ§ÂÄºËøõË°åÂàùÂßãÂåñ„ÄÇ</li>
<li>gRPC ËøûÊé•:
<ul>
<li>ÈÖçÁΩÆ‰∫ÜËøûÊé•ÂèÇÊï∞ÂíåÊã®Âè∑ÈÄâÈ°πÔºàÂ¶ÇË∂ÖÊó∂„ÄÅTLS„ÄÅÂÆâÂÖ®Âá≠ËØÅÁ≠âÔºâ„ÄÇ</li>
<li>‰ΩøÁî® <code>grpc.NewClient</code> Âª∫Á´ãÂà∞ <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÁöÑ gRPC ËøûÊé•„ÄÇ</li>
<li>ËøûÊé•ÊàêÂäüÂêéÔºå‰øùÂ≠òËøûÊé•ÂØπË±° <code>conn</code> ÂíåÈáçÊñ∞ËøûÊé•ÁöÑÂáΩÊï∞ <code>connector</code>„ÄÇ</li>
</ul>
</li>
<li><strong>ÂëΩÂêçÁ©∫Èó¥Ê†áÁ≠æÊ£ÄÊü•</strong>: Â¶ÇÊûúÊ≤°ÊúâÊåáÂÆöËøêË°åÊó∂ÔºåÂπ∂‰∏îËÆæÁΩÆ‰∫ÜÈªòËÆ§ÂëΩÂêçÁ©∫Èó¥Ôºå‰ºöÂ∞ùËØï‰ªéÂëΩÂêçÁ©∫Èó¥Ê†áÁ≠æ‰∏≠Ëé∑ÂèñÈªòËÆ§ËøêË°åÊó∂„ÄÇ</li>
<li><strong>ÈîôËØØÂ§ÑÁêÜ</strong>: Â¶ÇÊûúÊó†Ê≥ïÂª∫Á´ã gRPC ËøûÊé•ÔºåÊàñÊú™Êèê‰æõËøûÊé•ÊàñÊúçÂä°ÔºåÂàôËøîÂõûÈîôËØØ„ÄÇ</li>
</ul>
<ol start="3">
<li><strong><code>NewWithConn</code> ÂáΩÊï∞</strong></li>
</ol>
<p><code>NewWithConn</code> ÂáΩÊï∞Áî®‰∫éÂàõÂª∫‰∏Ä‰∏™‰∏éÁé∞ÊúâÁöÑ gRPC ËøûÊé•ÂÖ≥ËÅîÁöÑ <code>Client</code> ÂÆû‰æã„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewWithConn</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">copts</span> <span class="nx">clientOpts</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">copts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">defaultns</span><span class="p">:</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">:</span>      <span class="nx">conn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runtime</span><span class="p">:</span>   <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">platforms</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// check namespace labels for default runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetLabel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntimeNSLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">label</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">label</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">services</span> <span class="p">=</span> <span class="o">*</span><span class="nx">copts</span><span class="p">.</span><span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ÂèÇÊï∞ËØ¥Êòé:
<ul>
<li><strong><code>conn</code></strong>: ‰∏Ä‰∏™Áé∞ÊúâÁöÑ gRPC ËøûÊé•ÂÆû‰æã„ÄÇ</li>
<li><strong><code>opts</code></strong>: ÂèØÈÄâÁöÑÂÆ¢Êà∑Á´ØÈÖçÁΩÆÈÄâÈ°π„ÄÇ</li>
</ul>
</li>
<li>ÂàùÂßãÂåñ:
<ul>
<li>‰∏é <code>New</code> ÂáΩÊï∞Á±ª‰ººÔºåÂàùÂßãÂåñ <code>Client</code> ÂÆû‰æãÔºåËÆæÁΩÆÈªòËÆ§ËøêË°åÊó∂ÂíåÂπ≥Âè∞„ÄÇ</li>
<li>Â¶ÇÊûú‰º†ÂÖ•‰∫ÜÊúçÂä°ÈÖçÁΩÆ <code>services</code>ÔºåÂàô‰ΩøÁî®ËØ•ÈÖçÁΩÆ„ÄÇ</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong><code>Reconnect</code> ÂáΩÊï∞</strong></li>
</ol>
<p><code>Reconnect</code> ÂáΩÊï∞Áî®‰∫éÈáçÊñ∞Âª∫Á´ã‰∏é <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÁöÑ gRPC ËøûÊé•„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Reconnect</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connector</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to reconnect to containerd, no connector available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">connector</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="p">=</span> <span class="nx">conn</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÈîÅÂÆöËøûÊé•</strong>: ‰ΩøÁî® <code>connMu</code> ‰∫íÊñ•ÈîÅÊù•Èò≤Ê≠¢Âπ∂Âèë‰øÆÊîπ <code>conn</code> ÂØπË±°„ÄÇ</li>
<li><strong>ÂÖ≥Èó≠ÊóßËøûÊé•</strong>: ÂÖ≥Èó≠Áé∞ÊúâÁöÑ gRPC ËøûÊé•„ÄÇ</li>
<li><strong>ÈáçÊñ∞ËøûÊé•</strong>: ‰ΩøÁî® <code>connector</code> ÂáΩÊï∞ÈáçÊñ∞Âª∫Á´ãËøûÊé•ÔºåÂπ∂Â∞ÜÊñ∞ËøûÊé•ËµãÂÄºÁªô <code>conn</code>„ÄÇ</li>
</ul>
<ol start="5">
<li><strong><code>IsServing</code> ÂáΩÊï∞</strong></li>
</ol>
<p><code>IsServing</code> ÂáΩÊï∞Áî®‰∫éÊ£ÄÊü• <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÊòØÂê¶Ê≠£Âú®ËøêË°åÔºåÂπ∂ËøîÂõû <code>SERVING</code> Áä∂ÊÄÅ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">IsServing</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no grpc connection available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">HealthService</span><span class="p">().</span><span class="nf">Check</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">grpc_health_v1</span><span class="p">.</span><span class="nx">HealthCheckRequest</span><span class="p">{},</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WaitForReady</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Status</span> <span class="o">==</span> <span class="nx">grpc_health_v1</span><span class="p">.</span><span class="nx">HealthCheckResponse_SERVING</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÈîÅÂÆöËøûÊé•</strong>: Á°Æ‰øùÂú®Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅÊó∂‰∏ç‰ºöÊúâÂÖ∂‰ªñÁ∫øÁ®ã‰øÆÊîπ <code>conn</code> ÂØπË±°„ÄÇ</li>
<li><strong>ÂÅ•Â∫∑Ê£ÄÊü•</strong>: Ë∞ÉÁî® <code>HealthService().Check</code> ÊñπÊ≥ïÔºåÊ£ÄÊü• <code>containerd</code> ÁöÑÂÅ•Â∫∑Áä∂ÊÄÅÔºåÁ°ÆÂÆöÊúçÂä°ÊòØÂê¶ÂèØÁî®„ÄÇ</li>
<li><strong>ËøîÂõûÂÄº</strong>: Â¶ÇÊûúÊúçÂä°Ê≠£Âú®ËøêË°åÂπ∂ËøîÂõû <code>SERVING</code> Áä∂ÊÄÅÔºåÂàôËøîÂõû <code>true</code>ÔºåÂê¶ÂàôËøîÂõû <code>false</code> ÂíåÈîôËØØ‰ø°ÊÅØ„ÄÇ</li>
</ul>
<p>Âú® <code>containerd</code> ÁöÑ‰ª£Á†Å‰∏≠ÔºåË∞ÉÁî® <code>grpc.NewClient</code> ÂáΩÊï∞ÂÆûÈôÖ‰∏äÊòØÁõ¥Êé•‰ΩøÁî® gRPC Â∫ì‰∏≠ÁöÑËøô‰∏™ÂáΩÊï∞Êù•ÂàõÂª∫ gRPC ÂÆ¢Êà∑Á´ØËøûÊé•„ÄÇËøô‰∏™ÂáΩÊï∞ÂÜÖÈÉ®‰ºöÂàõÂª∫ÂíåÁÆ°ÁêÜ‰∏é <code>containerd</code> ÊúçÂä°Âô®ÁöÑ gRPC ËøûÊé•Ôºå‰∏ã‰∏ÄÈÉ®ÂàÜÂ∞ÜËØ¶ÁªÜÂàÜÊûêgRPCÊ°ÜÊû∂„ÄÇ</p>
<blockquote>
<p>Ê∫êÁ†ÅÈìæÊé•Ôºö<a class="link" href="https://github.com/grpc/grpc-go/blob/v1.65.0/clientconn.go#L588"  target="_blank" rel="noopener"
    >grpc-go/clientconn.go at v1.65.0 ¬∑ grpc/grpc-go (github.com)</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">target</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">DialOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ClientConn</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">target</span><span class="p">:</span> <span class="nx">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conns</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">addrConn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dopts</span><span class="p">:</span>  <span class="nf">defaultDialOptions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">retryThrottler</span><span class="p">.</span><span class="nf">Store</span><span class="p">((</span><span class="o">*</span><span class="nx">retryThrottler</span><span class="p">)(</span><span class="kc">nil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">safeConfigSelector</span><span class="p">.</span><span class="nf">UpdateConfigSelector</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">defaultConfigSelector</span><span class="p">{</span><span class="kc">nil</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Apply dial options.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">disableGlobalOpts</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opt</span><span class="p">.(</span><span class="o">*</span><span class="nx">disableGlobalDialOptions</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">disableGlobalOpts</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">disableGlobalOpts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">globalDialOptions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opt</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opt</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Determine the resolver to use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">initParsedTargetAndResolverBuilder</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">globalPerTargetDialOptions</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opt</span><span class="p">.</span><span class="nf">DialOptionForTarget</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">.</span><span class="nx">URL</span><span class="p">).</span><span class="nf">apply</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">chainUnaryClientInterceptors</span><span class="p">(</span><span class="nx">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">chainStreamClientInterceptors</span><span class="p">(</span><span class="nx">cc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">validateTransportCredentials</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfigRawJSON</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">scpr</span> <span class="o">:=</span> <span class="nf">parseServiceConfig</span><span class="p">(</span><span class="o">*</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfigRawJSON</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">maxCallAttempts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">scpr</span><span class="p">.</span><span class="nx">Err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s: %v&#34;</span><span class="p">,</span> <span class="nx">invalidDefaultServiceConfigErrPrefix</span><span class="p">,</span> <span class="nx">scpr</span><span class="p">.</span><span class="nx">Err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfig</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">scpr</span><span class="p">.</span><span class="nx">Config</span><span class="p">.(</span><span class="o">*</span><span class="nx">ServiceConfig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">mkp</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">KeepaliveParams</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">initAuthority</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Register ClientConn with channelz. Note that this is only done after
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// channel creation cannot fail.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cc</span><span class="p">.</span><span class="nf">channelzRegistration</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">channelz</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;parsed dial target is: %#v&#34;</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">channelz</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;Channel authority set to %q&#34;</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">authority</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">csMgr</span> <span class="p">=</span> <span class="nf">newConnectivityStateManager</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nx">pickerWrapper</span> <span class="p">=</span> <span class="nf">newPickerWrapper</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">StatsHandlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cc</span><span class="p">.</span><span class="nf">initIdleStateLocked</span><span class="p">()</span> <span class="c1">// Safe to call without the lock, since nothing else has a reference to cc.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cc</span><span class="p">.</span><span class="nx">idlenessMgr</span> <span class="p">=</span> <span class="nx">idle</span><span class="p">.</span><span class="nf">NewManager</span><span class="p">((</span><span class="o">*</span><span class="nx">idler</span><span class="p">)(</span><span class="nx">cc</span><span class="p">),</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">idleTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âú® gRPC Ê°ÜÊû∂‰∏≠Ôºå<code>NewClient</code> ÂáΩÊï∞Ë¥üË¥£‰∏∫ÁªôÂÆöÁöÑÁõÆÊ†á URI ÂàõÂª∫‰∏Ä‰∏™ gRPC ‚ÄúÈÄöÈÅì‚ÄùÔºàÂç≥ <code>ClientConn</code>Ôºâ„ÄÇ<code>ClientConn</code> ÊòØ gRPC ÂÆ¢Êà∑Á´Ø‰∏éÊúçÂä°Âô®‰πãÈó¥ÁöÑËôöÊãüËøûÊé•ÔºåÂÆÉÂèØ‰ª•Ê†πÊçÆÈúÄË¶ÅÂàõÂª∫Â§ö‰∏™ÂÆûÈôÖËøûÊé•„ÄÇËøô‰∏™ÂáΩÊï∞‰∏ªË¶ÅÊâßË°å‰ª•‰∏ã‰ªªÂä°Ôºö</p>
<ol>
<li><strong>Ëß£ÊûêÁõÆÊ†á URI</strong>ÔºöÊ†πÊçÆÁõÆÊ†á URI ÁöÑÊñπÊ°àÔºàÂ¶Ç <code>dns://</code> Êàñ <code>passthrough://</code>ÔºâÔºåÈÄâÊã©ÂêàÈÄÇÁöÑËß£ÊûêÂô®Êù•Ëß£ÊûêÊúçÂä°Âú∞ÂùÄ„ÄÇ</li>
<li><strong>ÈÖçÁΩÆËøûÊé•ÂèÇÊï∞</strong>ÔºöÂ∫îÁî®ÂêÑÁßçÊã®Âè∑ÈÄâÈ°πÔºàÂ¶ÇÂÆâÂÖ®Âá≠ËØÅ„ÄÅË¥üËΩΩÂùáË°°Á≠ñÁï•„ÄÅÈáçËØïÁ≠ñÁï•Á≠âÔºâÔºåÂπ∂ÂàùÂßãÂåñ <code>ClientConn</code> ÁöÑÁä∂ÊÄÅ„ÄÇ</li>
<li><strong>ÂàõÂª∫ËøûÊé•</strong>ÔºöÂú®ÂêéÂè∞Â∞ùËØï‰∏éÁõÆÊ†áÂú∞ÂùÄÂª∫Á´ãËøûÊé•ÔºåÂπ∂Ê†πÊçÆËøûÊé•Áä∂ÊÄÅÊõ¥Êñ∞ <code>ClientConn</code> ÁöÑÁä∂ÊÄÅ„ÄÇ</li>
<li><strong>ÁÆ°ÁêÜËøûÊé•ÁîüÂëΩÂë®Êúü</strong>ÔºöÂú®ËøûÊé•ÁöÑÁîüÂëΩÂë®Êúü‰∏≠Ôºå<code>ClientConn</code> ‰ºöËá™Âä®Â§ÑÁêÜËøûÊé•Â§±Ë¥•„ÄÅÈáçËøû„ÄÅË¥üËΩΩÂùáË°°Á≠âÈÄªËæë„ÄÇ</li>
</ol>
<h2 id="grpcÊ°ÜÊû∂‰∏≠ÁöÑrpcÈÄö‰ø°">gRPCÊ°ÜÊû∂‰∏≠ÁöÑRPCÈÄö‰ø°
</h2><h3 id="grpc-go-‰∏≠-rpc-ÈÄö‰ø°">gRPC-Go ‰∏≠ RPC ÈÄö‰ø°
</h3><h4 id="goÁâàÊú¨grpcÈÄö‰ø°Êú∫Âà∂Ê¶ÇËø∞">GoÁâàÊú¨gRPCÈÄö‰ø°Êú∫Âà∂Ê¶ÇËø∞
</h4><p>Âú® gRPC-Go ‰∏≠ÔºåÂÆ¢Êà∑Á´ØÂèëËµ∑ÁöÑÊØè‰∏Ä‰∏™ RPC Ë∞ÉÁî®ÈÉΩ‰ºöÊ∂âÂèäÂà∞‰ª•‰∏ãÂá†‰∏™Ê≠•È™§Ôºö</p>
<ol>
<li><strong>ÂèëËµ∑ RPC ËØ∑Ê±Ç</strong>ÔºöÂÆ¢Êà∑Á´ØÂàõÂª∫‰∏Ä‰∏™ RPC Ë∞ÉÁî®ÔºåÂπ∂ÂèëÈÄÅÂÖÉÊï∞ÊçÆÂíåËØ∑Ê±ÇÊï∞ÊçÆ„ÄÇ</li>
<li><strong>ÊúçÂä°Âô®Â§ÑÁêÜËØ∑Ê±Ç</strong>ÔºöÊúçÂä°Âô®Êé•Êî∂Âà∞ËØ∑Ê±ÇÔºåÂ§ÑÁêÜÂπ∂ÁîüÊàêÂìçÂ∫î„ÄÇ</li>
<li><strong>ÂèëÈÄÅÂìçÂ∫î</strong>ÔºöÊúçÂä°Âô®Â∞ÜÂìçÂ∫îÂèëÈÄÅÂõûÂÆ¢Êà∑Á´Ø„ÄÇ</li>
<li><strong>Êé•Êî∂ÂìçÂ∫î</strong>ÔºöÂÆ¢Êà∑Á´ØÊé•Êî∂Âà∞ÂìçÂ∫îÔºåÂπ∂Â∞ÜÁªìÊûúËøîÂõûÁªôÁî®Êà∑„ÄÇ</li>
</ol>
<h4 id="goÁâàÊú¨grpcÊ∫êÁ†ÅÁªìÊûÑ">GoÁâàÊú¨gRPCÊ∫êÁ†ÅÁªìÊûÑ
</h4><p>gRPC-Go ÁöÑÊ∫êÁ†Å‰∏ªË¶ÅÂàÜ‰∏∫‰ª•‰∏ãÂá†‰∏™Ê®°ÂùóÔºö</p>
<ul>
<li><strong>transport</strong>ÔºöË¥üË¥£Â∫ïÂ±Ç HTTP/2 ‰º†ËæìÁöÑÂÆûÁé∞„ÄÇ</li>
<li><strong>stream</strong>ÔºöÁÆ°ÁêÜÂíåÊéßÂà∂ gRPC ÁöÑÊµÅ„ÄÇ</li>
<li><strong>server</strong> Âíå <strong>client</strong>ÔºöÂàÜÂà´ÁÆ°ÁêÜ gRPC ÊúçÂä°Âô®ÂíåÂÆ¢Êà∑Á´ØÁöÑÁîüÂëΩÂë®Êúü„ÄÇ</li>
<li><strong>codec</strong>ÔºöÁî®‰∫éÊ∂àÊÅØÁöÑÁºñÁ†ÅÂíåËß£Á†Å„ÄÇ</li>
</ul>
<h4 id="grpc-go-‰∏≠-rpc-ÈÄö‰ø°ÊµÅÁ®ãÁöÑÊ∫êÁ†ÅÂàÜÊûê">gRPC-Go ‰∏≠ RPC ÈÄö‰ø°ÊµÅÁ®ãÁöÑÊ∫êÁ†ÅÂàÜÊûê
</h4><h5 id="clientconn-ÁöÑÂàùÂßãÂåñ"><strong><code>ClientConn</code> ÁöÑÂàùÂßãÂåñ</strong>
</h5><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">target</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">DialOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ClientConn</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">target</span><span class="p">:</span> <span class="nx">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conns</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">addrConn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dopts</span><span class="p">:</span>  <span class="nf">defaultDialOptions</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëß£Êûê target Âú∞ÂùÄÔºåÈÄâÊã©ÂêàÈÄÇÁöÑ resolver (Ëß£ÊûêÂô®)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">initParsedTargetAndResolverBuilder</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàùÂßãÂåñËøûÊé•ÁÆ°ÁêÜÂíåË¥üËΩΩÂùáË°°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cc</span><span class="p">.</span><span class="nx">csMgr</span> <span class="p">=</span> <span class="nf">newConnectivityStateManager</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cc</span><span class="p">.</span><span class="nx">pickerWrapper</span> <span class="p">=</span> <span class="nf">newPickerWrapper</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">StatsHandlers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="rpc-ËØ∑Ê±ÇÁöÑÂèëËµ∑"><strong>RPC ËØ∑Ê±ÇÁöÑÂèëËµ∑</strong>
</h5><p>Âú® gRPC-Go ‰∏≠ÔºåRPC ËØ∑Ê±ÇÁöÑÂèëËµ∑‰∏ªË¶ÅÈÄöËøá <code>invoke</code> ÊñπÊ≥ï„ÄÇËøô‰∏™ÊñπÊ≥ï‰Ωç‰∫é <code>google.golang.org/grpc</code> ÂåÖÁöÑ <code>call.go</code> Êñá‰ª∂‰∏≠Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">invoke</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">reply</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newClientStream</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">unaryStreamDesc</span><span class="p">,</span> <span class="nx">cc</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">SendMsg</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">RecvMsg</span><span class="p">(</span><span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>invoke</code> ÊñπÊ≥ïÊòØÂÆ¢Êà∑Á´ØÊâßË°åÂçï‰∏™ RPC Ë∞ÉÁî®ÁöÑÂÖ•Âè£„ÄÇÂÆÉÈ¶ñÂÖàÈÄöËøá <code>newClientStream</code> ÊñπÊ≥ïÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂÆ¢Êà∑Á´ØÊµÅÔºà<code>ClientStream</code>ÔºâÔºåÁÑ∂ÂêéÂèëÈÄÅÊ∂àÊÅØÂπ∂Êé•Êî∂ÂìçÂ∫î„ÄÇ</p>
<h5 id="ÂàõÂª∫-clientstream"><strong>ÂàõÂª∫ ClientStream</strong>
</h5><p><code>newClientStream</code> ÁöÑÂÆûÁé∞‰Ωç‰∫é <code>google.golang.org/grpc</code> ÂåÖÁöÑ <code>stream.go</code> Êñá‰ª∂‰∏≠ÔºåÂÆÉË¥üË¥£ÂàùÂßãÂåñ gRPC ÁöÑÊµÅÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newClientStream</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">desc</span> <span class="o">*</span><span class="nx">StreamDesc</span><span class="p">,</span> <span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">ClientStream</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàùÂßãÂåñ streamÔºåËÆæÁΩÆ‰º†ËæìÂ±Ç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">getTransport</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂºÄÂßãÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">NewStream</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">clientStream</span><span class="p">{</span><span class="nx">s</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">desc</span><span class="p">:</span> <span class="nx">desc</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÈáåÁöÑ <code>NewStream</code> ÊñπÊ≥ïÊòØÁî± <code>transport</code> Â±ÇÊù•Â§ÑÁêÜÁöÑÔºåÂÆÉÂ∞ÜÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ HTTP/2 ÊµÅÔºåÁî®‰∫éÂêéÁª≠ÁöÑÊ∂àÊÅØ‰º†Ëæì„ÄÇ</p>
<h5 id="‰º†ËæìÂ±Çtransport-layer"><strong>‰º†ËæìÂ±ÇÔºàTransport LayerÔºâ</strong>
</h5><p>Âú® gRPC-Go ‰∏≠Ôºå‰º†ËæìÂ±ÇÁöÑÊ†∏ÂøÉÂÆûÁé∞‰Ωç‰∫é <code>transport/http2_client.go</code> ‰∏≠„ÄÇËøô‰∏™Êñá‰ª∂ÂåÖÂê´‰∫Ü gRPC ‰ΩøÁî® HTTP/2 ËøõË°åÊï∞ÊçÆ‰º†ËæìÁöÑÊ†∏ÂøÉÈÄªËæë„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">http2Client</span><span class="p">)</span> <span class="nf">NewStream</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">callHdr</span> <span class="o">*</span><span class="nx">CallHdr</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">Stream</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàõÂª∫ HTTP/2 ÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Stream</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span><span class="p">.</span><span class="nx">activeStreams</span><span class="p">[</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="p">=</span> <span class="nx">s</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂèëÈÄÅËØ∑Ê±ÇÂ§¥ÈÉ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">framer</span><span class="p">.</span><span class="nf">writeHeaders</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>NewStream</code> ÊñπÊ≥ïÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ HTTP/2 ÊµÅÔºåÂπ∂ÈÄöËøá <code>writeHeaders</code> ÊñπÊ≥ïÂ∞Ü gRPC ËØ∑Ê±ÇÁöÑÂÖÉÊï∞ÊçÆÂèëÈÄÅÂà∞ÊúçÂä°Âô®„ÄÇ</p>
<h5 id="Ê∂àÊÅØÁöÑÂèëÈÄÅÂíåÊé•Êî∂"><strong>Ê∂àÊÅØÁöÑÂèëÈÄÅÂíåÊé•Êî∂</strong>
</h5><p>Âú®ÂÆ¢Êà∑Á´ØÊµÅ‰∏≠ÔºåÊ∂àÊÅØÁöÑÂèëÈÄÅÂíåÊé•Êî∂ÈÄöËøá <code>SendMsg</code> Âíå <code>RecvMsg</code> ÊñπÊ≥ïÊù•ÂÆåÊàêÔºåËøô‰∫õÊñπÊ≥ïÂêåÊ†∑‰Ωç‰∫é <code>stream.go</code> Êñá‰ª∂‰∏≠„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//(cs *clientStream) SendMsg(m any) (err error)ÂáΩÊï∞gRPC-Go ÂÆ¢Êà∑Á´ØÁî®‰∫éÂèëÈÄÅÊ∂àÊÅØÁöÑÊ†∏ÂøÉÊñπÊ≥ï„ÄÇÂÆÉÊâßË°å‰∫Ü‰ªéÊ∂àÊÅØÂáÜÂ§áÂà∞ÂÆûÈôÖÂèëÈÄÅÁöÑÊï¥‰∏™ËøáÁ®ãÔºåÂπ∂Â§ÑÁêÜÈîôËØØÂíåÈáçËØïÈÄªËæë„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">clientStream</span><span class="p">)</span> <span class="nf">SendMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//ÈîôËØØÂ§ÑÁêÜÁöÑ defer ÈÄªËæë
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cs</span><span class="p">.</span><span class="nf">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">sentLast</span> <span class="p">{</span>   <span class="c1">//Èò≤Ê≠¢ÈáçÂ§çË∞ÉÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Internal</span><span class="p">,</span> <span class="s">&#34;SendMsg called after CloseSend&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ClientStreams</span> <span class="p">{</span>   <span class="c1">//Â§ÑÁêÜÈùûÂÆ¢Êà∑Á´ØÊµÅÂºèÁöÑ RPC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cs</span><span class="p">.</span><span class="nx">sentLast</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// load hdr, payload, data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">hdr</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">prepareMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">codec</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">cp</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">comp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">//ÂáÜÂ§áÊ∂àÊÅØÊï∞ÊçÆÔºåÊØîÂ¶ÇÁºñÁ†Å‰ªÄ‰πàÁöÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// TODO(dfawley): should we be checking len(data) instead?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">&gt;</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxSendMessageSize</span> <span class="p">{</span>  <span class="c1">//Ê£ÄÊü•Ê∂àÊÅØÂ§ßÂ∞è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">ResourceExhausted</span><span class="p">,</span> <span class="s">&#34;trying to send message larger than max (%d vs. %d)&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxSendMessageSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">op</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>   <span class="c1">//Ê∂àÊÅØÂèëÈÄÅÈÄªËæëÂíåÈáçËØïÊú∫Âà∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nf">sendMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">,</span> <span class="nx">payload</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">withRetry</span><span class="p">(</span><span class="nx">op</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">bufferForRetryLocked</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">hdr</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span> <span class="nx">op</span><span class="p">)</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">//‰∫åËøõÂà∂Êó•ÂøóËÆ∞ÂΩï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cm</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ClientMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">OnClientSide</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Message</span><span class="p">:</span>      <span class="nx">data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">			<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//func (cs *clientStream) RecvMsg(m any) error ÊòØ gRPC-Go ÂÆ¢Êà∑Á´ØÁî®‰∫éÊé•Êî∂ÊúçÂä°Âô®ÂìçÂ∫îÊ∂àÊÅØÁöÑÊ†∏ÂøÉÊñπÊ≥ï„ÄÇËøô‰∏™ÂáΩÊï∞Âú®ÂÆ¢Êà∑Á´ØÊé•Êî∂ÊúçÂä°Âô®ÁöÑÂìçÂ∫îÊó∂ÊâßË°åÔºåÂπ∂ÂåÖÊã¨‰∫ÜÈîôËØØÂ§ÑÁêÜ„ÄÅÈáçËØïÊú∫Âà∂„ÄÅ‰ª•ÂèäÊó•ÂøóËÆ∞ÂΩïÁ≠âÂäüËÉΩ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">clientStream</span><span class="p">)</span> <span class="nf">RecvMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//‰∫åËøõÂà∂Êó•ÂøóËÆ∞ÂΩïÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">serverHeaderBinlogged</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">		<span class="c1">// Call Header() to binary log header if it&#39;s not already logged.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cs</span><span class="p">.</span><span class="nf">Header</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Êé•Êî∂‰ø°ÊÅØÁöÑÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">recvInfo</span> <span class="o">*</span><span class="nx">payloadInfo</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">recvInfo</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">payloadInfo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Ê∂àÊÅØÊé•Êî∂ÈÄªËæëÂèäÈáçËØïÊú∫Âà∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">cs</span><span class="p">.</span><span class="nf">withRetry</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nf">recvMsg</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">recvInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">commitAttemptLocked</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//‰∫åËøõÂà∂Êó•ÂøóËÆ∞ÂΩïÂ§ÑÁêÜ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sm</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ServerMessage</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">OnClientSide</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Message</span><span class="p">:</span>      <span class="nx">recvInfo</span><span class="p">.</span><span class="nx">uncompressedBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">sm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÁªìÊùüÊµÅÊàñÂ§ÑÁêÜÈîôËØØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ServerStreams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// err != nil or non-server-streaming indicates end of stream.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">cs</span><span class="p">.</span><span class="nf">finish</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏äÈù¢ÁöÑ<code>SendMsg</code> Âíå <code>RecvMsg</code> ÊñπÊ≥ïÂÆûÈôÖË∞ÉÁî®‰∫ÜÊõ¥Â∫ïÂ±ÇÁöÑ<code>sendMsg</code>Âíå<code>recvMsg</code>„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//sendMsg ÂáΩÊï∞ÁöÑ‰∏ªË¶ÅËÅåË¥£ÊòØÂ∞ÜÁºñÁ†ÅÂêéÁöÑÊ∂àÊÅØÈÄöËøáÂ∫ïÂ±Ç‰º†ËæìÂ±ÇÂèëÈÄÅÁªôÊúçÂä°Âô®ÔºåÂπ∂Â§ÑÁêÜÂèëÈÄÅËøáÁ®ã‰∏≠ÁöÑÈîôËØØÂíåÁªüËÆ°‰ø°ÊÅØ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="nf">sendMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">,</span> <span class="nx">payld</span><span class="p">,</span> <span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cs</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cs</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">payload</span><span class="p">{</span><span class="nx">sent</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">msg</span><span class="p">:</span> <span class="nx">m</span><span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">hdr</span><span class="p">,</span> <span class="nx">payld</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">transport</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span><span class="nx">Last</span><span class="p">:</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ClientStreams</span><span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ClientStreams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// For non-client-streaming RPCs, we return nil instead of EOF on error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// because the generated code requires it.  finish is not called; RecvMsg()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// will call it with the stream&#39;s status independently.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">statsHandlers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nf">outPayload</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">payld</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">IsOn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">IncrMsgSent</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//recvMsg ÂáΩÊï∞ÁöÑ‰∏ªË¶ÅËÅåË¥£ÊòØ‰ªéÊúçÂä°Âô®Êé•Êî∂Ê∂àÊÅØÂπ∂Ëß£Á†ÅÔºåÂêåÊó∂Â§ÑÁêÜÊé•Êî∂ËøáÁ®ã‰∏≠ÁöÑÈîôËØØ„ÄÅËß£ÂéãÁº©ÂíåÁªüËÆ°‰ø°ÊÅØ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">csAttempt</span><span class="p">)</span> <span class="nf">recvMsg</span><span class="p">(</span><span class="nx">m</span> <span class="nx">any</span><span class="p">,</span> <span class="nx">payInfo</span> <span class="o">*</span><span class="nx">payloadInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cs</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">cs</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">statsHandlers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">payInfo</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">payInfo</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">payloadInfo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">a</span><span class="p">.</span><span class="nx">decompSet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Block until we receive headers containing received message encoding.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">ct</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">();</span> <span class="nx">ct</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">ct</span> <span class="o">!=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">Identity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">ct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// No configured decompressor, or it does not match the incoming
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// message encoding; attempt to find a registered compressor that does.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">a</span><span class="p">.</span><span class="nx">dc</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">				<span class="nx">a</span><span class="p">.</span><span class="nx">decomp</span> <span class="p">=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nf">GetCompressor</span><span class="p">(</span><span class="nx">ct</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// No compression is used; disable our decompressor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">a</span><span class="p">.</span><span class="nx">dc</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Only initialize this state once per stream.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">a</span><span class="p">.</span><span class="nx">decompSet</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nf">recv</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">codec</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxReceiveMessageSize</span><span class="p">,</span> <span class="nx">payInfo</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">decomp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">statusErr</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">statusErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">statusErr</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="c1">// indicates successful end of stream.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">toRPCErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">a</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">payload</span><span class="p">{</span><span class="nx">sent</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">msg</span><span class="p">:</span> <span class="nx">m</span><span class="p">},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span><span class="p">.</span><span class="nx">statsHandlers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">InPayload</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Client</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">RecvTime</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Payload</span><span class="p">:</span>  <span class="nx">m</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// TODO truncate large payload.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">Data</span><span class="p">:</span>             <span class="nx">payInfo</span><span class="p">.</span><span class="nx">uncompressedBytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">WireLength</span><span class="p">:</span>       <span class="nx">payInfo</span><span class="p">.</span><span class="nx">compressedLength</span> <span class="o">+</span> <span class="nx">headerLen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">CompressedLength</span><span class="p">:</span> <span class="nx">payInfo</span><span class="p">.</span><span class="nx">compressedLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Length</span><span class="p">:</span>           <span class="nb">len</span><span class="p">(</span><span class="nx">payInfo</span><span class="p">.</span><span class="nx">uncompressedBytes</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">IsOn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">a</span><span class="p">.</span><span class="nx">t</span><span class="p">.</span><span class="nf">IncrMsgRecv</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">ServerStreams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Subsequent messages should be received by subsequent RecvMsg calls.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Special handling for non-server-stream rpcs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This recv expects EOF or errors, so we don&#39;t collect inPayload.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nf">recv</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">p</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">codec</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">dc</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="o">*</span><span class="nx">cs</span><span class="p">.</span><span class="nx">callInfo</span><span class="p">.</span><span class="nx">maxReceiveMessageSize</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">decomp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">toRPCErr</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;grpc: client streaming protocol violation: get &lt;nil&gt;, want &lt;EOF&gt;&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Status</span><span class="p">().</span><span class="nf">Err</span><span class="p">()</span> <span class="c1">// non-server streaming Recv returns nil on success
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">toRPCErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ÊúçÂä°Âô®Á´ØÁöÑÂ§ÑÁêÜ"><strong>ÊúçÂä°Âô®Á´ØÁöÑÂ§ÑÁêÜ</strong>
</h5><p>Âú®ÊúçÂä°Âô®Á´ØÔºåRPC Ë∞ÉÁî®ÁöÑÂ§ÑÁêÜÈÄöËøá <code>handleStream</code> ÂáΩÊï∞ËøõË°åÁÆ°ÁêÜ„ÄÇËøô‰∏™ÂáΩÊï∞‰Ωç‰∫é <code>server.go</code> Êñá‰ª∂‰∏≠Ôºå<code>handleStream</code> ÊñπÊ≥ïÂ§ÑÁêÜ‰º†ÂÖ•ÁöÑÊµÅÔºåËß£ÊûêÂÆ¢Êà∑Á´ØÁöÑËØ∑Ê±ÇÔºåÂπ∂Ë∞ÉÁî®Áõ∏Â∫îÁöÑÊúçÂä°ÊñπÊ≥ïÊù•ÁîüÊàêÂìçÂ∫î„ÄÇ</p>
<p><strong>‰∏ä‰∏ãÊñáÂàùÂßãÂåñÂíåËøΩË∏™‰ø°ÊÅØ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Context</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">ctx</span> <span class="p">=</span> <span class="nf">contextWithServer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">ti</span> <span class="o">*</span><span class="nx">traceInfo</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">EnableTracing</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tr</span> <span class="o">:=</span> <span class="nf">newTrace</span><span class="p">(</span><span class="s">&#34;grpc.Recv.&#34;</span><span class="o">+</span><span class="nf">methodFamily</span><span class="p">(</span><span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">()),</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nf">newTraceContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">traceInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tr</span><span class="p">:</span> <span class="nx">tr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">firstLine</span><span class="p">:</span> <span class="nx">firstLine</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">client</span><span class="p">:</span>     <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">remoteAddr</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Peer</span><span class="p">().</span><span class="nx">Addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">dl</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Deadline</span><span class="p">();</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">firstLine</span><span class="p">.</span><span class="nx">deadline</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">dl</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>‰∏ä‰∏ãÊñáÂáÜÂ§á</strong>Ôºö‰ªéÊµÅ‰∏≠ÊèêÂèñÂá∫‰∏ä‰∏ãÊñáÔºåÂπ∂Â∞ÜÊúçÂä°Âô®Áõ∏ÂÖ≥ÁöÑ‰ø°ÊÅØÊ∑ªÂä†Âà∞‰∏ä‰∏ãÊñá‰∏≠„ÄÇ</li>
<li><strong>ËøΩË∏™‰ø°ÊÅØ</strong>ÔºöÂ¶ÇÊûúÂêØÁî®‰∫ÜËøΩË∏™Ôºà<code>EnableTracing</code>ÔºâÔºåÂáΩÊï∞‰ºöÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑËøΩË∏™ÂØπË±°ÔºåÂπ∂Â∞ÜÂÖ∂Ê∑ªÂä†Âà∞‰∏ä‰∏ãÊñá‰∏≠„ÄÇËøΩË∏™ÂØπË±°Áî®‰∫éËÆ∞ÂΩïËØ∑Ê±ÇÁöÑÂ§ÑÁêÜËøáÁ®ãÂíåÁõ∏ÂÖ≥ÁöÑÂÖÉÊï∞ÊçÆÔºàÂ¶ÇÂÆ¢Êà∑Á´ØÂú∞ÂùÄ„ÄÅÊà™Ê≠¢Êó∂Èó¥Á≠âÔºâ„ÄÇ</li>
</ul>
<p><strong>Ëß£ÊûêÊñπÊ≥ïÂêçÁß∞</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">sm</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">sm</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">sm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sm</span> <span class="p">=</span> <span class="nx">sm</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">pos</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">LastIndex</span><span class="p">(</span><span class="nx">sm</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Â§ÑÁêÜÈîôËØØÁöÑËØ∑Ê±ÇÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fmtStringer</span><span class="p">{</span><span class="s">&#34;Malformed method name %q&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">any</span><span class="p">{</span><span class="nx">sm</span><span class="p">}},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">errDesc</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;malformed method name: %q&#34;</span><span class="p">,</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="nx">errDesc</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fmtStringer</span><span class="p">{</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">any</span><span class="p">{</span><span class="nx">err</span><span class="p">}},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">channelz</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;grpc: Server.handleStream failed to write status: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">service</span> <span class="o">:=</span> <span class="nx">sm</span><span class="p">[:</span><span class="nx">pos</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">method</span> <span class="o">:=</span> <span class="nx">sm</span><span class="p">[</span><span class="nx">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÊñπÊ≥ïÂêçÁß∞Ëß£Êûê</strong>Ôºö‰ªéËØ∑Ê±ÇÁöÑ <code>Method</code> ‰∏≠Ëß£ÊûêÂá∫ÊúçÂä°ÂêçÂíåÊñπÊ≥ïÂêç„ÄÇÂ¶ÇÊûúËß£ÊûêÂ§±Ë¥•Ôºà‰æãÂ¶ÇÊñπÊ≥ïÂêçÁß∞Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºâÔºåÂàôÁ´ãÂç≥ËøîÂõû‰∏Ä‰∏™ <code>Unimplemented</code> ÈîôËØØÁä∂ÊÄÅ„ÄÇ</li>
</ul>
<p><strong>Â§ÑÁêÜÂÖÉÊï∞ÊçÆÂíåÁªüËÆ°‰ø°ÊÅØ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">md</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">FromIncomingContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statsHandlers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">sh</span><span class="p">.</span><span class="nf">TagRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">RPCTagInfo</span><span class="p">{</span><span class="nx">FullMethodName</span><span class="p">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">()})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">InHeader</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span>  <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">RemoteAddr</span><span class="p">:</span>  <span class="nx">t</span><span class="p">.</span><span class="nf">Peer</span><span class="p">().</span><span class="nx">Addr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">LocalAddr</span><span class="p">:</span>   <span class="nx">t</span><span class="p">.</span><span class="nf">Peer</span><span class="p">().</span><span class="nx">LocalAddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Compression</span><span class="p">:</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">WireLength</span><span class="p">:</span>  <span class="nx">stream</span><span class="p">.</span><span class="nf">HeaderWireLength</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Header</span><span class="p">:</span>      <span class="nx">md</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">stream</span><span class="p">.</span><span class="nf">SetContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂÖÉÊï∞ÊçÆÊèêÂèñ</strong>Ôºö‰ªé‰∏ä‰∏ãÊñá‰∏≠ÊèêÂèñÂÖÉÊï∞ÊçÆÔºà<code>metadata</code>ÔºâÔºå‰æãÂ¶ÇËØ∑Ê±ÇÂ§¥‰∏≠ÁöÑ‰ø°ÊÅØ„ÄÇ</li>
<li><strong>ÁªüËÆ°Â§ÑÁêÜ</strong>ÔºöÈÅçÂéÜÊâÄÊúâÂ∑≤ÈÖçÁΩÆÁöÑÁªüËÆ°Â§ÑÁêÜÂô®ÔºåÂπ∂Ë∞ÉÁî®ÂÆÉ‰ª¨Êù•ËÆ∞ÂΩïÊ≠§Ê¨° RPC Ë∞ÉÁî®ÁöÑÁªüËÆ°Êï∞ÊçÆ„ÄÇ</li>
</ul>
<p><strong>Ê†πÊçÆÊñπÊ≥ïÂêçÁß∞ÈÄâÊã©Â§ÑÁêÜÂô®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">srv</span><span class="p">,</span> <span class="nx">knownService</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">services</span><span class="p">[</span><span class="nx">service</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">knownService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">methods</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">processUnaryRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">srv</span><span class="p">,</span> <span class="nx">md</span><span class="p">,</span> <span class="nx">ti</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">sd</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">streams</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">processStreamingRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="nx">srv</span><span class="p">,</span> <span class="nx">sd</span><span class="p">,</span> <span class="nx">ti</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÊúçÂä°ÂíåÊñπÊ≥ïÊü•Êâæ</strong>ÔºöÊ†πÊçÆËß£ÊûêÂá∫ÁöÑÊúçÂä°ÂêçÂíåÊñπÊ≥ïÂêçÔºåÂú®Ê≥®ÂÜåÁöÑÊúçÂä°‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÊúçÂä°ÂØπË±°ÂíåÊñπÊ≥ï„ÄÇ</li>
<li><strong>Â§ÑÁêÜËØ∑Ê±Ç</strong>ÔºöÂ¶ÇÊûúÊâæÂà∞ÂØπÂ∫îÁöÑÂ§ÑÁêÜÂô®ÔºåÂàôË∞ÉÁî® <code>processUnaryRPC</code> Êàñ <code>processStreamingRPC</code> Êù•Â§ÑÁêÜËØ∑Ê±Ç„ÄÇËøô‰∏§‰∏™ÂáΩÊï∞ÂàÜÂà´Áî®‰∫éÂ§ÑÁêÜÂçïÂêë RPC ÂíåÊµÅÂºè RPC„ÄÇ</li>
</ul>
<p><strong>Â§ÑÁêÜÊú™Áü•ÊúçÂä°ÊàñÊñπÊ≥ï</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">unknownDesc</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">unknownStreamDesc</span><span class="p">;</span> <span class="nx">unknownDesc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">processStreamingRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stream</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">unknownDesc</span><span class="p">,</span> <span class="nx">ti</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">errDesc</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">!</span><span class="nx">knownService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">errDesc</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unknown service %v&#34;</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">errDesc</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unknown method %v for service %v&#34;</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyPrintf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">errDesc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">status</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="nx">errDesc</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fmtStringer</span><span class="p">{</span><span class="s">&#34;%v&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="nx">any</span><span class="p">{</span><span class="nx">err</span><span class="p">}},</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">channelz</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">channelz</span><span class="p">,</span> <span class="s">&#34;grpc: Server.handleStream failed to write status: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">ti</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ti</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Â§ÑÁêÜÊú™Áü•ÊúçÂä°ÊàñÊñπÊ≥ï</strong>ÔºöÂ¶ÇÊûúÊúçÂä°ÊàñÊñπÊ≥ïÊú™ÊâæÂà∞ÔºåÂáΩÊï∞‰ºöËøîÂõû‰∏Ä‰∏™ <code>Unimplemented</code> Áä∂ÊÄÅÔºåË°®Á§∫ÂÆ¢Êà∑Á´ØËØ∑Ê±ÇÁöÑÊúçÂä°ÊàñÊñπÊ≥ï‰∏çÂ≠òÂú®„ÄÇÂ¶ÇÊûúÈÖçÁΩÆ‰∫Ü <code>unknownStreamDesc</code>ÔºåÂ∞ÜË∞ÉÁî®ÂÖ∂Â§ÑÁêÜÂô®Êù•Â§ÑÁêÜÊú™Áü•ÁöÑËØ∑Ê±ÇÔºåÂê¶ÂàôÁõ¥Êé•ËøîÂõûÈîôËØØ„ÄÇ</li>
</ul>
<p>Êàë‰ª¨ËøôÈáåÁªßÁª≠ÂæÄ‰∏ãÂàÜÊûê<code>processStreamingRPC</code>ÂáΩÊï∞</p>
<blockquote>
<p><code>processStreamingRPC</code> ÊòØ gRPC-Go ÊúçÂä°Âô®Á´ØÂ§ÑÁêÜÊµÅÂºè RPC ËØ∑Ê±ÇÁöÑÂÖ≥ÈîÆÂáΩÊï∞„ÄÇÂÆÉË¥üË¥£Â§ÑÁêÜÂÆ¢Êà∑Á´Ø‰∏éÊúçÂä°Âô®‰πãÈó¥ÁöÑÂèåÂêëÊàñÂçïÂêëÊµÅÂºè RPC Ë∞ÉÁî®„ÄÇËøô‰∏™ÂáΩÊï∞ÊâßË°åÁöÑ‰∏ªË¶Å‰ªªÂä°ÂåÖÊã¨ÔºöÂàùÂßãÂåñ‰∏ä‰∏ãÊñáÂíåÊµÅ„ÄÅÂ§ÑÁêÜÂéãÁº©ÂíåËß£ÂéãÁº©„ÄÅË∞ÉÁî®ÂÆûÈôÖÁöÑ RPC ÊñπÊ≥ïÂ§ÑÁêÜÂô®ÔºåÂπ∂Âú®ÂÆåÊàêÂêéËÆ∞ÂΩïÊó•ÂøóÂíåÁä∂ÊÄÅ„ÄÇ</p>
</blockquote>
<p><strong>1„ÄÅÂáΩÊï∞ÁªìÊûÑÊ¶ÇËø∞</strong></p>
<p><code>processStreamingRPC</code> Â§ÑÁêÜÊµÅÂºè RPC ÁöÑÊ†∏ÂøÉÈÄªËæëÂèØ‰ª•ÂàÜ‰∏∫‰ª•‰∏ãÂá†‰∏™‰∏ªË¶ÅÈÉ®ÂàÜÔºö</p>
<ol>
<li>ÂàùÂßãÂåñ‰∏ä‰∏ãÊñáÂíåËøΩË∏™‰ø°ÊÅØ„ÄÇ</li>
<li>ÂàùÂßãÂåñÊµÅÔºà<code>serverStream</code>ÔºâÂØπË±°„ÄÇ</li>
<li>Â§ÑÁêÜÂéãÁº©ÂíåËß£ÂéãÁº©ÈÄªËæë„ÄÇ</li>
<li>Ë∞ÉÁî®ÂÆûÈôÖÁöÑ RPC Â§ÑÁêÜÂô®„ÄÇ</li>
<li>Â§ÑÁêÜ RPC Ë∞ÉÁî®ÂêéÁöÑÊ∏ÖÁêÜÂíåÊó•ÂøóËÆ∞ÂΩï„ÄÇ</li>
</ol>
<p><strong>2„ÄÅÂÖ≥ÈîÆÊ≠•È™§Ëß£Êûê</strong></p>
<p><strong>ÂàùÂßãÂåñ‰∏ä‰∏ãÊñáÂíåËøΩË∏™‰ø°ÊÅØ</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">IsOn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">incrCallsStarted</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">shs</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">statsHandlers</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">statsBegin</span> <span class="o">*</span><span class="nx">stats</span><span class="p">.</span><span class="nx">Begin</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">shs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">beginTime</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">statsBegin</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">stats</span><span class="p">.</span><span class="nx">Begin</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">BeginTime</span><span class="p">:</span>      <span class="nx">beginTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsClientStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ClientStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsServerStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ServerStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sh</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">shs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sh</span><span class="p">.</span><span class="nf">HandleRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">statsBegin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">ctx</span> <span class="p">=</span> <span class="nf">NewContextWithServerTransportStream</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">stream</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ËøΩË∏™ÂíåÁªüËÆ°‰ø°ÊÅØ</strong>ÔºöÂ¶ÇÊûúÂêØÁî®‰∫Ü <code>channelz</code>ÔºåÊúçÂä°Âô®‰ºöÂ¢ûÂä†ÂêØÂä®ÁöÑ RPC Ë∞ÉÁî®ËÆ°Êï∞„ÄÇÁÑ∂ÂêéÔºåÂ¶ÇÊûúÊúâÈÖçÁΩÆÁªüËÆ°Â§ÑÁêÜÂô®Ôºå‰ºöËÆ∞ÂΩï RPC Ë∞ÉÁî®ÁöÑÂºÄÂßãÊó∂Èó¥ÂíåÂÖ∂‰ªñÂÖÉÊï∞ÊçÆ„ÄÇ</li>
<li><strong>‰∏ä‰∏ãÊñáÂàùÂßãÂåñ</strong>ÔºöÈÄöËøá <code>NewContextWithServerTransportStream</code> ÂáΩÊï∞Â∞ÜÊµÅÂØπË±°Âä†ÂÖ•Âà∞‰∏ä‰∏ãÊñá‰∏≠Ôºå‰æø‰∫éÂêéÁª≠Â§ÑÁêÜ„ÄÇ</li>
</ul>
<p>ÂàùÂßãÂåñ <code>serverStream</code> ÂØπË±°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ss := &amp;serverStream{
</span></span><span class="line"><span class="cl">	ctx:                   ctx,
</span></span><span class="line"><span class="cl">	t:                     t,
</span></span><span class="line"><span class="cl">	s:                     stream,
</span></span><span class="line"><span class="cl">	p:                     &amp;parser{r: stream, recvBufferPool: s.opts.recvBufferPool},
</span></span><span class="line"><span class="cl">	codec:                 s.getCodec(stream.ContentSubtype()),
</span></span><span class="line"><span class="cl">	maxReceiveMessageSize: s.opts.maxReceiveMessageSize,
</span></span><span class="line"><span class="cl">	maxSendMessageSize:    s.opts.maxSendMessageSize,
</span></span><span class="line"><span class="cl">	trInfo:                trInfo,
</span></span><span class="line"><span class="cl">	statsHandler:          shs,
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂàõÂª∫ <code>serverStream</code></strong>Ôºö<code>serverStream</code> ÊòØ gRPC-Go Áî®‰∫éÂ§ÑÁêÜÊµÅÂºè RPC ËØ∑Ê±ÇÁöÑÊ†∏ÂøÉÂØπË±°„ÄÇÂÆÉÂåÖÂê´‰∫Ü‰∏éÂΩìÂâçÊµÅÁõ∏ÂÖ≥ÁöÑÊâÄÊúâ‰ø°ÊÅØÔºåÂ¶Ç‰∏ä‰∏ãÊñá„ÄÅ‰º†ËæìÂ±Ç„ÄÅÁºñËß£Á†ÅÂô®Á≠â„ÄÇ</li>
</ul>
<p><strong>Â§ÑÁêÜÂéãÁº©ÂíåËß£ÂéãÁº©ÈÄªËæë</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rc</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">();</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dc</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">rc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">dc</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">dc</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">Identity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">decomp</span> <span class="p">=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nf">GetCompressor</span><span class="p">(</span><span class="nx">rc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">decomp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">st</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Newf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unimplemented</span><span class="p">,</span> <span class="s">&#34;grpc: Decompressor is not installed for grpc-encoding %q&#34;</span><span class="p">,</span> <span class="nx">rc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">cp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">cp</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">cp</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">sendCompressorName</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">cp</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">rc</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nf">RecvCompress</span><span class="p">();</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">rc</span> <span class="o">!=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">Identity</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">comp</span> <span class="p">=</span> <span class="nx">encoding</span><span class="p">.</span><span class="nf">GetCompressor</span><span class="p">(</span><span class="nx">rc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">comp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">sendCompressorName</span> <span class="p">=</span> <span class="nx">rc</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>Ëß£ÂéãÁº©ËÆæÁΩÆ</strong>ÔºöÊ£ÄÊü•ÂÆ¢Êà∑Á´ØËØ∑Ê±Ç‰∏≠‰ΩøÁî®ÁöÑÂéãÁº©ÊñπÊ≥ïÔºåÂ¶ÇÊûúÊúçÂä°Âô®Á´ØÈÖçÁΩÆ‰∫ÜÂØπÂ∫îÁöÑËß£ÂéãÁº©Âô®ÔºåÂàôËÆæÁΩÆÂú® <code>serverStream</code> ÂØπË±°‰∏≠„ÄÇÂ¶ÇÊûúÊâæ‰∏çÂà∞ÂØπÂ∫îÁöÑËß£ÂéãÁº©Âô®ÔºåÂàôËøîÂõû <code>Unimplemented</code> ÈîôËØØ„ÄÇ</li>
<li><strong>ÂéãÁº©ËÆæÁΩÆ</strong>ÔºöÂ¶ÇÊûúÊúçÂä°Âô®ÈÖçÁΩÆ‰∫ÜÂéãÁº©Âô®ÔºåÊàñËÄÖÂÆ¢Êà∑Á´ØËØ∑Ê±Ç‰∏≠ÊåáÂÆö‰∫ÜÂéãÁº©ÊñπÊ≥ïÔºåÊúçÂä°Âô®‰ºöÂ∞ùËØï‰ΩøÁî®Áõ∏ÂêåÁöÑÂéãÁº©ÊñπÊ≥ïÂìçÂ∫î„ÄÇ</li>
</ul>
<p><strong>Ë∞ÉÁî®ÂÆûÈôÖÁöÑ RPC Â§ÑÁêÜÂô®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">appErr</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">server</span> <span class="nx">any</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">info</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">serviceImpl</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nx">streamInt</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">appErr</span> <span class="p">=</span> <span class="nx">sd</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">ss</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">StreamServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span>     <span class="nx">stream</span><span class="p">.</span><span class="nf">Method</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsClientStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ClientStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IsServerStream</span><span class="p">:</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">ServerStreams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">appErr</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">opts</span><span class="p">.</span><span class="nf">streamInt</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">ss</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÂÆûÈôÖË∞ÉÁî®</strong>ÔºöËøôÈáåÊ†πÊçÆÊòØÂê¶ÈÖçÁΩÆ‰∫ÜÊã¶Êà™Âô®Ôºà<code>streamInt</code>ÔºâÊù•ÂÜ≥ÂÆöÂ¶Ç‰ΩïË∞ÉÁî®ÂÆûÈôÖÁöÑ RPC Â§ÑÁêÜÂô®Ôºà<code>Handler</code>Ôºâ„ÄÇÂ¶ÇÊûúÊúâÊã¶Êà™Âô®ÔºåÂ§ÑÁêÜÂô®‰ºöË¢´Êã¶Êà™Âô®ÂåÖË£ÖÔºõÂê¶ÂàôÁõ¥Êé•Ë∞ÉÁî®Â§ÑÁêÜÂô®„ÄÇ</li>
<li><strong><code>Handler</code> ÂáΩÊï∞</strong>Ôºö<code>Handler</code> ÊòØÁî®Êà∑ÂÆö‰πâÁöÑÂ§ÑÁêÜÊµÅÂºè RPC ËØ∑Ê±ÇÁöÑÂáΩÊï∞ÔºåÂÆÉ‰ºöÂú®ÊúçÂä°Âô®Á´ØÂ§ÑÁêÜ‰ªéÂÆ¢Êà∑Á´ØÊé•Êî∂Âà∞ÁöÑÊï∞ÊçÆÊµÅÔºåÂπ∂Ê†πÊçÆÈÄªËæëÁîüÊàêÂìçÂ∫î„ÄÇ</li>
</ul>
<p><strong>Â§ÑÁêÜ RPC Ë∞ÉÁî®ÂêéÁöÑÊ∏ÖÁêÜÂíåÊó•ÂøóËÆ∞ÂΩï</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">appErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">appStatus</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">FromError</span><span class="p">(</span><span class="nx">appErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">appStatus</span> <span class="p">=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">FromContextError</span><span class="p">(</span><span class="nx">appErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">appErr</span> <span class="p">=</span> <span class="nx">appStatus</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="nf">stringer</span><span class="p">(</span><span class="nx">appStatus</span><span class="p">.</span><span class="nf">Message</span><span class="p">()),</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">SetError</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">st</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ServerTrailer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Trailer</span><span class="p">:</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Trailer</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Err</span><span class="p">:</span>     <span class="nx">appErr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">appStatus</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">appErr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">trInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">trInfo</span><span class="p">.</span><span class="nx">tr</span><span class="p">.</span><span class="nf">LazyLog</span><span class="p">(</span><span class="nf">stringer</span><span class="p">(</span><span class="s">&#34;OK&#34;</span><span class="p">),</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ss</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">st</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">binarylog</span><span class="p">.</span><span class="nx">ServerTrailer</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Trailer</span><span class="p">:</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">.</span><span class="nf">Trailer</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Err</span><span class="p">:</span>     <span class="nx">appErr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">binlog</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ss</span><span class="p">.</span><span class="nx">binlogs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">binlog</span><span class="p">.</span><span class="nf">Log</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nf">WriteStatus</span><span class="p">(</span><span class="nx">ss</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">statusOK</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>ÈîôËØØÂ§ÑÁêÜ</strong>ÔºöÂ¶ÇÊûúÂ§ÑÁêÜËøáÁ®ã‰∏≠ÂèëÁîüÈîôËØØÔºåÂáΩÊï∞‰ºöÂ∞ÜÈîôËØØËΩ¨Êç¢‰∏∫ gRPC Áä∂ÊÄÅÁ†ÅÂπ∂ËøîÂõûÁªôÂÆ¢Êà∑Á´Ø„ÄÇ</li>
<li><strong>Êó•ÂøóÂíåËøΩË∏™</strong>ÔºöËÆ∞ÂΩïÂ§ÑÁêÜËøáÁ®ã‰∏≠ÁöÑÊó•ÂøóÂíåËøΩË∏™‰ø°ÊÅØÔºàÂ¶ÇÈîôËØØ‰ø°ÊÅØ„ÄÅÂìçÂ∫îÁä∂ÊÄÅÁ≠âÔºâÔºåÁ°Æ‰øùÂú®Ë∞ÉËØïÊàñÁõëÊéßÊó∂ÊúâÂÖÖÂàÜÁöÑ‰∏ä‰∏ãÊñá„ÄÇ</li>
<li><strong>ËøîÂõûÁä∂ÊÄÅ</strong>ÔºöÂáΩÊï∞ÊúÄÂêé‰ºöÈÄöËøá <code>WriteStatus</code> Â∞ÜÂ§ÑÁêÜÁªìÊûúÁöÑÁä∂ÊÄÅÁ†ÅÂÜôÂõûÂÆ¢Êà∑Á´Ø„ÄÇ</li>
</ul>
<p><strong>Êé•ÁùÄÂàÜÊûê<code>sd.Handler</code> ÁöÑÊù•Ê∫ê</strong></p>
<p>Âú® gRPC ‰∏≠ÔºåÊúçÂä°ÂíåÊñπÊ≥ïÁöÑÂÆö‰πâÈÄöÂ∏∏ÊòØÂú® <code>.proto</code> Êñá‰ª∂‰∏≠ÂÆö‰πâÁöÑÔºå‰πãÂêéÈÄöËøá gRPC ÁºñËØëÂô®ÁîüÊàêÁõ∏Â∫îÁöÑ Go ‰ª£Á†Å„ÄÇÂú®ÁîüÊàêÁöÑ‰ª£Á†Å‰∏≠ÔºåÊØè‰∏™ÊúçÂä°ÊñπÊ≥ïÈÉΩ‰ºöÊúâ‰∏Ä‰∏™ÂØπÂ∫îÁöÑ <code>Handler</code> ÂáΩÊï∞„ÄÇËøô‰∏™ <code>Handler</code> ÂáΩÊï∞‰ºöÂú®ÊúçÂä°Ê≥®ÂÜåÊó∂Ë¢´‰º†ÈÄíÁªô gRPC ÊúçÂä°Âô®„ÄÇÔºà<strong>ÊâÄ‰ª•containerd‰∏≠ÁöÑÊúçÂä°ÈÉΩÊòØÈÄöËøáhandlerÊù•Â§ÑÁêÜÁöÑÔºåËÄåÈùûÊØè‰∏™ÊúçÂä°ÈÉΩÊòØ‰∏Ä‰∏™ÂçïÁã¨ÁöÑËøõÁ®ãÔºåÂêåÊó∂ËøôÈáå‰∏éÂâçÈù¢ÂΩ¢Êàê‰∫ÜÈó≠ÁéØÔºåÂú®containerdÁöÑÂêØÂä®‰∏≠ÊúâÊ∂âÂèäÂà∞ÊúçÂä°Ê≥®ÂÜå</strong>Ôºâ</p>
<ul>
<li><strong><code>sd</code> ÂØπË±°</strong>Ôºö<code>sd</code> ÊòØ <code>*StreamDesc</code> Á±ªÂûãÁöÑÂØπË±°ÔºåÊèèËø∞‰∫ÜÊµÅÂºè RPC ÊñπÊ≥ïÁöÑÁâπÊÄßÔºåÂåÖÊã¨ÊòØÂê¶ÊòØÂÆ¢Êà∑Á´ØÊµÅ„ÄÅÊòØÂê¶ÊòØÊúçÂä°Âô®Á´ØÊµÅÔºå‰ª•ÂèäÂ§ÑÁêÜËØ• RPC Ë∞ÉÁî®ÁöÑ <code>Handler</code> ÂáΩÊï∞„ÄÇ</li>
<li><strong><code>Handler</code> Â≠óÊÆµ</strong>Ôºö<code>sd.Handler</code> ÊòØ‰∏Ä‰∏™ÂáΩÊï∞Á±ªÂûãÔºåÁî®‰∫éÂ§ÑÁêÜÁâπÂÆöÁöÑÊµÅÂºè RPC ËØ∑Ê±Ç„ÄÇËøô‰∏™ÂáΩÊï∞ÊòØÁî®Êà∑Âú®ÊúçÂä°Ê≥®ÂÜåÊó∂Êèê‰æõÁöÑÔºåÁî®‰∫éÊâßË°åÂÆûÈôÖÁöÑ‰∏öÂä°ÈÄªËæë„ÄÇ</li>
</ul>
<h2 id="containerd‰∏écontainerd-shimÈÄö‰ø°Êú∫Âà∂">Containerd‰∏éContainerd-shimÈÄö‰ø°Êú∫Âà∂
</h2><p><code>containerd-shim</code> Âíå <code>containerd</code> ‰πãÈó¥ÁöÑÈÄö‰ø°ÊòØÂÆπÂô®ËøêË°åÊó∂ÁöÑÊ†∏ÂøÉÈÉ®ÂàÜÔºåÁ°Æ‰øùÂÆπÂô®ÁöÑÂàõÂª∫„ÄÅÁÆ°ÁêÜÂíåÂà†Èô§Á≠âÊìç‰ΩúËÉΩÂ§üÈ°∫Âà©ËøõË°å„ÄÇÂÆÉ‰ª¨‰πãÈó¥ÁöÑÈÄö‰ø°‰∏ªË¶ÅÈÄöËøá‰ª•‰∏ãÊñπÂºèËøõË°åÔºö</p>
<h3 id="ttrpc">ttRPC
</h3><p><code>containerd</code> Âíå <code>containerd-shim</code> ‰πãÈó¥ÁöÑÈÄö‰ø°‰∏ªË¶ÅÈÄöËøá‰∏ÄÁßçÁß∞‰∏∫ <code>ttRPC</code> ÁöÑËΩªÈáèÁ∫ß RPC Ê°ÜÊû∂ËøõË°å„ÄÇ<code>ttRPC</code> ÊòØ <code>containerd</code> È°πÁõÆ‰∏≠ÂºïÂÖ•ÁöÑÔºå‰∏ìÈó®ËÆæËÆ°Áî®‰∫éÈ´òÊïàÁöÑËøõÁ®ãÈó¥ÈÄö‰ø°ÔºàIPCÔºâÔºåÁâπÂà´ÊòØÂú®Âêå‰∏Ä‰∏ªÊú∫‰∏äËøêË°åÁöÑËøõÁ®ã‰πãÈó¥„ÄÇ</p>
<ul>
<li>ttRPC:
<ul>
<li><code>ttRPC</code> ÊòØ <code>containerd</code> Âõ¢ÈòüÂºÄÂèëÁöÑ‰∏ÄÁßç‰ºòÂåñÂêéÁöÑ RPC Ê°ÜÊû∂ÔºåÊó®Âú®Êèê‰æõÊØî gRPC Êõ¥‰ΩéÁöÑÂª∂ËøüÂíåÊõ¥Â∞èÁöÑÂºÄÈîÄ„ÄÇÂÆÉÁõ¥Êé•ÈÄöËøá Unix ÂüüÂ•óÊé•Â≠óËøõË°åÈÄö‰ø°ÔºåÊ≤°Êúâ HTTP/2 ÁöÑÂºÄÈîÄ„ÄÇ</li>
<li><code>containerd</code> ‰ΩøÁî® <code>ttRPC</code> Êù•Âêë <code>containerd-shim</code> ÂèëÈÄÅÊéßÂà∂ÂëΩ‰ª§ÔºåÂ¶ÇÂêØÂä®„ÄÅÂÅúÊ≠¢„ÄÅÊåÇËµ∑ÂíåÂà†Èô§ÂÆπÂô®„ÄÇ</li>
</ul>
</li>
</ul>
<p>Âú®<code>containerd</code>‰∏≠ÊòØËøôÊ†∑ÂêØÂä®ÁöÑ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get listener for main ttrpc endpoint: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">tl</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nx">ServeTTRPC</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="unix-ÂüüÂ•óÊé•Â≠ó">Unix ÂüüÂ•óÊé•Â≠ó
</h3><p><code>containerd</code> Âíå <code>containerd-shim</code> ‰πãÈó¥ÁöÑÈÄö‰ø°ÈÄöÂ∏∏ÈÄöËøá Unix ÂüüÂ•óÊé•Â≠óËøõË°å„ÄÇËøôÁßçÈÄö‰ø°ÊñπÂºèÈùûÂ∏∏ÈÄÇÂêàÂêå‰∏Ä‰∏ªÊú∫‰∏äÁöÑËøõÁ®ãÈó¥ÈÄö‰ø°ÔºåÂÖ∑Êúâ‰ΩéÂª∂ËøüÂíåÈ´òÊïàÁöÑÁâπÁÇπ„ÄÇ</p>
<ul>
<li>Unix ÂüüÂ•óÊé•Â≠ó:
<ul>
<li>Âú®ÂêØÂä®Êó∂Ôºå<code>containerd-shim</code> ËøõÁ®ã‰ºöÈÄöËøá‰∏Ä‰∏™‰∏ìÁî®ÁöÑ Unix ÂüüÂ•óÊé•Â≠ó‰∏é <code>containerd</code> Âª∫Á´ãÈÄö‰ø°„ÄÇ</li>
<li>Ëøô‰∏™Â•óÊé•Â≠óÈÄöÂ∏∏‰Ωç‰∫é <code>/run/containerd/</code> Êàñ <code>/run/containerd/io.containerd.runtime.v2.linux/</code> ÁõÆÂΩï‰∏ãÔºåÂπ∂Â∏¶ÊúâÂÆπÂô® ID Áõ∏ÂÖ≥ÁöÑÂëΩÂêç„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="ÂÆπÂô®ÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜ">ÂÆπÂô®ÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜ
</h3><p><code>containerd</code> ÈÄöËøá <code>ttRPC</code> Âíå Unix ÂüüÂ•óÊé•Â≠ó‰∏é <code>containerd-shim</code> ËøõË°åÈÄö‰ø°Ôºå‰ª•ÁÆ°ÁêÜÂÆπÂô®ÁöÑÁîüÂëΩÂë®ÊúüÔºö</p>
<ul>
<li>ÂÆπÂô®ÂàõÂª∫:
<ul>
<li>ÂΩì <code>containerd</code> Êî∂Âà∞ÂàõÂª∫ÂÆπÂô®ÁöÑËØ∑Ê±ÇÊó∂ÔºåÂÆÉ‰ºöÂêØÂä®‰∏Ä‰∏™Êñ∞ÁöÑ <code>containerd-shim</code> ËøõÁ®ã„ÄÇËøô‰∏™ËøõÁ®ãË¥üË¥£Âú® <code>runc</code> ÊàñÂÖ∂‰ªñ OCI ÂÖºÂÆπÁöÑËøêË°åÊó∂‰∏äËøêË°åÂÆπÂô®„ÄÇ</li>
</ul>
</li>
<li>ÂÆπÂô®ÁÆ°ÁêÜ:
<ul>
<li><code>containerd-shim</code> ËøõÁ®ãË¥üË¥£Â§ÑÁêÜÂÆπÂô®ÁöÑÊ†áÂáÜËæìÂÖ•/ËæìÂá∫ÊµÅ„ÄÅ‰ø°Âè∑ÁÆ°ÁêÜ‰ª•ÂèäÂÖ∂‰ªñ‰∏éÂÆπÂô®Áõ∏ÂÖ≥ÁöÑÊìç‰Ωú„ÄÇ<code>containerd</code> ÈÄöËøá <code>ttRPC</code> Âêë <code>containerd-shim</code> ÂèëÈÄÅÂëΩ‰ª§ÔºàÂ¶ÇÂêØÂä®„ÄÅÂÅúÊ≠¢ÂÆπÂô®Ôºâ„ÄÇ</li>
</ul>
</li>
<li>ÂÆπÂô®Âà†Èô§:
<ul>
<li>ÂΩìÂÆπÂô®ÈÄÄÂá∫Êó∂Ôºå<code>containerd-shim</code> ËøõÁ®ãÂ∞ÜÁªßÁª≠ËøêË°åÔºåÁõ¥Âà∞ <code>containerd</code> ÈÄöËøá <code>ttRPC</code> ÂëΩ‰ª§ÂëäÁü• <code>containerd-shim</code> ËøõÁ®ãÂèØ‰ª•ÂÆâÂÖ®ÈÄÄÂá∫„ÄÇËøôÁ°Æ‰øù‰∫ÜÂç≥‰Ωø <code>containerd</code> Â¥©Ê∫ÉÔºåÂÆπÂô®ËøõÁ®ã‰πü‰∏ç‰ºöË¢´ÁªàÊ≠¢„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="ÂÆπÂô®‰∏éÂÆàÊä§ËøõÁ®ãÁöÑÂàÜÁ¶ª">ÂÆπÂô®‰∏éÂÆàÊä§ËøõÁ®ãÁöÑÂàÜÁ¶ª
</h3><p><code>containerd-shim</code> ÁöÑÂ≠òÂú®Ëøò‰ΩøÂæóÂÆπÂô®‰∏é <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÂàÜÁ¶ª„ÄÇËøôÊÑèÂë≥ÁùÄÔºö</p>
<ul>
<li>Áã¨Á´ãÊÄß:
<ul>
<li>Âç≥‰Ωø <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÂ¥©Ê∫ÉÊàñÈáçÂêØÔºåÂ∑≤ÁªèËøêË°åÁöÑÂÆπÂô®‰ªçÁÑ∂ËÉΩÂ§üÁªßÁª≠ËøêË°åÔºåÂõ†‰∏∫ÂÆÉ‰ª¨Áî±Áã¨Á´ãÁöÑ <code>containerd-shim</code> ËøõÁ®ãÁÆ°ÁêÜ„ÄÇ</li>
</ul>
</li>
<li>ÂáèÂ∞ë‰æùËµñ:
<ul>
<li>ËøôÁßçÊû∂ÊûÑÂáèÂ∞ë‰∫ÜÂØπÂçïÁÇπÊïÖÈöúÁöÑ‰æùËµñÔºåÂ¢ûÂº∫‰∫ÜÂÆπÂô®ËøêË°åÁöÑÁ®≥ÂÆöÊÄß„ÄÇ</li>
</ul>
</li>
</ul>
<h2 id="containerd-shim‰∏écontainerÈÄö‰ø°Êú∫Âà∂">Containerd-shim‰∏éContainerÈÄö‰ø°Êú∫Âà∂
</h2><h3 id="ÈÄö‰ø°ÊµÅÁ®ã">ÈÄö‰ø°ÊµÅÁ®ã
</h3><p><code>containerd</code> ÈÄöËøá‰∏Ä‰∏™<code>runtime</code>Êù•ÂÆûÁé∞ÂØπÂ§ö‰∏™ÂÆπÂô®ÁöÑÊéßÂà∂Ôºå‰æãÂ¶Ç create„ÄÅstart Âíå stop„ÄÇ</p>
<p>ÈÄö‰ø°ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>Êù•Ëá™ <code>containerd</code> ÁöÑÂàõÂª∫ÂÆπÂô®ÁöÑÂÆ¢Êà∑Á´ØËØ∑Ê±Ç</li>
<li><code>containerd</code> ËÆæÁΩÆÂÆπÂô®ÁöÑÊñá‰ª∂Á≥ªÁªüÔºåÂπ∂ÂàõÂª∫ÂøÖË¶ÅÁöÑÈÖçÁΩÆ‰ø°ÊÅØ</li>
<li><code>containerd</code> Ë∞ÉÁî® shimÔºåÂåÖÊã¨ÂÆπÂô®ÈÖçÁΩÆÔºåËøô‰∏™ÂÆπÂô®ÈÖçÁΩÆÂÜ≥ÂÆöÊòØÂêØÂä®Êñ∞ÁöÑÂ•óÊé•Â≠ó‰æ¶Âê¨Âô®Ôºàshim‰∏écontainer 1Ôºö1ÔºâËøòÊòØ‰ΩøÁî®Áé∞ÊúâÁöÑÂ•óÊé•Â≠ó‰æ¶Âê¨Âô®Ôºà1ÔºöÂ§öÔºâ
<ul>
<li>Â¶ÇÊûú‰ΩøÁî®Áé∞ÊúâÂ•óÊé•Â≠óÔºåÂàôËøîÂõûÁé∞Êúâ socket ÁöÑÂú∞ÂùÄÂπ∂ÈÄÄÂá∫</li>
<li>Â¶ÇÊûúÊòØ‰ΩøÁî®Êñ∞ÁöÑÂ•óÊé•Â≠óÔºåÂàôshim
<ul>
<li>a. ÂàõÂª∫‰∏Ä‰∏™Êñ∞ËøõÁ®ãÊù•‰æ¶Âê¨Â•óÊé•Â≠ó‰∏≠Êù•Ëá™ <code>containerd</code> ÁöÑ ttRPC ÂëΩ‰ª§</li>
<li>b. Â∞ÜËØ•Â•óÊé•Â≠óÁöÑÂú∞ÂùÄËøîÂõûÁªô <code>containerd</code></li>
<li>c. ÈÄÄÂá∫</li>
</ul>
</li>
</ul>
</li>
<li><code>containerd</code> Âêë shim ÂèëÈÄÅ‰∏Ä‰∏™ÂëΩ‰ª§Êù•ÂêØÂä®ÂÆπÂô®</li>
<li><code>containerd</code> ÈÄöËøá API Ë∞ÉÁî®<code>runtime</code>Êù•ÂàõÂª∫/ÂêØÂä®/ÂÅúÊ≠¢ÂÆπÂô®</li>
</ol>
<p>‰ΩÜÊòØÔºå<code>containerd</code> Êú¨Ë∫´ÂÆûÈôÖ‰∏äÂπ∂‰∏çÁõ¥Êé•Ë∞ÉÁî®ËøêË°åÊó∂Êù•ÂêØÂä®ÂÆπÂô®„ÄÇÁõ∏ÂèçÔºåÂÆÉÊúüÊúõË∞ÉÁî®ËøêË°åÊó∂ÔºåËøôÂ∞ÜÊö¥Èú≤‰∏Ä‰∏™Â•óÊé•Â≠ó Ôºå Âú®Á±ª Unix Á≥ªÁªü‰∏äÊòØ Unix ÂüüÔºåÂú® Windows ‰∏äÂêç‰∏∫ pipeÔºå Âπ∂ÈÄöËøáËØ•Â•óÊé•Â≠ó‰∏äÁöÑ ttRPC ‰æ¶Âê¨ÂÆπÂô®ÂëΩ‰ª§„ÄÇ</p>
<p>ËøêË°åÊó∂Êúâ‰∏§ÁßçÂ∏∏ËßÅÁöÑÊ®°ÂºèÔºö</p>
<ul>
<li>‰∏Ä‰∏™Áî®‰∫éËøêË°åÊó∂ÁöÑ‰∫åËøõÂà∂Êñá‰ª∂ÔºåÂÆÉÊó¢‰æ¶Âê¨Â•óÊé•Â≠óÂèàÂàõÂª∫/ÂêØÂä®/ÂÅúÊ≠¢ÂÆπÂô®</li>
<li>‰∏Ä‰∏™ÂàÜÁ¶ªÁöÑ Shim ‰∫åËøõÂà∂Êñá‰ª∂ÔºåÁî®‰∫é‰æ¶Âê¨Â•óÊé•Â≠óÔºåÂπ∂Ë∞ÉÁî®‰∏Ä‰∏™ÂçïÁã¨ÁöÑËøêË°åÊó∂ÂºïÊìéÊù•ÂàõÂª∫/ÂêØÂä®/ÂÅúÊ≠¢ÂÆπÂô®</li>
</ul>
<p>‰ΩøÁî®ÂçïÁã¨ÁöÑ‚Äúshim + engine‚ÄùÊ®°ÂºèÊòØÂõ†‰∏∫ÂÆÉÂèØ‰ª•Êõ¥ËΩªÊùæÂú∞ÈõÜÊàêÂÆûÁé∞ÁâπÂÆöËøêË°åÊó∂ÂºïÊìéËßÑËåÉÔºàÂ¶Ç <a class="link" href="https://github.com/opencontainers/runtime-spec"  target="_blank" rel="noopener"
    >OCI ËøêË°åÊó∂ËßÑËåÉ</a>ÔºâÁöÑ‰∏çÂêåËøêË°åÊó∂„ÄÇttRPC ÂçèËÆÆÂèØ‰ª•ÈÄöËøá‰∏Ä‰∏™<code>runtime shim</code>ËøõË°åÂ§ÑÁêÜÔºåËÄåÂèØ‰ª•‰ΩøÁî®‰∏çÂêåÁöÑËøêË°åÊó∂ÂºïÊìéÂÆûÁé∞ÔºåÂè™Ë¶ÅÂÆÉ‰ª¨ÂÆûÁé∞ OCI ËøêË°åÊó∂ËßÑËåÉÂç≥ÂèØ„ÄÇ</p>
<p>ÊúÄÂ∏∏Áî®ÁöÑËøêË°åÊó∂ÂºïÊìéÊòØ runcÔºåÂÆÉÂÆûÊñΩ OCI ËøêË°åÊó∂ËßÑËåÉ„ÄÇÁî±‰∫éËøôÊòØ‰∏Ä‰∏™ËøêË°åÊó∂ÂºïÊìéÔºåÂõ†Ê≠§ <code>containerd</code> ‰∏ç‰ºöÁõ¥Êé•Ë∞ÉÁî®ÂÆÉ;Áõ∏ÂèçÔºåÂÆÉÁî± Shim Ë∞ÉÁî®ÔºåËØ• Shim ‰æ¶Âê¨Â•óÊé•Â≠óÂπ∂Ë∞ÉÁî®ËøêË°åÊó∂ÂºïÊìé„ÄÇ</p>
<p>‰ª•‰∏ãÂ∫èÂàóÂõæÊòæÁ§∫‰∫ÜÊâßË°å <code>ctr run</code> ÂëΩ‰ª§Êó∂ÁöÑÊìç‰ΩúÊµÅÁ®ã„ÄÇ</p>
<p><img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240909175413949.png"
	width="1601"
	height="3024"
	srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240909175413949_hu14605848158616288619.png 480w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240909175413949_hu1695372946056556433.png 1024w"
	loading="lazy"
	
		alt="ctr runÊìç‰ΩúÊµÅÁ®ã"
	
	
		class="gallery-image" 
		data-flex-grow="52"
		data-flex-basis="127px"
	
></p>
<h3 id="Ê∫êÁ†ÅËß£Êûê">Ê∫êÁ†ÅËß£Êûê
</h3><blockquote>
<p>shimÂêØÂä®ÂÖ•Âè£Ôºöcontainerd/cmd/containerd-shim-runc-v2/main.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">NewShimManager</span><span class="p">(</span><span class="s">&#34;io.containerd.runc.v2&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>RunÂáΩÊï∞Ôºöcontainerd/pkg/shim/shim.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Run initializes and runs a shim server.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">manager</span> <span class="nx">Manager</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">BinaryOpts</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">config</span> <span class="nx">Config</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">WithLogger</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;runtime&#34;</span><span class="p">,</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">Name</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">manager</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;%s: %s&#34;</span><span class="p">,</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">Name</span><span class="p">(),</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>shimÁúüÊ≠£ÂêØÂä®Ôºö</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//shim ÂêØÂä®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">run</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">manager</span> <span class="nx">Manager</span><span class="p">,</span> <span class="nx">config</span> <span class="nx">Config</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nf">setRuntime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Handle explicit actions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="nx">action</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="s">&#34;delete&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="s">&#34;start&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">StartOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Address</span><span class="p">:</span>      <span class="nx">addressFlag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">TTRPCAddress</span><span class="p">:</span> <span class="nx">ttrpcAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Debug</span><span class="p">:</span>        <span class="nx">debugFlag</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Á¨¨‰∏Ä‰∏™ÂêØÂä®ÁöÑshimÊé•Êî∂ÁöÑaction Â∞±ÊòØ start„ÄÇËøôÈáåÂêØÂä®Á¨¨‰∫å‰∏™shim„ÄÇaddressÊòØÊ†πÊçÆnsÂíåidÂìàÂ∏åÂá∫Êù•ÁöÑÔºå‰ºö‰º†ÈÄíÁªôÁ¨¨‰∫å‰∏™shim,Á¨¨‰∫å‰∏™shim‰ºö‰ª•Ëøô‰∏™Âú∞ÂùÄËµ∑‰∏Ä‰∏™serverÔºåÂêåÊó∂‰ºöÈÄöËøástdoutÂèëÈÄÅÁªôcontainerdÔºàÂõ†‰∏∫cÂêØÂä®ÁöÑÊú¨ËøõÁ®ãÔºåÊâÄ‰ª•ÂèØ‰ª•Êî∂Âà∞ÔºâÔºåËøôÂ∞±ÊòØcontainerdÂíåÁ¨¨‰∫å‰∏™shim‰∫§ÊµÅÁöÑ.sockÂú∞ÂùÄ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">params</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">manager</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to marshal bootstrap params to json: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">unaryInterceptor</span> <span class="o">:=</span> <span class="nf">chainUnaryServerInterceptors</span><span class="p">(</span><span class="nx">ttrpcUnaryInterceptors</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newServer</span><span class="p">(</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nf">WithUnaryServerInterceptor</span><span class="p">(</span><span class="nx">unaryInterceptor</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed creating server: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">srv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ttrpcServices</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to register service: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">signals</span><span class="p">,</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">Shutdown</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">shutdown</span><span class="p">.</span><span class="nx">ErrShutdown</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">cleanupSockets</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÂêØÂä®Á¨¨‰∫å‰∏™shimÔºö</p>
<p>ËøôÈáåÊúâ‰∏Ä‰∏™ÊúâÊÑèÊÄùÂú∞ÊñπÊòØÁ¨¨‰∫å‰∏™shimÂ¶Ç‰ΩïËé∑ÂèñËá™Ë∫´‰Ωú‰∏∫serverÁöÑsocketÂú∞ÂùÄ„ÄÇ‰ªé‰ª£Á†Å‰∏äÁúãÊòØÈÄöËøáÊääÂ•óÊé•Â≠óËΩ¨Êç¢ÊàêÊñá‰ª∂ÊèèËø∞Á¨¶‰º†ÈÄíÁªôÁ¨¨‰∫å‰∏™shimÔºåÁÑ∂ÂêéÁ¨¨‰∫å‰∏™shimÂÜçËøòÂéüÊàêlistenerÂÆûÁé∞ÁöÑ„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">manager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">StartOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">BootstrapParams</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">params</span> <span class="nx">shim</span><span class="p">.</span><span class="nx">BootstrapParams</span>
</span></span><span class="line"><span class="cl">	<span class="nx">params</span><span class="p">.</span><span class="nx">Version</span> <span class="p">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">	<span class="nx">params</span><span class="p">.</span><span class="nx">Protocol</span> <span class="p">=</span> <span class="s">&#34;ttrpc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newCommand</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TTRPCAddress</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Debug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">grouping</span> <span class="o">:=</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">	<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readSpec</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">sockets</span> <span class="p">[]</span><span class="o">*</span><span class="nx">shimSocket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newShimSocket</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">grouping</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">IsAlreadyExists</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">params</span><span class="p">.</span><span class="nx">Address</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">addr</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sockets</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">sockets</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span><span class="p">.</span><span class="nx">ExtraFiles</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">cmd</span><span class="p">.</span><span class="nx">ExtraFiles</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">goruntime</span><span class="p">.</span><span class="nf">LockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;SCHED_CORE&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">schedcore</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">schedcore</span><span class="p">.</span><span class="nx">ProcessGroup</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;enable sched core support: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">goruntime</span><span class="p">.</span><span class="nf">UnlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂêØÂä®ÊàêÂäüÂêéÔºåÁ¨¨‰∏Ä‰∏™ shim ÈÄÄÂá∫ÔºåÊâßË°åÊ∏ÖÁêÜÊìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cmd</span><span class="p">.</span><span class="nx">Process</span><span class="p">.</span><span class="nf">Kill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// make sure to wait after start
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">params</span><span class="p">.</span><span class="nx">Address</span> <span class="p">=</span> <span class="nx">sockets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">addr</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">params</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>shim socketÂ•óÊé•Â≠óÂàõÂª∫Ôºö</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//shim socketÂàõÂª∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newShimSocket</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">debug</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">shimSocket</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">address</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">SocketAddress</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">debug</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">socket</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">NewSocket</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">shimSocket</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">addr</span><span class="p">:</span> <span class="nx">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">:</span>    <span class="nx">socket</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">File</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">f</span> <span class="p">=</span> <span class="nx">f</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>SocketAddressÔºöÁîüÊàê‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑ‰Ωç‰∫é<code>/run/containerd/s/&lt;ÂìàÂ∏åÂÄº&gt;</code>‰∏ãÁöÑUnix Â•óÊé•Â≠óÂú∞ÂùÄ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// SocketAddress returns a socket address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">SocketAddress</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">socketPath</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">debug</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nf">NamespaceRequired</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">socketPath</span><span class="p">,</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">debug</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">path</span> <span class="p">=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s">&#34;debug&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">d</span> <span class="o">:=</span> <span class="nx">sha256</span><span class="p">.</span><span class="nf">Sum256</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unix://%s/%x&#34;</span><span class="p">,</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">socketRoot</span><span class="p">,</span> <span class="s">&#34;s&#34;</span><span class="p">),</span> <span class="nx">d</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>NewSocketÔºöËÆæÁΩÆsockÊñá‰ª∂ÊùÉÈôê</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//ÁúüÊ≠£ÁöÑsocketÂàõÂª∫
</span></span></span><span class="line"><span class="cl"><span class="c1">// NewSocket returns a new socket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSocket</span><span class="p">(</span><span class="nx">address</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UnixListener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">sock</span>       <span class="p">=</span> <span class="nf">socket</span><span class="p">(</span><span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">path</span>       <span class="p">=</span> <span class="nx">sock</span><span class="p">.</span><span class="nf">path</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">isAbstract</span> <span class="p">=</span> <span class="nx">sock</span><span class="p">.</span><span class="nf">isAbstract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">perm</span>       <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">FileMode</span><span class="p">(</span><span class="mo">0600</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Darwin needs +x to access socket, otherwise it&#39;ll fail with &#34;bind: permission denied&#34; when running as non-root.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;darwin&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">perm</span> <span class="p">=</span> <span class="mo">0700</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">isAbstract</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">perm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;mkdir failed for %s: %w&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">isAbstract</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">perm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">os</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sock</span><span class="p">.</span><span class="nf">path</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;chmod failed for %s: %w&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">.(</span><span class="o">*</span><span class="nx">net</span><span class="p">.</span><span class="nx">UnixListener</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>serveÂáΩÊï∞ÔºåÂêØÂä® <code>ttrpc</code> ÊúçÂä°ÔºåÂπ∂Êèê‰æõRPCÊúçÂä°Ôºö</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// serve serves the ttrpc API over a unix socket in the current working directory
</span></span></span><span class="line"><span class="cl"><span class="c1">// and blocks until the context is canceled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="nx">signals</span> <span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="nx">shutdown</span> <span class="kd">func</span><span class="p">())</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dump</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">setupDumpStacks</span><span class="p">(</span><span class="nx">dump</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">path</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getwd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÂàõÂª∫ Unix Â•óÊé•Â≠óÁõëÂê¨Âô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">serveListener</span><span class="p">(</span><span class="nx">socketFlag</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂêØÂä® ttrpc ÊúçÂä°Âô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Is</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">net</span><span class="p">.</span><span class="nx">ErrClosed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;containerd-shim: ttrpc server failure&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">go</span> <span class="nf">handleExitSignals</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">shutdown</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">reap</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">signals</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÂàõÂª∫‰∏Ä‰∏™Áî®‰∫éÁõëÂê¨ Unix Â•óÊé•Â≠óÁöÑ <code>net.Listener</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// serve()‰ºöÊúÄÁªàË∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞Êù•ÂêØÂä®ÊúçÂä°ÁõëÂê¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">serveListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">fd</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÂàõÂª∫ÁõëÂê¨Âô®ÁöÑÈÄªËæë
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span>   <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//Â§ÑÁêÜÁªßÊâøÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">path</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="c1">//os.NewFile(fd, &#34;socket&#34;) Â∞ÜÊñá‰ª∂ÊèèËø∞Á¨¶ fd Â∞ÅË£ÖÊàê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//‰∏Ä‰∏™*os.File ÂØπË±°ÔºåÂπ∂‰ΩøÁî® net.FileListener Â∞ÜÂÖ∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">//ËΩ¨Êç¢‰∏∫ net.ListenerÔºåËøôÊ†∑ÂèØ‰ª•ÈÄöËøáÂ•óÊé•Â≠óËøõË°åÈÄö‰ø°„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">FileListener</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">NewFile</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="s">&#34;socket&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">path</span> <span class="p">=</span> <span class="s">&#34;[inherited from parent]&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">//ÂàõÂª∫Êñ∞ÁöÑ Unix Â•óÊé•Â≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">socketPathLimit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%q: unix socket path too long (&gt; %d)&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">socketPathLimit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;unix&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">).</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;serving api on socket&#34;</span><span class="p">)</span><span class="err">¬∑</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>ÂõûÂà∞serveÂáΩÊï∞Ôºåcontainerd-shim‰ª•Ê≥®ÂÜåÊúçÂä°ÁöÑÂΩ¢ÂºèÊù•ÂØπcontainerdÊèê‰æõÂÆπÂô®Áõ∏ÂÖ≥Êìç‰ΩúÔºå‰∏ãÈù¢ÊòØÁõ∏ÂÖ≥ÊúçÂä°Ê≥®ÂÜåÁöÑÊ∫êÁ†ÅÔºåÂèØ‰ª•ÁúãÂà∞shimÈÄöËøáË∞ÉÁî®<code>runc</code>ÂÆπÂô®ËøêË°åÊó∂Êù•ÂàõÂª∫ÂÆπÂô®„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskAPI</span><span class="p">.</span><span class="nf">RegisterTTRPCTaskService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create a new initial process and container with the underlying OCI runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">platform</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">containers</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskCreate</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskIO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>        <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The following line cannot return an error as the only state in which that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// could happen would also cause the container.Pid() call above to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// nil-deference panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">proc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Ê≥®ÔºöshimÂàõÂª∫ÁöÑ‰∏écontainerdÈÄö‰ø°ÁöÑsockÊñá‰ª∂ÁöÑmode‰∏∫0600ÔºåÂÆûÈôÖÊÉÖÂÜµ‰∏éÊ∫êÁ†Å‰∏ÄËá¥„ÄÇ</strong></p>
<p><img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240918162254734.png"
	width="728"
	height="132"
	srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240918162254734_hu1991328956554458519.png 480w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/image-20240918162254734_hu9702084743628895238.png 1024w"
	loading="lazy"
	
		alt="sockÊñá‰ª∂ÊùÉÈôê"
	
	
		class="gallery-image" 
		data-flex-grow="551"
		data-flex-basis="1323px"
	
></p>
<h2 id="ÂÆπÂô®ÂêØÂä®ÊµÅÁ®ãÂàÜÊûê">ÂÆπÂô®ÂêØÂä®ÊµÅÁ®ãÂàÜÊûê
</h2><p>ÂàÜÊûêÊµÅÁ®ãÂõæÂ¶Ç‰∏ãÔºåtask.StartÊ≤°ÊúâÂæÄ‰∏ãÂàÜÊûêÔºåÂÆÉÁöÑÂáΩÊï∞‰º†ÈÄíÊµÅÁ®ã‰∏éNewtaskÁ±ª‰ºº„ÄÇ</p>
<p><img src="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/%E6%97%A0%E6%A0%87%E9%A2%98.png"
	width="4552"
	height="3158"
	srcset="/p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/%E6%97%A0%E6%A0%87%E9%A2%98_hu3418511777243317462.png 480w, /p/containerd%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/assets/%E6%97%A0%E6%A0%87%E9%A2%98_hu7513606798315144493.png 1024w"
	loading="lazy"
	
		alt="ctrÊåá‰ª§Ëß£ÊûêÂõæ"
	
	
		class="gallery-image" 
		data-flex-grow="144"
		data-flex-basis="345px"
	
></p>
<blockquote>
<p>ctrËß£ÊûêÂëΩ‰ª§</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//Ë∞ÉÁî®command.NewClient()-&gt;client.LoadContainer()-&gt;NewTask()-&gt;task.Start()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	1„ÄÅcommand.NewClient() ÂàõÂª∫containerd client
</span></span></span><span class="line"><span class="cl"><span class="cm">	2„ÄÅLoadContainer()
</span></span></span><span class="line"><span class="cl"><span class="cm">	3„ÄÅNewTask()
</span></span></span><span class="line"><span class="cl"><span class="cm">	4„ÄÅtask.Start()
</span></span></span><span class="line"><span class="cl"><span class="cm">	//Â¶ÇÊûúÊî∂Âà∞ÈÄÄÂá∫‰ø°Âè∑
</span></span></span><span class="line"><span class="cl"><span class="cm">	5„ÄÅtask.Delete(ctx)
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">startCommand</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Name</span><span class="p">:</span>      <span class="s">&#34;start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Usage</span><span class="p">:</span>     <span class="s">&#34;Start a container that has been created&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ArgsUsage</span><span class="p">:</span> <span class="s">&#34;CONTAINER&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Flags</span><span class="p">:</span> <span class="nb">append</span><span class="p">(</span><span class="nx">platformStartFlags</span><span class="p">,</span> <span class="p">[]</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Flag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">BoolFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;null-io&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;Send all IO to /dev/null&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">StringFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;log-uri&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;Log uri&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">StringFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;fifo-dir&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;Directory used for storing IO FIFOs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">StringFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;pid-file&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span> <span class="s">&#34;File path to write the task&#39;s pid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="o">&amp;</span><span class="nx">cli</span><span class="p">.</span><span class="nx">BoolFlag</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Name</span><span class="p">:</span>    <span class="s">&#34;detach&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Aliases</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;d&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Usage</span><span class="p">:</span>   <span class="s">&#34;Detach from the task after it has started execution&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span><span class="o">...</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Action</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cliContext</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span>    <span class="kt">error</span>
</span></span><span class="line"><span class="cl">			<span class="nx">id</span>     <span class="p">=</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">Args</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">detach</span> <span class="p">=</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;detach&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;container id must be provided&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">commands</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">LoadContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Spec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">tty</span>    <span class="p">=</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Process</span><span class="p">.</span><span class="nx">Terminal</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span>   <span class="p">=</span> <span class="nf">GetNewTaskOpts</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ioOpts</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">{</span><span class="nx">cio</span><span class="p">.</span><span class="nf">WithFIFODir</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;fifo-dir&#34;</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl">		<span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">con</span> <span class="nx">console</span><span class="p">.</span><span class="nx">Console</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">tty</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">con</span> <span class="p">=</span> <span class="nx">console</span><span class="p">.</span><span class="nf">Current</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">con</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">con</span><span class="p">.</span><span class="nf">SetRaw</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">task</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">con</span><span class="p">,</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;null-io&#34;</span><span class="p">),</span> <span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;log-uri&#34;</span><span class="p">),</span> <span class="nx">ioOpts</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">task</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">tty</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">HandleConsoleResize</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">task</span><span class="p">,</span> <span class="nx">con</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;console resize&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">sigc</span> <span class="o">:=</span> <span class="nx">commands</span><span class="p">.</span><span class="nf">ForwardAllSignals</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">task</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">commands</span><span class="p">.</span><span class="nf">StopCatch</span><span class="p">(</span><span class="nx">sigc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">status</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">statusC</span>
</span></span><span class="line"><span class="cl">		<span class="nx">code</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">task</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">code</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">code</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1„ÄÅcontainerd clientÂàõÂª∫</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\cmd\ctr\commands\client.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// NewClient returns a new containerd client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">cliContext</span> <span class="o">*</span><span class="nx">cli</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">timeoutOpt</span> <span class="o">:=</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="s">&#34;connect-timeout&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">timeoutOpt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;address&#34;</span><span class="p">),</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nf">AppContext</span><span class="p">(</span><span class="nx">cliContext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">suppressDeprecationWarnings</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">suppressDeprecationWarnings</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">IntrospectionService</span><span class="p">().</span><span class="nf">Server</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;Failed to check deprecations&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Deprecations</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;DEPRECATION: &#34;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>1„ÄÅÂÆûÈôÖË∞ÉÁî®NewÂáΩÊï∞ÂàõÂª∫</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\client\client.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// New returns a new containerd client that is connected to the containerd
</span></span></span><span class="line"><span class="cl"><span class="c1">// instance provided by address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">address</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">Opt</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">copts</span> <span class="nx">clientOpts</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">copts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Client</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">defaultns</span><span class="p">:</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntime</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultPlatform</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">platform</span> <span class="p">=</span> <span class="nx">platforms</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">services</span> <span class="p">=</span> <span class="o">*</span><span class="nx">copts</span><span class="p">.</span><span class="nx">services</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span> <span class="o">:=</span> <span class="nx">backoff</span><span class="p">.</span><span class="nx">DefaultConfig</span>
</span></span><span class="line"><span class="cl">		<span class="nx">backoffConfig</span><span class="p">.</span><span class="nx">MaxDelay</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">timeout</span>
</span></span><span class="line"><span class="cl">		<span class="nx">connParams</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ConnectParams</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Backoff</span><span class="p">:</span> <span class="nx">backoffConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">DialOption</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithTransportCredentials</span><span class="p">(</span><span class="nx">insecure</span><span class="p">.</span><span class="nf">NewCredentials</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithConnectParams</span><span class="p">(</span><span class="nx">connParams</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">WithContextDialer</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nx">ContextDialer</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">dialOptions</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallRecvMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxRecvMsgSize</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">grpc</span><span class="p">.</span><span class="nf">MaxCallSendMsgSize</span><span class="p">(</span><span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultMaxSendMsgSize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithDefaultCallOptions</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">callOptions</span><span class="o">...</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">unary</span><span class="p">,</span> <span class="nx">stream</span> <span class="o">:=</span> <span class="nf">newNSInterceptors</span><span class="p">(</span><span class="nx">copts</span><span class="p">.</span><span class="nx">defaultns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainUnaryInterceptor</span><span class="p">(</span><span class="nx">unary</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="nx">gopts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">gopts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithChainStreamInterceptor</span><span class="p">(</span><span class="nx">stream</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">connector</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">dialer</span><span class="p">.</span><span class="nf">DialAddress</span><span class="p">(</span><span class="nx">address</span><span class="p">),</span> <span class="nx">gopts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to dial %q: %w&#34;</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">conn</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">connector</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connector</span> <span class="p">=</span> <span class="nx">conn</span><span class="p">,</span> <span class="nx">connector</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">services</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">conn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;no grpc connection or services is available: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrUnavailable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// check namespace labels for default runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">copts</span><span class="p">.</span><span class="nx">defaultRuntime</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">defaultns</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">label</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetLabel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">defaults</span><span class="p">.</span><span class="nx">DefaultRuntimeNSLabel</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">label</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">c</span><span class="p">.</span><span class="nx">runtime</span> <span class="p">=</span> <span class="nx">label</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2„ÄÅÂä†ËΩΩcontainer</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\client\client.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// LoadContainer loads an existing container from metadata
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">LoadContainer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Container</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">span</span> <span class="o">:=</span> <span class="nx">tracing</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;client.LoadContainer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">span</span><span class="p">.</span><span class="nf">End</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ContainerService</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">SetAttributes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.id&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.image.ref&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Image</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.runtime.name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.snapshotter.name&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Snapshotter</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.createdAt&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">CreatedAt</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;container.updatedAt&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">UpdatedAt</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">RFC3339</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">containerFromRecord</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">r</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2„ÄÅContainerServiceÂÆûÈôÖÊòØË∞ÉÁî®ÁöÑNewRemoteContainerStoreÔºåËøîÂõûNewContainersClient</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ContainerService returns the underlying container Store
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">ContainerService</span><span class="p">()</span> <span class="nx">containers</span><span class="p">.</span><span class="nx">Store</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">containerStore</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">containerStore</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">NewRemoteContainerStore</span><span class="p">(</span><span class="nx">containersapi</span><span class="p">.</span><span class="nf">NewContainersClient</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2„ÄÅgRPCË∞ÉÁî®containerdÁöÑcontainers.GetÂáΩÊï∞</p>
<p>containerd/containerd/api/services/containers/v1/containers_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">containersClient</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">GetContainerRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">GetContainerResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">GetContainerResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.services.containers.v1.Containers/Get&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2„ÄÅcontainerdÊé•Êî∂Âπ∂Â§ÑÁêÜËØ∑Ê±Ç</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd/containerd/api/services/containers/v1/containers_grpc.pb.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">_Containers_Get_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">GetContainerRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">ContainersServer</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.services.containers.v1.Containers/Get&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">ContainersServer</span><span class="p">).</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">GetContainerRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>2„ÄÅÊé•ÁùÄË∞ÉÁî®local.Get()ÂáΩÊï∞Â§ÑÁêÜÔºàËøôÈáåÊúâ‰∏™ÂØπË±°ÁöÑËΩ¨Êç¢ContainersServerËΩ¨Êç¢Âà∞ServiceÂÜçËΩ¨Êç¢Âà∞localÔºâ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd/containerd/api/services/containers/v1/containers_grpc.pb.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// ËøôÈáåË∞ÉÁî®Â∫ïÂ±ÇÁöÑÊï∞ÊçÆÂ∫ìËé∑Âèñcontianer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">local</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">GetContainerRequest</span><span class="p">,</span> <span class="nx">_</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">GetContainerResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">api</span><span class="p">.</span><span class="nx">GetContainerResponse</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">l</span><span class="p">.</span><span class="nf">withStoreView</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">Store</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">containerpb</span> <span class="o">:=</span> <span class="nf">containerToProto</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">container</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resp</span><span class="p">.</span><span class="nx">Container</span> <span class="p">=</span> <span class="nx">containerpb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅNewTaskÂàõÂª∫ÂÆπÂô®ËØ∑Ê±Ç</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// containerd\containerd\cmd\ctr\commands\tasks\tasks_unix.go
</span></span></span><span class="line"><span class="cl"><span class="c1">//NewTask creates a new task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">container</span> <span class="nx">containerd</span><span class="p">.</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">checkpoint</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">con</span> <span class="nx">console</span><span class="p">.</span><span class="nx">Console</span><span class="p">,</span> <span class="nx">nullIO</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">logURI</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ioOpts</span> <span class="p">[]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">NewTaskOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">containerd</span><span class="p">.</span><span class="nx">Task</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stdinC</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">stdinCloser</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">stdin</span><span class="p">:</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">checkpoint</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">im</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">GetImage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">checkpoint</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithTaskCheckpoint</span><span class="p">(</span><span class="nx">im</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Spec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">UIDMappings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithUIDOwner</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">UIDMappings</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">HostID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">GIDMappings</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nf">WithGIDOwner</span><span class="p">(</span><span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">GIDMappings</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">HostID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">ioCreator</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">Creator</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">con</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">nullIO</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;tty and null-io cannot be used together&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nf">NewCreator</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">{</span><span class="nx">cio</span><span class="p">.</span><span class="nf">WithStreams</span><span class="p">(</span><span class="nx">con</span><span class="p">,</span> <span class="nx">con</span><span class="p">,</span> <span class="kc">nil</span><span class="p">),</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">WithTerminal</span><span class="p">},</span> <span class="nx">ioOpts</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">nullIO</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">NullIO</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">logURI</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">logURI</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nf">LogURI</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ioCreator</span> <span class="p">=</span> <span class="nx">cio</span><span class="p">.</span><span class="nf">NewCreator</span><span class="p">(</span><span class="nb">append</span><span class="p">([]</span><span class="nx">cio</span><span class="p">.</span><span class="nx">Opt</span><span class="p">{</span><span class="nx">cio</span><span class="p">.</span><span class="nf">WithStreams</span><span class="p">(</span><span class="nx">stdinC</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">)},</span> <span class="nx">ioOpts</span><span class="o">...</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ioCreator</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">stdinC</span><span class="p">.</span><span class="nx">closer</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nf">CloseIO</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">containerd</span><span class="p">.</span><span class="nx">WithStdinCloser</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅË∞ÉÁî®container.NewTaskÂáΩÊï∞</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\client\container.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">container</span><span class="p">)</span> <span class="nf">NewTask</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">ioCreate</span> <span class="nx">cio</span><span class="p">.</span><span class="nx">Creator</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">NewTaskOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">Task</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">span</span> <span class="o">:=</span> <span class="nx">tracing</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;container.NewTask&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">span</span><span class="p">.</span><span class="nf">End</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ioCreate</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">i</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">i</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">i</span><span class="p">.</span><span class="nf">Config</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Terminal</span><span class="p">:</span>    <span class="nx">cfg</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdin</span><span class="p">:</span>       <span class="nx">cfg</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdout</span><span class="p">:</span>      <span class="nx">cfg</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stderr</span><span class="p">:</span>      <span class="nx">cfg</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">SnapshotKey</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Snapshotter</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unable to resolve rootfs mounts without snapshotter on container: %w&#34;</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrInvalidArgument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// get the rootfs from the snapshotter and add it to the request
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">getSnapshotter</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Snapshotter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mounts</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Mounts</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">SnapshotKey</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">spec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Spec</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">mounts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">MountLabel</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">ml</span> <span class="o">:=</span> <span class="nx">label</span><span class="p">.</span><span class="nf">FormatMountLabel</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">spec</span><span class="p">.</span><span class="nx">Linux</span><span class="p">.</span><span class="nx">MountLabel</span><span class="p">);</span> <span class="nx">ml</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">m</span><span class="p">.</span><span class="nx">Options</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span> <span class="nx">ml</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="nx">TaskInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runtime</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">o</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">info</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">info</span><span class="p">.</span><span class="nx">RootFS</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span><span class="p">.</span><span class="nx">RuntimePath</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">RuntimePath</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">o</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalAny</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Options</span> <span class="p">=</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalProto</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">task</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">client</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">io</span><span class="p">:</span>     <span class="nx">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">id</span><span class="p">:</span>     <span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">c</span><span class="p">:</span>      <span class="nx">c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="p">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">Checkpoint</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">SetAttributes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.container.id&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.request.options&#34;</span><span class="p">,</span> <span class="nx">request</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.runtime.name&#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nx">runtime</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">TaskService</span><span class="p">().</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">FromGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">AddEvent</span><span class="p">(</span><span class="s">&#34;task created&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;task.process.id&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Pid</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">pid</span> <span class="p">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">Pid</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅTaskserviceËé∑ÂèñTasksClientÂÆû‰æã</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// TaskService returns the underlying TasksClient
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">TaskService</span><span class="p">()</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">TasksClient</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">taskService</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">taskService</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">connMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">NewTasksClient</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅÈÄöËøágRPCÂèëÈÄÅÁªôcontainerd</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd/api/services/tasks/v1/tasks_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">tasksClient</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.services.tasks.v1.Tasks/Create&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅcontainerdÊé•Êî∂Âπ∂Â§ÑÁêÜËØ∑Ê±Ç</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd/api/services/tasks/v1/tasks_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">_Tasks_Create_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TasksServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.services.tasks.v1.Tasks/Create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TasksServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅÂÆûÈôÖË∞ÉÁî®localÁöÑÁõ∏ÂÖ≥ÂáΩÊï∞Â§ÑÁêÜÔºàËøôÈáå‰πüÊúâÂØπË±°ÁöÑËΩ¨Êç¢Ôºâ</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd/plugins/services/tasks/local.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">local</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">,</span> <span class="nx">_</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">api</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">getContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">checkpointPath</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIAddress</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIVersion</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskOptions</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">formatOptions</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">checkpointPath</span> <span class="p">=</span> <span class="nx">taskOptions</span><span class="p">.</span><span class="nx">CriuImagePath</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIAddress</span> <span class="p">=</span> <span class="nx">taskOptions</span><span class="p">.</span><span class="nx">TaskApiAddress</span>
</span></span><span class="line"><span class="cl">		<span class="nx">taskAPIVersion</span> <span class="p">=</span> <span class="nx">taskOptions</span><span class="p">.</span><span class="nx">TaskApiVersion</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// jump get checkpointPath from checkpoint image
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">checkpointPath</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">checkpointPath</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirTemp</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;XDG_RUNTIME_DIR&#34;</span><span class="p">),</span> <span class="s">&#34;ctrd-checkpoint&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">MediaType</span> <span class="o">!=</span> <span class="nx">images</span><span class="p">.</span><span class="nx">MediaTypeContainerd1Checkpoint</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unsupported checkpoint type %q&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">MediaType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nf">ReaderAt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ocispec</span><span class="p">.</span><span class="nx">Descriptor</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">MediaType</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">MediaType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Digest</span><span class="p">:</span>      <span class="nx">digest</span><span class="p">.</span><span class="nf">Digest</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">Digest</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Size</span><span class="p">:</span>        <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">Size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Annotations</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">Annotations</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">archive</span><span class="p">.</span><span class="nf">Apply</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">checkpointPath</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">reader</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reader</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Spec</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Spec</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">IO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span>     <span class="nx">checkpointPath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Runtime</span><span class="p">:</span>        <span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">RuntimeOptions</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">TaskOptions</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">SandboxID</span><span class="p">:</span>      <span class="nx">container</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Address</span><span class="p">:</span>        <span class="nx">taskAPIAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Version</span><span class="p">:</span>        <span class="nx">taskAPIVersion</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">RuntimePath</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">Runtime</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">RuntimePath</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rtime</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">v2Runtime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rtime</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">errdefs</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;task %s: %w&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrAlreadyExists</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rtime</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">labels</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;runtime&#34;</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">.</span><span class="nx">Name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">monitor</span><span class="p">.</span><span class="nf">Monitor</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">labels</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;monitor task: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">PID</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get task pid: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">api</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ContainerID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>         <span class="nx">pid</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅË∞ÉÁî®runtime.PlatformRuntime.createÔºåPlatformRuntimeÊé•Âè£ÂÆûÈôÖÁî±TaskManagerÂÆûÁé∞Ôºå‰πüÂ∞±ÊòØTaskManager.Create„ÄÇCreateÂáΩÊï∞ÁöÑÂÖ≥ÈîÆË∞ÉÁî®ÊµÅÁ®ãÊúâÁÇπÂ§öÔºåÊàë‰ª¨‰∏Ä‰∏ÄÂàÜÊûê„ÄÇ</p>
<p>1.m.manager.Start()</p>
<p>2.newShimTask(shim)</p>
<p>3.shimTask.Create()</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\containerd\core\runtime\v2\task_manager.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// Create launches new shim instance and creates new task
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">TaskManager</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">taskID</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">Task</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">bundle</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewBundle</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">root</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">taskID</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Spec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">bundle</span><span class="p">.</span><span class="nf">Delete</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">manager</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">taskID</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start shim: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Cast to shim task and call task service to create a new container task instance.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// This will not be required once shim service / client implemented.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">shimTask</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newShimTask</span><span class="p">(</span><span class="nx">shim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// runc ignores silently features it doesn&#39;t know about, so for things that this is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// problematic let&#39;s check if this runc version supports them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">validateRuntimeFeatures</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to validate OCI runtime features: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">shimTask</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// NOTE: ctx contains required namespace information.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">m</span><span class="p">.</span><span class="nx">manager</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">taskID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">dctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">timeout</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span> <span class="nx">cleanupTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">sandboxed</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">errShim</span> <span class="o">:=</span> <span class="nx">shimTask</span><span class="p">.</span><span class="nb">delete</span><span class="p">(</span><span class="nx">dctx</span><span class="p">,</span> <span class="nx">sandboxed</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">errShim</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">IsDeadlineExceeded</span><span class="p">(</span><span class="nx">errShim</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">dctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">timeout</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span> <span class="nx">cleanupTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">shimTask</span><span class="p">.</span><span class="nf">Shutdown</span><span class="p">(</span><span class="nx">dctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">shimTask</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create shim task: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.1„ÄÅm.manager.Start()Ë∞ÉÁî®ShimManager.Start</p>
<p>containerd\containerd\core\runtime\v2\shim_manager.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start launches a new shim instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ShimManager</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">bundle</span> <span class="o">*</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">ShimInstance</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// This container belongs to sandbox which supposed to be already started via sandbox API.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">params</span> <span class="nx">shimbinary</span><span class="p">.</span><span class="nx">BootstrapParams</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// The address returned from sandbox controller should be in the form like ttrpc+unix://&lt;uds-path&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// or grpc+vsock://&lt;cid&gt;:&lt;port&gt;, we should get the protocol from the url first.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">protocol</span><span class="p">,</span> <span class="nx">address</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Cut</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="s">&#34;+&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;the scheme of sandbox address should be in &#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">					<span class="s">&#34; the form of &lt;protocol&gt;+&lt;unix|vsock|tcp&gt;, i.e. ttrpc+unix or grpc+vsock&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">params</span> <span class="p">=</span> <span class="nx">shimbinary</span><span class="p">.</span><span class="nx">BootstrapParams</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Version</span><span class="p">:</span>  <span class="nb">int</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Version</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Protocol</span><span class="p">:</span> <span class="nx">protocol</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Address</span><span class="p">:</span>  <span class="nx">address</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// For those sandbox we can not get endpoint,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// fallback to legacy implementation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">process</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;can&#39;t find sandbox %s&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">,</span> <span class="nx">restoreErr</span> <span class="o">:=</span> <span class="nf">restoreBootstrapParams</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nf">Bundle</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">restoreErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to get bootstrap &#34;</span><span class="o">+</span>
</span></span><span class="line"><span class="cl">					<span class="s">&#34;params of sandbox %s, %v, legacy restore error %v&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">restoreErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">params</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Write sandbox ID this task belongs to.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">bundle</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">&#34;sandbox&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">),</span> <span class="mo">0600</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeBootstrapParams</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">bundle</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="s">&#34;bootstrap.json&#34;</span><span class="p">),</span> <span class="nx">params</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to write bootstrap.json for bundle %s: %w&#34;</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadShim</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{})</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to load sandbox task %q: %w&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">SandboxID</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">shim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">shim</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">startShim</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">m</span><span class="p">.</span><span class="nf">cleanupShim</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">shim</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">shim</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to add task: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">shim</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.1„ÄÅ‰∏äÈù¢Â¶ÇÊûúSandboxID‰∏ç‰∏∫Á©∫ÔºåË∞ÉÁî®loadShimÂáΩÊï∞Âä†ËΩΩshimÔºåÂê¶ÂàôË∞ÉÁî®startShimÂáΩÊï∞ÂêØÂä®shimÔºåËøôÈáåÊàë‰ª¨ÂàÜÊûêstartShim„ÄÇ</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\containerd\core\runtime\v2\shim.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">ShimManager</span><span class="p">)</span> <span class="nf">startShim</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">bundle</span> <span class="o">*</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">shim</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nf">NamespaceRequired</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">WithLogger</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;namespace&#34;</span><span class="p">,</span> <span class="nx">ns</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">topts</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TaskOptions</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">topts</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">topts</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">()</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">topts</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">RuntimeOptions</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">runtimePath</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">resolveRuntimePath</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">Runtime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to resolve runtime path: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">b</span> <span class="o">:=</span> <span class="nf">shimBinary</span><span class="p">(</span><span class="nx">bundle</span><span class="p">,</span> <span class="nx">shimBinaryConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">runtime</span><span class="p">:</span>      <span class="nx">runtimePath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">address</span><span class="p">:</span>      <span class="nx">m</span><span class="p">.</span><span class="nx">containerdAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ttrpcAddress</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">containerdTTRPCAddress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">env</span><span class="p">:</span>          <span class="nx">m</span><span class="p">.</span><span class="nx">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">shim</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalProto</span><span class="p">(</span><span class="nx">topts</span><span class="p">),</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithField</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;shim disconnected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">cleanupAfterDeadShim</span><span class="p">(</span><span class="nx">cleanup</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">events</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Remove self from the runtime task list. Even though the cleanupAfterDeadShim()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// would publish taskExit event, but the shim.Delete() would always failed with ttrpc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// disconnect and there is no chance to remove this dead task from runtime task lists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Thus it&#39;s better to delete it here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">m</span><span class="p">.</span><span class="nx">shims</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;start failed: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">shim</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.2„ÄÅnewShimTask(shim)Ë∞ÉÁî®NewTaskClient</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\core\runtime\v2\shim.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newShimTask</span><span class="p">(</span><span class="nx">shim</span> <span class="nx">ShimInstance</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">shimTask</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">version</span> <span class="o">:=</span> <span class="nx">shim</span><span class="p">.</span><span class="nf">Endpoint</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">shim</span><span class="p">.</span><span class="nf">Client</span><span class="p">(),</span> <span class="nx">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">shimTask</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ShimInstance</span><span class="p">:</span> <span class="nx">shim</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">task</span><span class="p">:</span>         <span class="nx">taskClient</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.2„ÄÅNewTaskClient()Ê†πÊçÆ‰º†ÂÖ•ÁöÑÁâàÊú¨Âè∑ÈÄâÊã©‰∏çÂêåÁöÑÈÄö‰ø°Ê°ÜÊû∂‰∏éshimÈÄö‰ø°ÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™shimTaskÂÆû‰æã</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\core\runtime\v2\bridge.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">client</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">version</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">TaskServiceClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Client</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">version</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ttrpcV2Bridge</span><span class="p">{</span><span class="nx">client</span><span class="p">:</span> <span class="nx">v2</span><span class="p">.</span><span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">c</span><span class="p">)},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">NewTTRPCTaskClient</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;containerd client supports only v2 and v3 TTRPC task client (got %d)&#34;</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConnInterface</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">version</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;containerd client supports only v3 GRPC task service (got %d)&#34;</span><span class="p">,</span> <span class="nx">version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">grpcV3Bridge</span><span class="p">{</span><span class="nx">v3</span><span class="p">.</span><span class="nf">NewTaskClient</span><span class="p">(</span><span class="nx">c</span><span class="p">)},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unsupported shim client type %T&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅshimTask.Create(ctx, opts)ÂàõÂª∫task</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">shimTask</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Task</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">topts</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">TaskOptions</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">topts</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">topts</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">()</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">topts</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">RuntimeOptions</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">request</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">task</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ID</span><span class="p">:</span>         <span class="nx">s</span><span class="p">.</span><span class="nf">ID</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>     <span class="nx">s</span><span class="p">.</span><span class="nf">Bundle</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdin</span><span class="p">:</span>      <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdout</span><span class="p">:</span>     <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stderr</span><span class="p">:</span>     <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Terminal</span><span class="p">:</span>   <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Options</span><span class="p">:</span>    <span class="nx">typeurl</span><span class="p">.</span><span class="nf">MarshalProto</span><span class="p">(</span><span class="nx">topts</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">types</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">FromGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅtask.CreateÊ†πÊçÆNewTaskClient‰º†ÂÖ•ÁöÑÁâàÊú¨Âè∑ÈÄâÊã©Ë∞ÉÁî®‰∏çÂêåÁöÑRPCÔºàËøô‰∏™NewTaskClientÂú®ÂâçÈù¢newShimTaskÂáΩÊï∞Ë∞ÉÁî®ËøáÔºâÔºåËøôÈáåÊàë‰ª¨ÈÄâÊã©ÂàÜÊûêttrpctaskClient.CreateÔºåËøôÈáåË∞ÉÁî®ttRPCÊé•Âè£ÂêëshimÂèëÂá∫ËØ∑Ê±Ç„ÄÇ</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//containerd\containerd\api\runtime\task\v3\shim_ttrpc.pb.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">ttrpctaskClient</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">CreateTaskResponse</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">Call</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;containerd.task.v3.Task&#34;</span><span class="p">,</span> <span class="s">&#34;Create&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅshimÂú®‰πãÂâçÂêØÂä®Âêé‰ºöË∞ÉÁî®RegisterTTRPCÊ≥®ÂÜåÊúçÂä°ÔºåÊâÄ‰ª•‰ºöÊé•Êî∂Âà∞containerdÂèëÂá∫ÁöÑTTRPCËØ∑Ê±ÇÔºåÂú®ËøôÈáåËøõË°åÂ§ÑÁêÜ„ÄÇ</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\containerd\cmd\containerd-shim-runc-v2\task\service.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskAPI</span><span class="p">.</span><span class="nf">RegisterTTRPCTaskService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create a new initial process and container with the underlying OCI runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">platform</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">containers</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskCreate</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskIO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>        <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The following line cannot return an error as the only state in which that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// could happen would also cause the container.Pid() call above to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// nil-deference panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">proc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅÊé•ÁùÄË∞ÉÁî®runc.NewContainerÂáΩÊï∞</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\containerd\cmd\containerd-shim-runc-v2\runc\container.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// NewContainer returns a new runc container
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">platform</span> <span class="nx">stdio</span><span class="p">.</span><span class="nx">Platform</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">task</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">Container</span><span class="p">,</span> <span class="nx">retErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ns</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">namespaces</span><span class="p">.</span><span class="nf">NamespaceRequired</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;create namespace: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">typeurl</span><span class="p">.</span><span class="nf">UnmarshalAny</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">v</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">opts</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.(</span><span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">pmounts</span> <span class="p">[]</span><span class="nx">process</span><span class="p">.</span><span class="nx">Mount</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">m</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pmounts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">pmounts</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">m</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">m</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">rootfs</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pmounts</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rootfs</span> <span class="p">=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="s">&#34;rootfs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Mkdir</span><span class="p">(</span><span class="nx">rootfs</span><span class="p">,</span> <span class="mo">0711</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">config</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">process</span><span class="p">.</span><span class="nx">CreateConfig</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ID</span><span class="p">:</span>               <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>           <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Runtime</span><span class="p">:</span>          <span class="nx">opts</span><span class="p">.</span><span class="nx">BinaryName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>           <span class="nx">pmounts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Terminal</span><span class="p">:</span>         <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdin</span><span class="p">:</span>            <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stdout</span><span class="p">:</span>           <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Stderr</span><span class="p">:</span>           <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span>       <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ParentCheckpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ParentCheckpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Options</span><span class="p">:</span>          <span class="nx">r</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">WriteOptions</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// For historical reason, we write opts.BinaryName as well as the entire opts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">WriteRuntime</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">BinaryName</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">mounts</span> <span class="p">[]</span><span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pm</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pmounts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mounts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">mounts</span><span class="p">,</span> <span class="nx">mount</span><span class="p">.</span><span class="nx">Mount</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Type</span><span class="p">:</span>    <span class="nx">pm</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Source</span><span class="p">:</span>  <span class="nx">pm</span><span class="p">.</span><span class="nx">Source</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Target</span><span class="p">:</span>  <span class="nx">pm</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Options</span><span class="p">:</span> <span class="nx">pm</span><span class="p">.</span><span class="nx">Options</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">retErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mount</span><span class="p">.</span><span class="nf">UnmountMounts</span><span class="p">(</span><span class="nx">mounts</span><span class="p">,</span> <span class="nx">rootfs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;failed to cleanup rootfs mount&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mount</span><span class="p">.</span><span class="nf">All</span><span class="p">(</span><span class="nx">mounts</span><span class="p">,</span> <span class="nx">rootfs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to mount rootfs component: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newInit</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ctx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="s">&#34;work&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">platform</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">config</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">container</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Container</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ID</span><span class="p">:</span>              <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>          <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">process</span><span class="p">:</span>         <span class="nx">p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">processes</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">process</span><span class="p">.</span><span class="nx">Process</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reservedProcess</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}),</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">pid</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">cg</span> <span class="kd">interface</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nf">Mode</span><span class="p">()</span> <span class="o">==</span> <span class="nx">cgroups</span><span class="p">.</span><span class="nx">Unified</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">g</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cgroupsv2</span><span class="p">.</span><span class="nf">PidGroupPath</span><span class="p">(</span><span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;loading cgroup2 for %d&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">container</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cg</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cgroupsv2</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;loading cgroup2 for %d&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cg</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cgroup1</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">cgroup1</span><span class="p">.</span><span class="nf">PidPath</span><span class="p">(</span><span class="nx">pid</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;loading cgroup for %d&#34;</span><span class="p">,</span> <span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">container</span><span class="p">.</span><span class="nx">cgroup</span> <span class="p">=</span> <span class="nx">cg</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">container</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅÊé•ÁùÄË∞ÉÁî®newInit.Create</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\containerd\cmd\containerd-shim-runc-v2\process\init.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create the process with the provided config
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Init</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">CreateConfig</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span>     <span class="kt">error</span>
</span></span><span class="line"><span class="cl">		<span class="nx">socket</span>  <span class="o">*</span><span class="nx">runc</span><span class="p">.</span><span class="nx">Socket</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pio</span>     <span class="o">*</span><span class="nx">processIO</span>
</span></span><span class="line"><span class="cl">		<span class="nx">pidFile</span> <span class="p">=</span> <span class="nf">newPidFile</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//ËøôÈáåÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑsocketÊñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewTempConsoleSocket</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create OCI runtime console socket: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">pio</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">createIO</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">IoUID</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">IoGID</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">stdio</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to create init process I/O: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">io</span> <span class="p">=</span> <span class="nx">pio</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">createCheckpointedState</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">pidFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">runc</span><span class="p">.</span><span class="nx">CreateOpts</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">PidFile</span><span class="p">:</span>      <span class="nx">pidFile</span><span class="p">.</span><span class="nf">Path</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">NoPivot</span><span class="p">:</span>      <span class="nx">p</span><span class="p">.</span><span class="nx">NoPivotRoot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">NoNewKeyring</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">NoNewKeyring</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">io</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">IO</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">socket</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nx">ConsoleSocket</span> <span class="p">=</span> <span class="nx">socket</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">runtimeError</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;OCI runtime create failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">openStdin</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">socket</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">console</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">socket</span><span class="p">.</span><span class="nf">ReceiveMaster</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to retrieve console master: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">console</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Platform</span><span class="p">.</span><span class="nf">CopyConsole</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">console</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start console copy: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">p</span><span class="p">.</span><span class="nx">console</span> <span class="p">=</span> <span class="nx">console</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pio</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">wg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to start io pipe copy: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">pidFile</span><span class="p">.</span><span class="nf">Read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to retrieve OCI runtime container pid: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nx">pid</span> <span class="p">=</span> <span class="nx">pid</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅÊé•ÁùÄË∞ÉÁî®runtime.Create</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\go-runc\runc.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create creates a new container and returns its pid if it was created successfully
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Runc</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">context</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">bundle</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">*</span><span class="nx">CreateOpts</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;create&#34;</span><span class="p">,</span> <span class="s">&#34;--bundle&#34;</span><span class="p">,</span> <span class="nx">bundle</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">opts</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">CreateOpts</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">oargs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nf">args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">args</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">oargs</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">command</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nb">append</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">opts</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cmd</span><span class="p">.</span><span class="nx">ExtraFiles</span> <span class="p">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">ExtraFiles</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stdout</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Stderr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">cmdOutput</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nf">putBuf</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ec</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">startCommand</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">IO</span><span class="p">.(</span><span class="nx">StartCloser</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">CloseAfterStart</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">status</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">ec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s did not terminate successfully: %w&#34;</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="nx">ExitError</span><span class="p">{</span><span class="nx">status</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅÊé•ÁùÄÂæÄ‰∏ãË∞ÉÁî®runc.startCommand</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\go-runc\monitor.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Runc</span><span class="p">)</span> <span class="nf">startCommand</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">exec</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">)</span> <span class="p">(</span><span class="kd">chan</span> <span class="nx">Exit</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">PdeathSignal</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nf">StartLocked</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">Monitor</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅÂÜçÂæÄ‰∏ãË∞ÉÁî®Monitor.Start</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöcontainerd\containerd\pkg\sys\reaper\reaper_unix.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start starts the command and registers the process with the reaper
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Monitor</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">exec</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">)</span> <span class="p">(</span><span class="kd">chan</span> <span class="nx">runc</span><span class="p">.</span><span class="nx">Exit</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ec</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Subscribe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nf">Unsubscribe</span><span class="p">(</span><span class="nx">ec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ec</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3.3„ÄÅÊé•ÁùÄÂæÄ‰∏ãË∞ÉÁî®Cmd.StartÔºåÊúÄÂêéË∞ÉÁî®‰∫Ü‰∏Ä‰∏™Á≥ªÁªüË∞ÉÁî®os.StartProcessÂêØÂä®ËøõÁ®ã„ÄÇ</p>
<p>Ê∫êÁ†ÅË∑ØÂæÑÔºöGo\src\os\exec\exec.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cmd</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Check for doubled Start calls before we defer failure cleanup. If the prior
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// call to Start succeeded, we don&#39;t want to spuriously close its pipes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Process</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;exec: already started&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">started</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">lp</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Path</span>
</span></span><span class="line"><span class="cl">	<span class="nx">c</span><span class="p">.</span><span class="nx">Process</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">StartProcess</span><span class="p">(</span><span class="nx">lp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">argv</span><span class="p">(),</span> <span class="o">&amp;</span><span class="nx">os</span><span class="p">.</span><span class="nx">ProcAttr</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Dir</span><span class="p">:</span>   <span class="nx">c</span><span class="p">.</span><span class="nx">Dir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Files</span><span class="p">:</span> <span class="nx">childFiles</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Env</span><span class="p">:</span>   <span class="nx">env</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Sys</span><span class="p">:</span>   <span class="nx">c</span><span class="p">.</span><span class="nx">SysProcAttr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="nx">started</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅStartÂáΩÊï∞Ë∞ÉÁî®RPC</p>
<p>containerd/client/process.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Start starts the exec process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">process</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">span</span> <span class="o">:=</span> <span class="nx">tracing</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;process.Start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">WithAttribute</span><span class="p">(</span><span class="s">&#34;process.id&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nf">ID</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">tracing</span><span class="p">.</span><span class="nf">WithAttribute</span><span class="p">(</span><span class="s">&#34;process.task.id&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nf">ID</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">span</span><span class="p">.</span><span class="nf">End</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nf">TaskService</span><span class="p">().</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">StartRequest</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">task</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ExecID</span><span class="p">:</span>      <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">io</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">Cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">FromGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">span</span><span class="p">.</span><span class="nf">SetAttributes</span><span class="p">(</span><span class="nx">tracing</span><span class="p">.</span><span class="nf">Attribute</span><span class="p">(</span><span class="s">&#34;process.pid&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Pid</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">.</span><span class="nx">pid</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Pid</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅRPCËØ∑Ê±Çshim</p>
<p>containerd/api/runtime/task/v3/shim_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">taskClient</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.task.v3.Task/Create&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">taskClient</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">StartRequest</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">StartResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">out</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">StartResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;/containerd.task.v3.Task/Start&#34;</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅshimÊî∂Âà∞ËØ∑Ê±ÇÂπ∂Ë∞ÉÁî®Â§ÑÁêÜÂáΩÊï∞</p>
<p>containerd/api/runtime/task/v3/shim_grpc.pb.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">_Task_Create_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CreateTaskRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.task.v3.Task/Create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">CreateTaskRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">_Task_Start_Handler</span><span class="p">(</span><span class="nx">srv</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">dec</span> <span class="kd">func</span><span class="p">(</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">in</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">StartRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">dec</span><span class="p">(</span><span class="nx">in</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">interceptor</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">info</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Server</span><span class="p">:</span>     <span class="nx">srv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">FullMethod</span><span class="p">:</span> <span class="s">&#34;/containerd.task.v3.Task/Start&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">srv</span><span class="p">.(</span><span class="nx">TaskServer</span><span class="p">).</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">.(</span><span class="o">*</span><span class="nx">StartRequest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">interceptor</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>3„ÄÅÂÆûÈôÖË∞ÉÁî®ÁöÑÂ§ÑÁêÜÂáΩÊï∞</p>
<p>containerd/cmd/containerd-shim-runc-v2/task/service.go</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">RegisterTTRPC</span><span class="p">(</span><span class="nx">server</span> <span class="o">*</span><span class="nx">ttrpc</span><span class="p">.</span><span class="nx">Server</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">taskAPI</span><span class="p">.</span><span class="nf">RegisterTTRPCTaskService</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Create a new initial process and container with the underlying OCI runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runc</span><span class="p">.</span><span class="nf">NewContainer</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">platform</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">containers</span><span class="p">[</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskCreate</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Bundle</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Bundle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Rootfs</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">Rootfs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">IO</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskIO</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdin</span><span class="p">:</span>    <span class="nx">r</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stdout</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Stderr</span><span class="p">:</span>   <span class="nx">r</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Terminal</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Terminal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Checkpoint</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span>        <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// The following line cannot return an error as the only state in which that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// could happen would also cause the container.Pid() call above to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// nil-deference panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">proc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Process</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">proc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">CreateTaskResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Start a process
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">service</span><span class="p">)</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">StartRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">StartResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">container</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">getContainer</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">cinit</span> <span class="o">*</span><span class="nx">runc</span><span class="p">.</span><span class="nx">Container</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cinit</span> <span class="p">=</span> <span class="nx">container</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">initExited</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">containerInitExit</span><span class="p">[</span><span class="nx">container</span><span class="p">];</span> <span class="nx">initExited</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPCf</span><span class="p">(</span><span class="nx">errdefs</span><span class="p">.</span><span class="nx">ErrFailedPrecondition</span><span class="p">,</span> <span class="s">&#34;container %s init process is not running&#34;</span><span class="p">,</span> <span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nx">runningExecs</span><span class="p">[</span><span class="nx">container</span><span class="p">]</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">handleStarted</span><span class="p">,</span> <span class="nx">cleanup</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">preStart</span><span class="p">(</span><span class="nx">cinit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If we failed to even start the process, s.runningExecs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// won&#39;t get decremented in s.handleProcessExit. We still need
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// to update it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">runningExecs</span><span class="p">[</span><span class="nx">container</span><span class="p">]</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">ch</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">execCountSubscribers</span><span class="p">[</span><span class="nx">container</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nx">runningExecs</span><span class="p">[</span><span class="nx">container</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">s</span><span class="p">.</span><span class="nx">lifecycleMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errdefs</span><span class="p">.</span><span class="nf">ToGRPC</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="s">&#34;&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">cg</span> <span class="o">:=</span> <span class="nx">container</span><span class="p">.</span><span class="nf">Cgroup</span><span class="p">().(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">cgroup1</span><span class="p">.</span><span class="nx">Cgroup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">cg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;add cg to OOM monitor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">*</span><span class="nx">cgroupsv2</span><span class="p">.</span><span class="nx">Manager</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">allControllers</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cg</span><span class="p">.</span><span class="nf">RootControllers</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed to get root controllers&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cg</span><span class="p">.</span><span class="nf">ToggleControllers</span><span class="p">(</span><span class="nx">allControllers</span><span class="p">,</span> <span class="nx">cgroupsv2</span><span class="p">.</span><span class="nx">Enable</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">userns</span><span class="p">.</span><span class="nf">RunningInUserNS</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Debugf</span><span class="p">(</span><span class="s">&#34;failed to enable controllers (%v)&#34;</span><span class="p">,</span> <span class="nx">allControllers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to enable controllers (%v)&#34;</span><span class="p">,</span> <span class="nx">allControllers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span> <span class="nx">cg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">log</span><span class="p">.</span><span class="nf">G</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">WithError</span><span class="p">(</span><span class="nx">err</span><span class="p">).</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;add cg to OOM monitor&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskStart</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Pid</span><span class="p">:</span>         <span class="nb">uint32</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">eventstypes</span><span class="p">.</span><span class="nx">TaskExecStarted</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ContainerID</span><span class="p">:</span> <span class="nx">container</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">ExecID</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nx">ExecID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">Pid</span><span class="p">:</span>         <span class="nb">uint32</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">		<span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">handleStarted</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">taskAPI</span><span class="p">.</span><span class="nx">StartResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Pid</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nf">Pid</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">	<span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ÈóÆÈ¢ò‰∏éËß£Á≠î">ÈóÆÈ¢ò‰∏éËß£Á≠î
</h2><p><strong>1„ÄÅcontainerdÁöÑ gRPC ÁõÆÂâçÂêØÁî®Âä†Ëß£ÂØÜ‰øùÊä§ÈÄö‰ø°‰∏éÂê¶ÔºüÊòØÂê¶ÊúâÂèåÂêëËÆ§ËØÅÔºü</strong></p>
<p>Á≠îÔºöÂú® <code>containerd</code> ‰∏≠ÔºågRPC ÁöÑÂä†ÂØÜÊòØÈÄöËøáÈÖçÁΩÆÊñá‰ª∂‰∏≠ÁöÑ TLS ËÆæÁΩÆÂÆûÁé∞ÁöÑ„ÄÇ‰Ω†ÂèØ‰ª•Âú® <code>containerd</code> ÁöÑÈÖçÁΩÆÊñá‰ª∂ <code>/etc/containerd/config.toml</code> ‰∏≠ÈÖçÁΩÆ TLS Áõ∏ÂÖ≥ÁöÑÈÄâÈ°π„ÄÇ</p>
<p>Âú® <code>config.toml</code> Êñá‰ª∂‰∏≠Ôºå‰Ω†ÂèØ‰ª•‰∏∫ gRPC ÊúçÂä°ÂêØÁî® TLSÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-toml" data-lang="toml"><span class="line"><span class="cl"><span class="p">[</span><span class="nx">grpc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;/run/containerd/containerd.sock&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># ÂºÄÂêØTCPÁõëÂê¨ÔºåÈªòËÆ§ÊòØÂÖ≥Èó≠ÁöÑ</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tcp_address</span> <span class="p">=</span> <span class="s2">&#34;0.0.0.0:2375&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># ÈÖçÁΩÆTLSËØÅ‰π¶ÂíåÂØÜÈí•</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tls_cert</span> <span class="p">=</span> <span class="s2">&#34;/etc/containerd/tls/containerd.crt&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tls_key</span> <span class="p">=</span> <span class="s2">&#34;/etc/containerd/tls/containerd.key&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c"># ÂèØÈÄâÁöÑÔºåCAËØÅ‰π¶Ë∑ØÂæÑ</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tls_ca</span> <span class="p">=</span> <span class="s2">&#34;/etc/containerd/tls/ca.crt&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>tls_cert</code> Âíå <code>tls_key</code> ÊòØÊúçÂä°Âô®ÁöÑËØÅ‰π¶ÂíåÁßÅÈí•Êñá‰ª∂Ôºå<code>containerd</code> Â∞Ü‰ΩøÁî®Ëøô‰∫õÊñá‰ª∂Êù•Âä†ÂØÜ gRPC ÈÄö‰ø°„ÄÇ</p>
<p><code>tls_ca</code> ÊòØÂèØÈÄâÁöÑ CA ËØÅ‰π¶ÔºåÁî®‰∫éÈ™åËØÅÂÆ¢Êà∑Á´ØËØÅ‰π¶Ôºå‰ªéËÄåÊîØÊåÅÂèåÂêëËÆ§ËØÅÔºàMutual TLS, mTLSÔºâ„ÄÇ</p>
<p><strong>2„ÄÅ2.1.4‰∏≠ÊèêÂà∞‚ÄúÊèí‰ª∂ÈÄöËøá gRPC Êèê‰æõÊúçÂä°Êé•Âè£Ôºåcontainerd Ê†∏ÂøÉÈÄöËøáË∞ÉÁî®Ëøô‰∫õÊé•Âè£Êù•ÁÆ°ÁêÜÈïúÂÉè„ÄÅÂø´ÁÖßÂíåÂÆπÂô®ËøêË°åÊó∂Á≠â‚Äù„ÄÇ</strong>
<strong>ÊòØÂê¶ÊÑèÂë≥ÁùÄcontainerd‰∏éÊèí‰ª∂‰πãÈó¥‰πüÊòØ‰ΩøÁî®gRPCËøõË°åÁöÑÈÄö‰ø°Ôºü‰πüÂ∞±ÊòØcontainerdÂÜÖÈÉ®‰πüÊúâgRPCÈÄö‰ø°Ôºü</strong></p>
<p>Á≠îÔºöcontainerdÂÜÖÈÉ®Â∫îËØ•‰∏çÊòØgRPCÈÄö‰ø°ÔºågRPCÊòØ‰∏Ä‰∏™RPCÈÄö‰ø°Ê°ÜÊû∂Ôºå‰∏ÄËà¨Áî®‰∫éËøõÁ®ãÈó¥ÔºåÂú®‰∏Ä‰∏™ËøõÁ®ã‰∏≠‰ΩøÁî®gRPCÊ≤°ÊúâÂ§™Â§ßÁöÑÂøÖË¶ÅÔºå‰∏Ä‰∏™ËøõÁ®ãÂÜÖÈÉ®ÂêÑÊ®°ÂùóÁöÑÈÄö‰ø°Â∫îËØ•ÊòØÈÄöËøáÊé•Âè£ÂíåÁõ¥Êé•ÁöÑÂáΩÊï∞Ë∞ÉÁî®Êù•ÂÆûÁé∞ÂÜÖÈÉ®ÈÄö‰ø°ÁöÑ„ÄÇ</p>
<p><strong>3„ÄÅ2.1.4 ‰ª•Âèä 3.1 ÂàÜÂà´ÊèêÂà∞Ôºö‚ÄúÂÆàÊä§ËøõÁ®ã‰∏éÂ§ñÈÉ®ÂÆ¢Êà∑Á´ØÔºàÂ¶Ç ctr Â∑•ÂÖ∑Êàñ Docker ÂºïÊìéÔºâ‰πãÈó¥ÁöÑÈÄö‰ø° ‚Äù‰ΩøÁî® gRPC/UDS Ôºü</strong>
<strong>ÁâπÂà´ÊòØ 3.1 Â¶Ç‰ΩïÁêÜËß£Ôºü3.1 ÂêéÈù¢ÊèêÂà∞‰∏Ä‰∏™‰æãÂ≠êÔºåDockerÂºïÊìéÈÄöËøá gRPC ËøûÊé•Âà∞ÂÆàÊä§ËøõÁ®ãÁöÑUDSÂú∞ÂùÄÔºå‰ª•ËØ∑Ê±ÇÁÆ°ÁêÜÂÆπÂô®„ÄÅÈïúÂÉè„ÄÅÂø´ÁÖßÁ≠âÊìç‰Ωú„ÄÇÈóÆÔºögRPC Â¶Ç‰ΩïËøûÊé•ÁöÑËøô‰∏™ UDS Âú∞ÂùÄÔºàÊäÄÊúØÂéüÁêÜÔºâÔºü</strong></p>
<p>Á≠îÔºöËøô‰∏™ÈóÆÈ¢òÁêÜËß£ÁöÑÂÖ≥ÈîÆÁÇπÂú®‰∫éudsÊòØÂ¶Ç‰Ωï‰∏égRPCÁªìÂêà‰ΩøÁî®ÁöÑÔºåcontainerdÂú®ÊúçÂä°ÂêØÂä®ÁöÑÊó∂ÂÄô‰ΩøÁî® <code>sys.GetLocalListener</code> Êù•ÁõëÂê¨‰∏Ä‰∏™ Unix Domain Socket„ÄÇÁÑ∂ÂêéÂ∞ÜÁõëÂê¨Âô®‰º†ÈÄíÁªô <code>serve</code>ÂáΩÊï∞Â§ÑÁêÜgrpcËØ∑Ê±Ç„ÄÇÔºàÂÖ∑‰ΩìÁöÑ‰ª£Á†ÅÂèØ‰ª•Âú®4.1‰∏≠ÊâæÂà∞Ôºâ</p>
<p><img src="/assets/image-20240827113414851.png"
	
	
	
	loading="lazy"
	
		alt="ÁõëÂê¨uds"
	
	
></p>
<p><img src="/assets/image-20240826095151377.png"
	
	
	
	loading="lazy"
	
		alt="serveÂáΩÊï∞"
	
	
></p>
<p><strong>4„ÄÅÂàõÂª∫ÁöÑÂÆπÂô®ÁöÑÊâÄÂ±û user„ÄÅgroup ÈªòËÆ§ÊòØ‰∏écontainerd ÂêåÁªÑÂêåÁî®Êà∑ÂêóÔºü</strong></p>
<p>Á≠îÔºöÊàëÂú®Ëøô‰∏™ÈóÆÈ¢ò‰∏äÂÅö‰∫Ü‰∏Ä‰∫õÂÆûÈ™åÊù•È™åËØÅ„ÄÇÈ¶ñÂÖàÔºåÂàõÂª∫ÁöÑÂÆπÂô®ÁöÑÁî®Êà∑ÂíåÁî®Êà∑ÁªÑËÇØÂÆöÊòØÂèØ‰ª•ËÆæÁΩÆÁöÑÔºåÊó†ËÆ∫ÊòØÂú®ÈïúÂÉè‰∏≠ÊåáÂÆöÔºåËøòÊòØÂú®ÂàõÂª∫ÂÆπÂô®ÁöÑÊó∂ÂÄôÊåáÂÆöÔºõ‰ΩÜÈªòËÆ§‰∏çÊåáÂÆöÁöÑÊÉÖÂÜµ‰∏ãÈïúÂÉè‰∏ÄËà¨ÈÉΩÊòØÂ∞ÜÂÆπÂô®ÂÜÖÁöÑËøõÁ®ãËÆæÁΩÆ‰∏∫‰ª•rootÁî®Êà∑ËøõË°å„ÄÇËøô‰πüÂç∞ËØÅ‰∫Ü‰∏ãÈù¢ËøôÂè•ËØùÔºöÂú® <code>containerd</code> ‰∏≠ÔºåÂàõÂª∫ÁöÑÂÆπÂô®ÈªòËÆ§ÊÉÖÂÜµ‰∏ã‰∏ç‰ºöËá™Âä®ÁªßÊâø <code>containerd</code> ËøõÁ®ãÁöÑÁî®Êà∑Ôºà<code>user</code>ÔºâÂíåÁªÑÔºà<code>group</code>Ôºâ„ÄÇÁõ∏ÂèçÔºåÂÆπÂô®ÁöÑÁî®Êà∑ÂíåÁªÑÊòØÊ†πÊçÆÂÆπÂô®ÁöÑÈÖçÁΩÆÔºàÂ¶Ç OCI ËßÑËåÉÔºâÊù•ÂÜ≥ÂÆöÁöÑ„ÄÇ</p>
<p>‰∏ãÈù¢ÊòØÊàë‰ΩøÁî®<code>containerd</code>ÂàõÂª∫alpineÊúçÂä°ÂÆπÂô®ÁöÑÊùÉÈôêÁöÑÈÖçÁΩÆÊñá‰ª∂Ôºö</p>
<p><strong>5„ÄÅ3.3 ÊèêÂà∞‚ÄúÊèí‰ª∂ÂèØËÉΩ‰Ωú‰∏∫Â§ñÈÉ®ÊúçÂä°ËøêË°åÔºåÈúÄË¶ÅÈÄöËøá UDS ‰∏é containerd ÈÄö‰ø°„ÄÇ‚ÄùÔºå‰æãÂ≠ê‰ªãÁªç‰∏≠ËØ¥Ôºö‚ÄúÂ§ñÈÉ®Â≠òÂÇ®Êèí‰ª∂ÂèØËÉΩÁã¨Á´ãËøêË°åÂπ∂ÈÄöËøá UDS Êö¥Èú≤ÂÖ∂ gRPC ÊúçÂä°Ôºåcontainerd ÈÄöËøáËøûÊé•Ëøô‰∏™ UDS Êù•Ë∞ÉÁî®Êèí‰ª∂ÁöÑÊúçÂä°„ÄÇ‚Äù</strong>
<strong>ÈóÆÔºöcontainerd ÈÄöËøá UDS ËøûÊé•Â§ñÈÉ®Êèí‰ª∂ÔºåÂ§ñÈÉ®Êèí‰ª∂Êö¥Èú≤ÁöÑ gRPC ÁªôË∞ÅÔºü</strong></p>
<p>Á≠îÔºöËøôÊòØcontainerdÂÆòÊñπÊñáÊ°£Êü•Âà∞ÁöÑÔºåcontainerdÈÄöËøágRPCËøûÊé•Â§ñÈÉ®Êèí‰ª∂ÔºåÈÇ£Â§ñÈÉ®Êèí‰ª∂Êö¥Èú≤ÁöÑgRPCËÇØÂÆöÊòØÁªôcontainerdÁöÑÈÖçÁΩÆÊñá‰ª∂„ÄÇ</p>
<p><img src="/assets/image-20240826104113183.png"
	
	
	
	loading="lazy"
	
		alt="Â§ñÈÉ®Êèí‰ª∂"
	
	
></p>
<p><img src="/assets/image-20240826104245632.png"
	
	
	
	loading="lazy"
	
		alt="‰ª£ÁêÜÊèí‰ª∂"
	
	
></p>
<p><strong>6„ÄÅsystemd Êèê‰æõ‰ΩøÁî®socket activationtÊú∫Âà∂ÔºåÊòØÈíàÂØπÂÜÖÊ†∏ÊÄÅËøõÁ®ãËøòÊòØÁî®Êà∑ÊÄÅËøõÁ®ãÔºå‰∫¶ÊàñÊòØ‰∏§ËÄÖÈÉΩÊîØÊåÅÔºü</strong></p>
<p>Á≠îÔºöÈíàÂØπÁî®Êà∑ÊÄÅËøõÁ®ã„ÄÇ</p>
<p><strong>7„ÄÅcontainerdÁöÑsocketÊñá‰ª∂ÁöÑmodeÂíåuid„ÄÅgidÂàÜÂà´ÊòØÔºüÁî±Ë∞ÅËÆæÁΩÆËØ•ÂÜÖÂÆπÔºü</strong></p>
<p>Á≠îÔºöÂÖ∑‰ΩìÂõûÁ≠îÂèØ‰ª•ÁúãÈóÆÈ¢ò9ÔºåËá≥‰∫ésocketÊñá‰ª∂ÁöÑmode„ÄÅuid„ÄÅgidÁöÑËÆæÁΩÆËÇØÂÆöÊòØÁî±containerdËá™Â∑±ËÆæÁΩÆÔºåÂÖ∑‰ΩìÂèØÁúãÊ∫êÁ†Å„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//È¶ñÂÖà‰º†ÂÖ•config.toml‰∏≠ËÆæÁΩÆÁöÑgidÔºåuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="nx">ttrpc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="nx">address</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">gid</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="nx">uid</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//Êé•ÁùÄË∞ÉÁî®GetLocalListener
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">tl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sys</span><span class="p">.</span><span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">UID</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">TTRPC</span><span class="p">.</span><span class="nx">GID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//ÂÜçÂàõÂª∫socketÊñá‰ª∂Ôºå‰πãÂêéË∞ÉÁî®chmod‰∏∫0660Ôºåchown‰∏∫‰∏äÈù¢‰º†ÂÖ•ÁöÑgid„ÄÅuid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GetLocalListener</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ensure parent directory is created
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mkdirAs</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">CreateUnixSocket</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chmod</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="mo">0660</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Chown</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">uid</span><span class="p">,</span> <span class="nx">gid</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>8„ÄÅrootÊùÉÈôê‰∏ãÔºöcontainerd„ÄÅshim‰ª•ÂèäÂÆπÂô®ÁöÑUID„ÄÅGIDÊòØÂê¶ÈÉΩ‰∏ÄÊ†∑ÔºüÂ¶Ç‰ΩïËÆæÁΩÆÂÆπÂô®‰∏çÂêåÁöÑUID„ÄÅGID</strong></p>
<p>Á≠îÔºörootÊùÉÈôê‰∏ãcontainerd„ÄÅshimÁöÑUID„ÄÅGIDÈÉΩÊòØroot</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hacker@LAPTOP-V47UU71B:/mnt/c/Users/L$ ps -eo pid,user,group,comm <span class="p">|</span> grep containerd
</span></span><span class="line"><span class="cl">    <span class="m">248</span> root     root     containerd
</span></span><span class="line"><span class="cl">   <span class="m">8561</span> root     root     containerd-shim
</span></span><span class="line"><span class="cl">  <span class="m">13295</span> root     root     containerd-shim
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â¶Ç‰ΩïËÆæÁΩÆÂÆπÂô®‰∏çÂêåÁöÑuid„ÄÅgidÔºåÂèØ‰ª•Âú®containerdÂàõÂª∫ÂÆπÂô®Êó∂ÊåáÂÆöÁî®Êà∑ÂèäÁî®Êà∑ÁªÑÔºåÊØîÂ¶ÇÊàëÁöÑÁî®Êà∑ÂíåÁî®Êà∑ÁªÑÈÉΩÊòØ1000ÔºåÊàëÂèØ‰ª•Ëøô‰πàÂàõÂª∫ÂÆπÂô®„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hacker@LAPTOP-V47UU71B:/mnt/c/Users/L$ sudo ctr container create -u 1000:1000 m.daocloud.io/docker.io/library/alpine:latest mycont
</span></span><span class="line"><span class="cl">ainer
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøõÂÖ•ÂÆπÂô®ÂêéÊü•Áúãid</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hacker@LAPTOP-V47UU71B:/mnt/c/Users/L$ sudo ctr task <span class="nb">exec</span> -t --exec-id exec-1 mycontainer /bin/sh
</span></span><span class="line"><span class="cl">~ $ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span><span class="m">1000</span> <span class="nv">gid</span><span class="o">=</span><span class="m">1000</span> <span class="nv">groups</span><span class="o">=</span><span class="m">1000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>9„ÄÅÂ¶ÇÊûúÁî®systemdÂêØÂä®containerdÂÆàÊä§ËøõÁ®ã‰ª•ÂèäÁî®‰∫é‰∏écontainerdÈÄö‰ø°ÁöÑclientËøõÁ®ãÔºåÈÇ£‰πàsocketÊñá‰ª∂ÊòØÁî±systemdÂàõÂª∫ËøòÊòØcontainerdÂàõÂª∫Ôºü</strong></p>
<p>Â¶ÇÊûú‰ΩøÁî® systemd Êù•ÂêØÂä® <code>containerd</code> ÂÆàÊä§ËøõÁ®ã‰ª•ÂèäÁî®‰∫é‰∏é <code>containerd</code> ÈÄö‰ø°ÁöÑÂÆ¢Êà∑Á´ØËøõÁ®ãÔºåÂπ∂‰∏îÂêØÁî®‰∫Ü socket activation Êú∫Âà∂ÔºàÂèØ‰ª•‰∏çÂêØÂä®ÔºâÔºåÈÇ£‰πà socket Êñá‰ª∂Â∞ÜÁî± systemd ÂàõÂª∫ÔºåËÄå‰∏çÊòØ <code>containerd</code>„ÄÇ</p>
<p><strong>Ôºà‰∫ãÂÆû‰∏äcontainerdÂ∫îËØ•ÊòØ‰∏çÊîØÊåÅsystemdÁöÑsocket activationÊú∫Âà∂ÁöÑÔºågithub‰πüÊúâ‰∫∫ÊèêÂá∫ËøáÂú®containerd‰∏≠Âä†ÂÖ•Ê≠§Êú∫Âà∂Ôºö<a class="link" href="https://github.com/containerd/containerd/issues/164"  target="_blank" rel="noopener"
    >add socket activation ¬∑ Issue #164 ¬∑ containerd/containerd (github.com)</a>Ôºâ</strong></p>
<p>‰∏ÄËà¨Â¶ÇÊûúÊîØÊåÅsocket activationÊú∫Âà∂ÁöÑËØù‰ºöÊúâÁ±ª‰ºº‰∏ãÂõæÁöÑÈÄªËæëÔºåÊúçÂä°Âô®‰ºöÂÖàË∞ÉÁî®sd_listen_fdsÂáΩÊï∞ÔºåÁúãsystemdÊòØÂê¶ÂàõÂª∫‰∫ÜsocketÊñá‰ª∂ÔºåÂ¶ÇÊûúÂàõÂª∫‰∫ÜÂ∞±‰∏ç‰ºöÂÜçÂàõÂª∫‰∫Ü„ÄÇÊâÄ‰ª•Â¶ÇÊûú‰ΩøÁî®systemÁöÑsocket activationÂêØÂä®ËøõÁ®ãÔºåÈÇ£‰πàÂ∞±‰∏ÄÂÆöÊòØsystemdÂàõÂª∫socketÊñá‰ª∂„ÄÇ</p>
<p><img src="/assets/image-20240827232023457.png"
	
	
	
	loading="lazy"
	
		alt="socket activation‰ª£Á†ÅÈÄªËæë"
	
	
></p>
<p>ÂÖ∑‰ΩìËøáÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ol>
<li><strong>systemd ÂàõÂª∫ socket</strong>ÔºöÂú® socket activation Êú∫Âà∂‰∏ãÔºåsystemd ‰ºöÈ¶ñÂÖàÊ†πÊçÆÈÖçÁΩÆÂàõÂª∫‰∏Ä‰∏™ÁõëÂê¨ socket Êñá‰ª∂ÔºåÂπ∂Â∞ÜÂÖ∂ÁΩÆ‰∫éÁõëÂê¨Áä∂ÊÄÅ„ÄÇËøôÊòØÂú® <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÂêØÂä®‰πãÂâçÂÆåÊàêÁöÑ„ÄÇ</li>
<li><strong>systemd ÂêØÂä® containerd</strong>ÔºöÂΩìÊúâÂÆ¢Êà∑Á´ØËøûÊé•Âà∞Áî± systemd ÂàõÂª∫ÁöÑ socket Êó∂Ôºåsystemd Ê£ÄÊµãÂà∞ËøûÊé•ËØ∑Ê±ÇÂπ∂ÂêØÂä® <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÔºåÂπ∂Â∞ÜËøô‰∏™ socket ‰º†ÈÄíÁªô <code>containerd</code>„ÄÇ</li>
<li><strong>containerd ‰ΩøÁî® socket</strong>Ôºö<code>containerd</code> ÂêØÂä®ÂêéÔºåÊé•Êî∂ systemd ‰º†ÈÄíÁöÑ socketÔºåÂπ∂‰ΩøÁî®ËØ• socket Êù•Â§ÑÁêÜÂÆ¢Êà∑Á´ØÁöÑÈÄö‰ø°ËØ∑Ê±Ç„ÄÇ</li>
</ol>
<p>‰∏∫‰∫ÜÊõ¥Â•ΩÁöÑÁêÜËß£‰∏∫‰ªÄ‰πàÊòØsystemdÂàõÂª∫Êàë‰ª¨ÂÜô‰∏Ä‰∏™‰ΩøÁî® systemd ÂêØÂä® <code>containerd</code> ÂÆàÊä§ËøõÁ®ãÂíåÂÆ¢Êà∑Á´ØËøõÁ®ãÁöÑÊµÅÁ®ãÔºö</p>
<p>1„ÄÅÂàõÂª∫ systemd ÁöÑ socket ÂçïÂÖÉÊñá‰ª∂</p>
<p>‰Ω†ÈúÄË¶Å‰∏∫ <code>containerd</code> ÂàõÂª∫‰∏Ä‰∏™ <code>.socket</code> ÂçïÂÖÉÊñá‰ª∂ÔºåÈÄöÂ∏∏ÊîæÂú® <code>/etc/systemd/system/containerd.socket</code> Êàñ <code>/usr/lib/systemd/system/containerd.socket</code>„ÄÇ</p>
<p>Á§∫‰æãÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[Unit]
</span></span><span class="line"><span class="cl">Description=containerd Socket
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Socket]
</span></span><span class="line"><span class="cl">ListenStream=/run/containerd/containerd.sock
</span></span><span class="line"><span class="cl">SocketMode=0660
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Install]
</span></span><span class="line"><span class="cl">WantedBy=sockets.target
</span></span></code></pre></td></tr></table>
</div>
</div><p>2„ÄÅÂàõÂª∫ systemd ÁöÑ service ÂçïÂÖÉÊñá‰ª∂</p>
<p>‰Ω†ÈúÄË¶ÅÁ°Æ‰øù <code>containerd</code> ÁöÑ <code>.service</code> ÂçïÂÖÉÊñá‰ª∂Ê≠£Á°ÆÈÖçÁΩÆ„ÄÇÂ¶ÇÊûúÈªòËÆ§ÁöÑ service Êñá‰ª∂‰∏çÊîØÊåÅ socket activationÔºå‰Ω†ÂèØËÉΩÈúÄË¶ÅÊèê‰æõ‰∏Ä‰∏™Ëá™ÂÆö‰πâÁöÑ service Êñá‰ª∂„ÄÇÊîæÂú® <code>/etc/systemd/system/containerd.service</code> Êàñ <code>/usr/lib/systemd/system/containerd.service</code>„ÄÇ</p>
<p>Á§∫‰æãÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Description</span><span class="o">=</span><span class="n">containerd</span> <span class="n">container</span> <span class="n">runtime</span>
</span></span><span class="line"><span class="cl"><span class="n">Documentation</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">containerd</span><span class="o">.</span><span class="n">io</span>
</span></span><span class="line"><span class="cl"><span class="n">Wants</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
</span></span><span class="line"><span class="cl"><span class="n">After</span><span class="o">=</span><span class="n">network</span><span class="o">-</span><span class="n">online</span><span class="o">.</span><span class="n">target</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Service</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">containerd</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span><span class="o">=</span><span class="n">notify</span>
</span></span><span class="line"><span class="cl"><span class="n">Restart</span><span class="o">=</span><span class="n">always</span>
</span></span><span class="line"><span class="cl"><span class="n">LimitNOFILE</span><span class="o">=</span><span class="mi">1048576</span>
</span></span><span class="line"><span class="cl"><span class="n">LimitNPROC</span><span class="o">=</span><span class="n">infinity</span>
</span></span><span class="line"><span class="cl"><span class="n">LimitCORE</span><span class="o">=</span><span class="n">infinity</span>
</span></span><span class="line"><span class="cl"><span class="n">TasksMax</span><span class="o">=</span><span class="n">infinity</span>
</span></span><span class="line"><span class="cl"><span class="n">Delegate</span><span class="o">=</span><span class="n">yes</span>
</span></span><span class="line"><span class="cl"><span class="n">KillMode</span><span class="o">=</span><span class="n">process</span>
</span></span><span class="line"><span class="cl"><span class="n">OOMScoreAdjust</span><span class="o">=-</span><span class="mi">999</span>
</span></span><span class="line"><span class="cl"><span class="n">ExecStartPre</span><span class="o">=-/</span><span class="n">sbin</span><span class="o">/</span><span class="n">modprobe</span> <span class="n">overlay</span>
</span></span><span class="line"><span class="cl"><span class="n">ExecReload</span><span class="o">=/</span><span class="n">bin</span><span class="o">/</span><span class="n">kill</span> <span class="o">-</span><span class="n">s</span> <span class="n">HUP</span> <span class="o">$</span><span class="n">MAINPID</span>
</span></span><span class="line"><span class="cl"><span class="n">KillSignal</span><span class="o">=</span><span class="n">SIGTERM</span>
</span></span><span class="line"><span class="cl"><span class="n">TimeoutStartSec</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Install</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3„ÄÅÂêØÁî®Âπ∂ÂêØÂä® socket Âíå service</p>
<p>ÂêØÁî®Âπ∂ÂêØÂä® socket Âíå serviceÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sudo systemctl enable containerd.socket
</span></span><span class="line"><span class="cl">sudo systemctl start containerd.socket
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ê≠§Êó∂Ôºåsystemd ‰ºöÁõëÂê¨ <code>/run/containerd/containerd.sock</code>ÔºåÂπ∂Âú®ÊúâÂÆ¢Êà∑Á´ØËøûÊé•Êó∂Ëá™Âä®ÂêØÂä® <code>containerd</code> ÊúçÂä°„ÄÇ</p>
<p><strong>10„ÄÅOCI Ê†áÂáÜÊòØ‰ªÄ‰πàÔºü</strong></p>
<p><strong>OCIÔºàOpen Container InitiativeÔºâ</strong> ÊòØ‰∏Ä‰∏™ÂºÄÊ∫êÈ°πÁõÆÔºåÊó®Âú®ÂÆö‰πâÂÆπÂô®ËøêË°åÊó∂ÂíåÈïúÂÉèÁöÑÊ†áÂáÜ„ÄÇÂÆÉÁî± Linux Foundation ÁªÑÁªá‰∏ªÂØºÔºå‰∏ªË¶ÅÂåÖÊã¨‰∏§‰∏™ÂÖ≥ÈîÆËßÑËåÉÔºö</p>
<ol>
<li><strong>OCI Runtime SpecificationÔºàOCI ËøêË°åÊó∂ËßÑËåÉÔºâ</strong>Ôºö
<ul>
<li>Ëøô‰∏™ËßÑËåÉÂÆö‰πâ‰∫ÜÂÆπÂô®ÁöÑËøêË°åÊó∂Ë°å‰∏∫ÔºåÂåÖÊã¨Â¶Ç‰ΩïÂàõÂª∫„ÄÅÈÖçÁΩÆ„ÄÅÂêØÂä®„ÄÅÂÅúÊ≠¢ÂíåÂà†Èô§ÂÆπÂô®„ÄÇÂÆÉÂÆö‰πâ‰∫ÜÂÆπÂô®ÁîüÂëΩÂë®ÊúüÁöÑÂêÑ‰∏™Èò∂ÊÆµÔºå‰ª•ÂèäÂÆπÂô®ËøõÁ®ãÁöÑÁéØÂ¢É„ÄÅÂëΩÂêçÁ©∫Èó¥„ÄÅcgroups Á≠âÈÖçÁΩÆ„ÄÇ</li>
</ul>
</li>
<li><strong>OCI Image SpecificationÔºàOCI ÈïúÂÉèËßÑËåÉÔºâ</strong>Ôºö
<ul>
<li>Ëøô‰∏™ËßÑËåÉÂÆö‰πâ‰∫ÜÂÆπÂô®ÈïúÂÉèÁöÑÊ†ºÂºèÂèäÂÖ∂ÂÜÖÂÆπ„ÄÇËøôÂåÖÊã¨Â¶Ç‰ΩïÊâìÂåÖÂ∫îÁî®Á®ãÂ∫èÂèäÂÖ∂‰æùËµñÈ°πÔºå‰ª•‰æøÈïúÂÉèÂèØ‰ª•Ë¢´ÂêÑÁßçÂÆπÂô®ËøêË°åÊó∂ÊãâÂèñÂíåËß£ÂéãÔºå‰ª•‰∏ÄËá¥ÁöÑÊñπÂºèËøêË°å„ÄÇ</li>
</ul>
</li>
</ol>
<p><strong>11„ÄÅ‰∏∫‰ªÄ‰πàcontainerdÊúÄÁªàË∞ÉÁî®ÁöÑÊòØnet.listen()ÂàõÂª∫socketÊñá‰ª∂Ôºü</strong></p>
<p>Âõ†‰∏∫net.listen()Ë∞ÉÁî®ÁöÑÊòØGoÊ†áÂáÜÂ∫ìnetÂåÖ‰∏≠ÁöÑ‰∏Ä‰∏™ÂáΩÊï∞ÔºåGoÂØπÂ∫ïÂ±ÇudsÁöÑsyscallÂÅö‰∫Ü‰∏Ä‰∏™Â∞ÅË£ÖÔºåÂÆûÈôÖÂàõÂª∫socketÊñá‰ª∂ËøòÊòØbindÈò∂ÊÆµÔºåÂÖ∑‰ΩìÂèØ‰ª•Êü•ÁúãnetÁöÑÂÆûÁé∞ÔºåÊàëÁ®çÂæÆÁúã‰∫Ü‰∏Ä‰∏ãÊ∫êÁ†ÅÁ°ÆÂÆûÊòØÂÅö‰∫ÜÂ∞ÅË£Ö„ÄÇ</p>
<h2 id="ÂèÇËÄÉËµÑÊñô">ÂèÇËÄÉËµÑÊñô
</h2><p><a class="link" href="https://github.com/containerd/containerd/blob/main/core/runtime/v2/README.md"  target="_blank" rel="noopener"
    >containerd-shimÊñáÊ°£</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/containerd/">Containerd</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            ÊúÄÂêéÊõ¥Êñ∞‰∫é 2024-12-11
        </span>
    </section></footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

     
    
        
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css" />
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }

    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/bilibili"],"lang":"zh-CN","locale":{"admin":"Admin","placeholder":"ÊÑüË∞¢ÊÇ®ÁöÑËØÑËÆ∫"},"pageview":true,"requiredMeta":["nick"],"serverURL":"https://chenyuan1125.top","visitor":true});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 Lee
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
